<section class="departamentos-page">
  <h1 class="page-title">Áreas Organizacionales</h1>
  <p class="page-description">Administra la estructura organizacional de la organización</p>

  <div class="view-buttons">
    <button type="button" class="view-pill active" data-view="form">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/form.svg')"></span><span class="view-pill-label">Form</span>
    </button>
    <button type="button" class="view-pill" data-view="list">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/list.svg')"></span><span class="view-pill-label">Lista</span>
    </button>
    <button type="button" class="view-pill" data-view="kanban">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/kanban.svg')"></span><span class="view-pill-label">Kanban</span>
    </button>
    <button type="button" class="view-pill" data-view="organigrama">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/organigrama.svg')"></span><span class="view-pill-label">Organigrama</span>
    </button>
  </div>

  <section id="area-panel" class="usuario-panel">
    <div id="area-view"></div>
  </section>

  <style>
    .departamentos-page .area-card {
      border: 1px solid #dbe3ef;
      border-radius: 14px;
      background: #fff;
      padding: 14px;
      margin-bottom: 12px;
    }
    .departamentos-page .area-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .departamentos-page .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .departamentos-page .field.field-full {
      grid-column: 1 / -1;
    }
    .departamentos-page .field input,
    .departamentos-page .field select,
    .departamentos-page .field textarea {
      border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
      border-radius: 10px;
      padding: 10px 12px;
      font: inherit;
      color: var(--navbar-text, #1f172a);
      background: var(--field-color, #ffffff);
    }
    .departamentos-page .field textarea {
      min-height: 92px;
      resize: vertical;
    }
    .departamentos-page .color-field-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .departamentos-page .color-swatch {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 22%, #ffffff 78%);
      background: #1d4ed8;
      flex: 0 0 40px;
    }
    .departamentos-page .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .departamentos-page .btn {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      color: #0f172a;
      padding: 9px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .departamentos-page .btn.primary {
      background: #0f172a;
      color: #fff;
      border-color: #0f172a;
    }
    .departamentos-page .btn-icon {
      width: 34px;
      height: 34px;
      padding: 0;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .departamentos-page .btn-icon img {
      width: 16px;
      height: 16px;
      object-fit: contain;
      display: block;
    }
    .departamentos-page .save-status {
      min-height: 20px;
      font-size: .9rem;
      font-weight: 600;
      align-self: center;
    }
    .departamentos-page .save-status.is-pending { color: #334155; }
    .departamentos-page .save-status.is-ok { color: #166534; }
    .departamentos-page .save-status.is-error { color: #b91c1c; }
    .departamentos-page .list {
      display: grid;
      gap: 10px;
    }
    .departamentos-page .list-item {
      border: 1px solid #dbe3ef;
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      cursor: pointer;
      background: #fff;
    }
    .departamentos-page .list-item:hover {
      background: #f8fafc;
    }
    .departamentos-page .badge {
      border: 1px solid #dbe3ef;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: .8rem;
    }
    .departamentos-page .kanban {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .departamentos-page .kanban-col {
      border: 1px dashed #cbd5e1;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .departamentos-page .kanban-col h4 {
      margin: 0 0 10px;
    }
    .departamentos-page .org-root {
      margin-bottom: 8px;
      font-weight: 700;
    }
    .departamentos-page .dept-org-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .departamentos-page .dept-org-modal.open {
      display: flex;
    }
    .departamentos-page .dept-org-dialog {
      width: min(980px, 96vw);
      max-height: 90vh;
      overflow: auto;
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #dbe3ef;
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.24);
      padding: 14px;
    }
    .departamentos-page .dept-org-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .departamentos-page .dept-org-title {
      margin: 0;
      font-size: 1rem;
      color: #0f172a;
    }
    .departamentos-page .dept-org-close {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      color: #0f172a;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .departamentos-page .emp-note {
      margin-top: 12px;
      border: 1px solid #dbe3ef;
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }
    .departamentos-page .emp-note-tabs {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .departamentos-page .emp-note-tab {
      border: 0;
      background: transparent;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      color: #0f172a;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .departamentos-page .emp-note-tab .tab-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      flex: 0 0 auto;
    }
    .departamentos-page .emp-note-tab.active {
      background: #ffffff;
      border-bottom: 2px solid #0f172a;
    }
    .departamentos-page .emp-note-panel {
      padding: 10px 12px 12px;
    }
    .departamentos-page .emp-assigned-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 4px;
    }
    .departamentos-page .emp-assigned-meta {
      color: #334155;
      margin: 0 0 8px;
      font-weight: 600;
      font-size: .92rem;
    }
    @media (max-width: 980px) {
      .departamentos-page .area-grid,
      .departamentos-page .kanban {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    (function () {
      const areaView = document.getElementById('area-view');
      const areaTabs = document.querySelectorAll('.view-pill[data-view]');
      if (!areaView || !areaTabs.length) return;

      let areasData = [];
      let createAreaMode = false;
      let selectedAreaCode = null;
      let lastSaveFeedback = { message: '', tone: '' };
      let orgLibPromise = null;
      let orgChartInstance = null;
      let orgAvatarUrl = '/templates/icon/organigrama.svg';
      let colaboradoresData = [];

      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const normalizeAreaStatus = (value) => {
        const raw = String(value || '').trim();
        if (raw === 'Estratégico' || raw === 'En revisión' || raw === 'Activo') return raw;
        return 'Activo';
      };

      const normalizeAreaColor = (value) => {
        const raw = String(value || '').trim();
        return /^#[0-9a-fA-F]{6}$/.test(raw) ? raw : '#1d4ed8';
      };

      const normalizeAreaRow = (row, fallbackIndex = 0) => {
        const data = row && typeof row === 'object' ? row : {};
        const code = String(data.code || data.codigo || '').trim() || `DEP-${String(fallbackIndex + 1).padStart(3, '0')}`;
        return {
          name: String(data.name || data.nombre || '').trim(),
          parent: String(data.parent || data.padre || 'N/A').trim() || 'N/A',
          manager: String(data.manager || data.responsable || '').trim(),
          code,
          color: normalizeAreaColor(data.color),
          status: normalizeAreaStatus(data.status || data.estado),
        };
      };

      const replaceAreasData = (rows = []) => {
        const clean = (Array.isArray(rows) ? rows : [])
          .map((row, index) => normalizeAreaRow(row, index))
          .filter((row) => row.name && row.code);
        areasData = clean;
      };
      const normalizeText = (value) => String(value || '').trim().toLowerCase();
      const getAssignedEmployees = (area) => {
        const areaName = normalizeText(area?.name);
        const areaCode = normalizeText(area?.code);
        if (!areaName && !areaCode) return [];
        return colaboradoresData.filter((col) => {
          const dep = normalizeText(col?.departamento);
          return !!dep && (dep === areaName || dep === areaCode);
        });
      };
      const assignedCount = (area) => {
        const backendCount = Number(area?.empleados_asignados);
        if (!Number.isNaN(backendCount)) return backendCount;
        return getAssignedEmployees(area).length;
      };

      const loadAreasData = async () => {
        try {
          const res = await fetch('/api/inicio/departamentos');
          const json = await res.json().catch(() => ({}));
          if (!res.ok || json?.success === false) throw new Error();
          replaceAreasData(json?.data || []);
        } catch (_error) {
          replaceAreasData([]);
        }
      };
      const loadColaboradoresData = async () => {
        try {
          const res = await fetch('/api/colaboradores');
          const json = await res.json().catch(() => ({}));
          if (!res.ok || json?.success === false) throw new Error();
          colaboradoresData = Array.isArray(json?.data) ? json.data : [];
        } catch (_error) {
          colaboradoresData = [];
        }
      };

      const persistAreasData = async () => {
        const res = await fetch('/api/inicio/departamentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: areasData }),
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || json?.success === false) {
          const backendMessage = String(
            json?.error || json?.detail || json?.message || ''
          ).trim();
          throw new Error(backendMessage || 'No se pudieron guardar departamentos');
        }
        if (json?.message) {
          lastSaveFeedback = { message: String(json.message), tone: 'ok' };
        }
        replaceAreasData(json?.data || []);
      };

      const getAreaParentOptions = (selected = '') => {
        const names = [...new Set(areasData.map((a) => a.name).filter(Boolean))];
        const options = ['N/A', ...names];
        return options
          .map((name) => `<option value="${escapeHtml(name)}" ${name === selected ? 'selected' : ''}>${escapeHtml(name)}</option>`)
          .join('');
      };

      const renderAreaForm = () => {

        const selectedArea = createAreaMode
          ? {}
          : (
            areasData.find((area) => String(area.code || '').trim() === String(selectedAreaCode || '').trim())
            || areasData[0]
            || {}
          );

        const selectedName = escapeHtml(selectedArea.name || '');
        const selectedParentRaw = selectedArea.parent || 'N/A';
        const selectedCode = escapeHtml(selectedArea.code || '');
        const selectedManager = escapeHtml(selectedArea.manager || '');
        const selectedColor = normalizeAreaColor(selectedArea.color || '#1d4ed8');
        const selectedStatus = escapeHtml(selectedArea.status || 'Activo');
        const relation = selectedStatus === 'En revisión' ? 'Funcional' : 'Línea';
        const assigned = getAssignedEmployees(selectedArea);
        const renderNotebookPanel = (tabName) => {
          if (tabName === 'empleados') {
            return `
              <p class="emp-assigned-meta">Empleados asignados: ${assigned.length}</p>
              ${assigned.length
                ? `<ul class="emp-assigned-list">
                    ${assigned.map((emp) => `<li>${escapeHtml(emp.nombre || emp.usuario || 'Sin nombre')} ${emp.puesto ? `- ${escapeHtml(emp.puesto)}` : ''}</li>`).join('')}
                  </ul>`
                : '<p>Sin empleados asignados.</p>'
              }
            `;
          }
          return '<p>Sin acceso, consulte al administrdor</p>';
        };

        areaView.innerHTML = `
          <section class="area-card">
            <h2>Datos del área</h2>
            <p>Completa la información base y define su relación organizacional.</p>
            <form id="area-form">
              <div class="area-grid">
                <div class="field">
                  <label>Nombre</label>
                  <input id="area-name-input" type="text" value="${selectedName}" placeholder="Nombre del área">
                </div>
                <div class="field">
                  <label>Departamento padre</label>
                  <select id="area-parent-select">${getAreaParentOptions(selectedParentRaw)}</select>
                </div>
                <div class="field field-full">
                  <label>Responsable</label>
                  <select id="area-manager-select"><option value="">Cargando...</option></select>
                </div>
                <div class="field">
                  <label>Relación organizacional</label>
                  <select id="area-relacion-select">
                    <option value="Línea" ${relation === 'Línea' ? 'selected' : ''}>Línea</option>
                    <option value="Staff" ${relation === 'Staff' ? 'selected' : ''}>Staff</option>
                    <option value="Funcional" ${relation === 'Funcional' ? 'selected' : ''}>Funcional</option>
                  </select>
                </div>
                <div class="field">
                  <label>Código</label>
                  <input id="area-code-input" type="text" value="${selectedCode}" placeholder="Ej: OPE-010">
                </div>
                <div class="field">
                  <label>Color</label>
                  <div class="color-field-row">
                    <input id="area-color-input" type="color" value="${selectedColor}">
                    <span id="area-color-swatch" class="color-swatch" style="background:${selectedColor};"></span>
                  </div>
                </div>
              </div>
              <div class="area-grid" style="margin-top:10px;">
                <div class="field">
                  <label>Descripción</label>
                  <textarea placeholder="Describe el propósito del área"></textarea>
                </div>
                <div class="field">
                  <label>Notas internas</label>
                  <textarea placeholder="Observaciones, acuerdos, excepciones"></textarea>
                </div>
              </div>
              <div class="emp-note">
                <div class="emp-note-tabs">
                  <button type="button" class="emp-note-tab active" data-note-tab="empleados"><img src="/templates/icon/organigrama.svg" alt="" class="tab-icon">Empleados</button>
                  <button type="button" class="emp-note-tab" data-note-tab="ejes"><img src="/templates/icon/biblioteca.svg" alt="" class="tab-icon">Ejes estratégicos asignados</button>
                  <button type="button" class="emp-note-tab" data-note-tab="kpis"><img src="/templates/icon/kpi.svg" alt="" class="tab-icon">KPI</button>
                  <button type="button" class="emp-note-tab" data-note-tab="indice"><img src="/templates/icon/habilidades.svg" alt="" class="tab-icon">Indice de bateo</button>
                </div>
                <div class="emp-note-panel" id="area-emp-note-panel">
                  ${renderNotebookPanel('empleados')}
                </div>
              </div>
              <div class="actions">
                <button type="button" id="area-form-new-btn" class="btn">Nuevo</button>
                <button type="button" id="area-form-cancel-btn" class="btn">Cancelar</button>
                <button type="submit" id="area-form-save-btn" class="btn primary">Guardar</button>
                <span id="area-form-save-status" class="save-status" role="status" aria-live="polite"></span>
              </div>
            </form>
          </section>
        `;
        // Poblar select de responsables (colaboradores)
        const managerSelect = areaView.querySelector('#area-manager-select');
        if (managerSelect) {
          if (colaboradoresData.length) {
            managerSelect.innerHTML = '<option value="">Seleccione responsable</option>' +
              colaboradoresData.map(function(col) {
                const label = (col.nombre ? col.nombre : col.usuario) + (col.departamento ? ' (' + col.departamento + ')' : '');
                return '<option value="' + (col.nombre || col.usuario || '') + '"' + (selectedManager === (col.nombre || col.usuario) ? ' selected' : '') + '>' + label + '</option>';
              }).join('');
          } else {
            managerSelect.innerHTML = '<option value="">Sin colaboradores</option>';
          }
        }

        const form = areaView.querySelector('#area-form');
        const notebookPanel = areaView.querySelector('#area-emp-note-panel');
        const notebookTabs = areaView.querySelectorAll('.emp-note-tab[data-note-tab]');
        const newBtn = areaView.querySelector('#area-form-new-btn');
        const cancelBtn = areaView.querySelector('#area-form-cancel-btn');
        const saveBtn = areaView.querySelector('#area-form-save-btn');
        const saveStatus = areaView.querySelector('#area-form-save-status');
        const colorInput = areaView.querySelector('#area-color-input');
        const colorSwatch = areaView.querySelector('#area-color-swatch');

        const setSaveStatus = (message, tone = '') => {
          lastSaveFeedback = { message: message || '', tone: tone || '' };
          if (!saveStatus) return;
          saveStatus.textContent = message || '';
          saveStatus.classList.remove('is-pending', 'is-ok', 'is-error');
          if (tone) saveStatus.classList.add(`is-${tone}`);
        };
        if (lastSaveFeedback.message) {
          setSaveStatus(lastSaveFeedback.message, lastSaveFeedback.tone);
        }
        if (colorInput && colorSwatch) {
          const syncColorSwatch = () => {
            colorSwatch.style.background = normalizeAreaColor(colorInput.value);
          };
          colorInput.addEventListener('input', syncColorSwatch);
          syncColorSwatch();
        }
        if (notebookTabs.length && notebookPanel) {
          notebookTabs.forEach((tabBtn) => {
            tabBtn.addEventListener('click', () => {
              notebookTabs.forEach((btn) => btn.classList.remove('active'));
              tabBtn.classList.add('active');
              notebookPanel.innerHTML = renderNotebookPanel(tabBtn.getAttribute('data-note-tab'));
            });
          });
        }

        newBtn && newBtn.addEventListener('click', () => {
          createAreaMode = true;
          selectedAreaCode = null;
          renderAreaForm();
        });

        cancelBtn && cancelBtn.addEventListener('click', () => {
          createAreaMode = false;
          setAreaView('list');
        });

        form && form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const name = String(areaView.querySelector('#area-name-input')?.value || '').trim();
          const parent = String(areaView.querySelector('#area-parent-select')?.value || 'N/A').trim() || 'N/A';
          const manager = String(areaView.querySelector('#area-manager-select')?.value || '').trim();
          const code = String(areaView.querySelector('#area-code-input')?.value || '').trim();
          const color = normalizeAreaColor(areaView.querySelector('#area-color-input')?.value || '#1d4ed8');
          const relationValue = String(areaView.querySelector('#area-relacion-select')?.value || 'Línea').trim();
          const status = relationValue === 'Funcional' ? 'En revisión' : 'Activo';
          if (!name || !code) {
            setSaveStatus('Nombre y código son obligatorios.', 'error');
            return;
          }
          const payload = { name, parent, manager, code, color, status };
          const index = areasData.findIndex((area) => String(area.code || '').trim() === code);
          if (index >= 0) {
            areasData[index] = payload;
          } else {
            areasData.push(payload);
          }
          try {
            saveBtn && (saveBtn.disabled = true);
            setSaveStatus('Guardando...', 'pending');
            await persistAreasData();
            createAreaMode = false;
            selectedAreaCode = code;
            setSaveStatus('Guardado correctamente.', 'ok');
            setAreaView('form');
          } catch (error) {
            setSaveStatus(error?.message || 'Error al guardar.', 'error');
          } finally {
            saveBtn && (saveBtn.disabled = false);
          }
        });
      };

      const renderAreaList = () => {
        const sortedAreas = [...areasData].sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || ''), 'es', { sensitivity: 'base' }));
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Listado de áreas</h2>
            <p>Consulta áreas por código, responsable y estado.</p>
            <div class="list">
              ${sortedAreas.length ? sortedAreas.map((area) => `
                <div class="list-item" data-area-code="${escapeHtml(area.code)}">
                  <span><strong>${escapeHtml(area.name)}</strong><br><small>${escapeHtml(area.manager || 'Sin responsable')}</small><br><small>Empleados asignados: ${assignedCount(area)}</small></span>
                  <span>
                    <span class="badge">${escapeHtml(area.code || 'N/A')}</span>
                    <span class="badge">${escapeHtml(area.status || 'N/A')}</span>
                    <button class="btn btn-icon btn-delete" data-delete-code="${escapeHtml(area.code)}" title="Eliminar" style="margin-left:8px;background:#dc2626;color:#fff;border-color:#dc2626;">
                      <img src="/icon/eliminar.svg" alt="Eliminar">
                    </button>
                  </span>
                </div>
              `).join('') : '<p>Sin áreas registradas.</p>'}
            </div>
          </section>
        `;
        areaView.querySelectorAll('[data-area-code]').forEach((item) => {
          item.addEventListener('click', (ev) => {
            // Evitar que el click en el botón Eliminar abra el formulario
            if (ev.target && ev.target.matches('.btn-delete')) return;
            createAreaMode = false;
            selectedAreaCode = String(item.getAttribute('data-area-code') || '').trim();
            setAreaView('form');
          });
        });
        areaView.querySelectorAll('.btn-delete').forEach((btn) => {
          btn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const code = btn.getAttribute('data-delete-code');
            if (!code) return;
            if (!confirm('¿Seguro que deseas eliminar este departamento?')) return;
            try {
              const res = await fetch('/api/inicio/departamentos/' + encodeURIComponent(code), { method: 'DELETE' });
              const json = await res.json().catch(() => ({}));
              if (!res.ok || json?.success === false) {
                throw new Error(String(json?.error || json?.detail || 'No se pudo eliminar.'));
              }
              replaceAreasData(json?.data || []);
              setAreaView('list');
            } catch (error) {
              alert(error?.message || 'Error al eliminar.');
            }
          });
        });
      };

      const renderAreaKanban = () => {
        const byStatus = {
          'Estratégico': areasData.filter((area) => area.status === 'Estratégico'),
          'Activo': areasData.filter((area) => area.status === 'Activo'),
          'En revisión': areasData.filter((area) => area.status === 'En revisión'),
        };
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Kanban de áreas</h2>
            <p>Distribución por estado.</p>
            <div class="kanban">
              ${Object.entries(byStatus).map(([status, rows]) => `
                <div class="kanban-col">
                  <h4>${status} (${rows.length})</h4>
                  ${rows.length ? rows.map((area) => `
                    <div class="list-item" style="cursor:default;">
                      <span><strong>${escapeHtml(area.name)}</strong><br><small>${escapeHtml(area.code)}</small><br><small>Empleados asignados: ${assignedCount(area)}</small></span>
                    </div>
                  `).join('') : '<p>Sin elementos.</p>'}
                </div>
              `).join('')}
            </div>
          </section>
        `;
      };

      const renderAreaOrganigrama = () => {
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Organigrama de áreas</h2>
            <p>Vista jerárquica interactiva.</p>
            <div class="org-toolbar">
              <button type="button" id="area-org-fullscreen-btn" class="btn">Ver en pantalla completa</button>
              <span id="area-org-fullscreen-hint" class="org-fullscreen-hint">Esc para salir de pantalla completa</span>
            </div>
            <div id="area-org-chart" class="org-chart-wrap"></div>
          </section>
        `;
        const chartEl = areaView.querySelector('#area-org-chart');
        const fullscreenBtn = areaView.querySelector('#area-org-fullscreen-btn');
        const fullscreenHint = areaView.querySelector('#area-org-fullscreen-hint');
        if (!chartEl) return;
        setupOrgFullscreen(chartEl, fullscreenBtn, fullscreenHint);
        renderOrgChartWithLibrary(chartEl);
      };
      const renderDepartmentEmployeesOrg = (area) => {
        const areaName = normalizeText(area?.name);
        const areaCode = normalizeText(area?.code);
        const rows = colaboradoresData.filter((col) => {
          const dep = normalizeText(col?.departamento);
          return !!dep && (dep === areaName || dep === areaCode);
        });
        if (!rows.length) return '<p>Sin empleados asignados en este departamento.</p>';
        const byId = {};
        const idByKey = {};
        rows.forEach((row) => {
          const id = Number(row.id || 0);
          if (id) byId[id] = row;
          const keyName = normalizeText(row.nombre);
          const keyUser = normalizeText(row.usuario);
          if (keyName) idByKey[keyName] = id;
          if (keyUser) idByKey[keyUser] = id;
        });
        const byBoss = {};
        rows.forEach((row) => {
          const myId = Number(row.id || 0);
          const bossIdRaw = Number(row.jefe_inmediato_id || 0);
          let bossId = bossIdRaw && byId[bossIdRaw] ? bossIdRaw : 0;
          if (!bossId) {
            const bossKey = normalizeText(row.jefe);
            bossId = bossKey ? Number(idByKey[bossKey] || 0) : 0;
          }
          const groupKey = bossId && bossId !== myId ? String(bossId) : 'root';
          if (!byBoss[groupKey]) byBoss[groupKey] = [];
          byBoss[groupKey].push(row);
        });
        const roots = byBoss.root || rows;
        const renderLevel = (nodes, depth) => {
          if (!nodes || !nodes.length) return '';
          return `<div class="org-level" style="margin-top:${depth ? '10px' : '0'};">${
            nodes.map((node) => {
              const kids = byBoss[String(node.id)] || [];
              const avatar = escapeHtml((node.imagen || '').trim() || '/icon/usuario.png');
              return `
                <div class="${depth === 0 ? 'org-root' : ''}">
                  <div class="org-node">
                    <div class="org-node-avatar"><img src="${avatar}" alt="${escapeHtml(node.nombre || 'Colaborador')}" loading="lazy" onerror="this.src='/icon/usuario.png'"></div>
                    <strong>${escapeHtml(node.nombre || node.usuario || 'Sin nombre')}</strong>
                    <span>${escapeHtml(node.puesto || node.usuario || '')}</span>
                  </div>
                  ${kids.length ? `<div class="org-divider"></div>${renderLevel(kids, depth + 1)}` : ''}
                </div>
              `;
            }).join('')
          }</div>`;
        };
        return `<div class="usuario-organigrama">${renderLevel(roots, 0)}</div>`;
      };
      const ensureDeptOrgModal = () => {
        let modal = document.getElementById('dept-org-modal');
        if (modal) return modal;
        modal = document.createElement('div');
        modal.id = 'dept-org-modal';
        modal.className = 'dept-org-modal';
        modal.innerHTML = `
          <div class="dept-org-dialog" role="dialog" aria-modal="true" aria-labelledby="dept-org-modal-title">
            <div class="dept-org-head">
              <h3 id="dept-org-modal-title" class="dept-org-title">Organigrama del departamento</h3>
              <button type="button" class="dept-org-close" data-close-dept-org>Cerrar</button>
            </div>
            <div id="dept-org-modal-body"></div>
          </div>
        `;
        modal.addEventListener('click', (event) => {
          if (event.target === modal) modal.classList.remove('open');
        });
        modal.querySelector('[data-close-dept-org]')?.addEventListener('click', () => modal.classList.remove('open'));
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') modal.classList.remove('open');
        });
        document.body.appendChild(modal);
        return modal;
      };
      const openDeptOrgModal = (area) => {
        const modal = ensureDeptOrgModal();
        const titleEl = modal.querySelector('#dept-org-modal-title');
        const bodyEl = modal.querySelector('#dept-org-modal-body');
        if (titleEl) titleEl.textContent = `Organigrama del departamento: ${String(area?.name || area?.code || 'N/A')}`;
        if (bodyEl) bodyEl.innerHTML = renderDepartmentEmployeesOrg(area);
        modal.classList.add('open');
      };

      const getFullscreenElement = () => document.fullscreenElement || document.webkitFullscreenElement || null;

      const requestElementFullscreen = async (element) => {
        if (!element) return;
        if (element.requestFullscreen) {
          await element.requestFullscreen();
          return;
        }
        if (element.webkitRequestFullscreen) {
          element.webkitRequestFullscreen();
        }
      };

      const exitAnyFullscreen = async () => {
        if (document.exitFullscreen) {
          await document.exitFullscreen();
          return;
        }
        if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        }
      };

      const setupOrgFullscreen = (chartEl, btnEl, hintEl) => {
        if (!chartEl || !btnEl) return;
        const target = chartEl;
        const updateFullscreenUi = () => {
          const isActive = getFullscreenElement() === target;
          btnEl.textContent = isActive ? 'Salir de pantalla completa' : 'Ver en pantalla completa';
          if (hintEl) hintEl.classList.toggle('visible', isActive);
        };
        btnEl.addEventListener('click', async () => {
          const isActive = getFullscreenElement() === target;
          try {
            if (isActive) {
              await exitAnyFullscreen();
            } else {
              await requestElementFullscreen(target);
            }
          } catch (_error) {
            // Ignorar fallo silencioso del navegador en fullscreen sin gesto permitido.
          } finally {
            updateFullscreenUi();
          }
        });
        document.addEventListener('fullscreenchange', updateFullscreenUi);
        document.addEventListener('webkitfullscreenchange', updateFullscreenUi);
        updateFullscreenUi();
      };

      const loadScript = (src) => new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`No se pudo cargar ${src}`));
        document.head.appendChild(script);
      });

      const ensureOrgChartLibrary = async () => {
        if (window.d3 && window.d3.OrgChart) return true;
        if (!orgLibPromise) {
          orgLibPromise = (async () => {
            try {
              await loadScript('/static/vendor/d3.min.js');
              await loadScript('/static/vendor/d3-flextree.min.js');
              await loadScript('/static/vendor/d3-org-chart.min.js');
            } catch (_localError) {
              await loadScript('https://cdn.jsdelivr.net/npm/d3@7');
              await loadScript('https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js');
              await loadScript('https://cdn.jsdelivr.net/npm/d3-org-chart@3');
            }
          })().catch(() => false);
        }
        const result = await orgLibPromise;
        return result !== false && !!(window.d3 && window.d3.OrgChart);
      };

      const buildOrgNodes = () => {
        const nameToCode = new Map();
        areasData.forEach((area) => {
          const name = String(area.name || '').trim();
          const code = String(area.code || '').trim();
          if (name && code && !nameToCode.has(name)) nameToCode.set(name, code);
        });
        const nodes = areasData.map((area) => {
          const parentName = String(area.parent || '').trim();
          const parentCode = parentName && parentName !== 'N/A' ? (nameToCode.get(parentName) || '') : '';
          return {
            id: String(area.code || '').trim(),
            parentId: parentCode || null,
            name: String(area.name || '').trim(),
            code: String(area.code || '').trim(),
            manager: String(area.manager || '').trim(),
            status: String(area.status || '').trim() || 'Activo',
            color: normalizeAreaColor(area.color),
            empleados_asignados: assignedCount(area),
          };
        }).filter((node) => node.id && node.name);
        const rootNodes = nodes.filter((node) => !node.parentId);
        if (rootNodes.length > 1) {
          const virtualRootId = '__root__areas__';
          rootNodes.forEach((node) => { node.parentId = virtualRootId; });
          nodes.unshift({
            id: virtualRootId,
            parentId: null,
            name: 'Áreas organizacionales',
            code: 'ROOT',
            manager: '',
            status: 'Activo',
            color: '#0f172a',
          });
        }
        return nodes;
      };

      const renderOrgChartWithLibrary = async (container) => {
        const available = await ensureOrgChartLibrary();
        if (!available) {
          container.innerHTML = '<p>No se pudo cargar la librería de organigrama.</p>';
          return;
        }
        const nodes = buildOrgNodes();
        if (!nodes.length) {
          container.innerHTML = '<p>Sin áreas disponibles.</p>';
          return;
        }
        container.innerHTML = '';
        orgChartInstance = new window.d3.OrgChart()
          .container(container)
          .data(nodes)
          .nodeWidth(() => 260)
          .nodeHeight(() => 120)
          .childrenMargin(() => 48)
          .linkYOffset(20)
          .setActiveNodeCentered(false)
          .onNodeClick((d) => {
            const code = String(d?.data?.code || '').trim();
            if (!code || code === 'ROOT') return;
            openDeptOrgModal(d?.data || {});
          })
          .linkUpdate(function (d) {
            window.d3.select(this)
              .attr('stroke-width', 1.1)
              .attr('stroke', 'rgba(15, 23, 42, 0.38)');
          })
          .initialExpandLevel(99)
          .compact(false)
          .nodeContent((d) => {
            const data = d?.data || {};
            const manager = escapeHtml(data.manager || 'Sin responsable');
            const code = escapeHtml(data.code || '');
            const name = escapeHtml(data.name || '');
            const border = escapeHtml(data.color || '#1d4ed8');
            const empleados = Number(data.empleados_asignados || 0);
            const initials = escapeHtml((name || 'A').split(/\s+/).filter(Boolean).slice(0, 2).map(part => part.charAt(0).toUpperCase()).join(''));
            return `
              <div style="
                width:100%;
                height:100%;
                border:2px solid ${border};
                border-radius:12px;
                background:#ffffff;
                box-shadow:0 8px 20px rgba(15,23,42,.12);
                padding:10px 12px;
                color:#0f172a;
                display:flex;
                flex-direction:column;
                justify-content:center;
                gap:6px;
                box-sizing:border-box;
                overflow:hidden;
              ">
                <div class="org-node-layout">
                  <div class="org-node-avatar">
                    ${orgAvatarUrl
                      ? `<img src="${escapeHtml(orgAvatarUrl)}" alt="Área">`
                      : `<span class="org-node-avatar-fallback">${initials}</span>`
                    }
                  </div>
                  <div class="org-node-data">
                    <strong style="font-size:15px; line-height:1.2; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</strong>
                    <div style="font-size:12px; opacity:.85; line-height:1.2; margin-top:2px;">${code}</div>
                    <div style="font-size:12px; opacity:.9; line-height:1.2; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${manager}</div>
                    <div style="font-size:12px; opacity:.9; line-height:1.2; margin-top:2px;">Empleados asignados: ${empleados}</div>
                  </div>
                </div>
              </div>
            `;
          })
          .render();
        if (orgChartInstance && typeof orgChartInstance.fit === 'function') {
          orgChartInstance.fit();
        }
      };

      const setAreaView = (view) => {
        areaTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.view === view));
        switch (view) {
          case 'list':
            renderAreaList();
            break;
          case 'kanban':
            renderAreaKanban();
            break;
          case 'organigrama':
            renderAreaOrganigrama();
            break;
          default:
            renderAreaForm();
            break;
        }
      };

      areaTabs.forEach((tab) => {
        tab.addEventListener('click', () => setAreaView(tab.dataset.view));
      });

      document.addEventListener('backend-view-change', (event) => {
        const rawView = String(event.detail?.view || '').trim().toLowerCase();
        if (!rawView) return;
        if (rawView === 'graph' || rawView === 'grafica') {
          setAreaView('organigrama');
          return;
        }
        if (rawView === 'form' || rawView === 'list' || rawView === 'kanban' || rawView === 'organigrama') {
          setAreaView(rawView);
        }
      });

      Promise.all([loadAreasData(), loadColaboradoresData()]).then(() => setAreaView('form'));
    })();
  </script>
</section>

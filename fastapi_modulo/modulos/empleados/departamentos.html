<section class="departamentos-page">
  <h1 class="page-title">Departamentos</h1>
  <p class="page-description">Administra la estructura de departamentos de la organización</p>

  <div class="view-buttons">
    <button type="button" class="view-pill active" data-view="form">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/form.svg')"></span><span class="view-pill-label">Form</span>
    </button>
    <button type="button" class="view-pill" data-view="list">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/list.svg')"></span><span class="view-pill-label">Lista</span>
    </button>
    <button type="button" class="view-pill" data-view="kanban">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/kanban.svg')"></span><span class="view-pill-label">Kanban</span>
    </button>
    <button type="button" class="view-pill" data-view="organigrama">
      <span class="view-pill-icon-mask" aria-hidden="true" style="--view-pill-icon-url:url('/templates/icon/organigrama.svg')"></span><span class="view-pill-label">Organigrama</span>
    </button>
  </div>

  <section id="area-panel" class="usuario-panel">
    <div id="area-view"></div>
  </section>

  <style>
    .departamentos-page .area-card {
      border: 1px solid #dbe3ef;
      border-radius: 14px;
      background: #fff;
      padding: 14px;
      margin-bottom: 12px;
    }
    .departamentos-page .area-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .departamentos-page .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .departamentos-page .field input,
    .departamentos-page .field select,
    .departamentos-page .field textarea {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px 12px;
      font: inherit;
    }
    .departamentos-page .field textarea {
      min-height: 92px;
      resize: vertical;
    }
    .departamentos-page .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .departamentos-page .btn {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      color: #0f172a;
      padding: 9px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .departamentos-page .btn.primary {
      background: #0f172a;
      color: #fff;
      border-color: #0f172a;
    }
    .departamentos-page .save-status {
      min-height: 20px;
      font-size: .9rem;
      font-weight: 600;
      align-self: center;
    }
    .departamentos-page .save-status.is-pending { color: #334155; }
    .departamentos-page .save-status.is-ok { color: #166534; }
    .departamentos-page .save-status.is-error { color: #b91c1c; }
    .departamentos-page .list {
      display: grid;
      gap: 10px;
    }
    .departamentos-page .list-item {
      border: 1px solid #dbe3ef;
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      cursor: pointer;
      background: #fff;
    }
    .departamentos-page .list-item:hover {
      background: #f8fafc;
    }
    .departamentos-page .badge {
      border: 1px solid #dbe3ef;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: .8rem;
    }
    .departamentos-page .kanban {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .departamentos-page .kanban-col {
      border: 1px dashed #cbd5e1;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .departamentos-page .kanban-col h4 {
      margin: 0 0 10px;
    }
    .departamentos-page .org-root {
      margin-bottom: 8px;
      font-weight: 700;
    }
    @media (max-width: 980px) {
      .departamentos-page .area-grid,
      .departamentos-page .kanban {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    (function () {
      const areaView = document.getElementById('area-view');
      const areaTabs = document.querySelectorAll('.view-pill[data-view]');
      if (!areaView || !areaTabs.length) return;

      const defaultAreasData = [
        { name: 'Dirección General', parent: 'N/A', manager: 'Adriana Chávez Galeana', code: 'DIR-001', color: '#0f172a', status: 'Estratégico' },
        { name: 'Operaciones', parent: 'Dirección General', manager: 'Pablo Rojas', code: 'OPE-010', color: '#1d4ed8', status: 'Activo' },
        { name: 'Planeación', parent: 'Dirección General', manager: 'Lucía Ortega Moreno', code: 'PLA-020', color: '#0ea5e9', status: 'Activo' },
        { name: 'Servicios', parent: 'Operaciones', manager: 'María Delgado', code: 'SER-030', color: '#16a34a', status: 'En revisión' },
      ];
      let areasData = defaultAreasData.map((row) => ({ ...row }));
      let createAreaMode = false;
      let selectedAreaCode = null;
      let lastSaveFeedback = { message: '', tone: '' };

      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const normalizeAreaStatus = (value) => {
        const raw = String(value || '').trim();
        if (raw === 'Estratégico' || raw === 'En revisión' || raw === 'Activo') return raw;
        return 'Activo';
      };

      const normalizeAreaColor = (value) => {
        const raw = String(value || '').trim();
        return /^#[0-9a-fA-F]{6}$/.test(raw) ? raw : '#1d4ed8';
      };

      const normalizeAreaRow = (row, fallbackIndex = 0) => {
        const data = row && typeof row === 'object' ? row : {};
        const code = String(data.code || data.codigo || '').trim() || `DEP-${String(fallbackIndex + 1).padStart(3, '0')}`;
        return {
          name: String(data.name || data.nombre || '').trim(),
          parent: String(data.parent || data.padre || 'N/A').trim() || 'N/A',
          manager: String(data.manager || data.responsable || '').trim(),
          code,
          color: normalizeAreaColor(data.color),
          status: normalizeAreaStatus(data.status || data.estado),
        };
      };

      const replaceAreasData = (rows = []) => {
        const clean = (Array.isArray(rows) ? rows : [])
          .map((row, index) => normalizeAreaRow(row, index))
          .filter((row) => row.name && row.code);
        areasData = clean.length ? clean : defaultAreasData.map((row) => ({ ...row }));
      };

      const loadAreasData = async () => {
        try {
          const res = await fetch('/api/inicio/departamentos');
          const json = await res.json().catch(() => ({}));
          if (!res.ok || json?.success === false) throw new Error();
          replaceAreasData(json?.data || []);
        } catch (_error) {
          replaceAreasData(defaultAreasData);
        }
      };

      const persistAreasData = async () => {
        const res = await fetch('/api/inicio/departamentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: areasData }),
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || json?.success === false) {
          throw new Error('No se pudieron guardar departamentos');
        }
        replaceAreasData(json?.data || []);
      };

      const getAreaParentOptions = (selected = '') => {
        const names = [...new Set(areasData.map((a) => a.name).filter(Boolean))];
        const options = ['N/A', ...names];
        return options
          .map((name) => `<option value="${escapeHtml(name)}" ${name === selected ? 'selected' : ''}>${escapeHtml(name)}</option>`)
          .join('');
      };

      const renderAreaForm = () => {

        const selectedArea = createAreaMode
          ? {}
          : (
            areasData.find((area) => String(area.code || '').trim() === String(selectedAreaCode || '').trim())
            || areasData[0]
            || {}
          );

        const selectedName = escapeHtml(selectedArea.name || '');
        const selectedParentRaw = selectedArea.parent || 'N/A';
        const selectedCode = escapeHtml(selectedArea.code || '');
        const selectedManager = escapeHtml(selectedArea.manager || '');
        const selectedColor = normalizeAreaColor(selectedArea.color || '#1d4ed8');
        const selectedStatus = escapeHtml(selectedArea.status || 'Activo');
        const relation = selectedStatus === 'En revisión' ? 'Funcional' : 'Línea';

        areaView.innerHTML = `
          <section class="area-card">
            <h2>Datos del área</h2>
            <p>Completa la información base y define su relación organizacional.</p>
            <form id="area-form">
              <div class="area-grid">
                <div class="field">
                  <label>Nombre</label>
                  <input id="area-name-input" type="text" value="${selectedName}" placeholder="Nombre del área">
                </div>
                <div class="field">
                  <label>Departamento padre</label>
                  <select id="area-parent-select">${getAreaParentOptions(selectedParentRaw)}</select>
                </div>
                <div class="field">
                  <label>Responsable</label>
                  <select id="area-manager-select"><option value="">Cargando...</option></select>
                </div>
                <div class="field">
                  <label>Relación organizacional</label>
                  <select id="area-relacion-select">
                    <option value="Línea" ${relation === 'Línea' ? 'selected' : ''}>Línea</option>
                    <option value="Staff" ${relation === 'Staff' ? 'selected' : ''}>Staff</option>
                    <option value="Funcional" ${relation === 'Funcional' ? 'selected' : ''}>Funcional</option>
                  </select>
                </div>
                <div class="field">
                  <label>Código</label>
                  <input id="area-code-input" type="text" value="${selectedCode}" placeholder="Ej: OPE-010">
                </div>
                <div class="field">
                  <label>Color</label>
                  <input id="area-color-input" type="color" value="${selectedColor}">
                </div>
              </div>
              <div class="area-grid" style="margin-top:10px;">
                <div class="field">
                  <label>Descripción</label>
                  <textarea placeholder="Describe el propósito del área"></textarea>
                </div>
                <div class="field">
                  <label>Notas internas</label>
                  <textarea placeholder="Observaciones, acuerdos, excepciones"></textarea>
                </div>
              </div>
              <div class="actions">
                <button type="button" id="area-form-new-btn" class="btn">Nuevo</button>
                <button type="button" id="area-form-cancel-btn" class="btn">Cancelar</button>
                <button type="submit" id="area-form-save-btn" class="btn primary">Guardar</button>
                <span id="area-form-save-status" class="save-status" role="status" aria-live="polite"></span>
              </div>
            </form>
          </section>
        `;

        // Poblar select de responsables (colaboradores)
        const managerSelect = areaView.querySelector('#area-manager-select');
        if (managerSelect) {
          fetch('/api/colaboradores').then(r => r.json()).then(json => {
            if (json && Array.isArray(json.data)) {
              managerSelect.innerHTML = '<option value="">Seleccione responsable</option>' +
                json.data.map(function(col) {
                  const label = (col.nombre ? col.nombre : col.usuario) + (col.departamento ? ' (' + col.departamento + ')' : '');
                  return '<option value="' + (col.nombre || col.usuario || '') + '"' + (selectedManager === (col.nombre || col.usuario) ? ' selected' : '') + '>' + label + '</option>';
                }).join('');
            } else {
              managerSelect.innerHTML = '<option value="">Sin colaboradores</option>';
            }
          }).catch(() => {
            managerSelect.innerHTML = '<option value="">Error al cargar</option>';
          });
        }

        const form = areaView.querySelector('#area-form');
        const newBtn = areaView.querySelector('#area-form-new-btn');
        const cancelBtn = areaView.querySelector('#area-form-cancel-btn');
        const saveBtn = areaView.querySelector('#area-form-save-btn');
        const saveStatus = areaView.querySelector('#area-form-save-status');

        const setSaveStatus = (message, tone = '') => {
          lastSaveFeedback = { message: message || '', tone: tone || '' };
          if (!saveStatus) return;
          saveStatus.textContent = message || '';
          saveStatus.classList.remove('is-pending', 'is-ok', 'is-error');
          if (tone) saveStatus.classList.add(`is-${tone}`);
        };
        if (lastSaveFeedback.message) {
          setSaveStatus(lastSaveFeedback.message, lastSaveFeedback.tone);
        }

        newBtn && newBtn.addEventListener('click', () => {
          createAreaMode = true;
          selectedAreaCode = null;
          renderAreaForm();
        });

        cancelBtn && cancelBtn.addEventListener('click', () => {
          createAreaMode = false;
          setAreaView('list');
        });

        form && form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const name = String(areaView.querySelector('#area-name-input')?.value || '').trim();
          const parent = String(areaView.querySelector('#area-parent-select')?.value || 'N/A').trim() || 'N/A';
          const manager = String(areaView.querySelector('#area-manager-input')?.value || '').trim();
          const code = String(areaView.querySelector('#area-code-input')?.value || '').trim();
          const color = normalizeAreaColor(areaView.querySelector('#area-color-input')?.value || '#1d4ed8');
          const relationValue = String(areaView.querySelector('#area-relacion-select')?.value || 'Línea').trim();
          const status = relationValue === 'Funcional' ? 'En revisión' : 'Activo';
          if (!name || !code) {
            alert('Nombre y código son obligatorios.');
            return;
          }
          const payload = { name, parent, manager, code, color, status };
          const index = areasData.findIndex((area) => String(area.code || '').trim() === code);
          if (index >= 0) {
            areasData[index] = payload;
          } else {
            areasData.push(payload);
          }
          try {
            saveBtn && (saveBtn.disabled = true);
            setSaveStatus('Guardando...', 'pending');
            await persistAreasData();
            createAreaMode = false;
            selectedAreaCode = code;
            setSaveStatus('Guardado correctamente.', 'ok');
            setAreaView('form');
          } catch (error) {
            setSaveStatus(error?.message || 'Error al guardar.', 'error');
          } finally {
            saveBtn && (saveBtn.disabled = false);
          }
        });
      };

      const renderAreaList = () => {
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Listado de áreas</h2>
            <p>Consulta áreas por código, responsable y estado.</p>
            <div class="list">
              ${areasData.length ? areasData.map((area) => `
                <div class="list-item" data-area-code="${escapeHtml(area.code)}">
                  <span><strong>${escapeHtml(area.name)}</strong><br><small>${escapeHtml(area.manager || 'Sin responsable')}</small></span>
                  <span>
                    <span class="badge">${escapeHtml(area.code || 'N/A')}</span>
                    <span class="badge">${escapeHtml(area.status || 'N/A')}</span>
                    <button class="btn btn-delete" data-delete-code="${escapeHtml(area.code)}" title="Eliminar" style="margin-left:8px;background:#dc2626;color:#fff;border-color:#dc2626;">Eliminar</button>
                  </span>
                </div>
              `).join('') : '<p>Sin áreas registradas.</p>'}
            </div>
          </section>
        `;
        areaView.querySelectorAll('[data-area-code]').forEach((item) => {
          item.addEventListener('click', (ev) => {
            // Evitar que el click en el botón Eliminar abra el formulario
            if (ev.target && ev.target.matches('.btn-delete')) return;
            createAreaMode = false;
            selectedAreaCode = String(item.getAttribute('data-area-code') || '').trim();
            setAreaView('form');
          });
        });
        areaView.querySelectorAll('.btn-delete').forEach((btn) => {
          btn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const code = btn.getAttribute('data-delete-code');
            if (!code) return;
            if (!confirm('¿Seguro que deseas eliminar este departamento?')) return;
            const idx = areasData.findIndex((a) => String(a.code) === String(code));
            if (idx >= 0) {
              areasData.splice(idx, 1);
              try {
                await persistAreasData();
                setAreaView('list');
              } catch (error) {
                alert(error?.message || 'Error al eliminar.');
              }
            }
          });
        });
      };

      const renderAreaKanban = () => {
        const byStatus = {
          'Estratégico': areasData.filter((area) => area.status === 'Estratégico'),
          'Activo': areasData.filter((area) => area.status === 'Activo'),
          'En revisión': areasData.filter((area) => area.status === 'En revisión'),
        };
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Kanban de áreas</h2>
            <p>Distribución por estado.</p>
            <div class="kanban">
              ${Object.entries(byStatus).map(([status, rows]) => `
                <div class="kanban-col">
                  <h4>${status} (${rows.length})</h4>
                  ${rows.length ? rows.map((area) => `
                    <div class="list-item" style="cursor:default;">
                      <span><strong>${escapeHtml(area.name)}</strong><br><small>${escapeHtml(area.code)}</small></span>
                    </div>
                  `).join('') : '<p>Sin elementos.</p>'}
                </div>
              `).join('')}
            </div>
          </section>
        `;
      };

      const renderAreaOrganigrama = () => {
        const root = areasData.find((area) => area.parent === 'N/A') || areasData[0];
        if (!root) {
          areaView.innerHTML = '<section class="area-card"><h2>Organigrama</h2><p>Sin áreas disponibles.</p></section>';
          return;
        }
        const firstLevel = areasData.filter((area) => area.parent === root.name);
        const secondLevel = areasData.filter((area) => firstLevel.some((parent) => parent.name === area.parent));
        areaView.innerHTML = `
          <section class="area-card">
            <h2>Organigrama de áreas</h2>
            <p>Vista jerárquica con líneas y niveles.</p>
            <div class="org-root org-level">Nivel 1: ${escapeHtml(root.name)} (${escapeHtml(root.code)})</div>
            <div><strong>Nivel 2</strong>: ${firstLevel.map((a) => escapeHtml(a.name)).join(', ') || 'Sin áreas'}</div>
            <div style="margin-top:6px;"><strong>Nivel 3</strong>: ${secondLevel.map((a) => escapeHtml(a.name)).join(', ') || 'Sin áreas'}</div>
          </section>
        `;
      };

      const setAreaView = (view) => {
        areaTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.view === view));
        switch (view) {
          case 'list':
            renderAreaList();
            break;
          case 'kanban':
            renderAreaKanban();
            break;
          case 'organigrama':
            renderAreaOrganigrama();
            break;
          default:
            renderAreaForm();
            break;
        }
      };

      areaTabs.forEach((tab) => {
        tab.addEventListener('click', () => setAreaView(tab.dataset.view));
      });

      document.addEventListener('backend-view-change', (event) => {
        const rawView = String(event.detail?.view || '').trim().toLowerCase();
        if (!rawView) return;
        if (rawView === 'graph' || rawView === 'grafica') {
          setAreaView('organigrama');
          return;
        }
        if (rawView === 'form' || rawView === 'list' || rawView === 'kanban' || rawView === 'organigrama') {
          setAreaView(rawView);
        }
      });

      loadAreasData().then(() => setAreaView('form'));
    })();
  </script>
</section>

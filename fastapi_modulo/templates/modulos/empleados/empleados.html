<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Colaboradores</title>
    <style>
        #empleados-module {
            display: grid;
            gap: 14px;
        }
        .emp-card { 
            background: #fff; 
            border: 1px solid #dbe3ef; 
            border-radius: 14px; 
            padding: 14px; 
        }
        .emp-head { 
            margin: 0 0 10px; 
            font-size: 1.02rem; 
            color: #0f172a; 
        }
        .emp-table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1px solid rgba(15,23,42,.16); 
            border-radius: 12px; 
            overflow: hidden; 
            background: #fff; 
        }
        .emp-table th { 
            text-align: left; 
            font-size: 12px; 
            letter-spacing: .06em; 
            text-transform: uppercase; 
            color: rgba(15,23,42,.82); 
            background: linear-gradient(180deg, rgba(239,246,255,.96), rgba(219,234,254,.90)); 
            border: 1px solid rgba(15,23,42,.14); 
            padding: 10px 12px; 
            white-space: nowrap; 
        }
        .emp-table td { 
            border: 1px solid rgba(15,23,42,.10); 
            padding: 10px 12px; 
            color: #0f172a; 
            background: #fff; 
        }
        .emp-list-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .emp-list-btn {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #ffffff;
            color: #0f172a;
            padding: 4px;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .emp-list-btn img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            display: block;
        }
        .emp-list-btn.delete {
            border-color: #ef4444;
            color: #ef4444;
        }
        .emp-table tbody tr:nth-child(even) td { 
            background: #f3f4f6; 
        }
        .emp-empty { 
            color: #64748b; 
        }
        .view-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .view-pill {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            background: #fff;
            cursor: pointer;
        }
        .view-pill.active {
            background: #0f172a;
            color: #fff;
            border-color: #0f172a;
        }
        .field {
            display: grid;
            gap: 4px;
            margin-bottom: 10px;
        }
        .field input, .field select {
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        .emp-form-shell {
            display: grid;
            gap: 14px;
            max-width: 980px;
        }
        .emp-form-header {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 180px;
            gap: 16px;
            align-items: start;
        }
        .emp-form-header-left {
            display: grid;
            gap: 10px;
        }
        .emp-photo-box {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 16%, #ffffff 84%);
            border-radius: 14px;
            background: var(--field-color, #ffffff);
            min-height: 170px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sidebar-bottom, #0f172a);
            font-weight: 700;
            font-size: 2rem;
            overflow: hidden;
            position: relative;
        }
        .emp-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .emp-photo-action {
            position: absolute;
            bottom: 8px;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 24%, #ffffff 76%);
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }
        .emp-photo-action img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }
        .emp-photo-action.edit {
            left: 8px;
        }
        .emp-photo-action.delete {
            right: 8px;
        }
        .emp-form-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .emp-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .emp-field label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--sidebar-bottom, #0f172a);
        }
        .emp-field input,
        .emp-field select,
        .emp-field textarea {
            width: 100%;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
            border-radius: 10px;
            padding: 10px;
            color: var(--navbar-text, #1f172a);
            background: var(--field-color, #ffffff);
            font-size: 0.95rem;
        }
        @media (max-width: 900px) {
            .emp-form-header {
                grid-template-columns: 1fr;
            }
            .emp-form-grid {
                grid-template-columns: 1fr;
            }
        }
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }
        .btn.primary {
            background: #0f172a;
            color: #fff;
            border-color: #0f172a;
        }
        .emp-notebook {
            margin-top: 8px;
            border: 1px solid color-mix(in srgb, var(--sidebar-bottom, #0f172a) 16%, #ffffff 84%);
            border-radius: 12px;
            background: #ffffff;
            overflow: hidden;
        }
        .emp-notebook-tabs {
            display: flex;
            align-items: center;
            gap: 2px;
            border-bottom: 1px solid color-mix(in srgb, var(--sidebar-bottom, #0f172a) 28%, #ffffff 72%);
            background: #ffffff;
        }
        .emp-notebook-tab {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 0;
            background: transparent;
            color: #1f2937;
            font-weight: 600;
            font-size: 1rem;
            padding: 12px 16px 14px;
            cursor: pointer;
        }
        .emp-notebook-tab::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 4px;
            background: transparent;
            transition: background 0.18s ease;
        }
        .emp-notebook-tab.active {
            color: var(--sidebar-bottom, #0f172a);
            background: transparent;
        }
        .emp-notebook-tab.active::after {
            background: var(--sidebar-bottom, #0f172a);
        }
        .emp-notebook-tab .tab-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            flex: 0 0 auto;
        }
        .emp-notebook-panel {
            min-height: 180px;
            padding: 14px 16px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            text-align: center;
        }
        .emp-kanban-board {
            display: grid;
            gap: 12px;
        }
        .emp-kanban-card {
            position: relative;
            display: grid;
            grid-template-columns: 150px minmax(0, 1fr);
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            background: #f8fafc;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }
        .emp-kanban-status-dot {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: #f59e0b;
        }
        .emp-kanban-status-dot.activo { background: #22c55e; }
        .emp-kanban-status-dot.inactivo { background: #ef4444; }
        .emp-kanban-status-dot.pendiente { background: #f59e0b; }
        .emp-kanban-avatar {
            background: color-mix(in srgb, var(--sidebar-bottom, #0f172a) 78%, #34d399 22%);
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            overflow: hidden;
        }
        .emp-kanban-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .emp-kanban-body {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .emp-kanban-name {
            margin: 0;
            font-size: 1.08rem;
            line-height: 1.2;
            color: #3f4852;
            font-weight: 700;
            max-width: calc(100% - 40px);
        }
        .emp-kanban-puesto {
            margin: 0;
            font-size: 0.96rem;
            line-height: 1.3;
            color: #46505a;
            font-weight: 500;
        }
        .emp-kanban-email {
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #46505a;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .emp-kanban-email a {
            color: inherit;
            text-decoration: none;
        }
        .emp-kanban-email a:hover {
            text-decoration: underline;
        }
        .emp-kanban-mail-icon {
            width: 22px;
            height: 22px;
            border-radius: 8px;
            background: #2f3f4e;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 0.85rem;
            line-height: 1;
            flex: 0 0 auto;
        }
        .emp-kanban-actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 14px;
        }
        .emp-kanban-action {
            border: 0;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .emp-kanban-action.main {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #42a37f;
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 700;
        }
        .emp-kanban-action.clock {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #9ca3af;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 1200px) {
            .emp-kanban-card {
                grid-template-columns: 130px minmax(0, 1fr);
            }
            .emp-kanban-name { font-size: 1.02rem; }
            .emp-kanban-puesto { font-size: 0.9rem; }
            .emp-kanban-email { font-size: 0.84rem; }
        }
        @media (max-width: 760px) {
            .emp-kanban-card {
                grid-template-columns: 1fr;
            }
            .emp-kanban-avatar {
                min-height: 120px;
                font-size: 3rem;
            }
            .emp-kanban-name {
                font-size: 1.38rem;
                max-width: 100%;
            }
            .emp-kanban-puesto {
                font-size: 1.06rem;
            }
            .emp-kanban-email {
                font-size: 0.95rem;
            }
            .emp-kanban-mail-icon {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <section id="empleados-module">
        <!-- Botones de vista eliminados para evitar duplicación -->
        
        <article class="emp-card">
            <h3 class="emp-head">Colaboradores</h3>
            <table class="emp-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Usuario</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Departamento</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="empleados-tbody">
                    <tr><td colspan="7" class="emp-empty">Cargando...</td></tr>
                </tbody>
            </table>
        </article>
    </section>

    <script>
    (function() {
        // Obtener elementos
        var tbody = document.getElementById('empleados-tbody');
        var viewButtons = document.querySelectorAll('.view-pill[data-view]');
        var empCard = document.querySelector('.emp-card');
        
        if (!tbody || !viewButtons.length || !empCard) return;
        
        var empleadosData = [];
        var viewerCanViewAll = false;
        var viewerCanManageAccess = false;
        var viewerAssignableRoles = [];
        var currentAccessState = { rol: 'usuario', menu_blocks: [] };
        
        // Función para escapar caracteres HTML
        function esc(v) {
            if (v === null || v === undefined) return '';
            return String(v)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        function initialsFrom(name) {
            var parts = String(name || '').trim().split(/\s+/).filter(Boolean);
            if (!parts.length) return 'U';
            if (parts.length === 1) return parts[0].slice(0, 1).toUpperCase();
            return (parts[0].slice(0, 1) + parts[1].slice(0, 1)).toUpperCase();
        }
        function estadoClassName(estado) {
            var key = String(estado || 'pendiente').trim().toLowerCase();
            if (key === 'activo') return 'activo';
            if (key === 'inactivo') return 'inactivo';
            return 'pendiente';
        }
        function detectMenuBlocks() {
            var nodes = document.querySelectorAll('.sidebar-menu > details > summary .sidebar-item-label, .sidebar-menu > .sidebar-link .sidebar-item-label');
            var labels = [];
            for (var i = 0; i < nodes.length; i++) {
                var txt = (nodes[i].textContent || '').trim();
                if (txt && labels.indexOf(txt) === -1) labels.push(txt);
            }
            return labels;
        }
        function labelFromRole(role) {
            var normalized = String(role || '').trim().toLowerCase();
            if (normalized === 'superadministrador') return 'Superadministrador';
            if (normalized === 'administrador') return 'Administrador';
            if (normalized === 'autoridades') return 'Autoridades';
            if (normalized === 'departamento') return 'Departamento';
            return 'Usuario';
        }
        function renderNotebookPanel(tabName, panel) {
            if (!panel) return;
            if (tabName === 'cv' || tabName === 'habilidades') {
                panel.textContent = 'Sin acceso';
                return;
            }
            if (!viewerCanManageAccess) {
                panel.textContent = 'Sin acceso';
                return;
            }
            var menuBlocks = detectMenuBlocks();
            var roleChoices = [];
            for (var r = 0; r < viewerAssignableRoles.length; r++) {
                roleChoices.push(
                    '<label style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">' +
                        '<input type="radio" name="colab-role" value="' + esc(viewerAssignableRoles[r]) + '">' +
                        esc(labelFromRole(viewerAssignableRoles[r])) +
                    '</label>'
                );
            }
            if (!roleChoices.length) {
                roleChoices.push('<span class="emp-empty">Sin roles asignables</span>');
            }
            panel.innerHTML =
                '<div style="width:100%;display:grid;gap:14px;align-items:start;">' +
                    '<div style="display:grid;gap:8px;">' +
                        '<strong>Roles</strong>' +
                        '<div style="display:flex;flex-wrap:wrap;gap:12px;">' + roleChoices.join('') + '</div>' +
                    '</div>' +
                    '<div style="display:grid;gap:8px;">' +
                        '<strong>Bloques del menú</strong>' +
                        '<div style="display:grid;gap:6px;">' +
                            menuBlocks.map(function(block) {
                                return '<label style="display:inline-flex;align-items:center;gap:8px;font-weight:500;">' +
                                    '<input type="checkbox" name="colab-menu-block" value="' + esc(block) + '">' +
                                    esc(block) +
                                '</label>';
                            }).join('') +
                        '</div>' +
                    '</div>' +
                '</div>';
            var roleInputs = panel.querySelectorAll('input[name="colab-role"]');
            for (var i = 0; i < roleInputs.length; i++) {
                if (roleInputs[i].value === (currentAccessState.rol || 'usuario')) {
                    roleInputs[i].checked = true;
                }
                roleInputs[i].addEventListener('change', function() {
                    if (this.checked) currentAccessState.rol = this.value;
                });
            }
            var blockInputs = panel.querySelectorAll('input[name="colab-menu-block"]');
            for (var j = 0; j < blockInputs.length; j++) {
                if ((currentAccessState.menu_blocks || []).indexOf(blockInputs[j].value) !== -1) {
                    blockInputs[j].checked = true;
                }
                blockInputs[j].addEventListener('change', function() {
                    var value = this.value;
                    var list = Array.isArray(currentAccessState.menu_blocks) ? currentAccessState.menu_blocks : [];
                    var idx = list.indexOf(value);
                    if (this.checked && idx === -1) list.push(value);
                    if (!this.checked && idx !== -1) list.splice(idx, 1);
                    currentAccessState.menu_blocks = list;
                });
            }
        }
        function fillFormWithColaborador(user) {
            if (!user) return;
            var nombre = document.getElementById('colab-nombre');
            var puesto = document.getElementById('colab-puesto');
            var celular = document.getElementById('colab-celular');
            var usuario = document.getElementById('colab-usuario');
            var correo = document.getElementById('colab-correo');
            var nivel = document.getElementById('colab-nivel');
            var dept = document.getElementById('departamento-select');
            var colabId = document.getElementById('colab-id');
            var foto = document.getElementById('colab-photo-preview');
            var fotoUrl = document.getElementById('colab-imagen-url');
            var colaboradorCheck = document.getElementById('colab-colaborador-check');
            var notebookPanel = document.getElementById('colaborador-notebook-panel');
            if (nombre) nombre.value = user.nombre || '';
            if (puesto) puesto.value = user.puesto || '';
            if (celular) celular.value = user.celular || '';
            if (usuario) usuario.value = user.usuario || '';
            if (correo) correo.value = user.correo || '';
            if (colabId) colabId.value = user.id || '';
            if (nivel) nivel.value = user.nivel_organizacional || '';
            if (colaboradorCheck) colaboradorCheck.checked = !!user.colaborador;
            if (fotoUrl) fotoUrl.value = user.imagen || '';
            if (foto) foto.src = user.imagen || '/icon/usuario.png';
            currentAccessState = {
                rol: String(user.rol || 'usuario').trim().toLowerCase() || 'usuario',
                menu_blocks: Array.isArray(user.menu_blocks) ? user.menu_blocks.slice() : [],
            };
            if (dept) {
                var deptValue = user.departamento || '';
                if (deptValue && !Array.from(dept.options).some(function(opt) { return opt.value === deptValue; })) {
                    var opt = document.createElement('option');
                    opt.value = deptValue;
                    opt.textContent = deptValue;
                    dept.appendChild(opt);
                }
                dept.value = deptValue;
            }
            var activeTab = document.querySelector('.emp-notebook-tab.active');
            renderNotebookPanel(activeTab ? activeTab.getAttribute('data-tab') : 'cv', notebookPanel);
        }
        function openColaboradorFromKanban(index) {
            var pos = Number(index);
            if (Number.isNaN(pos) || pos < 0 || pos >= empleadosData.length) return;
            var user = empleadosData[pos];
            setView('form');
            setTimeout(function() { fillFormWithColaborador(user); }, 80);
        }
        
        // Renderizar vista de lista
        function renderList(rows) {
            var listBody = document.getElementById('empleados-tbody') || tbody;
            if (!listBody) return;
            if (!rows || !rows.length) {
                listBody.innerHTML = '<tr><td colspan="7" class="emp-empty">Sin registros.</td></tr>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < rows.length; i++) {
                var u = rows[i];
                html += '<tr>' +
                    '<td>' + esc(u.nombre) + '</td>' +
                    '<td>' + esc(u.usuario) + '</td>' +
                    '<td>' + esc(u.correo) + '</td>' +
                    '<td>' + esc(u.rol) + '</td>' +
                    '<td>' + esc(u.departamento) + '</td>' +
                    '<td>' + esc(u.estado) + '</td>' +
                    '<td>' +
                        '<div class="emp-list-actions">' +
                            '<button type="button" class="emp-list-btn" data-list-action="edit" data-index="' + i + '" title="Editar">' +
                                '<img src="/icon/editar.svg" alt="Editar">' +
                            '</button>' +
                            (viewerCanViewAll
                                ? '<button type="button" class="emp-list-btn delete" data-list-action="delete" data-index="' + i + '" title="Eliminar">' +
                                    '<img src="/icon/eliminar.svg" alt="Eliminar">' +
                                  '</button>'
                                : ''
                            ) +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }
            listBody.innerHTML = html;
            listBody.querySelectorAll('button[data-list-action="edit"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    if (Number.isNaN(idx) || idx < 0 || idx >= empleadosData.length) return;
                    setView('form');
                    setTimeout(function() { fillFormWithColaborador(empleadosData[idx]); }, 80);
                });
            });
            listBody.querySelectorAll('button[data-list-action="delete"]').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    var user = (!Number.isNaN(idx) && idx >= 0 && idx < empleadosData.length) ? empleadosData[idx] : null;
                    if (!user || !user.id) return;
                    if (!confirm('¿Eliminar colaborador "' + (user.nombre || user.usuario || 'seleccionado') + '"?')) return;
                    try {
                        var res = await fetch('/api/colaboradores/' + encodeURIComponent(String(user.id)), { method: 'DELETE' });
                        var json = await res.json().catch(function() { return {}; });
                        if (!res.ok || json?.success === false) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo eliminar');
                        }
                        await load();
                    } catch (err) {
                        alert((err && err.message) ? err.message : 'Error al eliminar.');
                    }
                });
            });
        }
        
        // Renderizar vista de formulario
        function renderForm() {
            empCard.innerHTML = `
                <h3 class="emp-head">Agregar colaborador</h3>
                <form id="colaborador-form" class="emp-form-shell">
                    <section class="emp-form-header">
                        <div class="emp-form-header-left">
                            <div class="emp-field">
                                <label for="colab-nombre">Nombre</label>
                                <input id="colab-nombre" type="text" name="nombre" required>
                            </div>
                            <div class="emp-field">
                                <label for="colab-puesto">Puesto</label>
                                <input id="colab-puesto" type="text" name="puesto">
                            </div>
                            <div class="emp-field">
                                <label for="colab-celular">Celular</label>
                                <input id="colab-celular" type="text" name="celular">
                            </div>
                        </div>
                        <div class="emp-photo-box" aria-label="Foto del colaborador">
                            <img id="colab-photo-preview" src="/icon/usuario.png" alt="Foto colaborador">
                            <button type="button" class="emp-photo-action edit" id="colab-photo-edit-btn" title="Editar foto">
                                <img src="/icon/editar.svg" alt="Editar">
                            </button>
                            <button type="button" class="emp-photo-action delete" id="colab-photo-delete-btn" title="Eliminar foto">
                                <img src="/icon/eliminar.svg" alt="Eliminar">
                            </button>
                            <input type="file" id="colab-photo-input" accept="image/*" style="display:none;">
                            <input type="hidden" id="colab-imagen-url" name="imagen" value="">
                        </div>
                    </section>
                    <section class="emp-form-grid">
                        <div class="emp-field">
                            <label for="colab-usuario">Usuario</label>
                            <input id="colab-usuario" type="text" name="usuario" required>
                            <input id="colab-id" type="hidden" name="id" value="">
                        </div>
                        <div class="emp-field">
                            <label for="colab-correo">Correo electrónico</label>
                            <input id="colab-correo" type="text" name="correo">
                        </div>
                        <div class="emp-field">
                            <label for="departamento-select">Área organizacional</label>
                            <select name="departamento" id="departamento-select"></select>
                        </div>
                        <div class="emp-field">
                            <label for="colab-nivel">Nivel organizacional</label>
                            <select id="colab-nivel" name="nivel_organizacional">
                                <option value="">Seleccione nivel</option>
                                <option value="Direccion">Dirección</option>
                                <option value="Gerencia">Gerencia</option>
                                <option value="Jefatura">Jefatura</option>
                                <option value="Coordinacion">Coordinación</option>
                                <option value="Staff">Staff</option>
                            </select>
                        </div>
                        <div class="emp-field">
                            <label for="colab-colaborador-check">Colaborador</label>
                            <label style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">
                                <input id="colab-colaborador-check" type="checkbox" name="colaborador" style="width:auto;">
                                Mostrar en organigrama
                            </label>
                        </div>
                    </section>
                    <div class="emp-notebook" id="colaborador-notebook">
                        <div class="emp-notebook-tabs">
                            <button type="button" class="emp-notebook-tab active" data-tab="cv"><img src="/templates/icon/cv.svg" alt="" class="tab-icon">CV</button>
                            <button type="button" class="emp-notebook-tab" data-tab="habilidades"><img src="/templates/icon/habilidades.svg" alt="" class="tab-icon">Habilidades</button>
                            ${viewerCanManageAccess ? '<button type="button" class="emp-notebook-tab" data-tab="acceso"><img src="/templates/icon/acceso.svg" alt="" class="tab-icon">Acceso</button>' : ''}
                        </div>
                        <div class="emp-notebook-panel" id="colaborador-notebook-panel">Sin acceso</div>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn" onclick="window.nuevoColaborador()">Nuevo</button>
                        <button type="button" class="btn" onclick="window.editarColaborador()">Editar</button>
                        <button type="button" class="btn" onclick="window.eliminarColaborador()">Eliminar</button>
                        <button type="submit" class="btn primary">Guardar</button>
                        <span id="colaborador-form-msg" class="emp-empty"></span>
                    </div>
                </form>
            `;
            
            var form = document.getElementById('colaborador-form');
            var deptSelect = document.getElementById('departamento-select');
            var formMsg = document.getElementById('colaborador-form-msg');
            var photoPreview = document.getElementById('colab-photo-preview');
            var photoEditBtn = document.getElementById('colab-photo-edit-btn');
            var photoDeleteBtn = document.getElementById('colab-photo-delete-btn');
            var photoInput = document.getElementById('colab-photo-input');
            var imagenInput = document.getElementById('colab-imagen-url');
            var notebookTabs = empCard.querySelectorAll('.emp-notebook-tab');
            var notebookPanel = document.getElementById('colaborador-notebook-panel');
            currentAccessState = { rol: 'usuario', menu_blocks: [] };
            if (notebookTabs.length && notebookPanel) {
                for (var t = 0; t < notebookTabs.length; t++) {
                    notebookTabs[t].addEventListener('click', function() {
                        for (var j = 0; j < notebookTabs.length; j++) {
                            notebookTabs[j].classList.remove('active');
                        }
                        this.classList.add('active');
                        renderNotebookPanel(this.getAttribute('data-tab'), notebookPanel);
                    });
                }
                renderNotebookPanel('cv', notebookPanel);
            }
            // Cargar departamentos y llenar el select
            if (deptSelect) {
                fetch('/api/inicio/departamentos').then(r => r.json()).then(json => {
                    if (json && Array.isArray(json.data)) {
                        deptSelect.innerHTML = '<option value="">Seleccione</option>' +
                            json.data.map(function(dep) {
                                return '<option value="' + (dep.name || dep.code || '') + '">' + (dep.name || dep.code || '') + '</option>';
                            }).join('');
                    } else {
                        deptSelect.innerHTML = '<option value="">Sin departamentos</option>';
                    }
                }).catch(() => {
                    deptSelect.innerHTML = '<option value="">Error al cargar</option>';
                });
            }
            if (photoEditBtn && photoInput) {
                photoEditBtn.addEventListener('click', function() {
                    photoInput.click();
                });
            }
            if (photoDeleteBtn && photoPreview && imagenInput) {
                photoDeleteBtn.addEventListener('click', function() {
                    photoPreview.src = '/icon/usuario.png';
                    imagenInput.value = '';
                    if (formMsg) formMsg.textContent = 'Foto eliminada.';
                });
            }
            if (photoInput && photoPreview && imagenInput) {
                photoInput.addEventListener('change', async function() {
                    if (!photoInput.files || !photoInput.files.length) return;
                    var file = photoInput.files[0];
                    var fd = new FormData();
                    fd.append('file', file);
                    if (formMsg) formMsg.textContent = 'Subiendo foto...';
                    try {
                        var res = await fetch('/api/colaboradores/foto', { method: 'POST', body: fd });
                        var json = await res.json().catch(function() { return {}; });
                        if (!res.ok || json?.success === false || !json?.url) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo subir la foto');
                        }
                        photoPreview.src = json.url;
                        imagenInput.value = json.url;
                        if (formMsg) formMsg.textContent = 'Foto cargada.';
                    } catch (err) {
                        if (formMsg) formMsg.textContent = (err && err.message) ? err.message : 'Error al subir foto.';
                    }
                });
            }
            if (form) {
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    var payload = {
                        id: (document.getElementById('colab-id')?.value || '').trim(),
                        nombre: (document.getElementById('colab-nombre')?.value || '').trim(),
                        puesto: (document.getElementById('colab-puesto')?.value || '').trim(),
                        celular: (document.getElementById('colab-celular')?.value || '').trim(),
                        usuario: (document.getElementById('colab-usuario')?.value || '').trim(),
                        correo: (document.getElementById('colab-correo')?.value || '').trim(),
                        departamento: (document.getElementById('departamento-select')?.value || '').trim(),
                        nivel_organizacional: (document.getElementById('colab-nivel')?.value || '').trim(),
                        imagen: (document.getElementById('colab-imagen-url')?.value || '').trim(),
                        colaborador: !!document.getElementById('colab-colaborador-check')?.checked,
                        rol: (currentAccessState.rol || 'usuario'),
                        menu_blocks: Array.isArray(currentAccessState.menu_blocks) ? currentAccessState.menu_blocks : []
                    };
                    if (!payload.nombre || !payload.usuario) {
                        if (formMsg) formMsg.textContent = 'Nombre y usuario son obligatorios.';
                        return;
                    }
                    if (formMsg) formMsg.textContent = 'Guardando...';
                    try {
                        var res = await fetch('/api/colaboradores', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        var json = await res.json().catch(function() { return {}; });

                        if ((res.status === 404 || res.status === 405)) {
                            // Fallback para entornos con endpoint legacy de usuarios.
                            res = await fetch('/api/usuarios/registro-seguro', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    nombre: payload.nombre,
                                    usuario: payload.usuario,
                                    correo: payload.correo,
                                    imagen: payload.imagen,
                                    rol: 'usuario',
                                    contrasena: 'Temp1234!'
                                })
                            });
                            json = await res.json().catch(function() { return {}; });
                        }

                        if (!res.ok || json?.success === false) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo guardar');
                        }
                        if (formMsg) formMsg.textContent = 'Guardado correctamente.';
                        await load();
                        setView('form');
                    } catch (err) {
                        if (formMsg) formMsg.textContent = (err && err.message) ? err.message : 'Error al guardar.';
                    }
                };
            }
        }
        
        // Renderizar vista kanban
        function renderKanban() {
            var kanbanHtml = '<h3 class="emp-head">Kanban de colaboradores</h3>';
            if (!empleadosData.length) {
                empCard.innerHTML = kanbanHtml + '<p class="emp-empty">Sin colaboradores.</p>';
                return;
            }
            kanbanHtml += '<div class="emp-kanban-board">';
            for (var i = 0; i < empleadosData.length; i++) {
                var u = empleadosData[i];
                var nombre = esc(u.nombre || 'Sin nombre');
                var puesto = esc(u.puesto || u.nivel_organizacional || 'Sin puesto');
                var correo = esc(u.correo || 'sin-correo@sipet.local');
                var estadoClass = estadoClassName(u.estado);
                var avatarUrl = String(u.imagen || '').trim();
                var avatarHtml = avatarUrl
                    ? '<img src="' + esc(avatarUrl) + '" alt="' + nombre + '" loading="lazy" onerror="this.parentElement.textContent=\'' + esc(initialsFrom(u.nombre)) + '\'">'
                    : esc(initialsFrom(u.nombre));
                kanbanHtml +=
                    '<article class="emp-kanban-card" data-colab-index="' + i + '">' +
                        '<span class="emp-kanban-status-dot ' + estadoClass + '" aria-hidden="true"></span>' +
                        '<div class="emp-kanban-avatar">' + avatarHtml + '</div>' +
                        '<div class="emp-kanban-body">' +
                            '<h4 class="emp-kanban-name">' + nombre + '</h4>' +
                            '<p class="emp-kanban-puesto">' + puesto + '</p>' +
                            '<div class="emp-kanban-email">' +
                                '<span class="emp-kanban-mail-icon" aria-hidden="true">✉</span>' +
                                '<a href="mailto:' + correo + '">' + correo + '</a>' +
                            '</div>' +
                            '<div class="emp-kanban-actions">' +
                                '<button type="button" class="emp-kanban-action main" data-action="edit" data-index="' + i + '" title="Editar colaborador">' + esc(initialsFrom(u.nombre).slice(0, 1)) + '</button>' +
                                '<button type="button" class="emp-kanban-action clock" data-action="history" data-index="' + i + '" title="Ver actividad">◷</button>' +
                            '</div>' +
                        '</div>' +
                    '</article>';
            }
            kanbanHtml += '</div>';
            empCard.innerHTML = kanbanHtml;
            empCard.querySelectorAll('.emp-kanban-action[data-action="edit"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    openColaboradorFromKanban(btn.getAttribute('data-index'));
                });
            });
            empCard.querySelectorAll('.emp-kanban-action[data-action="history"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    var user = empleadosData[idx] || {};
                    alert('Actividad de ' + (user.nombre || 'colaborador') + ': funcionalidad en construcción.');
                });
            });
        }

        function renderOrganigrama() {
            empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">Cargando...</p>';
            fetch('/api/colaboradores/organigrama')
                .then(function(r) { return r.json().then(function(j){ return { ok: r.ok, j: j }; }); })
                .then(function(res) {
                    if (!res.ok || !res.j || res.j.success === false) throw new Error();
                    var rows = Array.isArray(res.j.data) ? res.j.data : [];
                    if (!rows.length) {
                        empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">Sin colaboradores visibles.</p>';
                        return;
                    }
                    var byBoss = {};
                    var idByKey = {};
                    rows.forEach(function(row) {
                        var keyName = (row.nombre || '').trim().toLowerCase();
                        var keyUser = (row.usuario || '').trim().toLowerCase();
                        if (keyName) idByKey[keyName] = row.id;
                        if (keyUser) idByKey[keyUser] = row.id;
                    });
                    rows.forEach(function(row) {
                        var boss = (row.jefe || '').trim().toLowerCase();
                        var bossId = idByKey[boss] || null;
                        var groupKey = bossId ? String(bossId) : 'root';
                        if (!byBoss[groupKey]) byBoss[groupKey] = [];
                        byBoss[groupKey].push(row);
                    });
                    var roots = byBoss.root || rows.filter(function(row) {
                        var boss = (row.jefe || '').trim().toLowerCase();
                        return !boss || !idByKey[boss];
                    });
                    var renderLevel = function(nodes, depth) {
                        if (!nodes || !nodes.length) return '';
                        return '<div class="org-level" style="margin-top:' + (depth ? '10px' : '0') + ';">' +
                            nodes.map(function(n) {
                                var children = byBoss[String(n.id)] || [];
                                var avatar = esc((n.imagen || '').trim() || '/icon/usuario.png');
                                return '<div class="' + (depth === 0 ? 'org-root' : '') + '">' +
                                    '<div class="org-node">' +
                                        '<div class="org-node-avatar"><img src="' + avatar + '" alt="' + esc(n.nombre || 'Colaborador') + '" loading="lazy" onerror="this.src=\'/icon/usuario.png\'"></div>' +
                                        '<strong>' + esc(n.nombre) + '</strong>' +
                                        '<span>' + esc(n.puesto || n.usuario) + '</span>' +
                                    '</div>' +
                                    (children.length ? '<div class="org-divider"></div>' + renderLevel(children, depth + 1) : '') +
                                '</div>';
                            }).join('') +
                        '</div>';
                    };
                    empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><div class="usuario-organigrama">' + renderLevel(roots, 0) + '</div>';
                })
                .catch(function() {
                    empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">No se pudo cargar organigrama.</p>';
                });
        }
        
        // Cambiar vista
        function setView(view) {
            for (var i = 0; i < viewButtons.length; i++) {
                var btn = viewButtons[i];
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            if (view === 'list') {
                empCard.innerHTML = 
                    '<h3 class="emp-head">Colaboradores</h3>' +
                    '<table class="emp-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th>Nombre</th>' +
                                '<th>Usuario</th>' +
                                '<th>Correo</th>' +
                                '<th>Rol</th>' +
                                '<th>Departamento</th>' +
                                '<th>Estado</th>' +
                                '<th>Acciones</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody id="empleados-tbody"></tbody>' +
                    '</table>';
                tbody = document.getElementById('empleados-tbody');
                renderList(empleadosData);
            } else if (view === 'form') {
                renderForm();
            } else if (view === 'kanban') {
                renderKanban();
            } else if (view === 'organigrama') {
                renderOrganigrama();
            }
        }
        
        // Agregar event listeners a los botones de vista
        for (var i = 0; i < viewButtons.length; i++) {
            var btn = viewButtons[i];
            btn.onclick = (function(v) {
                return function() {
                    setView(v);
                };
            })(btn.getAttribute('data-view'));
        }
        
        // Funciones globales para los botones del formulario
        window.nuevoColaborador = function() {
            var form = document.getElementById('colaborador-form');
            var msg = document.getElementById('colaborador-form-msg');
            if (form) form.reset();
            var idInput = document.getElementById('colab-id');
            var foto = document.getElementById('colab-photo-preview');
            var fotoUrl = document.getElementById('colab-imagen-url');
            if (idInput) idInput.value = '';
            if (fotoUrl) fotoUrl.value = '';
            if (foto) foto.src = '/icon/usuario.png';
            currentAccessState = { rol: 'usuario', menu_blocks: [] };
            var panel = document.getElementById('colaborador-notebook-panel');
            var activeTab = document.querySelector('.emp-notebook-tab.active');
            renderNotebookPanel(activeTab ? activeTab.getAttribute('data-tab') : 'cv', panel);
            if (msg) msg.textContent = 'Formulario limpio.';
        };
        
        window.editarColaborador = function() {
            alert('Funcionalidad de edición no implementada.');
        };

        window.eliminarColaborador = async function() {
            var idInput = document.getElementById('colab-id');
            var msg = document.getElementById('colaborador-form-msg');
            var colabId = (idInput && idInput.value) ? String(idInput.value).trim() : '';
            if (!colabId) {
                if (msg) msg.textContent = 'Selecciona un colaborador para eliminar.';
                return;
            }
            if (!confirm('¿Eliminar este colaborador?')) return;
            if (msg) msg.textContent = 'Eliminando...';
            try {
                var res = await fetch('/api/colaboradores/' + encodeURIComponent(colabId), { method: 'DELETE' });
                var json = await res.json().catch(function() { return {}; });
                if (!res.ok || json?.success === false) {
                    throw new Error((json && (json.error || json.detail)) || 'No se pudo eliminar');
                }
                if (msg) msg.textContent = 'Colaborador eliminado.';
                await load();
                setView('form');
                setTimeout(function() {
                    var form = document.getElementById('colaborador-form');
                    if (form) form.reset();
                    var photo = document.getElementById('colab-photo-preview');
                    if (photo) photo.src = '/icon/usuario.png';
                    var idEl = document.getElementById('colab-id');
                    if (idEl) idEl.value = '';
                }, 80);
            } catch (err) {
                if (msg) msg.textContent = (err && err.message) ? err.message : 'Error al eliminar.';
            }
        };
        
        // Cargar datos
        async function load() {
            try {
                var res = await fetch('/api/colaboradores');
                var json = await res.json();
                if (!res.ok || json?.success === false) throw new Error();
                empleadosData = Array.isArray(json?.data) ? json.data : [];
                viewerCanViewAll = !!json?.can_view_all;
                viewerCanManageAccess = !!json?.can_manage_access;
                viewerAssignableRoles = Array.isArray(json?.assignable_roles) ? json.assignable_roles : [];
                setView('list');
            } catch (e) {
                empCard.innerHTML = '<p class="emp-empty">No se pudo cargar colaboradores.</p>';
            }
        }
        
        load();
    })();
    </script>
</body>
</html>

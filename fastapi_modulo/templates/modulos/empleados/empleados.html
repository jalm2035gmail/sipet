<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Colaboradores</title>
    <style>
        #empleados-module {
            display: grid;
            gap: 14px;
        }
        .emp-card { 
            background: #fff; 
            border: 1px solid #dbe3ef; 
            border-radius: 14px; 
            padding: 14px; 
        }
        .emp-head { 
            margin: 0 0 10px; 
            font-size: 1.02rem; 
            color: #0f172a; 
        }
        .emp-table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1px solid rgba(15,23,42,.16); 
            border-radius: 12px; 
            overflow: hidden; 
            background: #fff; 
        }
        .emp-table th { 
            text-align: left; 
            font-size: 12px; 
            letter-spacing: .06em; 
            text-transform: uppercase; 
            color: rgba(15,23,42,.82); 
            background: linear-gradient(180deg, rgba(239,246,255,.96), rgba(219,234,254,.90)); 
            border: 1px solid rgba(15,23,42,.14); 
            padding: 10px 12px; 
            white-space: nowrap; 
        }
        .emp-table td { 
            border: 1px solid rgba(15,23,42,.10); 
            padding: 10px 12px; 
            color: #0f172a; 
            background: #fff; 
        }
        .emp-list-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .emp-list-btn {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #ffffff;
            color: #0f172a;
            padding: 4px;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .emp-list-btn img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            display: block;
        }
        .emp-list-btn.delete {
            border-color: #ef4444;
            color: #ef4444;
        }
        .emp-table tbody tr:nth-child(even) td { 
            background: #f3f4f6; 
        }
        .emp-empty { 
            color: #64748b; 
        }
        .view-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .view-pill {
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            background: #fff;
            cursor: pointer;
        }
        .view-pill.active {
            background: #0f172a;
            color: #fff;
            border-color: #0f172a;
        }
        .field {
            display: grid;
            gap: 4px;
            margin-bottom: 10px;
        }
        .field input, .field select {
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }
        .emp-form-shell {
            display: grid;
            gap: 14px;
            max-width: 980px;
        }
        .emp-form-header {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 180px;
            gap: 16px;
            align-items: start;
        }
        .emp-form-header-left {
            display: grid;
            gap: 10px;
        }
        .emp-photo-box {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 16%, #ffffff 84%);
            border-radius: 14px;
            background: var(--field-color, #ffffff);
            min-height: 170px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sidebar-bottom, #0f172a);
            font-weight: 700;
            font-size: 2rem;
            overflow: hidden;
            position: relative;
        }
        .emp-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .emp-photo-action {
            position: absolute;
            bottom: 8px;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 24%, #ffffff 76%);
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }
        .emp-photo-action img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }
        .emp-photo-action.edit {
            left: 8px;
        }
        .emp-photo-action.delete {
            right: 8px;
        }
        .emp-form-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .emp-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .emp-field label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--sidebar-bottom, #0f172a);
        }
        .emp-field input,
        .emp-field select,
        .emp-field textarea {
            width: 100%;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
            border-radius: 10px;
            padding: 10px;
            color: var(--navbar-text, #1f172a);
            background: var(--field-color, #ffffff);
            font-size: 0.95rem;
        }
        @media (max-width: 900px) {
            .emp-form-header {
                grid-template-columns: 1fr;
            }
            .emp-form-grid {
                grid-template-columns: 1fr;
            }
        }
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }
        .btn.primary {
            background: #0f172a;
            color: #fff;
            border-color: #0f172a;
        }
        .emp-notebook {
            margin-top: 8px;
            border: 1px solid color-mix(in srgb, var(--sidebar-bottom, #0f172a) 16%, #ffffff 84%);
            border-radius: 12px;
            background: #ffffff;
            overflow: hidden;
        }
        .emp-notebook-tabs {
            display: flex;
            align-items: center;
            gap: 2px;
            border-bottom: 1px solid color-mix(in srgb, var(--sidebar-bottom, #0f172a) 28%, #ffffff 72%);
            background: #ffffff;
        }
        .emp-notebook-tab {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 0;
            background: transparent;
            color: #1f2937;
            font-weight: 600;
            font-size: 1rem;
            padding: 12px 16px 14px;
            cursor: pointer;
        }
        .emp-notebook-tab::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 4px;
            background: transparent;
            transition: background 0.18s ease;
        }
        .emp-notebook-tab.active {
            color: var(--sidebar-bottom, #0f172a);
            background: transparent;
        }
        .emp-notebook-tab.active::after {
            background: var(--sidebar-bottom, #0f172a);
        }
        .emp-notebook-tab .tab-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            flex: 0 0 auto;
        }
        .emp-notebook-panel {
            min-height: 180px;
            padding: 14px 16px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            text-align: center;
        }
        .emp-kanban-board {
            display: grid;
            gap: 12px;
        }
        #empleados-module{
            --bg:#f6f8fb;
            --card:#ffffff;
            --border:#e7edf5;
            --text:#0f172a;
            --muted:#64748b;
            --shadow: 0 14px 32px rgba(15,23,42,.10);
            --radius:16px;
        }
        .oc-card{
            width: 320px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform .18s ease, box-shadow .18s ease;
        }
        .oc-card:hover{
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(15,23,42,.14);
        }
        .oc-top{
            padding: 12px 14px;
            display:flex;
            justify-content:space-between;
            gap:10px;
            background: linear-gradient(180deg,#fff,#fbfdff);
        }
        .oc-name{
            font-weight: 700;
            font-size: 14px;
            letter-spacing: -.01em;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .oc-sub{
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top: 8px;
        }
        .oc-pill{
            font-size: 11px;
            color:#334155;
            background:#f8fafc;
            border:1px solid var(--border);
            border-radius:999px;
            padding: 6px 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .oc-score{
            font-weight: 800;
            font-size: 13px;
            background:#0f172a;
            color:#fff;
            border-radius:12px;
            padding: 8px 10px;
            height: fit-content;
            flex: 0 0 auto;
        }
        .oc-progress{
            height: 10px;
            background:#e2e8f0;
            border-top:1px solid var(--border);
            border-bottom:1px solid var(--border);
        }
        .oc-fill{ height:100%; width:0%; }
        .oc-bottom{
            padding: 12px 14px 14px;
            display:flex;
            justify-content:space-between;
            align-items:flex-end;
            gap: 10px;
        }
        .oc-status{
            font-weight: 800;
            font-size: 12px;
        }
        .oc-card[data-status="ok"] .oc-status{ color:#16a34a; }
        .oc-card[data-status="warning"] .oc-status{ color:#f59e0b; }
        .oc-card[data-status="danger"] .oc-status{ color:#ef4444; }
        .oc-kpis{
            display:flex; gap:10px;
        }
        .oc-kpi span{
            display:block;
            font-size:10px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .oc-kpi strong{
            display:block;
            font-size:13px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .emp-org-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .emp-org-zoom {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .emp-org-zoom button {
            width: 34px;
            height: 34px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            background: #ffffff;
            color: #0f172a;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
        }
        .emp-org-fit {
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            background: #ffffff;
            color: #0f172a;
            font-size: 0.86rem;
            font-weight: 600;
            padding: 8px 12px;
            cursor: pointer;
        }
        .emp-org-chart-wrap {
            min-height: 580px;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            overflow: auto;
            padding: 8px;
        }
        .emp-org-node-layout {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .emp-org-node-avatar {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            overflow: hidden;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f172a;
            font-size: 0.82rem;
            font-weight: 700;
            flex: 0 0 auto;
        }
        .emp-org-node-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .emp-org-node-data {
            min-width: 0;
            display: grid;
            gap: 2px;
        }
        .emp-kanban-card {
            position: relative;
            display: grid;
            grid-template-columns: 150px minmax(0, 1fr);
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            background: #f8fafc;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }
        .emp-kanban-status-dot {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: #f59e0b;
        }
        .emp-kanban-status-dot.activo { background: #22c55e; }
        .emp-kanban-status-dot.inactivo { background: #ef4444; }
        .emp-kanban-status-dot.pendiente { background: #f59e0b; }
        .emp-kanban-avatar {
            background: color-mix(in srgb, var(--sidebar-bottom, #0f172a) 78%, #34d399 22%);
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            overflow: hidden;
        }
        .emp-kanban-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .emp-kanban-body {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .emp-kanban-name {
            margin: 0;
            font-size: 1.08rem;
            line-height: 1.2;
            color: #3f4852;
            font-weight: 700;
            max-width: calc(100% - 40px);
        }
        .emp-kanban-puesto {
            margin: 0;
            font-size: 0.96rem;
            line-height: 1.3;
            color: #46505a;
            font-weight: 500;
        }
        .emp-kanban-email {
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #46505a;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .emp-kanban-email a {
            color: inherit;
            text-decoration: none;
        }
        .emp-kanban-email a:hover {
            text-decoration: underline;
        }
        .emp-kanban-mail-icon {
            width: 22px;
            height: 22px;
            border-radius: 8px;
            background: #2f3f4e;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 0.85rem;
            line-height: 1;
            flex: 0 0 auto;
        }
        .emp-kanban-actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 14px;
        }
        .emp-kanban-action {
            border: 0;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .emp-kanban-action.main {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #42a37f;
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 700;
        }
        .emp-kanban-action.clock {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #9ca3af;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 1200px) {
            .emp-kanban-card {
                grid-template-columns: 130px minmax(0, 1fr);
            }
            .emp-kanban-name { font-size: 1.02rem; }
            .emp-kanban-puesto { font-size: 0.9rem; }
            .emp-kanban-email { font-size: 0.84rem; }
        }
        @media (max-width: 760px) {
            .emp-kanban-card {
                grid-template-columns: 1fr;
            }
            .emp-kanban-avatar {
                min-height: 120px;
                font-size: 3rem;
            }
            .emp-kanban-name {
                font-size: 1.38rem;
                max-width: 100%;
            }
            .emp-kanban-puesto {
                font-size: 1.06rem;
            }
            .emp-kanban-email {
                font-size: 0.95rem;
            }
            .emp-kanban-mail-icon {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <section id="empleados-module">
        <!-- Botones de vista eliminados para evitar duplicación -->
        
        <article class="emp-card">
            <h3 class="emp-head">Colaboradores</h3>
            <table class="emp-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Usuario</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Departamento</th>
                        <th>Org</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="empleados-tbody">
                    <tr><td colspan="8" class="emp-empty">Cargando...</td></tr>
                </tbody>
            </table>
        </article>
    </section>

    <script>
    (function() {
        // Obtener elementos
        var tbody = document.getElementById('empleados-tbody');
        var viewButtons = document.querySelectorAll('.view-pill[data-view]');
        var empCard = document.querySelector('.emp-card');
        
        if (!tbody || !viewButtons.length || !empCard) return;
        
        var empleadosData = [];
        var orgChartInstance = null;
        var orgLibPromise = null;
        var viewerCanViewAll = false;
        var viewerCanManageAccess = false;
        var viewerAssignableRoles = [];
        var currentAccessState = { rol: 'usuario', menu_blocks: [] };
        
        // Función para escapar caracteres HTML
        function esc(v) {
            if (v === null || v === undefined) return '';
            return String(v)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        function initialsFrom(name) {
            var parts = String(name || '').trim().split(/\s+/).filter(Boolean);
            if (!parts.length) return 'U';
            if (parts.length === 1) return parts[0].slice(0, 1).toUpperCase();
            return (parts[0].slice(0, 1) + parts[1].slice(0, 1)).toUpperCase();
        }
        function estadoClassName(estado) {
            var key = String(estado || 'pendiente').trim().toLowerCase();
            if (key === 'activo') return 'activo';
            if (key === 'inactivo') return 'inactivo';
            return 'pendiente';
        }
        function renderJefeOptions(selectEl, selectedId, currentId) {
            if (!selectEl) return;
            var options = ['<option value="">Sin jefe inmediato</option>'];
            for (var i = 0; i < empleadosData.length; i++) {
                var emp = empleadosData[i] || {};
                var id = emp.id;
                if (!id) continue;
                if (currentId && Number(id) === Number(currentId)) continue;
                var selected = (selectedId && Number(id) === Number(selectedId)) ? ' selected' : '';
                options.push('<option value="' + esc(id) + '"' + selected + '>' + esc(emp.nombre || emp.usuario || ('#' + id)) + '</option>');
            }
            selectEl.innerHTML = options.join('');
        }
        function detectMenuBlocks() {
            var nodes = document.querySelectorAll('.sidebar-menu > details > summary .sidebar-item-label, .sidebar-menu > .sidebar-link .sidebar-item-label');
            var labels = [];
            for (var i = 0; i < nodes.length; i++) {
                var txt = (nodes[i].textContent || '').trim();
                if (txt && labels.indexOf(txt) === -1) labels.push(txt);
            }
            return labels;
        }
        function labelFromRole(role) {
            var normalized = String(role || '').trim().toLowerCase();
            if (normalized === 'superadministrador') return 'Superadministrador';
            if (normalized === 'administrador') return 'Administrador';
            if (normalized === 'autoridades') return 'Autoridades';
            if (normalized === 'departamento') return 'Departamento';
            return 'Usuario';
        }
        function renderNotebookPanel(tabName, panel) {
            if (!panel) return;
            if (tabName === 'cv' || tabName === 'habilidades') {
                panel.textContent = 'Sin acceso';
                return;
            }
            if (!viewerCanManageAccess) {
                panel.textContent = 'Sin acceso';
                return;
            }
            var menuBlocks = detectMenuBlocks();
            var roleChoices = [];
            for (var r = 0; r < viewerAssignableRoles.length; r++) {
                roleChoices.push(
                    '<label style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">' +
                        '<input type="radio" name="colab-role" value="' + esc(viewerAssignableRoles[r]) + '">' +
                        esc(labelFromRole(viewerAssignableRoles[r])) +
                    '</label>'
                );
            }
            if (!roleChoices.length) {
                roleChoices.push('<span class="emp-empty">Sin roles asignables</span>');
            }
            panel.innerHTML =
                '<div style="width:100%;display:grid;gap:14px;align-items:start;">' +
                    '<div style="display:grid;gap:8px;">' +
                        '<strong>Roles</strong>' +
                        '<div style="display:flex;flex-wrap:wrap;gap:12px;">' + roleChoices.join('') + '</div>' +
                    '</div>' +
                    '<div style="display:grid;gap:8px;">' +
                        '<strong>Bloques del menú</strong>' +
                        '<div style="display:grid;gap:6px;">' +
                            menuBlocks.map(function(block) {
                                return '<label style="display:inline-flex;align-items:center;gap:8px;font-weight:500;">' +
                                    '<input type="checkbox" name="colab-menu-block" value="' + esc(block) + '">' +
                                    esc(block) +
                                '</label>';
                            }).join('') +
                        '</div>' +
                    '</div>' +
                '</div>';
            var roleInputs = panel.querySelectorAll('input[name="colab-role"]');
            for (var i = 0; i < roleInputs.length; i++) {
                if (roleInputs[i].value === (currentAccessState.rol || 'usuario')) {
                    roleInputs[i].checked = true;
                }
                roleInputs[i].addEventListener('change', function() {
                    if (this.checked) currentAccessState.rol = this.value;
                });
            }
            var blockInputs = panel.querySelectorAll('input[name="colab-menu-block"]');
            for (var j = 0; j < blockInputs.length; j++) {
                if ((currentAccessState.menu_blocks || []).indexOf(blockInputs[j].value) !== -1) {
                    blockInputs[j].checked = true;
                }
                blockInputs[j].addEventListener('change', function() {
                    var value = this.value;
                    var list = Array.isArray(currentAccessState.menu_blocks) ? currentAccessState.menu_blocks : [];
                    var idx = list.indexOf(value);
                    if (this.checked && idx === -1) list.push(value);
                    if (!this.checked && idx !== -1) list.splice(idx, 1);
                    currentAccessState.menu_blocks = list;
                });
            }
        }
        function fillFormWithColaborador(user) {
            if (!user) return;
            var nombre = document.getElementById('colab-nombre');
            var puesto = document.getElementById('colab-puesto');
            var celular = document.getElementById('colab-celular');
            var usuario = document.getElementById('colab-usuario');
            var correo = document.getElementById('colab-correo');
            var nivel = document.getElementById('colab-nivel');
            var dept = document.getElementById('departamento-select');
            var jefeInmediato = document.getElementById('colab-jefe-inmediato');
            var colabId = document.getElementById('colab-id');
            var foto = document.getElementById('colab-photo-preview');
            var fotoUrl = document.getElementById('colab-imagen-url');
            var colaboradorCheck = document.getElementById('colab-colaborador-check');
            var notebookPanel = document.getElementById('colaborador-notebook-panel');
            if (nombre) nombre.value = user.nombre || '';
            if (puesto) puesto.value = user.puesto || '';
            if (celular) celular.value = user.celular || '';
            if (usuario) usuario.value = user.usuario || '';
            if (correo) correo.value = user.correo || '';
            if (colabId) colabId.value = user.id || '';
            if (jefeInmediato) {
                renderJefeOptions(jefeInmediato, user.jefe_inmediato_id || '', user.id || '');
            }
            if (nivel) nivel.value = user.nivel_organizacional || '';
            if (colaboradorCheck) colaboradorCheck.checked = !!user.colaborador;
            if (fotoUrl) fotoUrl.value = user.imagen || '';
            if (foto) foto.src = user.imagen || '/icon/usuario.png';
            currentAccessState = {
                rol: String(user.rol || 'usuario').trim().toLowerCase() || 'usuario',
                menu_blocks: Array.isArray(user.menu_blocks) ? user.menu_blocks.slice() : [],
            };
            if (dept) {
                var deptValue = user.departamento || '';
                if (deptValue && !Array.from(dept.options).some(function(opt) { return opt.value === deptValue; })) {
                    var opt = document.createElement('option');
                    opt.value = deptValue;
                    opt.textContent = deptValue;
                    dept.appendChild(opt);
                }
                dept.value = deptValue;
            }
            var activeTab = document.querySelector('.emp-notebook-tab.active');
            renderNotebookPanel(activeTab ? activeTab.getAttribute('data-tab') : 'cv', notebookPanel);
        }
        function openColaboradorFromKanban(index) {
            var pos = Number(index);
            if (Number.isNaN(pos) || pos < 0 || pos >= empleadosData.length) return;
            var user = empleadosData[pos];
            setView('form');
            setTimeout(function() { fillFormWithColaborador(user); }, 80);
        }
        function openColaboradorFromId(colabId) {
            var numericId = Number(colabId);
            if (!numericId) return;
            var selected = null;
            for (var i = 0; i < empleadosData.length; i++) {
                var row = empleadosData[i] || {};
                if (Number(row.id) === numericId) {
                    selected = row;
                    break;
                }
            }
            if (!selected) return;
            setView('form');
            setTimeout(function() { fillFormWithColaborador(selected); }, 80);
        }
        function normalizeText(value) {
            return String(value || '').trim().toLowerCase();
        }
        function statusFromProgress(progress) {
            var p = Number(progress || 0);
            if (p >= 85) return 'ok';
            if (p >= 60) return 'warning';
            return 'danger';
        }
        function statusLabel(status) {
            if (status === 'danger') return 'Atrasado';
            if (status === 'warning') return 'En riesgo';
            return 'OK';
        }
        function collaboratorProgress(data) {
            var n = Number(data && data.progress);
            if (Number.isFinite(n)) return Math.max(0, Math.min(100, n));
            var estado = normalizeText(data && data.estado);
            if (estado === 'activo') return 90;
            if (estado === 'inactivo') return 30;
            return 60;
        }
        function statusBorderColor(estado) {
            var key = normalizeText(estado);
            if (key === 'inactivo') return '#ef4444';
            if (key === 'pendiente') return '#f59e0b';
            return '#0f766e';
        }
        function loadScript(src) {
            return new Promise(function(resolve, reject) {
                if (document.querySelector('script[src="' + src + '"]')) {
                    resolve();
                    return;
                }
                var script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = function() { resolve(); };
                script.onerror = function() { reject(new Error('No se pudo cargar ' + src)); };
                document.head.appendChild(script);
            });
        }
        async function ensureOrgChartLibrary() {
            if (window.d3 && window.d3.OrgChart) return true;
            if (!orgLibPromise) {
                orgLibPromise = (async function() {
                    try {
                        await loadScript('/static/vendor/d3.min.js');
                        await loadScript('/static/vendor/d3-flextree.min.js');
                        await loadScript('/static/vendor/d3-org-chart.min.js');
                    } catch (_localError) {
                        await loadScript('https://cdn.jsdelivr.net/npm/d3@7');
                        await loadScript('https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js');
                        await loadScript('https://cdn.jsdelivr.net/npm/d3-org-chart@3');
                    }
                })().catch(function() { return false; });
            }
            var result = await orgLibPromise;
            return result !== false && !!(window.d3 && window.d3.OrgChart);
        }
        function buildOrgNodes(rows) {
            var nodes = [];
            var byId = {};
            var idByKey = {};
            for (var i = 0; i < rows.length; i++) {
                var row = rows[i] || {};
                var id = Number(row.id || 0);
                if (!id) continue;
                byId[id] = row;
                var nameKey = normalizeText(row.nombre);
                var userKey = normalizeText(row.usuario);
                if (nameKey) idByKey[nameKey] = id;
                if (userKey) idByKey[userKey] = id;
            }
            for (var j = 0; j < rows.length; j++) {
                var r = rows[j] || {};
                var rowId = Number(r.id || 0);
                if (!rowId) continue;
                var parentId = Number(r.jefe_inmediato_id || 0);
                if (!parentId || !byId[parentId] || parentId === rowId) {
                    var bossKey = normalizeText(r.jefe);
                    parentId = bossKey ? Number(idByKey[bossKey] || 0) : 0;
                }
                if (parentId === rowId || !byId[parentId]) parentId = 0;
                nodes.push({
                    id: String(rowId),
                    parentId: parentId ? String(parentId) : null,
                    nombre: String(r.nombre || '').trim(),
                    usuario: String(r.usuario || '').trim(),
                    puesto: String(r.puesto || '').trim(),
                    departamento: String(r.departamento || '').trim(),
                    imagen: String(r.imagen || '').trim(),
                    estado: String(r.estado || 'Activo').trim()
                });
            }
            var roots = nodes.filter(function(node) { return !node.parentId; });
            if (roots.length > 1) {
                var virtualRootId = '__root__colaboradores__';
                for (var k = 0; k < roots.length; k++) {
                    roots[k].parentId = virtualRootId;
                }
                nodes.unshift({
                    id: virtualRootId,
                    parentId: null,
                    nombre: 'Colaboradores',
                    usuario: '',
                    puesto: '',
                    departamento: '',
                    imagen: '/icon/usuario.png',
                    estado: 'Activo'
                });
            }
            return nodes;
        }
        function bindOrgToolbar(toolbarEl) {
            if (!toolbarEl || !orgChartInstance) return;
            var zoomInBtn = toolbarEl.querySelector('[data-org-zoom="in"]');
            var zoomOutBtn = toolbarEl.querySelector('[data-org-zoom="out"]');
            var fitBtn = toolbarEl.querySelector('[data-org-zoom="fit"]');
            var expandBtn = toolbarEl.querySelector('[data-org-zoom="expand"]');
            var collapseBtn = toolbarEl.querySelector('[data-org-zoom="collapse"]');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', function() {
                    if (orgChartInstance && typeof orgChartInstance.zoomIn === 'function') orgChartInstance.zoomIn();
                });
            }
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', function() {
                    if (orgChartInstance && typeof orgChartInstance.zoomOut === 'function') orgChartInstance.zoomOut();
                });
            }
            if (fitBtn) {
                fitBtn.addEventListener('click', function() {
                    if (orgChartInstance && typeof orgChartInstance.fit === 'function') orgChartInstance.fit();
                });
            }
            if (expandBtn) {
                expandBtn.addEventListener('click', function() {
                    if (orgChartInstance && typeof orgChartInstance.expandAll === 'function') orgChartInstance.expandAll();
                    if (orgChartInstance && typeof orgChartInstance.fit === 'function') orgChartInstance.fit();
                });
            }
            if (collapseBtn) {
                collapseBtn.addEventListener('click', function() {
                    if (orgChartInstance && typeof orgChartInstance.collapseAll === 'function') orgChartInstance.collapseAll();
                    if (orgChartInstance && typeof orgChartInstance.fit === 'function') orgChartInstance.fit();
                });
            }
        }
        
        // Renderizar vista de lista
        function renderList(rows) {
            var listBody = document.getElementById('empleados-tbody') || tbody;
            if (!listBody) return;
            if (!rows || !rows.length) {
                listBody.innerHTML = '<tr><td colspan="8" class="emp-empty">Sin registros.</td></tr>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < rows.length; i++) {
                var u = rows[i];
                html += '<tr>' +
                    '<td>' + esc(u.nombre) + '</td>' +
                    '<td>' + esc(u.usuario) + '</td>' +
                    '<td>' + esc(u.correo) + '</td>' +
                    '<td>' + esc(u.rol) + '</td>' +
                    '<td>' + esc(u.departamento) + '</td>' +
                    '<td style="text-align:center;"><input type="checkbox" disabled ' + (u.colaborador ? 'checked' : '') + ' aria-label="En organigrama"></td>' +
                    '<td>' + esc(u.estado) + '</td>' +
                    '<td>' +
                        '<div class="emp-list-actions">' +
                            '<button type="button" class="emp-list-btn" data-list-action="edit" data-index="' + i + '" title="Editar">' +
                                '<img src="/icon/editar.svg" alt="Editar">' +
                            '</button>' +
                            (viewerCanViewAll
                                ? '<button type="button" class="emp-list-btn delete" data-list-action="delete" data-index="' + i + '" title="Eliminar">' +
                                    '<img src="/icon/eliminar.svg" alt="Eliminar">' +
                                  '</button>'
                                : ''
                            ) +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }
            listBody.innerHTML = html;
            listBody.querySelectorAll('button[data-list-action="edit"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    if (Number.isNaN(idx) || idx < 0 || idx >= empleadosData.length) return;
                    setView('form');
                    setTimeout(function() { fillFormWithColaborador(empleadosData[idx]); }, 80);
                });
            });
            listBody.querySelectorAll('button[data-list-action="delete"]').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    var user = (!Number.isNaN(idx) && idx >= 0 && idx < empleadosData.length) ? empleadosData[idx] : null;
                    if (!user || !user.id) return;
                    if (!confirm('¿Eliminar colaborador "' + (user.nombre || user.usuario || 'seleccionado') + '"?')) return;
                    try {
                        var res = await fetch('/api/colaboradores/' + encodeURIComponent(String(user.id)), { method: 'DELETE' });
                        var json = await res.json().catch(function() { return {}; });
                        if (!res.ok || json?.success === false) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo eliminar');
                        }
                        await load();
                    } catch (err) {
                        alert((err && err.message) ? err.message : 'Error al eliminar.');
                    }
                });
            });
        }
        
        // Renderizar vista de formulario
        function renderForm() {
            empCard.innerHTML = `
                <h3 class="emp-head">Agregar colaborador</h3>
                <form id="colaborador-form" class="emp-form-shell">
                    <section class="emp-form-header">
                        <div class="emp-form-header-left">
                            <div class="emp-field">
                                <label for="colab-nombre">Nombre</label>
                                <input id="colab-nombre" type="text" name="nombre" required>
                            </div>
                            <div class="emp-field">
                                <label for="colab-puesto">Puesto</label>
                                <input id="colab-puesto" type="text" name="puesto">
                            </div>
                            <div class="emp-field">
                                <label for="colab-celular">Celular</label>
                                <input id="colab-celular" type="text" name="celular">
                            </div>
                        </div>
                        <div class="emp-photo-box" aria-label="Foto del colaborador">
                            <img id="colab-photo-preview" src="/icon/usuario.png" alt="Foto colaborador">
                            <button type="button" class="emp-photo-action edit" id="colab-photo-edit-btn" title="Editar foto">
                                <img src="/icon/editar.svg" alt="Editar">
                            </button>
                            <button type="button" class="emp-photo-action delete" id="colab-photo-delete-btn" title="Eliminar foto">
                                <img src="/icon/eliminar.svg" alt="Eliminar">
                            </button>
                            <input type="file" id="colab-photo-input" accept="image/*" style="display:none;">
                            <input type="hidden" id="colab-imagen-url" name="imagen" value="">
                        </div>
                    </section>
                    <section class="emp-form-grid">
                        <div class="emp-field">
                            <label for="colab-usuario">Usuario</label>
                            <input id="colab-usuario" type="text" name="usuario" required>
                            <input id="colab-id" type="hidden" name="id" value="">
                        </div>
                        <div class="emp-field">
                            <label for="colab-correo">Correo electrónico</label>
                            <input id="colab-correo" type="text" name="correo">
                        </div>
                        <div class="emp-field">
                            <label for="departamento-select">Área organizacional</label>
                            <select name="departamento" id="departamento-select"></select>
                        </div>
                        <div class="emp-field">
                            <label for="colab-nivel">Nivel organizacional</label>
                            <select id="colab-nivel" name="nivel_organizacional">
                                <option value="">Seleccione nivel</option>
                                <option value="Direccion">Dirección</option>
                                <option value="Gerencia">Gerencia</option>
                                <option value="Jefatura">Jefatura</option>
                                <option value="Coordinacion">Coordinación</option>
                                <option value="Staff">Staff</option>
                            </select>
                        </div>
                        <div class="emp-field">
                            <label for="colab-jefe-inmediato">Jefe inmediato</label>
                            <select id="colab-jefe-inmediato" name="jefe_inmediato_id"></select>
                        </div>
                        <div class="emp-field">
                            <label for="colab-colaborador-check">Colaborador</label>
                            <label style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">
                                <input id="colab-colaborador-check" type="checkbox" name="colaborador" style="width:auto;">
                                Mostrar en organigrama
                            </label>
                        </div>
                    </section>
                    <div class="emp-notebook" id="colaborador-notebook">
                        <div class="emp-notebook-tabs">
                            <button type="button" class="emp-notebook-tab active" data-tab="cv"><img src="/templates/icon/cv.svg" alt="" class="tab-icon">CV</button>
                            <button type="button" class="emp-notebook-tab" data-tab="habilidades"><img src="/templates/icon/habilidades.svg" alt="" class="tab-icon">Habilidades</button>
                            ${viewerCanManageAccess ? '<button type="button" class="emp-notebook-tab" data-tab="acceso"><img src="/templates/icon/acceso.svg" alt="" class="tab-icon">Acceso</button>' : ''}
                        </div>
                        <div class="emp-notebook-panel" id="colaborador-notebook-panel">Sin acceso</div>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn" onclick="window.nuevoColaborador()">Nuevo</button>
                        <button type="button" class="btn" onclick="window.editarColaborador()">Editar</button>
                        <button type="button" class="btn" onclick="window.eliminarColaborador()">Eliminar</button>
                        <button type="submit" class="btn primary">Guardar</button>
                        <span id="colaborador-form-msg" class="emp-empty"></span>
                    </div>
                </form>
            `;
            
            var form = document.getElementById('colaborador-form');
            var deptSelect = document.getElementById('departamento-select');
            var jefeInmediatoSelect = document.getElementById('colab-jefe-inmediato');
            var formMsg = document.getElementById('colaborador-form-msg');
            var photoPreview = document.getElementById('colab-photo-preview');
            var photoEditBtn = document.getElementById('colab-photo-edit-btn');
            var photoDeleteBtn = document.getElementById('colab-photo-delete-btn');
            var photoInput = document.getElementById('colab-photo-input');
            var imagenInput = document.getElementById('colab-imagen-url');
            var notebookTabs = empCard.querySelectorAll('.emp-notebook-tab');
            var notebookPanel = document.getElementById('colaborador-notebook-panel');
            currentAccessState = { rol: 'usuario', menu_blocks: [] };
            if (notebookTabs.length && notebookPanel) {
                for (var t = 0; t < notebookTabs.length; t++) {
                    notebookTabs[t].addEventListener('click', function() {
                        for (var j = 0; j < notebookTabs.length; j++) {
                            notebookTabs[j].classList.remove('active');
                        }
                        this.classList.add('active');
                        renderNotebookPanel(this.getAttribute('data-tab'), notebookPanel);
                    });
                }
                renderNotebookPanel('cv', notebookPanel);
            }
            // Cargar departamentos y llenar el select
            if (deptSelect) {
                fetch('/api/inicio/departamentos').then(r => r.json()).then(json => {
                    if (json && Array.isArray(json.data)) {
                        deptSelect.innerHTML = '<option value="">Seleccione</option>' +
                            json.data.map(function(dep) {
                                return '<option value="' + (dep.name || dep.code || '') + '">' + (dep.name || dep.code || '') + '</option>';
                            }).join('');
                    } else {
                        deptSelect.innerHTML = '<option value="">Sin departamentos</option>';
                    }
                }).catch(() => {
                    deptSelect.innerHTML = '<option value="">Error al cargar</option>';
                });
            }
            if (jefeInmediatoSelect) {
                renderJefeOptions(jefeInmediatoSelect, '', '');
            }
            if (photoEditBtn && photoInput) {
                photoEditBtn.addEventListener('click', function() {
                    photoInput.click();
                });
            }
            if (photoDeleteBtn && photoPreview && imagenInput) {
                photoDeleteBtn.addEventListener('click', function() {
                    photoPreview.src = '/icon/usuario.png';
                    imagenInput.value = '';
                    if (formMsg) formMsg.textContent = 'Foto eliminada.';
                });
            }
            if (photoInput && photoPreview && imagenInput) {
                photoInput.addEventListener('change', async function() {
                    if (!photoInput.files || !photoInput.files.length) return;
                    var file = photoInput.files[0];
                    var fd = new FormData();
                    fd.append('file', file);
                    if (formMsg) formMsg.textContent = 'Subiendo foto...';
                    try {
                        var res = await fetch('/api/colaboradores/foto', { method: 'POST', body: fd });
                        var json = await res.json().catch(function() { return {}; });
                        if (!res.ok || json?.success === false || !json?.url) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo subir la foto');
                        }
                        photoPreview.src = json.url;
                        imagenInput.value = json.url;
                        if (formMsg) formMsg.textContent = 'Foto cargada.';
                    } catch (err) {
                        if (formMsg) formMsg.textContent = (err && err.message) ? err.message : 'Error al subir foto.';
                    }
                });
            }
            if (form) {
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    var payload = {
                        id: (document.getElementById('colab-id')?.value || '').trim(),
                        nombre: (document.getElementById('colab-nombre')?.value || '').trim(),
                        puesto: (document.getElementById('colab-puesto')?.value || '').trim(),
                        celular: (document.getElementById('colab-celular')?.value || '').trim(),
                        usuario: (document.getElementById('colab-usuario')?.value || '').trim(),
                        correo: (document.getElementById('colab-correo')?.value || '').trim(),
                        departamento: (document.getElementById('departamento-select')?.value || '').trim(),
                        jefe_inmediato_id: (document.getElementById('colab-jefe-inmediato')?.value || '').trim(),
                        nivel_organizacional: (document.getElementById('colab-nivel')?.value || '').trim(),
                        imagen: (document.getElementById('colab-imagen-url')?.value || '').trim(),
                        colaborador: !!document.getElementById('colab-colaborador-check')?.checked,
                        rol: (currentAccessState.rol || 'usuario'),
                        menu_blocks: Array.isArray(currentAccessState.menu_blocks) ? currentAccessState.menu_blocks : []
                    };
                    if (!payload.nombre || !payload.usuario) {
                        if (formMsg) formMsg.textContent = 'Nombre y usuario son obligatorios.';
                        return;
                    }
                    if (formMsg) formMsg.textContent = 'Guardando...';
                    try {
                        var res = await fetch('/api/colaboradores', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        var json = await res.json().catch(function() { return {}; });

                        if ((res.status === 404 || res.status === 405)) {
                            // Fallback para entornos con endpoint legacy de usuarios.
                            res = await fetch('/api/usuarios/registro-seguro', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    nombre: payload.nombre,
                                    usuario: payload.usuario,
                                    correo: payload.correo,
                                    imagen: payload.imagen,
                                    rol: 'usuario',
                                    contrasena: 'Temp1234!'
                                })
                            });
                            json = await res.json().catch(function() { return {}; });
                        }

                        if (!res.ok || json?.success === false) {
                            throw new Error((json && (json.error || json.detail)) || 'No se pudo guardar');
                        }
                        if (formMsg) formMsg.textContent = (json && (json.message || json.detail)) ? (json.message || json.detail) : 'Guardado correctamente.';
                        await load();
                        setView('form');
                    } catch (err) {
                        if (formMsg) formMsg.textContent = (err && err.message) ? err.message : 'Error al guardar.';
                    }
                };
            }
        }
        
        // Renderizar vista kanban
        function renderKanban() {
            var kanbanHtml = '<h3 class="emp-head">Kanban de colaboradores</h3>';
            if (!empleadosData.length) {
                empCard.innerHTML = kanbanHtml + '<p class="emp-empty">Sin colaboradores.</p>';
                return;
            }
            kanbanHtml += '<div class="emp-kanban-board">';
            for (var i = 0; i < empleadosData.length; i++) {
                var u = empleadosData[i];
                var nombre = esc(u.nombre || 'Sin nombre');
                var puesto = esc(u.puesto || u.nivel_organizacional || 'Sin puesto');
                var correo = esc(u.correo || 'sin-correo@sipet.local');
                var estadoClass = estadoClassName(u.estado);
                var avatarUrl = String(u.imagen || '').trim();
                var avatarHtml = avatarUrl
                    ? '<img src="' + esc(avatarUrl) + '" alt="' + nombre + '" loading="lazy" onerror="this.parentElement.textContent=\'' + esc(initialsFrom(u.nombre)) + '\'">'
                    : esc(initialsFrom(u.nombre));
                kanbanHtml +=
                    '<article class="emp-kanban-card" data-colab-index="' + i + '">' +
                        '<span class="emp-kanban-status-dot ' + estadoClass + '" aria-hidden="true"></span>' +
                        '<div class="emp-kanban-avatar">' + avatarHtml + '</div>' +
                        '<div class="emp-kanban-body">' +
                            '<h4 class="emp-kanban-name">' + nombre + '</h4>' +
                            '<p class="emp-kanban-puesto">' + puesto + '</p>' +
                            '<div class="emp-kanban-email">' +
                                '<span class="emp-kanban-mail-icon" aria-hidden="true">✉</span>' +
                                '<a href="mailto:' + correo + '">' + correo + '</a>' +
                            '</div>' +
                            '<div class="emp-kanban-actions">' +
                                '<button type="button" class="emp-kanban-action main" data-action="edit" data-index="' + i + '" title="Editar colaborador">' + esc(initialsFrom(u.nombre).slice(0, 1)) + '</button>' +
                                '<button type="button" class="emp-kanban-action clock" data-action="history" data-index="' + i + '" title="Ver actividad">◷</button>' +
                            '</div>' +
                        '</div>' +
                    '</article>';
            }
            kanbanHtml += '</div>';
            empCard.innerHTML = kanbanHtml;
            empCard.querySelectorAll('.emp-kanban-action[data-action="edit"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    openColaboradorFromKanban(btn.getAttribute('data-index'));
                });
            });
            empCard.querySelectorAll('.emp-kanban-action[data-action="history"]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = Number(btn.getAttribute('data-index'));
                    var user = empleadosData[idx] || {};
                    alert('Actividad de ' + (user.nombre || 'colaborador') + ': funcionalidad en construcción.');
                });
            });
        }

        function renderOrganigrama() {
            empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">Cargando...</p>';
            fetch('/api/colaboradores/organigrama')
                .then(function(r) { return r.json().then(function(j){ return { ok: r.ok, j: j }; }); })
                .then(async function(res) {
                    if (!res.ok || !res.j || res.j.success === false) throw new Error();
                    var rows = Array.isArray(res.j.data) ? res.j.data : [];
                    if (!rows.length) {
                        empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">Sin colaboradores visibles.</p>';
                        return;
                    }
                    var available = await ensureOrgChartLibrary();
                    if (!available) {
                        empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">No se pudo cargar la librería de organigrama.</p>';
                        return;
                    }
                    var nodes = buildOrgNodes(rows);
                    if (!nodes.length) {
                        empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">Sin colaboradores visibles.</p>';
                        return;
                    }
                    empCard.innerHTML =
                        '<h3 class="emp-head">Organigrama de colaboradores</h3>' +
                        '<div class="emp-org-toolbar">' +
                            '<span class="emp-empty">Mismo formato visual de departamentos.</span>' +
                            '<div class="emp-org-zoom">' +
                                '<button type="button" data-org-zoom="expand" title="Expandir todo">▾▾</button>' +
                                '<button type="button" data-org-zoom="collapse" title="Contraer todo">▸▸</button>' +
                                '<button type="button" data-org-zoom="out" title="Alejar">-</button>' +
                                '<button type="button" data-org-zoom="in" title="Acercar">+</button>' +
                                '<button type="button" class="emp-org-fit" data-org-zoom="fit">Ajustar</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="emp-org-chart" class="emp-org-chart-wrap"></div>';
                    var chartEl = empCard.querySelector('#emp-org-chart');
                    orgChartInstance = new window.d3.OrgChart()
                        .container(chartEl)
                        .data(nodes)
                        .nodeWidth(function() { return 340; })
                        .nodeHeight(function() { return 160; })
                        .childrenMargin(function() { return 60; })
                        .compactMarginBetween(function() { return 25; })
                        .compactMarginPair(function() { return 80; })
                        .pagingStep(function() { return 999999; })
                        .minPagingVisibleNodes(function() { return 999999; })
                        .linkYOffset(18)
                        .setActiveNodeCentered(false)
                        .initialExpandLevel(99)
                        .compact(false)
                        .onNodeClick(function(d) {
                            var nodeId = String(d && d.data && d.data.id ? d.data.id : '').trim();
                            if (!nodeId || nodeId === '__root__colaboradores__') return;
                            openColaboradorFromId(nodeId);
                        })
                        .linkUpdate(function() {
                            window.d3.select(this)
                                .attr('stroke-width', 1.1)
                                .attr('stroke', 'rgba(15, 23, 42, 0.35)');
                        })
                        .nodeContent(function(d) {
                            var data = d && d.data ? d.data : {};
                            var name = esc(data.nombre || data.usuario || 'Área / Puesto');
                            var puesto = esc(data.puesto || data.nivel_organizacional || 'Colaborador');
                            var owner = data.jefe ? '<span class="oc-pill">👤 ' + esc(data.jefe) + '</span>' : '';
                            var typeRaw = normalizeText(data.nivel_organizacional || data.rol || '');
                            var typeBadge = typeRaw === 'direccion' ? '🧭 Dirección'
                                : typeRaw === 'jefatura' ? '🛡 Control'
                                : typeRaw === 'coordinacion' ? '⚙ Operación'
                                : typeRaw === 'staff' ? '🏷 Área'
                                : '🏷 Área';
                            var progress = collaboratorProgress(data);
                            var status = String(data.status || '').trim() || statusFromProgress(progress);
                            var kpi1 = '<div class="oc-kpi"><span>Departamento</span><strong>' + esc(data.departamento || 'Sin área') + '</strong></div>';
                            var kpi2 = '<div class="oc-kpi"><span>Usuario</span><strong>' + esc(data.usuario || '-') + '</strong></div>';
                            var grad = status === 'danger'
                                ? 'linear-gradient(90deg,#ef4444,#fb7185)'
                                : status === 'warning'
                                    ? 'linear-gradient(90deg,#f59e0b,#fbbf24)'
                                    : 'linear-gradient(90deg,#16a34a,#22c55e)';
                            return '' +
                                '<div class="oc-card" data-status="' + esc(status) + '">' +
                                    '<div class="oc-top">' +
                                        '<div class="oc-title">' +
                                            '<div class="oc-name">' + name + '</div>' +
                                            '<div class="oc-sub">' +
                                                '<span class="oc-pill">' + typeBadge + '</span>' +
                                                owner +
                                            '</div>' +
                                        '</div>' +
                                        '<div class="oc-score">' + Math.round(progress) + '%</div>' +
                                    '</div>' +
                                    '<div class="oc-progress"><div class="oc-fill" style="width:' + progress + '%; background:' + grad + ';"></div></div>' +
                                    '<div class="oc-bottom">' +
                                        '<div class="oc-status">' + statusLabel(status) + '</div>' +
                                        '<div class="oc-kpis">' + kpi1 + kpi2 + '</div>' +
                                    '</div>' +
                                '</div>';
                        })
                        .render();
                    if (orgChartInstance && typeof orgChartInstance.expandAll === 'function') orgChartInstance.expandAll();
                    bindOrgToolbar(empCard.querySelector('.emp-org-toolbar'));
                    if (orgChartInstance && typeof orgChartInstance.fit === 'function') orgChartInstance.fit();
                })
                .catch(function() {
                    empCard.innerHTML = '<h3 class="emp-head">Organigrama de colaboradores</h3><p class="emp-empty">No se pudo cargar organigrama.</p>';
                });
        }
        
        // Cambiar vista
        function setView(view) {
            for (var i = 0; i < viewButtons.length; i++) {
                var btn = viewButtons[i];
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            if (view === 'list') {
                empCard.innerHTML = 
                    '<h3 class="emp-head">Colaboradores</h3>' +
                    '<table class="emp-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th>Nombre</th>' +
                                '<th>Usuario</th>' +
                                '<th>Correo</th>' +
                                '<th>Rol</th>' +
                                '<th>Departamento</th>' +
                                '<th>Org</th>' +
                                '<th>Estado</th>' +
                                '<th>Acciones</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody id="empleados-tbody"></tbody>' +
                    '</table>';
                tbody = document.getElementById('empleados-tbody');
                renderList(empleadosData);
            } else if (view === 'form') {
                renderForm();
            } else if (view === 'kanban') {
                renderKanban();
            } else if (view === 'organigrama') {
                renderOrganigrama();
            }
        }
        
        // Agregar event listeners a los botones de vista
        for (var i = 0; i < viewButtons.length; i++) {
            var btn = viewButtons[i];
            btn.onclick = (function(v) {
                return function() {
                    setView(v);
                };
            })(btn.getAttribute('data-view'));
        }
        
        // Funciones globales para los botones del formulario
        window.nuevoColaborador = function() {
            var form = document.getElementById('colaborador-form');
            var msg = document.getElementById('colaborador-form-msg');
            if (form) form.reset();
            var idInput = document.getElementById('colab-id');
            var foto = document.getElementById('colab-photo-preview');
            var fotoUrl = document.getElementById('colab-imagen-url');
            if (idInput) idInput.value = '';
            var jefeInmediato = document.getElementById('colab-jefe-inmediato');
            if (jefeInmediato) renderJefeOptions(jefeInmediato, '', '');
            if (fotoUrl) fotoUrl.value = '';
            if (foto) foto.src = '/icon/usuario.png';
            currentAccessState = { rol: 'usuario', menu_blocks: [] };
            var panel = document.getElementById('colaborador-notebook-panel');
            var activeTab = document.querySelector('.emp-notebook-tab.active');
            renderNotebookPanel(activeTab ? activeTab.getAttribute('data-tab') : 'cv', panel);
            if (msg) msg.textContent = 'Formulario limpio.';
        };
        
        window.editarColaborador = function() {
            alert('Funcionalidad de edición no implementada.');
        };

        window.eliminarColaborador = async function() {
            var idInput = document.getElementById('colab-id');
            var msg = document.getElementById('colaborador-form-msg');
            var colabId = (idInput && idInput.value) ? String(idInput.value).trim() : '';
            if (!colabId) {
                if (msg) msg.textContent = 'Selecciona un colaborador para eliminar.';
                return;
            }
            if (!confirm('¿Eliminar este colaborador?')) return;
            if (msg) msg.textContent = 'Eliminando...';
            try {
                var res = await fetch('/api/colaboradores/' + encodeURIComponent(colabId), { method: 'DELETE' });
                var json = await res.json().catch(function() { return {}; });
                if (!res.ok || json?.success === false) {
                    throw new Error((json && (json.error || json.detail)) || 'No se pudo eliminar');
                }
                if (msg) msg.textContent = (json && (json.message || json.detail)) ? (json.message || json.detail) : 'Colaborador eliminado.';
                await load();
                setView('form');
                setTimeout(function() {
                    var form = document.getElementById('colaborador-form');
                    if (form) form.reset();
                    var photo = document.getElementById('colab-photo-preview');
                    if (photo) photo.src = '/icon/usuario.png';
                    var idEl = document.getElementById('colab-id');
                    if (idEl) idEl.value = '';
                }, 80);
            } catch (err) {
                if (msg) msg.textContent = (err && err.message) ? err.message : 'Error al eliminar.';
            }
        };
        
        // Cargar datos
        async function load() {
            try {
                var res = await fetch('/api/colaboradores');
                var json = await res.json();
                if (!res.ok || json?.success === false) throw new Error();
                empleadosData = Array.isArray(json?.data) ? json.data : [];
                viewerCanViewAll = !!json?.can_view_all;
                viewerCanManageAccess = !!json?.can_manage_access;
                viewerAssignableRoles = Array.isArray(json?.assignable_roles) ? json.assignable_roles : [];
                setView('list');
            } catch (e) {
                empCard.innerHTML = '<p class="emp-empty">No se pudo cargar colaboradores.</p>';
            }
        }
        
        load();
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/templates/areas.css">
    <style>
        :root {
            color-scheme: light;
            /* defaults */
            --navbar-bg: #ffffff;
            --navbar-text: #1f172a;
            --sidebar-top: #1f2a3d;
            --sidebar-bottom: #0f172a;
            --sidebar-text: #ffffff;
            --sidebar-icon: #f5f7fb;
            --sidebar-hover: #2a3a52;
            --field-color: #e7d7da;
            --floating-panel-bg: var(--sidebar-text);
            --floating-scale: 0.5;
            --floating-toggle-color: var(--sidebar-bottom);
            --floating-toggle-text-color: var(--sidebar-text);
            --floating-icon-color: var(--sidebar-bottom);
            --floating-action-border: var(--sidebar-bottom);
            --floating-action-text: var(--sidebar-bottom);
            --floating-action-bg: var(--sidebar-text);
            --view-pill-border: var(--sidebar-bottom);
            --view-pill-bg: var(--sidebar-text);
            --view-pill-text: var(--sidebar-bottom);
            --view-pill-icon: var(--sidebar-bottom);
            --view-pill-hover-bg: var(--sidebar-bottom);
            --view-pill-hover-text: var(--sidebar-text);
            --view-pill-hover-icon: var(--sidebar-text);
            --page-bg: #f4f6fb;
            --content-bg: #ffffff;
            --body-text: #0f172a;
            --page-title-color: var(--sidebar-bottom);
            --sidebar-block-title-size: 1.05rem;
            --sidebar-submenu-size: calc(var(--sidebar-block-title-size) * 0.85);
            {% if colores %}
            {% for key, value in colores.items() %}
            --{{ key }}: {{ value }};
            {% endfor %}
            {% endif %}
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--page-bg, #f4f6fb);
            color: var(--body-text, #0f172a);
        }
        .sidebar {
            width: 220px;
            background: linear-gradient(
                180deg,
                var(--sidebar-top, #1f2a3d),
                var(--sidebar-bottom, #0f172a)
            );
            color: var(--sidebar-text, #ffffff);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            box-shadow: 2px 0 12px rgba(15, 23, 42, 0.35);
            z-index: 3;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            background: transparent;
            font-weight: 600;
        }
        .sidebar-user {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 96px;
            height: 96px;
            border-radius: 24px;
            background: var(--sidebar-icon, #ffffff);
            border: 2px solid rgba(255,255,255,0.4);
        }
        .sidebar-user img {
            width: 88px;
            height: 88px;
            border-radius: 20px;
            object-fit: cover;
        }
        .navbar-hamburger {
            font-size: 20px;
            background: none;
            border: none;
            color: #0f172a;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .navbar-hamburger svg {
            stroke: currentColor;
        }
        .navbar-hamburger:hover {
            background: rgba(15, 23, 42, 0.06);
        }
        nav {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.35) transparent;
        }
        .menu-audit-note {
            margin: 12px 16px 16px;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.78rem;
            line-height: 1.35;
        }
        .menu-audit-note strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        nav::-webkit-scrollbar {
            width: 8px;
        }
        nav::-webkit-scrollbar-track {
            background: transparent;
        }
        nav::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 999px;
        }
        nav::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.45);
        }
        nav a,
        .accordion-header,
        .sidebar-section-toggle {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            text-decoration: none;
            color: inherit;
            font-size: var(--sidebar-block-title-size);
            background: none;
            border: none;
            width: 100%;
            cursor: pointer;
            font-family: inherit;
        }
        nav a {
            justify-content: flex-start;
            gap: 12px;
        }
        nav a:hover,
        .accordion-header:hover,
        .sidebar-section-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        .accordion-header {
            justify-content: space-between;
        }
        .accordion,
        .sidebar-section {
            margin-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 4px;
        }
        .accordion-content,
        .sidebar-section-content {
            display: none;
            flex-direction: column;
        }
        .accordion.open .accordion-content {
            display: flex;
        }
        .submenu {
            display: block;
            width: 100%;
            padding: 10px 24px 10px 24px;
            padding-left: 66px;
            font-size: var(--sidebar-submenu-size);
            color: var(--sidebar-text, #d9e5ff);
            text-decoration: none;
            text-align: right;
            transition: color 0.2s, background 0.2s;
            font-family: inherit;
        }
        .submenu:hover {
            color: #ffcb2b;
            background: rgba(255, 255, 255, 0.05);
        }
        .submenu span {
            display: block;
            width: 100%;
            text-align: right;
        }
        .sidebar-section-title-with-icon {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: var(--sidebar-block-title-size);
            letter-spacing: 0.02em;
            text-transform: none;
            color: inherit;
            justify-content: flex-start;
        }
        .sidebar-section-title-with-icon .menu-icon img,
        .menu-indicator .menu-icon img {
            width: 18px;
            height: 18px;
            filter: brightness(0) invert(1);
        }
        .sidebar-section-toggle {
            justify-content: space-between;
        }
        .sidebar-section-toggle .menu-icon img {
            width: 20px;
            height: 20px;
        }
        .menu-indicator,
        .sidebar-section-title-with-icon {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: var(--sidebar-block-title-size);
            letter-spacing: 0.02em;
            text-transform: none;
        }
        .sidebar-section-content.open {
            display: flex;
        }
        .menu-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        .menu-icon svg {
            width: 22px;
            height: 22px;
            stroke: currentColor;
        }
        .menu-icon img {
            width: 22px;
            height: 22px;
            display: block;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }
        .menu-label {
            flex: 1;
            font-size: var(--sidebar-block-title-size);
            letter-spacing: 0.02em;
            text-transform: none;
        }
        .menu-notification-link {
            position: relative;
        }
        .menu-notification-badge {
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            border-radius: 999px;
            background: #ef4444;
            color: #ffffff;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 22px;
            text-align: center;
            display: none;
        }
        .menu-notification-badge.visible {
            display: inline-block;
        }
        .menu-icon.placeholder {
            visibility: hidden;
        }
        .navbar {
            margin-left: 220px;
            padding: 0 24px;
            background: var(--navbar-bg, #ffffff);
            border-bottom: 1px solid rgba(236, 237, 244, 0.9);
            position: sticky;
            top: 0;
            z-index: 2;
            transition: margin-left 0.3s ease;
            font-weight: 600;
            color: var(--navbar-text, #1f2933);
            display: flex;
            justify-content: center;
            height: 72px;
        }
        .navbar-inner {
            width: 100%;
            max-width: 1280px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .navbar-title {
            display: flex;
            align-items: baseline;
            gap: 8px;
            font-size: 1.35rem;
            font-weight: 700;
        }
        .navbar-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.6);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0;
            cursor: pointer;
            padding: 0;
        }
        .navbar-notifications-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 0;
            z-index: 2;
        }
        .navbar-notifications-icon {
            width: 20px;
            height: 20px;
            display: block;
            background: var(--navbar-notifications-icon-color, var(--sidebar-text, #ffffff));
            -webkit-mask: url("/templates/icon/notificaciones.svg") center / contain no-repeat;
            mask: url("/templates/icon/notificaciones.svg") center / contain no-repeat;
            filter: drop-shadow(0 0 1px rgba(15, 23, 42, 0.75));
        }
        .navbar-notifications-badge {
            position: absolute;
            top: -4px;
            right: -3px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 999px;
            background: #ef4444;
            color: #ffffff;
            font-size: 0.65rem;
            font-weight: 700;
            line-height: 18px;
            text-align: center;
            display: none;
            border: 1px solid #ffffff;
        }
        .navbar-notifications-badge.visible {
            display: inline-block;
        }
        .navbar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .navbar-user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            min-width: 168px;
            background: #ffffff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            padding: 8px;
            display: none;
            z-index: 40;
        }
        .user-dropdown.open {
            display: block;
        }
        .user-dropdown a {
            display: block;
            text-decoration: none;
            color: #0f172a;
            font-weight: 600;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        .user-dropdown a:hover {
            background: #f1f5f9;
        }
        .sidebar-notifications-panel {
            position: fixed;
            top: 86px;
            left: 230px;
            width: 340px;
            max-width: calc(100vw - 246px);
            max-height: 72vh;
            border-radius: 14px;
            background: #ffffff;
            border: 1px solid #dbe3ef;
            box-shadow: 0 16px 38px rgba(15, 23, 42, 0.22);
            overflow: hidden;
            z-index: 45;
            display: none;
        }
        .sidebar-notifications-panel.open {
            display: flex;
            flex-direction: column;
        }
        .sidebar-notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid #e2e8f0;
        }
        .sidebar-notifications-header strong {
            font-size: 0.95rem;
            color: #0f172a;
        }
        .sidebar-notifications-count {
            font-size: 0.8rem;
            color: #64748b;
        }
        .sidebar-notifications-refresh {
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            color: #334155;
            border-radius: 8px;
            font-size: 0.78rem;
            padding: 6px 10px;
            cursor: pointer;
        }
        .sidebar-notifications-actions {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .sidebar-notifications-list {
            list-style: none;
            margin: 0;
            padding: 8px 10px 10px;
            overflow-y: auto;
            max-height: calc(72vh - 56px);
        }
        .sidebar-notifications-empty {
            margin: 8px 10px 12px;
            padding: 12px;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.84rem;
            display: none;
        }
        .notification-item {
            display: block;
            text-decoration: none;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 12px;
            color: #0f172a;
            margin-bottom: 8px;
            background: #ffffff;
        }
        .notification-item:hover {
            background: #f8fafc;
        }
        .notification-item.read {
            opacity: 0.7;
            background: #f8fafc;
        }
        .notification-item-title {
            font-size: 0.84rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .notification-item-msg {
            font-size: 0.8rem;
            color: #334155;
            margin-bottom: 4px;
        }
        .notification-item-date {
            font-size: 0.72rem;
            color: #64748b;
        }
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .main-content {
            margin-left: 220px;
            padding: 32px 40px 48px;
            min-height: 100vh;
            background: #f4f6fb;
            transition: margin-left 0.3s ease;
            overflow-x: hidden;
            overflow-y: auto;
            width: calc(100vw - 220px);
            box-sizing: border-box;
        }
        .content-shell {
            width: min(80%, 1280px);
            max-width: 100%;
            margin: 0 auto;
        }
        .navbar-route {
            font-size: 1rem;
            font-style: italic;
            color: #4b5563;
            display: none;
            transition: opacity 0.15s ease;
        }
        .message-box {
            position: fixed;
            top: 80px;
            right: 40px;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
            color: var(--sidebar-bottom, #0f172a);
            background: transparent;
            z-index: 20;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.25s, transform 0.25s;
        }
        .message-box.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .page-header {
            max-width: 900px;
            margin: 0 auto 32px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .page-header-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .page-header-subtitle {
            font-size: 0.95rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-weight: 600;
            color: #475569;
        }
        .page-header-text h1 {
            font-size: 2rem;
            margin: 0;
            color: var(--page-title-color, var(--sidebar-bottom, #0f172a));
        }
        .page-header-description {
            margin: 0;
            color: #475569;
            font-size: 1rem;
        }
        .view-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        .view-buttons .view-pill {
            border-radius: 999px;
            border: 1px solid var(--view-pill-border, var(--sidebar-bottom, #0f172a));
            background: var(--view-pill-bg, var(--sidebar-text, #ffffff));
            color: var(--view-pill-text, var(--sidebar-bottom, #0f172a));
            font-weight: 600;
            padding: 10px 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }
        .view-buttons .view-pill:hover {
            background: var(--view-pill-hover-bg, var(--sidebar-bottom, #0f172a));
            color: var(--view-pill-hover-text, var(--sidebar-text, #ffffff));
            border-color: var(--view-pill-border, var(--sidebar-bottom, #0f172a));
        }
        .view-buttons .view-pill.active {
            background: var(--view-pill-hover-bg, var(--sidebar-bottom, #0f172a));
            color: var(--view-pill-hover-text, var(--sidebar-text, #ffffff));
            border-color: var(--view-pill-border, var(--sidebar-bottom, #0f172a));
        }
        .view-buttons .view-pill img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: block;
        }
        .view-pill-icon-mask {
            width: 18px;
            height: 18px;
            display: inline-block;
            background: var(--view-pill-icon, var(--sidebar-bottom, #0f172a));
            -webkit-mask: var(--view-pill-icon-url) center / contain no-repeat;
            mask: var(--view-pill-icon-url) center / contain no-repeat;
            transition: background 0.2s;
            flex: 0 0 18px;
        }
        .view-buttons .view-pill:hover .view-pill-icon-mask,
        .view-buttons .view-pill.active .view-pill-icon-mask {
            background: var(--view-pill-hover-icon, var(--sidebar-text, #ffffff));
        }
        .floating-actions-wrapper {
            position: fixed;
            right: 12px;
            top: 50%;
            transform: translateY(-50%) scale(var(--floating-scale, 1));
            transform-origin: right center;
            z-index: 4;
        }
        .floating-actions {
            background: var(--floating-panel-bg, var(--sidebar-text, #ffffff));
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.2);
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid var(--floating-toggle-color, #1f2a3d);
            min-width: 72px;
            position: relative;
        }
        .floating-actions-group {
            display: none;
            flex-direction: column;
            gap: 6px;
        }
        .floating-actions-group.active {
            display: flex;
        }
        .floating-actions.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(24px);
            display: none;
        }
        .floating-actions::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            border: 2px solid var(--floating-toggle-color, #1f2a3d);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .floating-actions:hover::after {
            opacity: 1;
        }
        .floating-placeholder .floating-actions {
            opacity: 0.4;
        }
        .floating-actions-separator {
            width: 100%;
            height: 12px;
        }
        .action-button {
            position: relative;
            background: transparent;
            border: none;
            padding: 6px 12px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: inherit;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            overflow: hidden;
        }
        .action-button:hover {
            background: var(--floating-toggle-color, #1f2a3d);
            color: var(--floating-toggle-text-color, #ffffff);
        }
        .action-button img,
        .action-button svg {
            width: 32px;
            height: 32px;
            transition: opacity 0.2s;
            opacity: 1;
        }
        .action-icon-mask {
            width: 32px;
            height: 32px;
            display: inline-block;
            background: var(--floating-icon-color, #1f2a3d);
            -webkit-mask: var(--action-icon-url) center / contain no-repeat;
            mask: var(--action-icon-url) center / contain no-repeat;
            transition: opacity 0.2s;
            opacity: 1;
            flex: 0 0 32px;
        }
        .action-button svg {
            fill: var(--floating-icon-color, #1f2a3d);
            stroke: var(--floating-icon-color, #1f2a3d);
        }
        .action-label {
            font-size: 1.3rem;
            font-style: italic;
            letter-spacing: 0.02em;
            opacity: 0;
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
            pointer-events: none;
        }
        .action-button:hover .action-label {
            opacity: 1;
        }
        .action-button:hover svg,
        .action-button:hover img,
        .action-button:hover .action-icon-mask {
            opacity: 0;
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button,
        .floating-actions-group[data-floating-screen="areas"] .action-button,
        .floating-actions-group[data-floating-screen="plantillas"] .action-button {
            width: 156px;
            min-width: 156px;
            max-width: 156px;
            justify-content: center;
            border: 1px solid var(--floating-action-border, #cbd5e1);
            background: var(--floating-action-bg, #ffffff);
            color: var(--floating-action-text, #0f172a);
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-label,
        .floating-actions-group[data-floating-screen="areas"] .action-label,
        .floating-actions-group[data-floating-screen="plantillas"] .action-label {
            position: absolute;
            inset: 0;
            opacity: 0;
            font-style: italic;
            pointer-events: none;
            color: var(--floating-action-text, #0f172a);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button:hover img,
        .floating-actions-group[data-floating-screen="usuarios"] .action-button:hover svg,
        .floating-actions-group[data-floating-screen="areas"] .action-button:hover img,
        .floating-actions-group[data-floating-screen="areas"] .action-button:hover svg,
        .floating-actions-group[data-floating-screen="plantillas"] .action-button:hover img,
        .floating-actions-group[data-floating-screen="plantillas"] .action-button:hover svg {
            opacity: 0;
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button:hover .action-label,
        .floating-actions-group[data-floating-screen="areas"] .action-button:hover .action-label,
        .floating-actions-group[data-floating-screen="plantillas"] .action-button:hover .action-label {
            opacity: 1;
            color: var(--floating-action-bg, #ffffff);
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button:hover,
        .floating-actions-group[data-floating-screen="areas"] .action-button:hover,
        .floating-actions-group[data-floating-screen="plantillas"] .action-button:hover {
            background: var(--floating-action-text, #0f172a);
            color: var(--floating-action-bg, #ffffff);
            border-color: var(--floating-action-text, #0f172a);
        }
        .floating-actions-group[data-floating-screen="areas"].active {
            display: flex !important;
        }
        .floating-actions-group[data-floating-screen="areas"] .action-button,
        .floating-actions-group[data-floating-screen="areas"] .action-label,
        .floating-actions-group[data-floating-screen="areas"] .action-button img,
        .floating-actions-group[data-floating-screen="areas"] .action-button svg {
            visibility: visible;
        }
        .floating-actions-group[data-floating-screen="usuarios"].active {
            display: flex !important;
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button,
        .floating-actions-group[data-floating-screen="usuarios"] .action-label,
        .floating-actions-group[data-floating-screen="usuarios"] .action-button img,
        .floating-actions-group[data-floating-screen="usuarios"] .action-button svg {
            visibility: visible;
        }
        .floating-toggle {
            position: absolute;
            top: 50%;
            right: -18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--floating-toggle-color, #1f2a3d);
            background: var(--floating-toggle-color, #1f2a3d);
            font-size: 18px;
            font-weight: 700;
            color: var(--floating-toggle-text-color, #ffffff);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            transform: scale(1.56);
            transform-origin: center;
        }
        .floating-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.6);
        }
        .floating-toggle:hover {
            filter: brightness(1.15);
        }
        .action-button:hover .action-label {
            opacity: 1;
            transform: translateX(0);
        }
        .personalization-panel {
            max-width: 1200px;
            margin-top: 40px;
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
        }
        .personalization-panel.hidden {
            display: none;
        }
        .personalization-panel h2 {
            font-size: 1.5rem;
            margin: 0 0 12px;
            color: #111827;
        }
        .personalization-panel p {
            color: #475569;
            margin: 0 0 24px;
        }
        .color-group {
            margin-top: 24px;
        }
        .color-group h3 {
            font-size: 1.15rem;
            margin-bottom: 12px;
            color: #0f172a;
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        .color-option {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 14px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        .color-option label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #475569;
        }
        .color-option strong {
            font-size: 1rem;
            color: #0f172a;
        }
        .color-preview {
            width: 90%;
            height: 34px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: inset 0 0 6px rgba(15, 23, 42, 0.25);
        }
        .usuario-panel {
            margin-top: 32px;
            background: #fff;
            border-radius: 20px;
            padding: 32px 36px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
        }
        .usuario-panel.hidden {
            display: none;
        }
        .usuario-header {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 24px;
        }
        .usuario-avatar {
            width: 90px;
            height: 90px;
            border-radius: 18px;
            background: #e5f1ff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #0f172a;
        }
        .usuario-avatar img {
            width: 72px;
            height: 72px;
            object-fit: cover;
        }
        .usuario-title h2 {
            margin: 0;
            font-size: 1.8rem;
            color: #0f172a;
        }
        .usuario-title small {
            color: #475569;
            font-size: 0.95rem;
        }
        .usuario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        .usuario-tab,
        .area-tab {
            padding: 8px 18px;
            border-radius: 999px;
            border: 1px solid #d4d4d8;
            background: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .usuario-tab.active,
        .area-tab.active {
            background: #0f172a;
            color: #fff;
        }
        .usuario-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .usuario-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .usuario-form-group label {
            color: #475569;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .usuario-form-group input,
        .usuario-form-group textarea,
        .usuario-form-group select {
            border-radius: 14px;
            border: 1px solid #d1d5db;
            padding: 10px 12px;
            font-family: inherit;
            background: #fefefe;
            min-height: 44px;
            font-size: 0.95rem;
        }
        .usuario-form-group textarea {
            min-height: 90px;
        }
        .usuario-list,
        .usuario-kanban {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .usuario-card {
            padding: 16px 20px;
            border-radius: 16px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            background: #fcfcff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .kanban-card-two-col {
            display: grid;
            grid-template-columns: 88px minmax(0, 1fr);
            align-items: center;
            gap: 14px;
        }
        .kanban-card-media {
            width: 88px;
            height: 88px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dbe3ef;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kanban-card-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .kanban-card-body {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }
        .kanban-card-body strong,
        .kanban-card-body span {
            overflow-wrap: anywhere;
        }
        .usuario-card strong {
            font-size: 1rem;
            color: #0f172a;
        }
        .usuario-card span {
            color: #475569;
        }
        .usuario-selectable {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
        }
        .usuario-selectable:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.09);
            border-color: rgba(37, 99, 235, 0.5);
        }
        .usuario-kanban-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .usuario-kanban-column {
            border: 1px dashed var(--sidebar-bottom, #0f172a);
            border-radius: 16px;
            padding: 12px;
            background: #fff;
        }
        .usuario-kanban-column h4 {
            margin: 0 0 12px;
            font-size: 1rem;
            color: #0f172a;
        }
        .usuario-role-filter {
            max-width: 280px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .usuario-role-filter label {
            font-size: 0.82rem;
            font-weight: 700;
            color: #334155;
        }
        .usuario-role-filter select {
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            padding: 9px 10px;
            font-size: 0.9rem;
        }
        .usuario-shell {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .usuario-shell__head {
            background: linear-gradient(140deg, rgba(15,61,46,.92), rgba(29,78,216,.86));
            border-radius: 16px;
            color: #fff;
            padding: 14px 16px;
            border: 1px solid rgba(15,61,46,.25);
            box-shadow: 0 14px 28px rgba(15,23,42,.12);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
        }
        .usuario-shell__head h2 {
            margin: 0;
            font-size: 1.12rem;
            font-weight: 700;
        }
        .usuario-shell__head p {
            margin: 6px 0 0;
            font-size: 0.85rem;
            opacity: .92;
        }
        .usuario-shell__meta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            border-radius: 999px;
            padding: 6px 10px;
            background: rgba(255,255,255,.16);
            border: 1px solid rgba(255,255,255,.25);
            font-size: 0.82rem;
            font-weight: 700;
        }
        .usuario-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .usuario-stat {
            background: #fff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(15,23,42,.05);
        }
        .usuario-stat strong {
            display: block;
            color: #0f172a;
            font-size: 1rem;
            line-height: 1;
            margin-bottom: 4px;
        }
        .usuario-stat span {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .usuario-empty {
            margin: 0;
            color: #64748b;
            font-size: 0.88rem;
            text-align: center;
            padding: 8px 0;
        }
        .area-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px 18px;
        }
        .area-shell {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .area-shell__head {
            background: linear-gradient(140deg, rgba(15,61,46,.92), rgba(29,78,216,.86));
            border-radius: 16px;
            color: #fff;
            padding: 14px 16px;
            border: 1px solid rgba(15,61,46,.25);
            box-shadow: 0 14px 28px rgba(15,23,42,.12);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
        }
        .area-shell__head h2 {
            margin: 0;
            font-size: 1.12rem;
            font-weight: 700;
        }
        .area-shell__head p {
            margin: 6px 0 0;
            font-size: 0.85rem;
            opacity: .92;
        }
        .area-shell__meta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            border-radius: 999px;
            padding: 6px 10px;
            background: rgba(255,255,255,.16);
            border: 1px solid rgba(255,255,255,.25);
            font-size: 0.82rem;
            font-weight: 700;
        }
        .area-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .area-stat {
            background: #fff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(15,23,42,.05);
        }
        .area-stat strong {
            display: block;
            color: #0f172a;
            font-size: 1rem;
            line-height: 1;
            margin-bottom: 4px;
        }
        .area-stat span {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .area-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 2px;
        }
        .area-actions button {
            border: 1px solid #0f172a;
            background: #0f172a;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.86rem;
        }
        .area-actions button.secondary {
            background: #fff;
            color: #0f172a;
            border-color: #cbd5e1;
        }
        .area-relacion-help-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .area-relacion-help-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #334155;
            background: #f8fafc;
            border: 1px solid #dbeafe;
            border-radius: 999px;
            padding: 4px 10px;
        }
        .area-relacion-help-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #0f172a;
            background: #ffffff;
            color: #0f172a;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            cursor: pointer;
            padding: 0;
        }
        .area-kanban-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .area-kanban-column {
            border: 1px dashed var(--sidebar-bottom, #0f172a);
            border-radius: 12px;
            padding: 12px;
            background: #fff;
        }
        .area-kanban-column h4 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            color: #0f172a;
        }
        .area-card {
            padding: 10px 12px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            border-radius: 10px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .area-card strong {
            color: #0f172a;
        }
        .area-card span {
            color: #475569;
            font-size: 0.9rem;
        }
        .area-card.kanban-card-two-col {
            display: grid;
            grid-template-columns: 88px minmax(0, 1fr);
            align-items: center;
            gap: 14px;
        }
        .area-empty {
            margin: 0;
            color: #64748b;
            font-size: 0.88rem;
            text-align: center;
            padding: 8px 0;
        }
        .usuario-organigrama {
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding: 6px 0;
        }
        .plantillas-page {
            width: 100%;
        }
        .plantillas-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px;
            align-items: start;
        }
        .plantillas-list-card,
        .plantillas-editor-card {
            background: #ffffff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 16px;
        }
        .plantillas-list-card h3 {
            margin: 0;
            color: #0f172a;
        }
        .plantillas-hint {
            margin: 8px 0 14px;
            font-size: 0.9rem;
            color: #475569;
        }
        .plantillas-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 460px;
            overflow: auto;
        }
        .plantillas-item {
            border: 1px solid #dbe3ef;
            background: #f8fbff;
            color: #1e293b;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            transition: border-color 160ms ease, background 160ms ease;
        }
        .plantillas-item.active {
            border-color: #2c9c63;
            background: #ecfdf5;
        }
        .plantillas-editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .plantilla-code {
            min-height: 240px;
            resize: vertical;
            font-family: "SFMono-Regular", Menlo, Consolas, monospace;
            font-size: 0.86rem;
            background: #f8fafc;
        }
        .plantillas-preview-head {
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .plantillas-preview-head h4 {
            margin: 0;
            color: #0f172a;
        }
        .plantillas-preview-head button {
            border: 1px solid #14532d;
            background: #166534;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .plantilla-preview-frame {
            width: 100%;
            min-height: 290px;
            height: 340px;
            border: 1px solid #dbe3ef;
            border-radius: 10px;
            background: #ffffff;
            margin-top: 10px;
        }
        .form-builder-panel {
            margin-top: 12px;
            border: 1px solid #dbe3ef;
            border-radius: 10px;
            padding: 14px;
            background: #f8fbff;
        }
        .form-builder-panel.hidden {
            display: none;
        }
        .form-builder-head h4 {
            margin: 0;
            color: #0f172a;
        }
        .form-builder-head p {
            margin: 4px 0 0;
            color: #475569;
            font-size: 0.9rem;
        }
        .form-builder-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 12px;
            margin-top: 12px;
        }
        .form-builder-grid.field-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .form-builder-description {
            grid-column: 1 / -1;
        }
        .form-builder-description textarea {
            min-height: 72px;
        }
        .form-field-inline {
            align-self: end;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .form-builder-field-editor {
            margin-top: 12px;
            border-top: 1px solid #dbe3ef;
            padding-top: 12px;
        }
        .form-builder-field-editor h5,
        .form-builder-list-wrap h5 {
            margin: 0 0 10px;
            color: #0f172a;
            font-size: 0.95rem;
        }
        .form-builder-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .form-builder-actions button {
            border: 1px solid #14532d;
            background: #166534;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .form-builder-fields-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .builder-field-item {
            border: 1px solid #dbe3ef;
            background: #ffffff;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }
        .builder-field-item .meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            color: #334155;
            font-size: 0.86rem;
        }
        .builder-field-item strong {
            color: #0f172a;
            font-size: 0.92rem;
        }
        .builder-field-delete {
            border: 1px solid #b91c1c;
            background: #fff1f2;
            color: #b91c1c;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .org-level {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .org-node {
            min-width: 210px;
            padding: 12px 14px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            border-radius: 8px;
            background: #ffffff;
            text-align: center;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }
        .org-node-avatar {
            width: 74px;
            height: 74px;
            margin: 0 auto 10px;
            border-radius: 16px;
            border: 1px solid #cbd5e1;
            overflow: hidden;
            background: #ffffff;
        }
        .org-node-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .org-node strong {
            display: block;
            margin-bottom: 4px;
            color: #0f172a;
        }
        .org-node span {
            display: block;
            color: #475569;
            font-size: 0.9rem;
        }
        .org-root .org-node {
            border-color: var(--sidebar-bottom, #0f172a);
            background: #f8fafc;
        }
        .org-node.usuario-selectable:hover {
            background: #eff6ff;
        }
        .org-divider {
            width: 2px;
            height: 20px;
            margin: 0 auto;
            background: #cbd5e1;
        }
        .usuarios-form-layout {
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-width: 980px;
        }
        .form-section {
            background: #fff;
            border-radius: 2px;
            padding: 16px 18px;
            border: 1px solid #e5e7eb;
            box-shadow: none;
        }
        .section-title h2 {
            margin: 0 0 14px;
            font-size: 1.15rem;
            color: #1e293b;
            font-weight: 600;
        }
        .section-title .tag {
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #64748b;
            margin: 0 0 4px;
            font-weight: 600;
        }
        .section-grid {
            display: grid;
            gap: 12px 18px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .section-grid.two-columns {
            grid-template-columns: minmax(0, 1fr) 110px;
            align-items: start;
        }
        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.88rem;
            color: #334155;
        }
        .form-field label {
            font-size: 0.86rem;
            font-weight: 600;
            color: #334155;
        }
        .form-field input,
        .form-field select,
        .form-field textarea {
            border-radius: 2px;
            border: 1px solid #d1d5db;
            padding: 9px 10px;
            font-size: 0.95rem;
            font-family: inherit;
            color: #0f172a;
            background: #fff;
        }
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #64748b;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.12);
        }
        .campo,
        .campo-personalizado {
            background: var(--field-color, #e7d7da) !important;
            border-radius: 16px !important;
            border: 1px solid rgba(15, 23, 42, 0.08);
            padding: 10px 14px;
        }
        input.campo,
        textarea.campo,
        select.campo,
        input.campo-personalizado,
        textarea.campo-personalizado,
        select.campo-personalizado {
            border-radius: 16px !important;
        }
        .password-confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 30;
        }
        .password-confirm-backdrop.hidden {
            display: none;
        }
        .password-confirm-modal {
            width: min(92vw, 360px);
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .password-confirm-modal h3 {
            margin: 0;
            font-size: 1rem;
            color: #0f172a;
        }
        .password-confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .password-confirm-actions button {
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #0f172a;
            border-radius: 6px;
            padding: 7px 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .password-confirm-actions button.primary {
            background: #0f172a;
            border-color: #0f172a;
            color: #fff;
        }
        .password-confirm-msg {
            min-height: 16px;
            margin: 0;
            font-size: 0.82rem;
            color: #b91c1c;
        }
        .foda-page {
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .foda-input-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
        }
        .foda-input-card h2 {
            margin: 0;
            color: #0f172a;
            font-size: 1.25rem;
        }
        .foda-input-card p {
            margin: 8px 0 14px;
            color: #475569;
        }
        .foda-input-grid {
            display: grid;
            grid-template-columns: 1.8fr 1fr 1fr;
            gap: 12px;
        }
        .foda-input-grid textarea {
            min-height: 96px;
            resize: vertical;
        }
        .identity-inline-field {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            align-items: center;
            gap: 12px;
        }
        .identity-inline-field label.identity-field-label {
            text-align: right;
            font-size: 0.86rem;
            font-weight: 600;
            color: #334155;
            line-height: 1.1;
            display: inline-flex;
            flex-direction: column;
            gap: 2px;
            justify-self: end;
        }
        .identity-inline-field textarea {
            min-height: 86px;
        }
        .foda-input-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
        }
        .foda-input-actions button {
            border: 1px solid #0f172a;
            background: #0f172a;
            color: #fff;
            border-radius: 8px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .identity-assets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .identity-asset-row {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            align-items: center;
            gap: 16px;
            background: #ffffff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 14px;
        }
        .identity-asset-title {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
            text-align: right;
        }
        .identity-asset-media {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .identity-asset-image {
            width: 100%;
            max-width: 520px;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #f8fafc;
        }
        .identity-asset-image-logo {
            object-fit: contain;
        }
        .identity-asset-image-favicon {
            width: 96px;
            height: 96px;
            max-width: 96px;
            object-fit: contain;
            padding: 10px;
        }
        .identity-asset-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 106px;
        }
        .identity-asset-actions button {
            border: 1px solid #94a3b8;
            background: #ffffff;
            color: #0f172a;
            border-radius: 10px;
            padding: 7px 10px;
            font-weight: 600;
            cursor: pointer;
        }
        .identity-asset-actions .identity-asset-delete {
            border-color: #fecaca;
            color: #991b1b;
            background: #fff1f2;
        }
        .image-uploader {
            align-items: flex-end;
            justify-content: flex-start;
        }
        .image-placeholder {
            width: 92px;
            min-height: 92px;
            background: #f8fafc;
            border-radius: 2px;
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #64748b;
            justify-content: center;
        }
        .image-placeholder span {
            font-size: 0.72rem;
            line-height: 1.2;
        }
        .image-placeholder button {
            border: 1px solid #cbd5e1;
            padding: 4px 8px;
            border-radius: 2px;
            background: #ffffff;
            color: #334155;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .notebook-section .notebook-tabs {
            display: flex;
            gap: 0;
            flex-wrap: nowrap;
            margin-top: 0;
            border-bottom: 1px solid #d1d5db;
            overflow-x: auto;
        }
        .notebook-tabs .tab {
            border: 1px solid #d1d5db;
            border-bottom: none;
            padding: 8px 14px;
            border-radius: 0;
            background: #f8fafc;
            color: #334155;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            margin-bottom: -1px;
        }
        .notebook-tabs .tab.active {
            background: #ffffff;
            color: #0f172a;
            border-color: #d1d5db;
        }
        .notebook-content {
            margin-top: 0;
            padding: 16px;
            border-radius: 0;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-top: none;
            min-height: 120px;
        }
        .notebook-content p {
            margin: 0;
            color: #334155;
        }
        @media (max-width: 900px) {
            .foda-input-grid {
                grid-template-columns: 1fr;
            }
            .identity-inline-field {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .identity-inline-field label.identity-field-label {
                text-align: left;
                justify-self: start;
            }
            .identity-asset-row {
                grid-template-columns: 1fr;
            }
            .identity-asset-title {
                text-align: left;
            }
            .identity-asset-media {
                flex-direction: column;
                align-items: flex-start;
            }
            .identity-asset-image {
                max-width: 100%;
                height: 150px;
            }
            .identity-asset-actions {
                flex-direction: row;
            }
            .section-grid.two-columns {
                grid-template-columns: 1fr;
            }
            .usuario-shell__head {
                flex-direction: column;
                align-items: flex-start;
            }
            .usuario-stats {
                grid-template-columns: 1fr;
            }
            .area-shell__head {
                flex-direction: column;
                align-items: flex-start;
            }
            .area-stats {
                grid-template-columns: 1fr;
            }
            .area-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            .plantillas-layout {
                grid-template-columns: 1fr;
            }
            .plantillas-editor-grid {
                grid-template-columns: 1fr;
            }
            .form-builder-grid,
            .form-builder-grid.field-grid {
                grid-template-columns: 1fr;
            }
            .kanban-card-two-col {
                grid-template-columns: 72px minmax(0, 1fr);
            }
            .kanban-card-media {
                width: 72px;
                height: 72px;
            }
            .image-uploader {
                align-items: flex-start;
            }
        }
        @media (max-width: 900px) {
            .sidebar {
                width: 0;
            }
            .sidebar-notifications-panel {
                left: 12px;
                right: 12px;
                width: auto;
                max-width: none;
                top: 78px;
            }
            .navbar,
            .main-content {
                margin-left: 0;
            }
            .navbar {
                padding: 0 12px;
            }
            .main-content {
                width: 100%;
                padding: 16px 14px 24px;
            }
            .page-header {
                margin-bottom: 18px;
            }
            .content-shell {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    {% set hide_floating_actions = hide_floating_actions | default(false) %}
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-user">
                <img id="sidebar-user-img" src="/templates/icon/usuario.png" data-default="/templates/icon/usuario.png" alt="Usuario">
            </div>
        </div>
        <nav>
            <a href="/inicio" data-menu-name="Inicio" data-route="/inicio">
                <span class="menu-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16C9.85038 16.6303 10.8846 17 12 17C13.1154 17 14.1496 16.6303 15 16" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M21.6359 12.9579L21.3572 14.8952C20.8697 18.2827 20.626 19.9764 19.451 20.9882C18.2759 22 16.5526 22 13.1061 22H10.8939C7.44737 22 5.72409 22 4.54903 20.9882C3.37396 19.9764 3.13025 18.2827 2.64284 14.8952L2.36407 12.9579C1.98463 10.3208 1.79491 9.00229 2.33537 7.87495C2.87583 6.7476 4.02619 6.06234 6.32691 4.69181L7.71175 3.86687C9.80104 2.62229 10.8457 2 12 2C13.1543 2 14.199 2.62229 16.2882 3.86687L17.6731 4.69181C19.9738 6.06234 21.1242 6.7476 21.6646 7.87495" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </span>
                <span class="menu-label">Inicio</span>
            </a>
            <a href="/proyectando" data-menu-name="Proyectando" data-route="/proyectando">
                <span class="menu-icon" aria-hidden="true">
                    <img src="/templates/icon/proyectando.svg" alt="Proyectando">
                </span>
                <span class="menu-label">Proyectando</span>
            </a>
            <div class="accordion">
                <button type="button" class="accordion-header" id="planificacion-btn" data-menu-name="Planificacin" data-route="/planes">
                    <span class="menu-indicator">
                        <span class="menu-icon" aria-hidden="true">
                            <img src="/templates/icon/plan.svg" alt="Planificacin">
                        </span>
                        <span>Planificacin</span>
                    </span>
                    <span id="planificacion-toggle">+</span>
                </button>
                <div class="accordion-content" id="planificacion-submenu">
                    <a href="/planes" class="submenu" data-menu-name="Plan estratgico" data-route="/planes"><span>Plan estratgico</span></a>
                    <a href="/poa" class="submenu" data-menu-name="POA" data-route="/poa"><span>POA</span></a>
                </div>
            </div>
            <div class="accordion">
                <button type="button" class="accordion-header" id="diagnostico-btn" data-menu-name="Diagnstico" data-route="/diagnostico">
                    <span class="menu-indicator">
                        <span class="menu-icon" aria-hidden="true">
                            <img src="/templates/icon/diagnostico.svg" alt="Diagnstico">
                        </span>
                        <span>Diagnstico</span>
                    </span>
                    <span id="diagnostico-toggle">+</span>
                </button>
                <div class="accordion-content" id="diagnostico-submenu">
                    <a href="/diagnostico/foda" class="submenu" data-menu-name="FODA" data-route="/diagnostico/foda"><span>FODA</span></a>
                    <a href="/diagnostico/pestel" class="submenu" data-menu-name="PESTEL" data-route="/diagnostico/pestel"><span>PESTEL</span></a>
                    <a href="/diagnostico/porter" class="submenu" data-menu-name="PORTER" data-route="/diagnostico/porter"><span>PORTER</span></a>
                    <a href="/diagnostico/percepcion-cliente" class="submenu" data-menu-name="Percepcin del cliente" data-route="/diagnostico/percepcion-cliente"><span>Percepcin del cliente</span></a>
                </div>
            </div>
            <a href="/kpis" data-menu-name="KPIs" data-route="/kpis">
                <span class="menu-icon" aria-hidden="true">
                    <img src="/templates/icon/kpi.svg" alt="KPIs">
                </span>
                <span class="menu-label">KPIs</span>
            </a>
            <a href="#" id="sidebar-notifications-trigger" class="menu-notification-link" data-menu-name="Notificaciones" data-route="/notificaciones">
                <span class="menu-icon" aria-hidden="true">
                    <img src="/templates/icon/notificaciones.svg" alt="Notificaciones">
                </span>
                <span class="menu-label">Notificaciones</span>
                <span class="menu-notification-badge" id="sidebar-notifications-badge">0</span>
            </a>
            <div class="accordion">
                <button type="button" class="accordion-header" id="reportes-btn" data-menu-name="Reportes" data-route="/reportes">
                    <span class="menu-indicator">
                        <span class="menu-icon" aria-hidden="true">
                            <img src="/templates/icon/reporte.svg" alt="Reportes">
                        </span>
                        <span>Reportes</span>
                    </span>
                    <span id="reportes-toggle">+</span>
                </button>
                <div class="accordion-content" id="reportes-submenu">
                    <a href="/reportes" class="submenu" data-menu-name="Reportes" data-route="/reportes"><span>Resumen</span></a>
                    <a href="/reportes/documentos" class="submenu" data-menu-name="Documentos" data-route="/reportes/documentos"><span>Documentos</span></a>
                </div>
            </div>
            <div class="sidebar-section">
                <button type="button" class="sidebar-section-toggle" aria-expanded="false" id="empresa-section-toggle">
                    <span class="sidebar-section-title-with-icon" aria-hidden="true">
                        <span class="menu-icon" aria-hidden="true">
                            <img src="/templates/icon/empresa.svg" alt="Empresa">
                        </span>
                        <span>Empresa</span>
                    </span>
                    <span class="toggle-indicator">+</span>
                </button>
                <div class="sidebar-section-content" id="empresa-section-content">
                    <a href="/identidad-institucional" class="submenu" data-menu-name="Identidad institucional" data-route="/identidad-institucional"><span>Identidad institucional</span></a>
                    <a href="/areas-organizacionales" class="submenu" data-menu-name="reas organizacionales" data-route="/areas-organizacionales" data-floating-screen="areas"><span>reas organizacionales</span></a>
                    <a href="/usuarios-sistema" class="submenu usuario-view-link" data-menu-name="Usuarios de sistema" data-route="/usuarios-sistema" data-view="form" data-floating-screen="usuarios"><span>Usuarios de sistema</span></a>
                    <a href="/plantillas" class="submenu" data-menu-name="Plantillas" data-route="/plantillas" data-floating-screen="plantillas"><span>Plantillas</span></a>
                </div>
            </div>
            {% if can_manage_personalization %}
            <div class="accordion">
                <button type="button" class="accordion-header" id="personalizar-btn" data-menu-name="Personalizacin" data-route="/personalizacion">
                    <span class="menu-indicator">
                        <span class="menu-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M9.75195 12.0128C9.75175 11.0587 10.4087 10.2372 11.3211 10.0509C12.2335 9.86458 13.1472 10.3652 13.5034 11.2467C13.8595 12.1282 13.559 13.1449 12.7856 13.6752C12.0121 14.2054 10.9812 14.1014 10.3233 13.4268C9.95757 13.0518 9.75206 12.5432 9.75195 12.0128Z" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.3077 5.46781C10.2943 4.94809 10.557 4.46185 10.9937 4.19793C11.4305 3.93402 11.9725 3.93402 12.4092 4.19793C12.8459 4.46185 13.1086 4.94809 13.0952 5.46781V6.18481C14.1532 6.45066 15.1177 7.01454 15.8798 7.81281L16.4346 7.47881C16.7552 7.28632 17.1379 7.23446 17.4962 7.33495C17.8545 7.43544 18.1583 7.6798 18.3388 8.01281C18.7238 8.70718 18.4973 9.58984 17.8288 9.99981L17.3121 10.3108C17.6296 11.4207 17.6296 12.6009 17.3121 13.7108L17.8288 14.0218C18.4996 14.4319 18.7264 15.3175 18.3388 16.0128C18.1579 16.3455 17.8541 16.5894 17.4958 16.6895C17.1375 16.7896 16.7549 16.7375 16.4346 16.5448L15.8798 16.2108C15.1177 17.01 14.1528 17.5746 13.0942 17.8408V18.5578C13.1076 19.0775 12.845 19.5638 12.4082 19.8277C11.9715 20.0916 11.4295 20.0916 10.9927 19.8277C10.556 19.5638 10.2933 19.0775 10.3067 18.5578V17.8408C9.24871 17.575 8.28422 17.0111 7.52212 16.2128L6.96735 16.5468C6.64684 16.739 6.26438 16.7907 5.90629 16.6902C5.5482 16.5897 5.24464 16.3455 5.06415 16.0128C4.67911 15.3184 4.90563 14.4358 5.57407 14.0258L6.09082 13.7148C5.77329 12.6049 5.77329 11.4247 6.09082 10.3148L5.57407 10.0038C4.90333 9.59369 4.67651 8.70808 5.06415 8.01281C5.24498 7.68014 5.54885 7.43621 5.90715 7.3361C6.26546 7.236 6.64797 7.28816 6.96832 7.48081L7.5231 7.81481C8.28484 7.01545 9.24936 6.4505 10.3077 6.18381V5.46781Z" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>Personalizacin</span>
                    </span>
                    <span id="personalizar-toggle">+</span>
                </button>
                <div class="accordion-content" id="personalizar-submenu">
                    <a href="/personalizar-pantalla" class="submenu" data-menu-name="Personalizar pantalla" data-route="/personalizar-pantalla" data-floating-screen="personalization">Personalizar pantalla</a>
                    <a href="/roles-permisos" class="submenu" data-menu-name="Roles del sistema" data-route="/roles-permisos" data-floating-screen="personalization">Roles del sistema</a>
                    <a href="/membresia" class="submenu" data-menu-name="Membresa" data-route="/membresia">Membresa</a>
                </div>
            </div>
            {% endif %}
        </nav>
        <div class="sidebar-notifications-panel" id="sidebar-notifications-panel" aria-hidden="true">
            <div class="sidebar-notifications-header">
                <div>
                    <strong>Notificaciones</strong>
                    <div class="sidebar-notifications-count" id="sidebar-notifications-count">Sin pendientes</div>
                </div>
                <div class="sidebar-notifications-actions">
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-mark-all">Marcar todo</button>
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-refresh">Actualizar</button>
                </div>
            </div>
            <div class="sidebar-notifications-empty" id="sidebar-notifications-empty">No tienes notificaciones pendientes.</div>
            <ul class="sidebar-notifications-list" id="sidebar-notifications-list"></ul>
        </div>
    </div>
    <div class="navbar">
        <div class="navbar-inner">
            <div class="navbar-left">
                <button class="navbar-hamburger" aria-label="Mostrar u ocultar men">&#9776;</button>
                <div class="navbar-title">
                    <span class="navbar-menu-name">Sistema</span>
                    <a class="navbar-route" href="/inicio">/ inicio</a>
                </div>
            </div>
            <div class="navbar-user-menu">
                <button class="navbar-notifications-btn" id="navbar-notifications-trigger" aria-label="Notificaciones" aria-expanded="false">
                    <span class="navbar-notifications-icon" aria-hidden="true"></span>
                    <span class="navbar-notifications-badge" id="navbar-notifications-badge">0</span>
                </button>
                <button class="navbar-avatar" id="navbar-avatar-btn" aria-label="Men de usuario" aria-expanded="false">
                    <img id="navbar-avatar-img" src="/templates/icon/usuarios.svg" alt="Avatar" data-default="/templates/icon/usuarios.svg">
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="/logout" id="logout-link">Cerrar sesin</a>
                </div>
            </div>
        </div>
    </div>
    <main class="main-content">
        <div class="content-shell">
        {% if show_page_header | default(true) and (page_title or title or page_description or subtitle or view_buttons_html) %}
        <section class="page-header">
            <div class="page-header-text">
                {% if subtitle %}
                <span class="page-header-subtitle">{{ subtitle }}</span>
                {% endif %}
                {% if page_title or title %}
                <h1>{{ page_title or title }}</h1>
                {% endif %}
                {% if page_description %}
                <p class="page-header-description">{{ page_description }}</p>
                {% endif %}
            </div>
            {% if view_buttons_html %}
            <div class="view-buttons">
                {{ view_buttons_html | safe }}
            </div>
            {% endif %}
        </section>
        {% endif %}
        {{ content|safe }}
        </div>
    </main>
        <div class="floating-actions-wrapper{% if hide_floating_actions %} floating-placeholder{% endif %}"
             aria-label="Acciones rpidas de pantalla"
             data-default-screen="{{ floating_actions_screen | default('personalization') }}">
            <aside class="floating-actions">
            {% set DEFAULT_FLOATING_ACTIONS %}
            <div class="floating-actions-group" data-floating-screen="personalization">
                <button class="action-button" type="button" id="action-save-personal" aria-label="Guardar">
                    <img src="/templates/icon/guardar.svg" alt="Guardar">
                    <span class="action-label">Guardar</span>
                </button>
                <button class="action-button" type="button" id="action-reset-personal" aria-label="Restablecer">
                    <img src="/templates/icon/restablecer.svg" alt="Restablecer">
                    <span class="action-label">Restablecer</span>
                </button>
            </div>
            <div class="floating-actions-group{% if (floating_actions_screen | default('personalization')) == 'usuarios' %} active{% endif %}" data-floating-screen="usuarios"{% if (floating_actions_screen | default('personalization')) == 'usuarios' %} style="display:flex"{% endif %}>
                <button class="action-button" type="button" id="action-create-user" aria-label="Crear usuario">
                    <img src="/templates/icon/nuevo.svg" alt="Crear usuario">
                    <span class="action-label">Crear Usuario</span>
                </button>
                <button class="action-button" type="button" id="action-edit" aria-label="Editar">
                    <img src="/templates/icon/editar.svg" alt="Editar">
                    <span class="action-label">Editar</span>
                </button>
                <button class="action-button" type="button" id="action-save-usuario" aria-label="Guardar">
                    <img src="/templates/icon/guardar.svg" alt="Guardar">
                    <span class="action-label">Guardar</span>
                </button>
                <button class="action-button" type="button" id="action-delete" aria-label="Eliminar">
                    <img src="/templates/icon/eliminar.svg" alt="Eliminar">
                    <span class="action-label">Eliminar</span>
                </button>
            </div>
            <div class="floating-actions-group{% if (floating_actions_screen | default('personalization')) == 'areas' %} active{% endif %}" data-floating-screen="areas"{% if (floating_actions_screen | default('personalization')) == 'areas' %} style="display:flex"{% endif %}>
                <button class="action-button" type="button" id="action-new-areas" aria-label="Nuevo">
                    <img src="/templates/icon/nuevo.svg" alt="Nuevo">
                    <span class="action-label">Nuevo</span>
                </button>
                <button class="action-button" type="button" id="action-edit-areas" aria-label="Editar">
                    <img src="/templates/icon/editar.svg" alt="Editar">
                    <span class="action-label">Editar</span>
                </button>
                <button class="action-button" type="button" id="action-save-areas" aria-label="Guardar">
                    <img src="/templates/icon/guardar.svg" alt="Guardar">
                    <span class="action-label">Guardar</span>
                </button>
                <button class="action-button" type="button" id="action-delete-areas" aria-label="Eliminar">
                    <img src="/templates/icon/eliminar.svg" alt="Eliminar">
                    <span class="action-label">Eliminar</span>
                </button>
            </div>
            <div class="floating-actions-group{% if (floating_actions_screen | default('personalization')) == 'plantillas' %} active{% endif %}" data-floating-screen="plantillas"{% if (floating_actions_screen | default('personalization')) == 'plantillas' %} style="display:flex"{% endif %}>
                <button class="action-button" type="button" id="action-new-template" aria-label="Nuevo">
                    <img src="/templates/icon/nuevo.svg" alt="Nuevo">
                    <span class="action-label">Nuevo</span>
                </button>
                <button class="action-button" type="button" id="action-edit-template" aria-label="Editar">
                    <img src="/templates/icon/editar.svg" alt="Editar">
                    <span class="action-label">Editar</span>
                </button>
                <button class="action-button" type="button" id="action-save-template" aria-label="Guardar">
                    <img src="/templates/icon/guardar.svg" alt="Guardar">
                    <span class="action-label">Guardar</span>
                </button>
                <button class="action-button" type="button" id="action-delete-template" aria-label="Eliminar">
                    <img src="/templates/icon/eliminar.svg" alt="Eliminar">
                    <span class="action-label">Eliminar</span>
                </button>
            </div>
            {% endset %}
            {{ (floating_actions_html if floating_actions_html else DEFAULT_FLOATING_ACTIONS) | safe }}
        </aside>
        <button class="floating-toggle" type="button" id="floating-toggle" aria-label="Ocultar barra flotante"></button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const hamburger = document.querySelector('.navbar-hamburger');
            const sidebarElem = document.getElementById('sidebar');
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            const personalizarBtn = document.getElementById('personalizar-btn');
            const personalizarToggle = document.getElementById('personalizar-toggle');
            const personalizarSubmenu = document.getElementById('personalizar-submenu');
            const planificacionBtn = document.getElementById('planificacion-btn');
            const planificacionToggle = document.getElementById('planificacion-toggle');
            const planificacionSubmenu = document.getElementById('planificacion-submenu');
            const diagnosticoBtn = document.getElementById('diagnostico-btn');
            const diagnosticoToggle = document.getElementById('diagnostico-toggle');
            const diagnosticoSubmenu = document.getElementById('diagnostico-submenu');
            const reportesBtn = document.getElementById('reportes-btn');
            const reportesToggle = document.getElementById('reportes-toggle');
            const reportesSubmenu = document.getElementById('reportes-submenu');
            const submenuLinks = document.querySelectorAll('.submenu[data-menu-name]');
            const menuLinks = document.querySelectorAll('nav > a[data-menu-name]');
            const navbarMenuName = document.querySelector('.navbar-menu-name');
            const navbarRoute = document.querySelector('.navbar-route');
            const floatingActions = document.querySelector('.floating-actions');
            const floatingGroups = document.querySelectorAll('.floating-actions-group');
            const floatingToggle = document.getElementById('floating-toggle');
            const floatingActionsWrapper = document.querySelector('.floating-actions-wrapper');
            const usuarioPanel = document.getElementById('usuario-panel');
            const areaPanel = document.getElementById('area-panel');
            const identityForm = document.getElementById('identity-form');
            const actionSavePersonal = document.getElementById('action-save-personal');
            const actionResetPersonal = document.getElementById('action-reset-personal');
            const actionCreateUser = document.getElementById('action-create-user');
            const actionEdit = document.getElementById('action-edit');
            const actionSaveUsuario = document.getElementById('action-save-usuario');
            const actionDelete = document.getElementById('action-delete');
            const actionNewAreas = document.getElementById('action-new-areas');
            const actionEditAreas = document.getElementById('action-edit-areas');
            const actionSaveAreas = document.getElementById('action-save-areas');
            const actionDeleteAreas = document.getElementById('action-delete-areas');
            const actionViewForm = document.getElementById('action-view-form');
            const actionViewList = document.getElementById('action-view-list');
            const actionViewKanban = document.getElementById('action-view-kanban');
            const actionViewGraph = document.getElementById('action-view-graph');
            const actionViewGantt = document.getElementById('action-view-gantt');
            const actionViewDashboard = document.getElementById('action-view-dashboard');
            const actionViewCalendar = document.getElementById('action-view-calendar');
            const actionNewTemplate = document.getElementById('action-new-template');
            const actionEditTemplate = document.getElementById('action-edit-template');
            const actionSaveTemplate = document.getElementById('action-save-template');
            const actionDeleteTemplate = document.getElementById('action-delete-template');
            const actionExportReportes = document.getElementById('action-export-reportes');
            const actionExportPdf = document.getElementById('action-export-pdf');
            const actionExportExcel = document.getElementById('action-export-excel');
            const navbarAvatarBtn = document.getElementById('navbar-avatar-btn');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutLink = document.getElementById('logout-link');
            const sidebarNotificationsTrigger = document.getElementById('sidebar-notifications-trigger');
            const sidebarNotificationsBadge = document.getElementById('sidebar-notifications-badge');
            const navbarNotificationsTrigger = document.getElementById('navbar-notifications-trigger');
            const navbarNotificationsBadge = document.getElementById('navbar-notifications-badge');
            const navbarNotificationsIcon = document.querySelector('.navbar-notifications-icon');
            const sidebarNotificationsPanel = document.getElementById('sidebar-notifications-panel');
            const sidebarNotificationsCount = document.getElementById('sidebar-notifications-count');
            const sidebarNotificationsList = document.getElementById('sidebar-notifications-list');
            const sidebarNotificationsEmpty = document.getElementById('sidebar-notifications-empty');
            const sidebarNotificationsRefresh = document.getElementById('sidebar-notifications-refresh');
            const sidebarNotificationsMarkAll = document.getElementById('sidebar-notifications-mark-all');
            const personalizationPanel = document.querySelector('.personalization-panel');
            const viewPills = document.querySelectorAll('.view-buttons .view-pill[data-view]');
            const convertFloatingIconsToMasks = () => {
                document.querySelectorAll('.floating-actions .action-button img[src$=".svg"]').forEach((img) => {
                    const src = img.getAttribute('src');
                    if (!src || img.dataset.maskApplied === '1') return;
                    const iconMask = document.createElement('span');
                    iconMask.className = 'action-icon-mask';
                    iconMask.setAttribute('aria-hidden', 'true');
                    iconMask.style.setProperty('--action-icon-url', `url("${src}")`);
                    img.dataset.maskApplied = '1';
                    img.replaceWith(iconMask);
                });
            };
            convertFloatingIconsToMasks();
            const currentUserRole = {{ request.state.user_role | default('usuario') | tojson }};
            const currentTenantId = {{ request.state.tenant_id | default('default') | tojson }};
            const activateViewButton = (view) => {
                if (!viewPills.length || !view) return;
                viewPills.forEach(pill => pill.classList.toggle('active', pill.dataset.view === view));
            };
            viewPills.forEach(pill => pill.addEventListener('click', function() {
                const targetView = pill.dataset.view;
                if (!targetView) return;
                document.dispatchEvent(new CustomEvent('backend-view-change', { detail: { view: targetView } }));
            }));
            const floatingDefaultScreen = floatingActionsWrapper?.dataset.defaultScreen || 'personalization';
            let activeFloatingScreen = floatingDefaultScreen;
            let currentUsuarioView = 'form';
            const setFloatingScreen = (screen) => {
                activeFloatingScreen = screen;
                floatingGroups.forEach(group => {
                    const isActive = group.dataset.floatingScreen === screen;
                    group.classList.toggle('active', isActive);
                    group.style.display = isActive ? 'flex' : 'none';
                });
                if (personalizationPanel) {
                    personalizationPanel.classList.toggle('hidden', screen !== 'personalization');
                }
            };
            setFloatingScreen(activeFloatingScreen);
            const usuariosFloatingGroup = document.querySelector('.floating-actions-group[data-floating-screen="usuarios"]');
            const refreshUsuarioFloating = () => {
                if (!usuariosFloatingGroup) return;
                usuariosFloatingGroup.style.display = activeFloatingScreen === 'usuarios' ? 'flex' : 'none';
            };
            refreshUsuarioFloating();

            const collapsedWidth = '0px';
            const expandedWidth = '220px';
            let isSidebarOpen = true;

            const formatRouteLabel = (route) => {
                if (!route) return '';
                return route.replace(/^\//, '/ ').replace(/-/g, ' ');
            };

            const setMenuInfo = (source) => {
                if (!source) return;
                const name = source.dataset.menuName || source.textContent.trim();
                const route = source.dataset.route || '';
                navbarMenuName.textContent = name;
                navbarRoute.textContent = formatRouteLabel(route);
                navbarRoute.href = route || source.getAttribute('href') || '#';
            };

            const updateRouteVisibility = () => {
                if (!navbarRoute) return;
                if (!isSidebarOpen) {
                    navbarRoute.style.display = 'inline-flex';
                    navbarRoute.setAttribute('aria-hidden', 'false');
                } else {
                    navbarRoute.style.display = 'none';
                    navbarRoute.setAttribute('aria-hidden', 'true');
                }
            };

            const setSidebarState = (open) => {
                const width = open ? expandedWidth : collapsedWidth;
                sidebarElem.style.width = width;
                navbar.style.marginLeft = width;
                mainContent.style.marginLeft = width;
                isSidebarOpen = open;
                updateRouteVisibility();
            };

            const toggleSidebar = () => setSidebarState(!isSidebarOpen);

            if (hamburger) {
                hamburger.addEventListener('click', toggleSidebar);
            }

            if (personalizarBtn && personalizarSubmenu && personalizarToggle) {
                personalizarBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = personalizarBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    personalizarSubmenu.style.display = isOpen ? 'flex' : 'none';
                    personalizarToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(personalizarBtn);
                    setFloatingScreen('personalization');
                });
            }
            if (diagnosticoBtn && diagnosticoSubmenu && diagnosticoToggle) {
                diagnosticoBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = diagnosticoBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    diagnosticoSubmenu.style.display = isOpen ? 'flex' : 'none';
                    diagnosticoToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(diagnosticoBtn);
                });
                const currentPath = window.location.pathname;
                const diagnosticoLinks = diagnosticoSubmenu.querySelectorAll('a[href]');
                const shouldOpenDiagnostico = Array.from(diagnosticoLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenDiagnostico) {
                    const accordion = diagnosticoBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    diagnosticoSubmenu.style.display = 'flex';
                    diagnosticoToggle.textContent = '';
                    const activeDiagnosticoLink = Array.from(diagnosticoLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeDiagnosticoLink) {
                        setMenuInfo(activeDiagnosticoLink);
                    }
                }
            }
            if (planificacionBtn && planificacionSubmenu && planificacionToggle) {
                planificacionBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = planificacionBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    planificacionSubmenu.style.display = isOpen ? 'flex' : 'none';
                    planificacionToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(planificacionBtn);
                });
                const currentPath = window.location.pathname;
                const planificacionLinks = planificacionSubmenu.querySelectorAll('a[href]');
                const shouldOpenPlanificacion = Array.from(planificacionLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenPlanificacion) {
                    const accordion = planificacionBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    planificacionSubmenu.style.display = 'flex';
                    planificacionToggle.textContent = '';
                    const activePlanificacionLink = Array.from(planificacionLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activePlanificacionLink) {
                        setMenuInfo(activePlanificacionLink);
                    }
                }
            }
            if (reportesBtn && reportesSubmenu && reportesToggle) {
                reportesBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = reportesBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    reportesSubmenu.style.display = isOpen ? 'flex' : 'none';
                    reportesToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(reportesBtn);
                    setFloatingScreen('reportes');
                });
                const currentPath = window.location.pathname;
                const reportesLinks = reportesSubmenu.querySelectorAll('a[href]');
                const shouldOpenReportes = Array.from(reportesLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenReportes) {
                    const accordion = reportesBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    reportesSubmenu.style.display = 'flex';
                    reportesToggle.textContent = '';
                    const activeReportesLink = Array.from(reportesLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeReportesLink) {
                        setMenuInfo(activeReportesLink);
                    }
                }
            }

            // Eliminado: los links ahora navegan normalmente

            if (menuLinks.length) {
                setMenuInfo(menuLinks[0]);
            }
            setSidebarState(true);
            setFloatingScreen(floatingDefaultScreen);
            if (identityForm) {
                const editButtons = document.querySelectorAll('.identity-asset-edit[data-target-input]');
                const deleteButtons = document.querySelectorAll('.identity-asset-delete[data-target-remove]');
                editButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const target = btn.getAttribute('data-target-input');
                        if (!target) return;
                        const input = document.getElementById(target);
                        const removeFlagId = target === 'favicon'
                            ? 'remove_favicon'
                            : target === 'logo_empresa'
                            ? 'remove_logo'
                            : target === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : target === 'fondo_movil'
                                    ? 'remove_mobile'
                                    : '';
                        if (removeFlagId) {
                            const removeFlag = document.getElementById(removeFlagId);
                            if (removeFlag) removeFlag.value = '0';
                        }
                        if (input) input.click();
                    });
                });
                deleteButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const targetRemove = btn.getAttribute('data-target-remove');
                        if (!targetRemove) return;
                        const flag = document.getElementById(targetRemove);
                        if (flag) flag.value = '1';
                        showMessage('Imagen marcada para eliminar. Guarda para aplicar.', 'success');
                    });
                });
                ['favicon', 'logo_empresa', 'fondo_escritorio', 'fondo_movil'].forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    input.addEventListener('change', () => {
                        if (!input.files || !input.files.length) return;
                        const removeFlagId = id === 'favicon'
                            ? 'remove_favicon'
                            : id === 'logo_empresa'
                            ? 'remove_logo'
                            : id === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : 'remove_mobile';
                        const removeFlag = document.getElementById(removeFlagId);
                        if (removeFlag) removeFlag.value = '0';
                    });
                });
            }
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            document.body.appendChild(messageBox);
            let hideTimeout;
            const showMessage = (msg, type = 'success') => {
                messageBox.textContent = msg;
                messageBox.classList.add('visible');
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    messageBox.classList.remove('visible');
                }, 2200);
            };
            const syncNavbarNotificationIconColor = (color) => {
                const value = (color || '').trim() || '#ffffff';
                document.documentElement.style.setProperty('--navbar-notifications-icon-color', value);
                if (navbarNotificationsIcon) {
                    navbarNotificationsIcon.style.background = value;
                }
            };
            const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (char) => (
                { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char] || char
            ));
            const formatNotificationDate = (value) => {
                if (!value) return '';
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return '';
                return parsed.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                });
            };
            const renderNotifications = (payload) => {
                if (!sidebarNotificationsList || !sidebarNotificationsCount || !sidebarNotificationsEmpty) return;
                const total = Number(payload?.total || 0);
                const unread = Number(payload?.unread || 0);
                const items = Array.isArray(payload?.items) ? payload.items : [];
                if (sidebarNotificationsBadge) {
                    sidebarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    sidebarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                if (navbarNotificationsBadge) {
                    navbarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    navbarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                sidebarNotificationsCount.textContent = unread > 0 ? `${unread} pendiente${unread === 1 ? '' : 's'}` : 'Sin pendientes';
                if (!items.length) {
                    sidebarNotificationsList.innerHTML = '';
                    sidebarNotificationsEmpty.style.display = 'block';
                    return;
                }
                sidebarNotificationsEmpty.style.display = 'none';
                sidebarNotificationsList.innerHTML = items.map((item) => {
                    const href = item.href || '#';
                    const itemClass = item.read ? 'notification-item read' : 'notification-item';
                    const notificationId = escapeHtml(item.id || '');
                    return `
                        <li>
                            <a class="${itemClass}" href="${escapeHtml(href)}" data-notification-id="${notificationId}">
                                <div class="notification-item-title">${escapeHtml(item.title || 'Notificacin')}</div>
                                <div class="notification-item-msg">${escapeHtml(item.message || '')}</div>
                                <div class="notification-item-date">${escapeHtml(formatNotificationDate(item.created_at))}</div>
                            </a>
                        </li>
                    `;
                }).join('');
            };
            const markNotificationRead = async (notificationId) => {
                if (!notificationId) return;
                await fetch('/api/notificaciones/marcar-leida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: notificationId }),
                });
            };
            const markAllNotificationsRead = async (notificationIds) => {
                if (!Array.isArray(notificationIds) || !notificationIds.length) return;
                await fetch('/api/notificaciones/marcar-todas-leidas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: notificationIds }),
                });
            };
            const loadNotifications = async (silent = true) => {
                if (!sidebarNotificationsList) return;
                try {
                    const res = await fetch('/api/notificaciones/resumen', { headers: { 'Accept': 'application/json' } });
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) {
                        throw new Error(payload?.error || 'No se pudieron cargar las notificaciones');
                    }
                    renderNotifications(payload);
                } catch (error) {
                    if (!silent) {
                        showMessage(error.message || 'No se pudieron cargar las notificaciones', 'error');
                    }
                }
            };
            let guardarColores = () => {};
            let restablecerColores = () => {};
            if (personalizationPanel) {
                const colorInputs = [
                    'navbar-bg','navbar-text','sidebar-top','sidebar-bottom','sidebar-text',
                    'field-color',
                    'sidebar-icon','sidebar-hover'
                ];
                const colorDefaults = {};
                const updatePreview = (id, value) => {
                    const preview = document.getElementById(id + '-preview');
                    if (preview) preview.style.background = value;
                };
                const normalizeHex = (hex) => {
                    const cleaned = (hex || '').trim().replace('#', '');
                    if (cleaned.length === 3) {
                        return cleaned.split('').map(char => char + char).join('');
                    }
                    return cleaned;
                };
                const hexToRgba = (hex, alpha = 1) => {
                    const normalized = normalizeHex(hex);
                    if (!/^[0-9A-Fa-f]{6}$/.test(normalized)) return hex;
                    const r = parseInt(normalized.slice(0, 2), 16);
                    const g = parseInt(normalized.slice(2, 4), 16);
                    const b = parseInt(normalized.slice(4, 6), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                function applyColors() {
                    const navbar = document.querySelector('.navbar');
                    const navbarBg = document.getElementById('navbar-bg');
                    const navbarText = document.getElementById('navbar-text');
                    const sidebarTop = document.getElementById('sidebar-top');
                    const sidebarBottom = document.getElementById('sidebar-bottom');
                    const sidebarText = document.getElementById('sidebar-text');
                    const fieldColor = document.getElementById('field-color');
                    const sidebarIcon = document.getElementById('sidebar-icon');
                    const sidebarHover = document.getElementById('sidebar-hover');
                    if (navbarBg && navbar) {
                        navbar.style.background = navbarBg.value;
                    }
                    if (navbarText && navbar) {
                        navbar.style.color = navbarText.value;
                        const hamburger = document.querySelector('.navbar-hamburger');
                        if (hamburger) {
                            hamburger.style.color = navbarText.value;
                        }
                    }
                    if (sidebarTop && sidebarElem) {
                        if (sidebarBottom && sidebarBottom.value) {
                            sidebarElem.style.background = `linear-gradient(180deg, ${sidebarTop.value} 0%, ${sidebarBottom.value} 100%)`;
                        } else {
                            sidebarElem.style.background = sidebarTop.value;
                        }
                    }
                    if (sidebarText && sidebarElem) {
                        sidebarElem.style.color = sidebarText.value;
                        document.documentElement.style.setProperty('--sidebar-text', sidebarText.value);
                        syncNavbarNotificationIconColor(sidebarText.value);
                    } else {
                        syncNavbarNotificationIconColor(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-text'));
                    }
                    if (sidebarIcon) {
                        document.querySelectorAll('.menu-icon svg path').forEach(path => {
                            path.setAttribute('stroke', sidebarIcon.value);
                        });
                    }
                    if (sidebarHover) {
                        document.querySelectorAll('.sidebar nav a:hover').forEach(link => {
                            link.style.background = sidebarHover.value;
                        });
                    }
                    if (fieldColor) {
                        document.documentElement.style.setProperty('--field-color', fieldColor.value);
                    }
                    const bottomColor = (sidebarBottom && sidebarBottom.value) || '#0f172a';
                    const textColor = (sidebarText && sidebarText.value) || '#ffffff';
                    document.documentElement.style.setProperty('--page-title-color', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-border', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-bg', textColor);
                    document.documentElement.style.setProperty('--view-pill-text', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-icon', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-bg', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-text', textColor);
                    document.documentElement.style.setProperty('--view-pill-hover-icon', textColor);
                    if (floatingActions) {
                        floatingActions.style.background = textColor;
                        floatingActions.style.borderColor = bottomColor;
                        floatingActions.style.setProperty('--floating-panel-bg', textColor);
                        floatingActions.style.setProperty('--floating-icon-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-text-color', textColor);
                        floatingActions.style.setProperty('--floating-action-border', bottomColor);
                        floatingActions.style.setProperty('--floating-action-text', bottomColor);
                        floatingActions.style.setProperty('--floating-action-bg', textColor);
                        floatingActions.style.color = bottomColor;
                    }
                    if (floatingToggle) {
                        floatingToggle.style.borderColor = bottomColor;
                        floatingToggle.style.background = bottomColor;
                        floatingToggle.style.color = textColor;
                    }
                }
                colorInputs.forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    colorDefaults[id] = input.value;
                    input.dataset.default = input.value;
                    updatePreview(id, input.value);
                    input.addEventListener('input', function() {
                        updatePreview(id, input.value);
                        applyColors();
                    });
                });
                async function cargarColoresGuardados() {
                    try {
                        const res = await fetch('/guardar-colores', { method: 'GET' });
                        if (!res.ok) return;
                        const json = await res.json();
                        if (json && json.success && json.data) {
                            colorInputs.forEach(function(id) {
                                if (json.data[id]) {
                                    const input = document.getElementById(id);
                                    if (input) {
                                        input.value = json.data[id];
                                        updatePreview(id, input.value);
                                    }
                                }
                            });
                            applyColors();
                        }
                    } catch (e) {
                        // Ignorar errores de carga
                    }
                }
                await cargarColoresGuardados();
                applyColors();
                guardarColores = function() {
                    const data = {};
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (input) data[id] = input.value;
                    });
                    fetch('/guardar-colores', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async res => {
                        if (!res.ok) {
                            const text = await res.text();
                            console.error('Error backend:', text);
                            throw new Error(text);
                        }
                        return res.json();
                    })
                    .then(json => {
                        if (json && json.success) {
                            showMessage('Colores guardados exitosamente.', 'success');
                        } else {
                            showMessage('Error al guardar los colores: ' + (json && json.error ? json.error : ''), 'error');
                            console.error('Respuesta backend:', json);
                        }
                    })
                    .catch(err => {
                        showMessage('Error al guardar los colores.', 'error');
                        console.error('Error fetch:', err);
                    });
                };
                restablecerColores = function() {
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.value = colorDefaults[id] || input.defaultValue;
                        updatePreview(id, input.value);
                    });
                    applyColors();
                    showMessage('Colores restablecidos.', 'success');
                };
            }
            let actionsVisible = true;
            const updateToggle = () => {
                if (!floatingToggle || !floatingActions) return;
            floatingToggle.textContent = actionsVisible ? '' : '+';
            floatingToggle.setAttribute('aria-label', actionsVisible ? 'Ocultar barra flotante' : 'Mostrar barra flotante');
            floatingActions.classList.toggle('hidden', !actionsVisible);
        };
            const ensureFloatingVisible = () => {
                actionsVisible = true;
                updateToggle();
            };
            floatingToggle && floatingToggle.addEventListener('click', () => {
                actionsVisible = !actionsVisible;
                updateToggle();
            });
            updateToggle();
            const usuarioView = document.getElementById('usuario-view');
            const usuarioTabs = document.querySelectorAll('.usuario-tab');
            const usuarioLinks = document.querySelectorAll('.usuario-view-link');
            const areaView = document.getElementById('area-view');
            const areaTabs = document.querySelectorAll('.area-tab');
            const usuarioData = [
                { name: 'Adriana Chvez Galeana', role: 'Gerente', department: 'Operaciones', status: 'Activo', email: 'a.galeana@empresa.com' },
                { name: 'Luca Ortega Moreno', role: 'Analista', department: 'KPIs', status: 'En mejora', email: 'l.ortega@empresa.com' },
                { name: 'Mara Delgado', role: 'Ejecutivo', department: 'Servicios', status: 'Activo', email: 'm.delgado@empresa.com' },
                { name: 'Pablo Rojas', role: 'Analista', department: 'Planeacin', status: 'Observando', email: 'p.rojas@empresa.com' }
            ];
            let areasData = [
                { name: 'Direccin General', parent: 'N/A', manager: 'Adriana Chvez Galeana', code: 'DIR-001', color: '#0f172a', status: 'Estratgico' },
                { name: 'Operaciones', parent: 'Direccin General', manager: 'Pablo Rojas', code: 'OPE-010', color: '#1d4ed8', status: 'Activo' },
                { name: 'Planeacin', parent: 'Direccin General', manager: 'Luca Ortega Moreno', code: 'PLA-020', color: '#0ea5e9', status: 'Activo' },
                { name: 'Servicios', parent: 'Operaciones', manager: 'Mara Delgado', code: 'SER-030', color: '#16a34a', status: 'En revisin' }
            ];
            const defaultKanbanImage = '/templates/icon/fondo.svg';
            let usuariosImagenStore = [];
            const normalizeImagePath = (value) => {
                const raw = String(value || '').trim();
                if (!raw) return '';
                if (raw.startsWith('http://') || raw.startsWith('https://') || raw.startsWith('/')) {
                    return raw;
                }
                return `/templates/imagenes/${raw}`;
            };
            const getPersonImage = (person) => {
                if (!person || typeof person !== 'object') return defaultKanbanImage;
                const direct = person.image || person.photo || person.avatar || person.foto || person.imagen || '';
                if (typeof direct === 'string' && direct.trim()) return normalizeImagePath(direct);
                return defaultKanbanImage;
            };
            const enrichUsuarioImages = (usuarios = []) => {
                if (!Array.isArray(usuarios) || !usuarios.length) return;
                usuarios.forEach((u) => {
                    if (!u || typeof u !== 'object') return;
                    const nombre = String(u.nombre || '').trim();
                    if (!nombre) return;
                    const image = u.imagen || u.foto || u.image || u.avatar || '';
                    const normalizedImage = (typeof image === 'string' && image.trim()) ? normalizeImagePath(image) : '';
                    const idx = usuarioData.findIndex((item) => item.name === nombre);
                    if (idx >= 0) {
                        if (normalizedImage) usuarioData[idx].image = normalizedImage;
                    } else {
                        usuarioData.push({
                            name: nombre,
                            role: String(u.rol || 'Usuario'),
                            department: 'N/A',
                            status: 'Activo',
                            email: String(u.correo || ''),
                            image: normalizedImage || '',
                        });
                    }
                });
            };
            const hydrateAreasFromUsuarios = (usuarios = []) => {
                if (!Array.isArray(usuarios) || !usuarios.length) return;
                const grouped = new Map();
                usuarios.forEach((u) => {
                    const dept = String(u?.departamento || u?.department || '').trim();
                    if (!dept) return;
                    if (!grouped.has(dept)) grouped.set(dept, []);
                    grouped.get(dept).push(u);
                });
                const names = Array.from(grouped.keys());
                if (!names.length) return;
                const rootName = names.find((name) => name.toLowerCase() === 'direccin general' || name.toLowerCase() === 'direccion general') || names[0];
                const nextAreas = names.map((name, index) => {
                    const users = grouped.get(name) || [];
                    const managerCandidate = users.find((u) => {
                        const rol = String(u?.rol || '').toLowerCase();
                        const puesto = String(u?.puesto || '').toLowerCase();
                        return rol.includes('admin') || rol.includes('gerente') || puesto.includes('gerente') || puesto.includes('director');
                    }) || users[0] || {};
                    return {
                        name,
                        parent: name === rootName ? 'N/A' : rootName,
                        manager: String(managerCandidate?.nombre || managerCandidate?.name || 'Sin asignar'),
                        code: `DEP-${String(index + 1).padStart(3, '0')}`,
                        color: '#1d4ed8',
                        status: name === rootName ? 'Estratgico' : 'Activo',
                    };
                });
                if (nextAreas.length) {
                    areasData = nextAreas;
                }
            };
            const loadUsuariosImagenes = async () => {
                try {
                    const res = await fetch('/api/usuarios');
                    if (!res.ok) return;
                    const json = await res.json();
                    const data = Array.isArray(json?.data) ? json.data : [];
                    usuariosImagenStore = data;
                    enrichUsuarioImages(usuariosImagenStore);
                    hydrateAreasFromUsuarios(usuariosImagenStore);
                } catch (error) {
                    // Si falla, mantener fallback local/default.
                }
            };
            const getManagerImage = (managerName) => {
                const manager = usuarioData.find((user) => user.name === managerName);
                return getPersonImage(manager);
            };
            const relacionOrganizacionalHelp = {
                'Lnea': (
                    '1. Relacin de Lnea (Ejecutiva)\n'
                    + 'Es la relacin jerrquica directa que sigue la cadena de mando desde la Gerencia General hacia las reas operativas.\n\n'
                    + 'Naturaleza: Es una autoridad de decisin y ejecucin.\n\n'
                    + 'En la empresa: La relacin entre la Gerencia de Crditos y sus analistas o agencias. '
                    + 'Estas reas son responsables directas de los resultados del negocio y del cumplimiento de metas financieras.'
                ),
                'Staff': (
                    '2. Relacin de Staff (Asesora)\n'
                    + 'El Staff no tiene autoridad directa de mando sobre las reas de lnea, sino una funcin de apoyo especializado.\n\n'
                    + 'Naturaleza: Es una autoridad de especializacin, consejo y servicio. Su objetivo es facilitar el trabajo de la lnea mediante el expertise tcnico.\n\n'
                    + 'Por ejemplo:\n'
                    + '- Asesora Jurdica: Provee el marco legal para los contratos, pero no decide a quin se le otorga un crdito.\n'
                    + '- Gestin de Talento Humano: Define polticas de reclutamiento, pero la decisin final de contratacin suele recaer en el jefe del rea solicitante.\n'
                    + '- Auditora Interna: Aunque es Staff, su reporte suele ser directo al Consejo de Administracin para garantizar independencia.'
                ),
                'Funcional': (
                    '3. Relacin Funcional (Especializada)\n'
                    + 'Es un punto intermedio donde un rea tcnica tiene autoridad limitada sobre otros departamentos en temas especficos de su competencia, independientemente de la jerarqua.\n\n'
                    + 'Naturaleza: Autoridad de normatividad y control.\n\n'
                    + 'Por ejemplo: El oficial de cumplimiento de Normatividad. Aunque no es el jefe de un gerente de agencia, '
                    + 'tiene la autoridad funcional para exigir que se cumplan los protocolos de prevencin de lavado de dinero, '
                    + 'y su instruccin es de acatamiento obligatorio.'
                ),
            };
            const getAreaNamesDisponibles = () => [...new Set(areasData.map(area => area.name).filter(Boolean))];
            const getUsuarioRolesFiltro = () => ['Todos', ...new Set(usuarioData.map(u => u.role))];
            let rolesSistemaDisponibles = [
                { value: 'usuario', label: 'Usuario' },
                { value: 'departamento', label: 'Departamento' },
            ];
            let selectedUsuarioName = null;
            let createUsuarioMode = false;
            const departamentosDisponibles = [...new Set(usuarioData.map(u => u.department).filter(Boolean))];
            const roleMatches = (userRole, selectedRole) => {
                const left = String(userRole || '').trim().toLowerCase();
                const right = String(selectedRole || '').trim().toLowerCase();
                return left === right;
            };
            const escapeHtmlAttr = (value) => String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            const getRoleOptions = (selected = 'Todos') => {
                return getUsuarioRolesFiltro().map(role => `<option value="${role}" ${role === selected ? 'selected' : ''}>${role}</option>`).join('');
            };
            const getUsuarioRolOptions = (selected = '') => {
                return rolesSistemaDisponibles.map(role => `<option value="${role.value}" ${role.value === selected ? 'selected' : ''}>${role.label}</option>`).join('');
            };
            const getDepartamentoOptions = (selected = '') => {
                return departamentosDisponibles.map(dept => `<option value="${dept}" ${dept === selected ? 'selected' : ''}>${dept}</option>`).join('');
            };
            const getAreaParentOptions = (selected = '') => {
                const areaNamesDisponibles = getAreaNamesDisponibles();
                const options = ['N/A', ...areaNamesDisponibles];
                return options.map((name) => `<option value="${name}" ${name === selected ? 'selected' : ''}>${name}</option>`).join('');
            };
            const openUsuarioInForm = (userName) => {
                const normalized = String(userName || '').trim();
                if (!normalized) return;
                createUsuarioMode = false;
                selectedUsuarioName = normalized;
                setUsuarioView('form');
            };
            const bindUsuarioSelectableCards = () => {
                if (!usuarioView) return;
                usuarioView.querySelectorAll('[data-usuario-name]').forEach((item) => {
                    item.addEventListener('click', () => {
                        openUsuarioInForm(item.getAttribute('data-usuario-name'));
                    });
                });
            };
            const loadRolesSistemaDisponibles = async () => {
                try {
                    const res = await fetch('/api/roles-disponibles');
                    if (!res.ok) return;
                    const json = await res.json();
                    const data = Array.isArray(json?.data) ? json.data : [];
                    if (!data.length) return;
                    rolesSistemaDisponibles = data.map((role) => {
                        const value = String(role?.nombre || '').trim().toLowerCase();
                        const label = String(role?.label || role?.nombre || '').trim();
                        return { value, label };
                    }).filter((role) => role.value);
                } catch (error) {
                    // Mantener fallback local si falla.
                }
            };
            function renderUsuarioForm() {
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const roleCount = new Set(usuarioData.map((user) => user.role).filter(Boolean)).size;
                const selectedUser = createUsuarioMode
                    ? {}
                    : (usuarioData.find((user) => String(user.name || '').trim() === String(selectedUsuarioName || '').trim()) || usuarioData[0] || {});
                const selectedName = escapeHtmlAttr(selectedUser.name || '');
                const selectedEmail = escapeHtmlAttr(selectedUser.email || '');
                const selectedRole = String(selectedUser.role || 'Usuario');
                const selectedRoleValue = slugifyText(selectedRole).replace(/-/g, '_').toLowerCase();
                const selectedDepartmentRaw = selectedUser.department || '';
                const selectedDepartment = escapeHtmlAttr(selectedDepartmentRaw);
                const selectedStatus = escapeHtmlAttr(selectedUser.status || 'Activo');
                const selectedImage = getPersonImage(selectedUser);
                const loginValue = escapeHtmlAttr((String(selectedUser.email || '').split('@')[0]) || slugifyText(selectedUser.name || '').replace(/-/g, '_'));
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Usuarios activos</span></article>
                            <article class="usuario-stat"><strong>${roleCount}</strong><span>Roles en uso</span></article>
                        </section>
                        <section class="ar-grid">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Gestion de usuarios</h2>
                                        <p>Registra perfiles, asigna roles y configura su estructura organizacional.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill ar-pill--soft">Usuario activo</span>
                                        <span class="ar-pill">${totalUsers} usuarios</span>
                                    </div>
                                </header>
                                <form class="ar-form">
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Nombre</label>
                                            <input type="text" id="usuario-nombre" placeholder="Nombre completo" value="${selectedName}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Usuario</label>
                                            <input type="text" id="usuario-usuario" placeholder="Nombre de usuario" value="${loginValue}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Correo electronico</label>
                                            <input type="email" id="usuario-correo" placeholder="usuario@empresa.com" value="${selectedEmail}">
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Contrasena</label>
                                            <input type="password" id="usuario-password" placeholder="********">
                                        </div>
                                        <div class="ar-field">
                                            <label>Rol</label>
                                            <select id="usuario-rol">
                                                <option value="">Selecciona un rol</option>
                                                ${getUsuarioRolOptions(selectedRoleValue || 'usuario')}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Estado</label>
                                            <select id="usuario-estado">
                                                <option value="Activo" ${selectedStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                                <option value="En mejora" ${selectedStatus === 'En mejora' ? 'selected' : ''}>En mejora</option>
                                                <option value="Observando" ${selectedStatus === 'Observando' ? 'selected' : ''}>Observando</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Departamento</label>
                                            <select id="usuario-departamento-select">
                                                <option value="">Selecciona un departamento</option>
                                                ${getDepartamentoOptions(selectedDepartmentRaw)}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Jefe inmediato</label>
                                            <select id="usuario-jefe-select">
                                                <option value="">Selecciona un jefe inmediato</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Direccion</label>
                                            <input type="text" placeholder="Direccion">
                                        </div>
                                        <div class="ar-field">
                                            <label>Telefono</label>
                                            <input type="text" placeholder="+52 55 0000 0000">
                                        </div>
                                    </div>
                                    <div class="ar-actions">
                                        <button type="button" class="ar-btn ar-btn--soft" id="usuario-form-cancel">Cancelar</button>
                                        <button type="button" class="ar-btn ar-btn--primary2" id="usuario-form-save">Guardar</button>
                                    </div>
                                </form>
                            </section>
                            <aside class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Resumen</h2>
                                        <p>Perfil y asignacion organizacional del usuario.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill">${escapeHtmlAttr(selectedRole || 'Usuario')}</span>
                                    </div>
                                </header>
                                <div class="ar-summary">
                                    <div class="ar-summary__top">
                                        <div class="ar-avatar" aria-hidden="true">
                                            <img src="${selectedImage}" alt="Foto de ${selectedName || 'Usuario'}" class="ar-user-photo">
                                        </div>
                                        <div>
                                            <div class="ar-summary__name">${selectedName || 'Sin asignar'}</div>
                                            <div class="ar-summary__meta">
                                                <span class="ar-badge ${selectedStatus === 'Activo' ? 'ar-badge--ok' : ''}">${selectedStatus}</span>
                                                <span class="ar-badge">${escapeHtmlAttr(selectedRole || 'Usuario')}</span>
                                                <span class="ar-badge">${selectedDepartment || 'Sin departamento'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-miniGrid">
                                        <div class="ar-mini"><div class="ar-mini__k">Correo</div><div class="ar-mini__v">${selectedEmail || 'No registrado'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Departamento</div><div class="ar-mini__v">${selectedDepartment || 'N/A'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Usuarios activos</div><div class="ar-mini__v">${activeUsers}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Roles en uso</div><div class="ar-mini__v">${roleCount}</div></div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-links">
                                        <button class="ar-link" type="button">Ver permisos del rol</button>
                                        <button class="ar-link" type="button">Abrir en organigrama</button>
                                        <button class="ar-link" type="button">Revisar historial</button>
                                    </div>
                                </div>
                            </aside>
                        </section>
                    </section>
                    <div class="password-confirm-backdrop hidden" id="password-confirm-backdrop">
                        <div class="password-confirm-modal" role="dialog" aria-modal="true" aria-label="Confirmar contrasena">
                            <h3>Confirmar contrasena</h3>
                            <input type="password" id="usuario-confirm-password" placeholder="Repite la contrasena">
                            <div class="password-confirm-actions">
                                <button type="button" id="password-confirm-cancel">Cancelar</button>
                                <button type="button" class="primary" id="password-confirm-ok">Confirmar</button>
                            </div>
                            <p class="password-confirm-msg" id="password-confirm-msg"></p>
                        </div>
                    </div>
                `;
                const departamentoSelect = usuarioView.querySelector('#usuario-departamento-select');
                const jefeSelect = usuarioView.querySelector('#usuario-jefe-select');
                const refreshJefes = (department) => {
                    if (!jefeSelect) return;
                    const options = usuarioData
                        .filter(user => user.department === department)
                        .map(user => `<option value="${user.name}">${user.name}</option>`)
                        .join('');
                    jefeSelect.innerHTML = `<option value="">Selecciona un jefe inmediato</option>${options}`;
                };
                if (departamentoSelect) {
                    departamentoSelect.addEventListener('change', () => refreshJefes(departamentoSelect.value));
                    departamentoSelect.value = selectedDepartmentRaw;
                    refreshJefes(departamentoSelect.value);
                }
                const rolInput = usuarioView.querySelector('#usuario-rol');
                if (rolInput) {
                    const normalizedRole = String(selectedRole || '').trim().toLowerCase();
                    const roleOption = Array.from(rolInput.options).find((opt) => String(opt.value || '').trim().toLowerCase() === normalizedRole);
                    if (roleOption) rolInput.value = roleOption.value;
                }
                selectedUsuarioName = null;
                const passwordInput = usuarioView.querySelector('#usuario-password');
                const passwordConfirmBackdrop = usuarioView.querySelector('#password-confirm-backdrop');
                const passwordConfirmInput = usuarioView.querySelector('#usuario-confirm-password');
                const passwordConfirmOk = usuarioView.querySelector('#password-confirm-ok');
                const passwordConfirmCancel = usuarioView.querySelector('#password-confirm-cancel');
                const passwordConfirmMsg = usuarioView.querySelector('#password-confirm-msg');
                let passwordConfirmed = false;
                const openPasswordModal = () => {
                    if (!passwordConfirmBackdrop || !passwordConfirmInput) return;
                    passwordConfirmBackdrop.classList.remove('hidden');
                    passwordConfirmInput.value = '';
                    if (passwordConfirmMsg) passwordConfirmMsg.textContent = '';
                    setTimeout(() => passwordConfirmInput.focus(), 0);
                };
                const closePasswordModal = () => {
                    if (!passwordConfirmBackdrop) return;
                    passwordConfirmBackdrop.classList.add('hidden');
                };
                if (passwordInput) {
                    passwordInput.addEventListener('input', () => {
                        passwordConfirmed = false;
                    });
                    passwordInput.addEventListener('blur', () => {
                        const value = (passwordInput.value || '').trim();
                        if (!value || passwordConfirmed) return;
                        openPasswordModal();
                    });
                }
                passwordConfirmCancel && passwordConfirmCancel.addEventListener('click', () => {
                    passwordConfirmed = false;
                    closePasswordModal();
                });
                passwordConfirmOk && passwordConfirmOk.addEventListener('click', () => {
                    if (!passwordInput || !passwordConfirmInput) return;
                    if (passwordConfirmInput.value !== passwordInput.value) {
                        if (passwordConfirmMsg) passwordConfirmMsg.textContent = 'Las contrasenas no coinciden.';
                        return;
                    }
                    passwordConfirmed = true;
                    closePasswordModal();
                    showMessage('Contrasena confirmada.', 'success');
                });
                const formSaveBtn = usuarioView.querySelector('#usuario-form-save');
                const formCancelBtn = usuarioView.querySelector('#usuario-form-cancel');
                formSaveBtn && formSaveBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    actionSaveUsuario && actionSaveUsuario.click();
                });
                formCancelBtn && formCancelBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    createUsuarioMode = false;
                    selectedUsuarioName = null;
                    setUsuarioView('list');
                });
            }
            function renderUsuarioList(role = 'Todos') {
                const filtered = role === 'Todos' ? usuarioData : usuarioData.filter(u => roleMatches(u.role, role));
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const inReview = usuarioData.filter((user) => user.status !== 'Activo').length;
                const statusBadgeClass = (status) => {
                    if (status === 'Activo') return 'ar-badge--ok';
                    if (status === 'En mejora') return 'ar-badge--warn';
                    return '';
                };
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Activos</span></article>
                            <article class="usuario-stat"><strong>${inReview}</strong><span>En mejora u observacion</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Listado de usuarios</h2>
                                    <p>Consulta perfiles por rol y monitorea su estado operativo.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${filtered.length} resultados</span>
                                    <div class="ar-field">
                                        <select id="usuario-role-select">
                                            ${getRoleOptions(role)}
                                        </select>
                                    </div>
                                </div>
                            </header>
                            <div class="ar-user-list">
                                ${filtered.length ? filtered.map(user => `
                                    <button type="button" class="ar-user-item usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}">
                                        <div class="ar-user-item__main">
                                            <div class="ar-avatar">
                                                <img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo">
                                            </div>
                                            <div>
                                                <strong>${escapeHtmlAttr(user.name)}</strong>
                                                <div class="ar-user-item__sub">${escapeHtmlAttr(user.department)}</div>
                                            </div>
                                        </div>
                                        <div class="ar-summary__meta">
                                            <span class="ar-badge">${escapeHtmlAttr(user.role)}</span>
                                            <span class="ar-badge ${statusBadgeClass(user.status)}">${escapeHtmlAttr(user.status)}</span>
                                        </div>
                                    </button>
                                `).join('') : '<p class="ar-empty">No hay usuarios para este rol.</p>'}
                            </div>
                        </section>
                    </section>
                `;
                const selector = document.getElementById('usuario-role-select');
                selector && selector.addEventListener('change', () => renderUsuarioList(selector.value));
                bindUsuarioSelectableCards();
            }
            function renderUsuarioKanban(role = 'Todos') {
                const filtered = role === 'Todos' ? usuarioData : usuarioData.filter(u => roleMatches(u.role, role));
                const statuses = ['Activo', 'En mejora', 'Observando'];
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const observingUsers = usuarioData.filter((user) => user.status === 'Observando').length;
                const accentByStatus = (status) => {
                    if (status === 'Activo') return '#1f6f52';
                    if (status === 'En mejora') return '#f59e0b';
                    return '#2563eb';
                };
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Activos</span></article>
                            <article class="usuario-stat"><strong>${observingUsers}</strong><span>Observando</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Kanban de usuarios</h2>
                                    <p>Distribucion visual del equipo por estado para seguimiento rapido.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${filtered.length} visibles</span>
                                    <div class="ar-field">
                                        <select id="usuario-role-select-kanban">
                                            ${getRoleOptions(role)}
                                        </select>
                                    </div>
                                </div>
                            </header>
                            <div class="ar-kanban">
                                ${statuses.map(status => `
                                    <div class="ar-col">
                                        <div class="ar-col__head">
                                            <div>
                                                <strong>${status}</strong>
                                                <span class="ar-col__count">${filtered.filter(u => u.status === status).length}</span>
                                            </div>
                                        </div>
                                        <div class="ar-col__body">
                                            ${(filtered.filter(u => u.status === status)).length
                                                ? filtered.filter(u => u.status === status).map(user => `
                                                    <article class="ar-kcard usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:${accentByStatus(status)}">
                                                        <div class="ar-kcard__accent"></div>
                                                        <div class="ar-kcard__top">
                                                            <div class="ar-klogo">
                                                                <img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}">
                                                            </div>
                                                            <div class="ar-kcard__main">
                                                                <div class="ar-kcard__title">${escapeHtmlAttr(user.name)}</div>
                                                                <div class="ar-kcard__sub">${escapeHtmlAttr(user.department)}</div>
                                                                <div class="ar-kcard__person">${escapeHtmlAttr(user.role)}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ar-kcard__foot">
                                                            <span class="ar-badge">${escapeHtmlAttr(user.role)}</span>
                                                            <span class="ar-badge">${status}</span>
                                                        </div>
                                                    </article>
                                                `).join('')
                                                : '<p class="ar-empty">Sin usuarios en esta columna.</p>'
                                            }
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </section>
                `;
                const selector = document.getElementById('usuario-role-select-kanban');
                selector && selector.addEventListener('change', () => renderUsuarioKanban(selector.value));
                bindUsuarioSelectableCards();
            }
            function renderUsuarioOrganigrama() {
                const lider = usuarioData[0];
                const mandos = usuarioData.slice(1, 3);
                const equipoBase = usuarioData.slice(3);
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>1</strong><span>Nivel directivo</span></article>
                            <article class="usuario-stat"><strong>${mandos.length}</strong><span>Mandos medios</span></article>
                            <article class="usuario-stat"><strong>${equipoBase.length}</strong><span>Equipo base</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Organigrama de usuarios</h2>
                                    <p>Cadena de mando y distribucion por niveles dentro de la organizacion.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${usuarioData.length} usuarios</span>
                                </div>
                            </header>
                            <div class="ar-org">
                                <div class="ar-org__level">
                                    <article class="ar-node usuario-selectable" data-usuario-name="${escapeHtmlAttr(lider?.name || '')}" style="--accent:#0f3d2e">
                                        <div class="ar-node__badge">Nivel 1</div>
                                        <div class="ar-node__logo"><img src="${getPersonImage(lider)}" alt="Foto de ${escapeHtmlAttr(lider?.name || 'Direccion General')}" class="ar-user-photo"></div>
                                        <div class="ar-node__title">Direccion General</div>
                                        <div class="ar-node__sub">${escapeHtmlAttr(lider?.name || 'Sin asignar')}</div>
                                        <div class="ar-node__code">${escapeHtmlAttr(lider?.role || 'N/A')}</div>
                                    </article>
                                </div>
                                <div class="ar-org__pipe" aria-hidden="true"></div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${mandos.map(user => `
                                        <article class="ar-node usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:#1f6f52">
                                            <div class="ar-node__badge">Nivel 2</div>
                                            <div class="ar-node__logo"><img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo"></div>
                                            <div class="ar-node__title">${escapeHtmlAttr(user.department)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(user.name)}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(user.role)}</div>
                                        </article>
                                    `).join('')}
                                </div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${equipoBase.map(user => `
                                        <article class="ar-node usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:#2563eb">
                                            <div class="ar-node__badge">Base</div>
                                            <div class="ar-node__logo"><img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo"></div>
                                            <div class="ar-node__title">${escapeHtmlAttr(user.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(user.department)}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(user.role)}</div>
                                        </article>
                                    `).join('')}
                                </div>
                            </div>
                        </section>
                    </section>
                `;
                bindUsuarioSelectableCards();
            }
            function renderAreaForm() {
                if (!areaView) return;
                const areaCount = areasData.length;
                const parentCount = new Set(areasData.map(area => area.parent).filter(parent => parent && parent !== 'N/A')).size;
                const strategicCount = areasData.filter(area => area.status === 'Estratgico').length;
                const selectedArea = areasData.find(area => area.status === 'Activo') || areasData[0] || {};
                const selectedNameRaw = selectedArea.name || '';
                const selectedParentRaw = selectedArea.parent || 'N/A';
                const selectedManagerRaw = selectedArea.manager || '';
                const selectedCodeRaw = selectedArea.code || '';
                const selectedName = escapeHtmlAttr(selectedNameRaw);
                const selectedParent = escapeHtmlAttr(selectedParentRaw);
                const selectedManager = escapeHtmlAttr(selectedManagerRaw);
                const selectedCode = escapeHtmlAttr(selectedCodeRaw);
                const selectedColor = String(selectedArea.color || '#0f3d2e');
                const selectedStatus = escapeHtmlAttr(selectedArea.status || 'Activo');
                const relation = selectedStatus === 'Estratgico' ? 'Lnea' : (selectedStatus === 'En revisin' ? 'Funcional' : 'Lnea');
                const safeRelation = escapeHtmlAttr(relation);
                const hexLabel = /^#[0-9a-fA-F]{6}$/.test(selectedColor) ? selectedColor.toUpperCase() : '#0F3D2E';
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-grid">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Datos del rea</h2>
                                        <p>Completa la informacin base y define su relacin organizacional.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill ar-pill--soft">Registro activo</span>
                                        <span class="ar-pill">${areaCount} reas</span>
                                    </div>
                                </header>
                                <form class="ar-form">
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Nombre</label>
                                            <input type="text" placeholder="Nombre del rea" value="${selectedName}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Departamento padre</label>
                                            <select id="area-parent-select">
                                                ${getAreaParentOptions(selectedParentRaw)}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Responsable</label>
                                            <input type="text" placeholder="Nombre del responsable" value="${selectedManager}">
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Relacin organizacional</label>
                                            <select id="area-relacion-select">
                                                <option value="Lnea" ${safeRelation === 'Lnea' ? 'selected' : ''}>Lnea</option>
                                                <option value="Staff" ${safeRelation === 'Staff' ? 'selected' : ''}>Staff</option>
                                                <option value="Funcional" ${safeRelation === 'Funcional' ? 'selected' : ''}>Funcional</option>
                                            </select>
                                            <div class="ar-chips">
                                                <button class="ar-chip ${safeRelation === 'Lnea' ? 'is-active' : ''}" type="button" data-relacion-help="Lnea">Lnea <span class="ar-q">?</span></button>
                                                <button class="ar-chip ${safeRelation === 'Staff' ? 'is-active' : ''}" type="button" data-relacion-help="Staff">Staff <span class="ar-q">?</span></button>
                                                <button class="ar-chip ${safeRelation === 'Funcional' ? 'is-active' : ''}" type="button" data-relacion-help="Funcional">Funcional <span class="ar-q">?</span></button>
                                            </div>
                                        </div>
                                        <div class="ar-field">
                                            <label>Cdigo</label>
                                            <input type="text" placeholder="Ej: OPE-010" value="${selectedCode}">
                                            <div class="ar-help">Recomendado: prefijo + consecutivo (ej. OPE-010).</div>
                                        </div>
                                        <div class="ar-field">
                                            <label>Color</label>
                                            <div class="ar-color">
                                                <input type="color" value="${selectedColor}">
                                                <span class="ar-color__swatch" style="--c:${selectedColor}"></span>
                                                <span class="ar-color__txt">${hexLabel}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Descripcin</label>
                                            <textarea placeholder="Describe el propsito del rea">Responsable de la operacin diaria y ejecucin de procesos crticos.</textarea>
                                        </div>
                                        <div class="ar-field">
                                            <label>Notas internas</label>
                                            <textarea placeholder="Observaciones, acuerdos, excepciones"></textarea>
                                        </div>
                                    </div>
                                    <div class="ar-actions">
                                        <button type="button" class="ar-btn ar-btn--soft">Cancelar</button>
                                        <button type="button" class="ar-btn ar-btn--primary2">Guardar</button>
                                    </div>
                                </form>
                            </section>
                            <aside class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Resumen</h2>
                                        <p>Informacin rpida del rea y su posicin en la estructura.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill">${selectedCode || 'N/A'}</span>
                                    </div>
                                </header>
                                <div class="ar-summary">
                                    <div class="ar-summary__top">
                                        <div class="ar-avatar" aria-hidden="true">${escapeHtmlAttr((selectedNameRaw || 'A').charAt(0))}</div>
                                        <div>
                                            <div class="ar-summary__name">${selectedName || 'Sin rea'}</div>
                                            <div class="ar-summary__meta">
                                                <span class="ar-badge ${selectedStatus === 'Activo' ? 'ar-badge--ok' : ''}">${selectedStatus}</span>
                                                <span class="ar-badge">${safeRelation}</span>
                                                <span class="ar-badge">Padre: ${selectedParent}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-miniGrid">
                                        <div class="ar-mini"><div class="ar-mini__k">Responsable</div><div class="ar-mini__v">${selectedManager || 'Sin asignar'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Dependencias</div><div class="ar-mini__v">${parentCount}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">reas activas</div><div class="ar-mini__v">${areasData.filter(area => area.status === 'Activo').length}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Estado</div><div class="ar-mini__v ar-mini__v--ok">En regla</div></div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-links">
                                        <button class="ar-link" type="button">Ver puestos relacionados</button>
                                        <button class="ar-link" type="button">Abrir en organigrama</button>
                                        <button class="ar-link" type="button">Ver indicadores del rea</button>
                                    </div>
                                </div>
                            </aside>
                        </section>
                        <section class="area-stats">
                            <article class="area-stat"><strong>${areaCount}</strong><span>Total de reas</span></article>
                            <article class="area-stat"><strong>${parentCount}</strong><span>Dependencias padre</span></article>
                            <article class="area-stat"><strong>${strategicCount}</strong><span>reas estratgicas</span></article>
                        </section>
                    </section>
                `;
                areaView.querySelectorAll('[data-relacion-help]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const key = btn.getAttribute('data-relacion-help') || '';
                        const text = relacionOrganizacionalHelp[key];
                        if (text) alert(text);
                    });
                });
            }
            function renderAreaKanban() {
                if (!areaView) return;
                const byStatus = {
                    'Estratgico': areasData.filter(area => area.status === 'Estratgico'),
                    'Activo': areasData.filter(area => area.status === 'Activo'),
                    'En revisin': areasData.filter(area => area.status === 'En revisin')
                };
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Kanban de reas</h2>
                                    <p>Arrastra y suelta para cambiar estado. Cada tarjeta muestra responsable y cdigo.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">3 columnas</span>
                                    <button class="ar-btn ar-btn--soft" type="button">Nuevo estado</button>
                                </div>
                            </header>
                            <div class="ar-kanban">
                                ${Object.entries(byStatus).map(([status, areas]) => `
                                    <div class="ar-col">
                                        <div class="ar-col__head">
                                            <div>
                                                <strong>${status}</strong>
                                                <span class="ar-col__count">${areas.length}</span>
                                            </div>
                                            <button class="ar-btn ar-btn--soft" type="button"></button>
                                        </div>
                                        <div class="ar-col__body">
                                            ${areas.length ? areas.map(area => `
                                                <article class="ar-kcard" style="--accent:${escapeHtmlAttr(area.color || '#1f6f52')}">
                                                    <div class="ar-kcard__accent"></div>
                                                    <div class="ar-kcard__top">
                                                        <div class="ar-klogo" aria-hidden="true">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                                        <div class="ar-kcard__main">
                                                            <div class="ar-kcard__title">${escapeHtmlAttr(area.name)}</div>
                                                            <div class="ar-kcard__sub">${escapeHtmlAttr(area.code)}</div>
                                                            <div class="ar-kcard__person">${escapeHtmlAttr(area.manager)}</div>
                                                        </div>
                                                    </div>
                                                    <div class="ar-kcard__foot">
                                                        <span class="ar-badge">${status === 'Activo' ? 'Lnea' : (status === 'Estratgico' ? 'Nivel 1' : 'Pendiente')}</span>
                                                        <span class="ar-badge ${status === 'Activo' ? 'ar-badge--ok' : (status === 'En revisin' ? 'ar-badge--warn' : '')}">${status}</span>
                                                    </div>
                                                </article>
                                            `).join('') : '<p class="ar-empty">Sin reas en esta columna.</p>'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </section>
                `;
            }
            function renderAreaOrganigrama() {
                if (!areaView) return;
                const root = areasData.find(area => area.parent === 'N/A') || areasData[0];
                if (!root) {
                    areaView.innerHTML = `
                        <section class="ar-shell">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Organigrama de reas</h2>
                                        <p>No hay reas disponibles para construir el organigrama.</p>
                                    </div>
                                    <div class="ar-card__tools"><span class="ar-pill">0 reas</span></div>
                                </header>
                                <p class="ar-empty">
                                    Crea una primera rea para habilitar la vista jerrquica.
                                </p>
                            </section>
                        </section>
                    `;
                    return;
                }
                const firstLevel = areasData.filter(area => area.parent === root.name);
                const secondLevel = areasData.filter(area => firstLevel.some(parent => parent.name === area.parent));
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Organigrama de reas</h2>
                                    <p>Vista jerrquica con lneas y niveles. Selecciona un nodo para ver detalle.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <button class="ar-btn ar-btn--soft" type="button">Centrar</button>
                                    <button class="ar-btn ar-btn--soft" type="button">Expandir</button>
                                    <button class="ar-btn ar-btn--soft" type="button">Exportar</button>
                                </div>
                            </header>
                            <div class="ar-org">
                                <div class="ar-org__level">
                                    <div class="ar-node ar-node--root" style="--accent:${escapeHtmlAttr(root.color || '#0f3d2e')}">
                                        <div class="ar-node__badge">Nivel 1</div>
                                        <div class="ar-node__logo">${escapeHtmlAttr((root.name || 'A').charAt(0))}</div>
                                        <div class="ar-node__title">${escapeHtmlAttr(root.name)}</div>
                                        <div class="ar-node__sub">${escapeHtmlAttr(root.manager || 'Sin asignar')}</div>
                                        <div class="ar-node__code">${escapeHtmlAttr(root.code || 'N/A')}</div>
                                    </div>
                                </div>
                                <div class="ar-org__pipe" aria-hidden="true"></div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${firstLevel.map(area => `
                                        <div class="ar-node" style="--accent:${escapeHtmlAttr(area.color || '#1f6f52')}">
                                            <div class="ar-node__badge">Nivel 2</div>
                                            <div class="ar-node__logo">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                            <div class="ar-node__title">${escapeHtmlAttr(area.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(area.manager || 'Sin asignar')}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(area.code || 'N/A')}</div>
                                        </div>
                                    `).join('') || '<p class="ar-empty">Sin reas de primer nivel.</p>'}
                                </div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${secondLevel.map(area => `
                                        <div class="ar-node" style="--accent:${escapeHtmlAttr(area.color || '#2563eb')}">
                                            <div class="ar-node__badge">Nivel 3</div>
                                            <div class="ar-node__logo">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                            <div class="ar-node__title">${escapeHtmlAttr(area.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(area.manager || 'Sin asignar')}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(area.code || 'N/A')}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="ar-org__legend">
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#0f3d2e"></span> Estratgico</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#1f6f52"></span> Operativo</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#2563eb"></span> Staff</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#f59e0b"></span> Revisin</span>
                                </div>
                            </div>
                        </section>
                    </section>
                `;
            }
            function setAreaView(view) {
                if (!areaPanel || !areaView) return;
                setFloatingScreen('areas');
                ensureFloatingVisible();
                areaPanel.classList.remove('hidden');
                areaTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === view));
                activateViewButton(view);
                switch (view) {
                    case 'kanban':
                        renderAreaKanban();
                        break;
                    case 'organigrama':
                        renderAreaOrganigrama();
                        break;
                    default:
                        renderAreaForm();
                        break;
                }
            }
            function setUsuarioView(view) {
                if (!usuarioPanel || !usuarioView) return;
                setFloatingScreen('usuarios');
                ensureFloatingVisible();
                usuarioPanel.classList.remove('hidden');
                usuarioTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === view));
                activateViewButton(view);
                currentUsuarioView = view;
                refreshUsuarioFloating();
                switch (view) {
                    case 'list':
                        renderUsuarioList();
                        break;
                    case 'kanban':
                        renderUsuarioKanban();
                        break;
                    case 'organigrama':
                        renderUsuarioOrganigrama();
                        break;
                    default:
                        renderUsuarioForm();
                        break;
                }
            }
            usuarioTabs.forEach(tab => tab.addEventListener('click', () => setUsuarioView(tab.dataset.view)));
            areaTabs.forEach(tab => tab.addEventListener('click', () => setAreaView(tab.dataset.view)));
            usuarioLinks.forEach(link => link.addEventListener('click', event => {
                const targetHref = link.getAttribute('href');
                const currentPath = window.location.pathname;
                if (targetHref && targetHref !== currentPath) {
                    return;
                }
                event.preventDefault();
                setUsuarioView(link.dataset.view || 'form');
            }));
            const isUsuariosRoute = window.location.pathname === '/usuarios-sistema' || window.location.pathname === '/usuarios';
            if (isUsuariosRoute && usuarioPanel && usuarioView) {
                const activeUsuarioLink = Array.from(usuarioLinks).find(link => link.getAttribute('href') === window.location.pathname);
                if (activeUsuarioLink) {
                    setMenuInfo(activeUsuarioLink);
                }
                await loadUsuariosImagenes();
                await loadRolesSistemaDisponibles();
                setUsuarioView('form');
            }
            const isAreasRoute = window.location.pathname === '/areas-organizacionales';
            if (isAreasRoute && areaPanel && areaView) {
                const areaMenuLink = document.querySelector('a[data-route="/areas-organizacionales"]');
                if (areaMenuLink) {
                    setMenuInfo(areaMenuLink);
                }
                await loadUsuariosImagenes();
                setAreaView('form');
            }
            const plantillasPage = document.getElementById('plantillas-page');
            const templateNameInput = document.getElementById('template-name');
            const templateHtmlInput = document.getElementById('template-html');
            const templateCssInput = document.getElementById('template-css');
            const templateNewBtn = document.getElementById('template-new-btn');
            const templateEditBtn = document.getElementById('template-edit-btn');
            const templateBuilderBtn = document.getElementById('template-builder-btn');
            const templatePreviewBtn = document.getElementById('template-preview-btn');
            const templateSaveBtn = document.getElementById('template-save-btn');
            const templateDeleteBtn = document.getElementById('template-delete-btn');
            const templatePreviewFrame = document.getElementById('template-preview');
            const builderBackToTemplates = document.getElementById('builder-back-to-templates');
            const plantillasList = document.getElementById('plantillas-list');
            const formBuilderPanel = document.getElementById('form-builder-panel');
            const builderFormSelect = document.getElementById('builder-form-select');
            const builderFormName = document.getElementById('builder-form-name');
            const builderFormSlug = document.getElementById('builder-form-slug');
            const builderFormActive = document.getElementById('builder-form-active');
            const builderFormTenant = document.getElementById('builder-form-tenant');
            const builderFormRoles = document.getElementById('builder-form-roles');
            const builderFormDescription = document.getElementById('builder-form-description');
            const builderFormConfig = document.getElementById('builder-form-config');
            const builderFieldType = document.getElementById('builder-field-type');
            const builderFieldLabel = document.getElementById('builder-field-label');
            const builderFieldName = document.getElementById('builder-field-name');
            const builderFieldPlaceholder = document.getElementById('builder-field-placeholder');
            const builderFieldHelp = document.getElementById('builder-field-help');
            const builderFieldOptions = document.getElementById('builder-field-options');
            const builderFieldConditional = document.getElementById('builder-field-conditional');
            const builderFieldRequired = document.getElementById('builder-field-required');
            const builderAddFieldBtn = document.getElementById('builder-add-field-btn');
            const builderClearFormBtn = document.getElementById('builder-clear-form-btn');
            const builderSaveFormBtn = document.getElementById('builder-save-form-btn');
            const builderDeleteFormBtn = document.getElementById('builder-delete-form-btn');
            const builderFieldsList = document.getElementById('builder-fields-list');
            let plantillasStore = [];
            let selectedTemplateId = null;
            let formDefinitionsStore = [];
            let selectedFormDefinitionId = null;
            let builderFields = [];
            let builderRoleOptions = [];
            const slugifyText = (value) => (value || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            const normalizeRoleValue = (value) => (value || '').toString().trim().toLowerCase();
            const getBuilderSelectedRoles = () => {
                if (!builderFormRoles) return [];
                return Array.from(builderFormRoles.selectedOptions || [])
                    .map((opt) => normalizeRoleValue(opt.value))
                    .filter(Boolean);
            };
            const renderBuilderRoleOptions = (selected = []) => {
                if (!builderFormRoles) return;
                const selectedSet = new Set((Array.isArray(selected) ? selected : []).map((item) => normalizeRoleValue(item)));
                builderFormRoles.innerHTML = builderRoleOptions.map((role) => (
                    `<option value="${role.value}" ${selectedSet.has(role.value) ? 'selected' : ''}>${role.label}</option>`
                )).join('');
            };
            const renderBuilderFields = () => {
                if (!builderFieldsList) return;
                if (!builderFields.length) {
                    builderFieldsList.innerHTML = '<p class="plantillas-hint">No hay campos agregados.</p>';
                    return;
                }
                builderFieldsList.innerHTML = builderFields.map((field, index) => `
                    <div class="builder-field-item">
                        <div class="meta">
                            <strong>${field.label || field.name}</strong>
                            <span>Tipo: ${field.field_type} | Nombre: ${field.name}</span>
                            <span>${field.is_required ? 'Obligatorio' : 'Opcional'}${field.options?.length ? ` | Opciones: ${field.options.map((opt) => opt.label || opt.value).join(', ')}` : ''}${field.conditional_logic && Object.keys(field.conditional_logic).length ? ' | Condicional' : ''}</span>
                        </div>
                        <button type="button" class="builder-field-delete" data-builder-remove-field="${index}">Quitar</button>
                    </div>
                `).join('');
                builderFieldsList.querySelectorAll('[data-builder-remove-field]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const index = Number(btn.dataset.builderRemoveField);
                        if (Number.isNaN(index)) return;
                        builderFields = builderFields.filter((_, i) => i !== index);
                        renderBuilderFields();
                    });
                });
            };
            const clearBuilderFieldInputs = () => {
                if (builderFieldType) builderFieldType.value = 'text';
                if (builderFieldLabel) builderFieldLabel.value = '';
                if (builderFieldName) builderFieldName.value = '';
                if (builderFieldPlaceholder) builderFieldPlaceholder.value = '';
                if (builderFieldHelp) builderFieldHelp.value = '';
                if (builderFieldOptions) builderFieldOptions.value = '';
                if (builderFieldConditional) builderFieldConditional.value = '';
                if (builderFieldRequired) builderFieldRequired.checked = false;
            };
            const clearBuilderForm = () => {
                selectedFormDefinitionId = null;
                builderFields = [];
                if (builderFormSelect) builderFormSelect.value = '';
                if (builderFormName) builderFormName.value = '';
                if (builderFormSlug) builderFormSlug.value = '';
                if (builderFormActive) builderFormActive.value = 'true';
                if (builderFormTenant) builderFormTenant.value = currentTenantId || 'default';
                renderBuilderRoleOptions([]);
                if (builderFormDescription) builderFormDescription.value = '';
                if (builderFormConfig) builderFormConfig.value = '';
                clearBuilderFieldInputs();
                renderBuilderFields();
            };
            const setBuilderFromForm = (formDef) => {
                if (!formDef) return;
                selectedFormDefinitionId = formDef.id;
                if (builderFormSelect) builderFormSelect.value = String(formDef.id);
                if (builderFormName) builderFormName.value = formDef.name || '';
                if (builderFormSlug) builderFormSlug.value = formDef.slug || '';
                if (builderFormActive) builderFormActive.value = formDef.is_active ? 'true' : 'false';
                if (builderFormTenant) builderFormTenant.value = (formDef.tenant_id || currentTenantId || 'default');
                renderBuilderRoleOptions(Array.isArray(formDef.allowed_roles) ? formDef.allowed_roles : []);
                if (builderFormDescription) builderFormDescription.value = formDef.description || '';
                if (builderFormConfig) {
                    const cfg = formDef.config && typeof formDef.config === 'object' ? formDef.config : {};
                    builderFormConfig.value = Object.keys(cfg).length ? JSON.stringify(cfg) : '';
                }
                const fields = Array.isArray(formDef.fields) ? formDef.fields : [];
                builderFields = fields.map((field, index) => ({
                    field_type: field.field_type || field.type || 'text',
                    label: field.label || '',
                    name: field.name || `campo_${index + 1}`,
                    placeholder: field.placeholder || '',
                    help_text: field.help_text || field.helpText || '',
                    default_value: field.default_value || field.defaultValue || '',
                    is_required: Boolean(field.is_required ?? field.required),
                    validation_rules: field.validation_rules || field.validation || {},
                    options: Array.isArray(field.options)
                        ? field.options.map((opt) => {
                            if (typeof opt === 'object' && opt !== null) {
                                return { label: String(opt.label || opt.value || ''), value: String(opt.value || opt.label || '') };
                            }
                            const value = String(opt || '');
                            return { label: value, value };
                        }).filter((opt) => opt.value)
                        : [],
                    order: Number(field.order ?? index),
                    conditional_logic: field.conditional_logic || field.conditional || {},
                }));
                renderBuilderFields();
            };
            const renderBuilderFormSelect = () => {
                if (!builderFormSelect) return;
                builderFormSelect.innerHTML = `<option value="">Nuevo formulario</option>${formDefinitionsStore.map((formDef) => (
                    `<option value="${formDef.id}" ${Number(formDef.id) === Number(selectedFormDefinitionId) ? 'selected' : ''}>${formDef.name} (${formDef.slug})</option>`
                )).join('')}`;
            };
            const loadFormDefinitions = async () => {
                if (!formBuilderPanel) return;
                try {
                    const res = await fetch('/api/admin/forms');
                    const json = await res.json();
                    if (!res.ok) throw new Error(json?.detail || 'No se pudo cargar formularios');
                    formDefinitionsStore = Array.isArray(json) ? json : [];
                    renderBuilderFormSelect();
                    if (selectedFormDefinitionId) {
                        const match = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                        if (match) setBuilderFromForm(match);
                    }
                } catch (error) {
                    showMessage('No se pudieron cargar los formularios.', 'error');
                }
            };
            const loadBuilderRoleOptions = async () => {
                if (!formBuilderPanel) return;
                builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                try {
                    const res = await fetch('/api/roles-disponibles');
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) throw new Error(payload?.error || 'No se pudieron cargar roles');
                    const items = Array.isArray(payload?.data) ? payload.data : [];
                    builderRoleOptions = items.map((role) => {
                        const value = normalizeRoleValue(role?.nombre || role?.value || '');
                        const label = String(role?.label || role?.nombre || value || '').trim();
                        return { value, label };
                    }).filter((role) => role.value);
                    if (!builderRoleOptions.length) {
                        builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                    }
                } catch (error) {
                    builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                }
                renderBuilderRoleOptions(getBuilderSelectedRoles());
            };
            const collectBuilderPayload = () => {
                const name = (builderFormName?.value || '').trim();
                const slug = (builderFormSlug?.value || '').trim();
                const description = (builderFormDescription?.value || '').trim();
                const tenantId = (builderFormTenant?.value || currentTenantId || 'default').trim();
                const rawConfig = (builderFormConfig?.value || '').trim();
                if (!name) {
                    throw new Error('El nombre del formulario es obligatorio.');
                }
                if (!builderFields.length) {
                    throw new Error('Agrega al menos un campo al formulario.');
                }
                let config = {};
                if (rawConfig) {
                    try {
                        const parsed = JSON.parse(rawConfig);
                        if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                            throw new Error();
                        }
                        config = parsed;
                    } catch (error) {
                        throw new Error('La configuracin JSON del formulario es invlida.');
                    }
                }
                return {
                    name,
                    slug: slug || slugifyText(name),
                    tenant_id: tenantId || 'default',
                    description: description || null,
                    is_active: (builderFormActive?.value || 'true') === 'true',
                    config,
                    allowed_roles: getBuilderSelectedRoles(),
                    fields: builderFields.map((field, index) => ({
                        ...field,
                        order: index,
                    })),
                };
            };
            const renderTemplatePreview = () => {
                if (!templatePreviewFrame) return;
                let htmlCode = templateHtmlInput?.value || '';
                const cssCode = templateCssInput?.value || '';
                if (!htmlCode.trim() && !cssCode.trim()) {
                    htmlCode = "<section style='padding:16px;font-family:Arial,sans-serif;color:#475569;'>Agrega HTML/CSS o selecciona una plantilla para previsualizar.</section>";
                }
                const previewDoc = `<!doctype html><html><head><meta charset="UTF-8"><style>${cssCode}</style></head><body>${htmlCode}</body></html>`;
                templatePreviewFrame.srcdoc = previewDoc;
                try {
                    const frameDoc = templatePreviewFrame.contentDocument || templatePreviewFrame.contentWindow?.document;
                    if (frameDoc) {
                        frameDoc.open();
                        frameDoc.write(previewDoc);
                        frameDoc.close();
                    }
                } catch (error) {
                    // srcdoc remains as fallback if direct write is blocked by browser policy.
                }
            };
            const clearTemplateEditor = () => {
                selectedTemplateId = null;
                if (templateNameInput) templateNameInput.value = '';
                if (templateHtmlInput) templateHtmlInput.value = '';
                if (templateCssInput) templateCssInput.value = '';
                renderTemplatePreview();
                if (plantillasList) {
                    plantillasList.querySelectorAll('.plantillas-item').forEach((btn) => btn.classList.remove('active'));
                }
            };
            const setTemplateEditor = (tpl) => {
                if (!tpl) return;
                selectedTemplateId = tpl.id;
                if (templateNameInput) templateNameInput.value = tpl.nombre || '';
                if (templateHtmlInput) templateHtmlInput.value = tpl.html || '';
                if (templateCssInput) templateCssInput.value = tpl.css || '';
                renderTemplatePreview();
            };
            const renderPlantillasList = () => {
                if (!plantillasList) return;
                plantillasList.innerHTML = plantillasStore.map((tpl) => `
                    <li>
                        <button type="button" class="plantillas-item ${tpl.id === selectedTemplateId ? 'active' : ''}" data-template-id="${tpl.id}">
                            ${tpl.nombre}
                        </button>
                    </li>
                `).join('');
                plantillasList.querySelectorAll('[data-template-id]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.templateId;
                        const tpl = plantillasStore.find((item) => item.id === id);
                        if (!tpl) return;
                        setTemplateEditor(tpl);
                        renderPlantillasList();
                        showMessage(`Plantilla "${tpl.nombre}" cargada.`, 'success');
                    });
                });
            };
            const loadPlantillas = async () => {
                if (!plantillasPage) return;
                try {
                    const res = await fetch('/api/plantillas');
                    if (!res.ok) throw new Error('No se pudo cargar la lista');
                    const json = await res.json();
                    plantillasStore = Array.isArray(json?.data) ? json.data : [];
                    if (!selectedTemplateId && plantillasStore.length) {
                        setTemplateEditor(plantillasStore[0]);
                    } else if (!plantillasStore.length) {
                        clearTemplateEditor();
                    }
                    renderPlantillasList();
                } catch (error) {
                    showMessage('No se pudieron cargar las plantillas.', 'error');
                }
            };
            if (plantillasPage) {
                const plantillasLink = document.querySelector('a[data-route="/plantillas"]');
                if (plantillasLink) {
                    setMenuInfo(plantillasLink);
                }
                setFloatingScreen('plantillas');
                ensureFloatingVisible();
                await loadBuilderRoleOptions();
                loadPlantillas();
                templatePreviewBtn && templatePreviewBtn.addEventListener('click', renderTemplatePreview);
                templateHtmlInput && templateHtmlInput.addEventListener('input', renderTemplatePreview);
                templateCssInput && templateCssInput.addEventListener('input', renderTemplatePreview);
                builderFormName && builderFormName.addEventListener('input', () => {
                    if (selectedFormDefinitionId) return;
                    if (!builderFormSlug) return;
                    if ((builderFormSlug.value || '').trim()) return;
                    builderFormSlug.value = slugifyText(builderFormName.value);
                });
                builderFieldLabel && builderFieldLabel.addEventListener('input', () => {
                    if (!builderFieldName) return;
                    if ((builderFieldName.value || '').trim()) return;
                    builderFieldName.value = slugifyText(builderFieldLabel.value).replace(/-/g, '_');
                });
                templateBuilderBtn && templateBuilderBtn.addEventListener('click', () => {
                    window.location.href = '/plantillas/constructor';
                });
                builderBackToTemplates && builderBackToTemplates.addEventListener('click', () => {
                    window.location.href = '/plantillas';
                });
                builderFormSelect && builderFormSelect.addEventListener('change', () => {
                    const formId = Number(builderFormSelect.value);
                    if (!formId) {
                        clearBuilderForm();
                        return;
                    }
                    const found = formDefinitionsStore.find((item) => Number(item.id) === formId);
                    if (!found) {
                        showMessage('Formulario no encontrado en la lista.', 'error');
                        return;
                    }
                    setBuilderFromForm(found);
                    showMessage(`Formulario "${found.name}" cargado.`, 'success');
                });
                builderAddFieldBtn && builderAddFieldBtn.addEventListener('click', () => {
                    const fieldLabel = (builderFieldLabel?.value || '').trim();
                    const fieldNameRaw = (builderFieldName?.value || '').trim();
                    const fieldType = (builderFieldType?.value || 'text').trim();
                    const conditionalRaw = (builderFieldConditional?.value || '').trim();
                    if (!fieldLabel) {
                        showMessage('La etiqueta del campo es obligatoria.', 'error');
                        return;
                    }
                    const normalizedName = (fieldNameRaw || slugifyText(fieldLabel).replace(/-/g, '_')).replace(/[^a-zA-Z0-9_]/g, '_');
                    if (!normalizedName) {
                        showMessage('El nombre tcnico del campo es invlido.', 'error');
                        return;
                    }
                    if (builderFields.some((item) => item.name === normalizedName)) {
                        showMessage('Ya existe un campo con ese nombre tcnico.', 'error');
                        return;
                    }
                    const optionValues = (builderFieldOptions?.value || '')
                        .split(',')
                        .map((opt) => opt.trim())
                        .filter(Boolean);
                    let normalizedOptions = optionValues.map((opt) => ({ label: opt, value: opt }));
                    if (fieldType === 'likert' && !normalizedOptions.length) {
                        normalizedOptions = ['1', '2', '3', '4', '5'].map((value) => ({ label: value, value }));
                    }
                    let conditionalLogic = {};
                    if (conditionalRaw) {
                        try {
                            const parsed = JSON.parse(conditionalRaw);
                            if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                                showMessage('La condicin debe ser un objeto JSON vlido.', 'error');
                                return;
                            }
                            conditionalLogic = parsed;
                        } catch (error) {
                            showMessage('JSON condicional invlido.', 'error');
                            return;
                        }
                    }
                    builderFields.push({
                        field_type: fieldType,
                        label: fieldLabel,
                        name: normalizedName,
                        placeholder: (builderFieldPlaceholder?.value || '').trim() || null,
                        help_text: (builderFieldHelp?.value || '').trim() || null,
                        default_value: null,
                        is_required: Boolean(builderFieldRequired?.checked),
                        validation_rules: {},
                        options: ['select', 'radio', 'checkboxes', 'likert'].includes(fieldType)
                            ? normalizedOptions
                            : [],
                        order: builderFields.length,
                        conditional_logic: conditionalLogic,
                    });
                    renderBuilderFields();
                    clearBuilderFieldInputs();
                    showMessage('Campo agregado al formulario.', 'success');
                });
                builderClearFormBtn && builderClearFormBtn.addEventListener('click', () => {
                    clearBuilderForm();
                    showMessage('Constructor limpiado.', 'success');
                });
                builderSaveFormBtn && builderSaveFormBtn.addEventListener('click', async () => {
                    try {
                        const payload = collectBuilderPayload();
                        const formId = selectedFormDefinitionId ? Number(selectedFormDefinitionId) : null;
                        const endpoint = formId ? `/api/admin/forms/${encodeURIComponent(formId)}` : '/api/admin/forms';
                        const method = formId ? 'PUT' : 'POST';
                        const res = await fetch(endpoint, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo guardar el formulario');
                        selectedFormDefinitionId = Number(json?.id || formId || selectedFormDefinitionId);
                        await loadFormDefinitions();
                        if (!selectedFormDefinitionId && json?.id) {
                            selectedFormDefinitionId = Number(json.id);
                        }
                        if (selectedFormDefinitionId) {
                            const saved = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                            if (saved) setBuilderFromForm(saved);
                        }
                        showMessage('Formulario guardado correctamente.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al guardar formulario.', 'error');
                    }
                });
                builderDeleteFormBtn && builderDeleteFormBtn.addEventListener('click', async () => {
                    if (!selectedFormDefinitionId) {
                        showMessage('Selecciona un formulario para eliminar.', 'error');
                        return;
                    }
                    if (!confirm('Eliminar el formulario seleccionado?')) {
                        showMessage('Eliminacin cancelada.', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/admin/forms/${encodeURIComponent(selectedFormDefinitionId)}`, {
                            method: 'DELETE',
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo eliminar');
                        clearBuilderForm();
                        await loadFormDefinitions();
                        showMessage('Formulario eliminado.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al eliminar formulario.', 'error');
                    }
                });
                if (formBuilderPanel && !formBuilderPanel.classList.contains('hidden')) {
                    clearBuilderForm();
                    loadFormDefinitions();
                    if (!builderFields.length) renderBuilderFields();
                }
            }
            document.addEventListener('backend-view-change', (event) => {
                const view = event.detail?.view;
                if (!view) return;
                if (activeFloatingScreen === 'usuarios') {
                    setUsuarioView(view);
                } else if (activeFloatingScreen === 'areas') {
                    setAreaView(view);
                }
            });
            const notebookTabs = document.querySelectorAll('.notebook-tabs .tab');
            const notebookPanels = document.querySelectorAll('.notebook-content .tab-panel');
            const activateNotebookTab = (name) => {
                if (!name) return;
                notebookTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === name));
                notebookPanels.forEach(panel => {
                    panel.hidden = panel.dataset.panel !== name;
                });
            };
            notebookTabs.forEach(tab => tab.addEventListener('click', () => activateNotebookTab(tab.dataset.tab)));
            actionCreateUser && actionCreateUser.addEventListener('click', (event) => {
                event.preventDefault();
                createUsuarioMode = true;
                selectedUsuarioName = null;
                setUsuarioView('form');
                const nombreInput = usuarioView ? usuarioView.querySelector('#usuario-nombre') : null;
                const usuarioInput = usuarioView ? usuarioView.querySelector('#usuario-usuario') : null;
                const correoInput = usuarioView ? usuarioView.querySelector('#usuario-correo') : null;
                const passwordInput = usuarioView ? usuarioView.querySelector('#usuario-password') : null;
                const rolSelect = usuarioView ? usuarioView.querySelector('#usuario-rol') : null;
                const estadoSelect = usuarioView ? usuarioView.querySelector('#usuario-estado') : null;
                const departamentoSelect = usuarioView ? usuarioView.querySelector('#usuario-departamento-select') : null;
                const jefeSelect = usuarioView ? usuarioView.querySelector('#usuario-jefe-select') : null;
                if (nombreInput) nombreInput.value = '';
                if (usuarioInput) usuarioInput.value = '';
                if (correoInput) correoInput.value = '';
                if (passwordInput) passwordInput.value = '';
                if (rolSelect) rolSelect.value = '';
                if (estadoSelect) estadoSelect.value = 'Activo';
                if (departamentoSelect) departamentoSelect.value = '';
                if (jefeSelect) jefeSelect.innerHTML = '<option value="">Selecciona un jefe inmediato</option>';
                if (nombreInput) nombreInput.focus();
                showMessage('Formulario listo para crear usuario.', 'success');
            });
            actionEdit && actionEdit.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                createUsuarioMode = false;
                setUsuarioView('form');
                showMessage('Modo edicin activado.', 'success');
            });
            actionSavePersonal && actionSavePersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                guardarColores();
            });
            actionResetPersonal && actionResetPersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                restablecerColores();
                showMessage('Colores restablecidos en personalizacin.', 'success');
            });
            actionSaveUsuario && actionSaveUsuario.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                if (!usuarioPanel || usuarioPanel.classList.contains('hidden')) {
                    showMessage('Abre la vista de formulario para guardar usuarios.', 'error');
                    return;
                }
                const nombreInput = usuarioView.querySelector('#usuario-nombre');
                const usuarioInput = usuarioView.querySelector('#usuario-usuario');
                const correoInput = usuarioView.querySelector('#usuario-correo');
                const passwordInput = usuarioView.querySelector('#usuario-password');
                const rolSelect = usuarioView.querySelector('#usuario-rol');
                if (!nombreInput || !usuarioInput || !correoInput || !passwordInput) {
                    showMessage('No se pudo leer el formulario de usuario.', 'error');
                    return;
                }
                const payload = {
                    nombre: (nombreInput.value || '').trim(),
                    usuario: (usuarioInput.value || '').trim(),
                    correo: (correoInput.value || '').trim(),
                    contrasena: passwordInput.value || '',
                    rol: (rolSelect?.value || 'usuario').trim(),
                };
                if (!payload.nombre || !payload.usuario || !payload.correo || !payload.contrasena) {
                    showMessage('Nombre, usuario, correo y contrasea son obligatorios.', 'error');
                    return;
                }
                fetch('/api/usuarios/registro-seguro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                })
                    .then(async (res) => {
                        const json = await res.json().catch(() => ({}));
                        if (!res.ok || !json?.success) {
                            throw new Error(json?.error || 'No se pudo guardar el usuario');
                        }
                        createUsuarioMode = false;
                        showMessage('Usuario registrado correctamente.', 'success');
                        passwordInput.value = '';
                        await loadUsuariosImagenes();
                    })
                    .catch((err) => {
                        showMessage(err?.message || 'Error al registrar usuario.', 'error');
                    });
            });
            actionDelete && actionDelete.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                if (confirm('Eliminar el registro seleccionado?')) {
                    showMessage('Registro eliminado.', 'success');
                } else {
                    showMessage('Eliminacin cancelada.', 'error');
                }
            });
            actionNewAreas && actionNewAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                setAreaView('form');
                showMessage('Nueva rea lista para captura.', 'success');
            });
            actionEditAreas && actionEditAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                setAreaView('form');
                showMessage('Modo edicin de reas activado.', 'success');
            });
            actionSaveAreas && actionSaveAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                showMessage('Cambios en reas guardados.', 'success');
            });
            actionDeleteAreas && actionDeleteAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                if (confirm('Eliminar el rea seleccionada?')) {
                    showMessage('rea eliminada.', 'success');
                } else {
                    showMessage('Eliminacin cancelada.', 'error');
                }
            });
            actionNewTemplate && actionNewTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                clearTemplateEditor();
                templateNameInput && templateNameInput.focus();
                showMessage('Nueva plantilla lista para captura.', 'success');
            });
            actionEditTemplate && actionEditTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para editar.', 'error');
                    return;
                }
                templateNameInput && templateNameInput.focus();
                showMessage('Modo edicin de plantilla activado.', 'success');
            });
            const handleTemplateSave = async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                if (event) event.preventDefault();
                const payload = {
                    id: selectedTemplateId,
                    nombre: (templateNameInput?.value || '').trim(),
                    html: templateHtmlInput?.value || '',
                    css: templateCssInput?.value || '',
                };
                if (!payload.nombre) {
                    showMessage('El nombre de la plantilla es obligatorio.', 'error');
                    return;
                }
                if (!payload.html.trim() && !payload.css.trim()) {
                    showMessage('Agrega HTML o CSS para guardar.', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/plantillas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo guardar');
                    }
                    selectedTemplateId = json?.data?.id || selectedTemplateId;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla guardada.', 'success');
                } catch (error) {
                    showMessage('Error al guardar la plantilla.', 'error');
                }
            };
            actionSaveTemplate && actionSaveTemplate.addEventListener('click', handleTemplateSave);
            templateSaveBtn && templateSaveBtn.addEventListener('click', handleTemplateSave);
            actionDeleteTemplate && actionDeleteTemplate.addEventListener('click', async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para eliminar.', 'error');
                    return;
                }
                if (!confirm('Eliminar la plantilla seleccionada?')) {
                    showMessage('Eliminacin cancelada.', 'error');
                    return;
                }
                try {
                    const res = await fetch(`/api/plantillas/${encodeURIComponent(selectedTemplateId)}`, {
                        method: 'DELETE',
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo eliminar');
                    }
                    selectedTemplateId = null;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla eliminada.', 'success');
                } catch (error) {
                    showMessage(error?.message || 'Error al eliminar la plantilla.', 'error');
                }
            });
            templateNewBtn && templateNewBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionNewTemplate && actionNewTemplate.click();
            });
            templateEditBtn && templateEditBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionEditTemplate && actionEditTemplate.click();
            });
            templateDeleteBtn && templateDeleteBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionDeleteTemplate && actionDeleteTemplate.click();
            });
            actionExportReportes && actionExportReportes.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/html';
                showMessage('Exportando reporte con encabezado.', 'success');
            });
            actionExportPdf && actionExportPdf.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/pdf';
                showMessage('Generando PDF con encabezado.', 'success');
            });
            actionExportExcel && actionExportExcel.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/excel';
                showMessage('Generando Excel con encabezado.', 'success');
            });
            actionViewForm && actionViewForm.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('form');
                showMessage('Vista formulario.', 'success');
            });
            actionViewList && actionViewList.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('list');
                showMessage('Vista lista.', 'success');
            });
            actionViewKanban && actionViewKanban.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('kanban');
                showMessage('Vista kanban.', 'success');
            });
            actionViewGraph && actionViewGraph.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista grfica.', 'success');
            });
            actionViewGantt && actionViewGantt.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista gantt.', 'success');
            });
            actionViewDashboard && actionViewDashboard.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista dashboard.', 'success');
            });
            actionViewCalendar && actionViewCalendar.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista calendario.', 'success');
            });
            const fodaBuilder = document.getElementById('foda-builder');
            if (fodaBuilder) {
                const descriptionInput = document.getElementById('foda-description');
                const categoryInput = document.getElementById('foda-category');
                const impactInput = document.getElementById('foda-impact');
                const addButton = document.getElementById('foda-add');
                const lists = {
                    strengths: document.getElementById('foda-list-strengths'),
                    weaknesses: document.getElementById('foda-list-weaknesses'),
                    opportunities: document.getElementById('foda-list-opportunities'),
                    threats: document.getElementById('foda-list-threats'),
                };
                const counters = {
                    strengths: document.getElementById('foda-count-strengths'),
                    weaknesses: document.getElementById('foda-count-weaknesses'),
                    opportunities: document.getElementById('foda-count-opportunities'),
                    threats: document.getElementById('foda-count-threats'),
                };
                const factors = {
                    strengths: [],
                    weaknesses: [],
                    opportunities: [],
                    threats: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderFoda = () => {
                    Object.keys(factors).forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="foda-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-foda-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    fodaBuilder.querySelectorAll('[data-foda-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [cat, indexRaw] = (btn.dataset.fodaRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[cat] || Number.isNaN(index)) return;
                            factors[cat].splice(index, 1);
                            renderFoda();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'strengths';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor FODA.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderFoda();
                    showMessage('Factor FODA agregado.', 'success');
                });
                renderFoda();
            }
            const pestelBuilder = document.getElementById('pestel-builder');
            if (pestelBuilder) {
                const descriptionInput = document.getElementById('pestel-description');
                const factorInput = document.getElementById('pestel-factor');
                const impactInput = document.getElementById('pestel-impact');
                const addButton = document.getElementById('pestel-add');
                const dimensions = ['political', 'economic', 'social', 'technological', 'ecological', 'legal'];
                const lists = {
                    political: document.getElementById('pestel-list-political'),
                    economic: document.getElementById('pestel-list-economic'),
                    social: document.getElementById('pestel-list-social'),
                    technological: document.getElementById('pestel-list-technological'),
                    ecological: document.getElementById('pestel-list-ecological'),
                    legal: document.getElementById('pestel-list-legal'),
                };
                const counters = {
                    political: document.getElementById('pestel-count-political'),
                    economic: document.getElementById('pestel-count-economic'),
                    social: document.getElementById('pestel-count-social'),
                    technological: document.getElementById('pestel-count-technological'),
                    ecological: document.getElementById('pestel-count-ecological'),
                    legal: document.getElementById('pestel-count-legal'),
                };
                const factors = {
                    political: [],
                    economic: [],
                    social: [],
                    technological: [],
                    ecological: [],
                    legal: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPestel = () => {
                    dimensions.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="pestel-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-pestel-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    pestelBuilder.querySelectorAll('[data-pestel-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [dimension, indexRaw] = (btn.dataset.pestelRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[dimension] || Number.isNaN(index)) return;
                            factors[dimension].splice(index, 1);
                            renderPestel();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const dimension = factorInput?.value || 'political';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor PESTEL.', 'error');
                        return;
                    }
                    if (!factors[dimension]) return;
                    factors[dimension].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPestel();
                    showMessage('Factor PESTEL agregado.', 'success');
                });
                renderPestel();
            }
            const porterBuilder = document.getElementById('porter-builder');
            if (porterBuilder) {
                const descriptionInput = document.getElementById('porter-description');
                const forceInput = document.getElementById('porter-force');
                const impactInput = document.getElementById('porter-impact');
                const addButton = document.getElementById('porter-add');
                const forces = ['competitors', 'entrants', 'suppliers', 'buyers', 'substitutes'];
                const lists = {
                    competitors: document.getElementById('porter-list-competitors'),
                    entrants: document.getElementById('porter-list-entrants'),
                    suppliers: document.getElementById('porter-list-suppliers'),
                    buyers: document.getElementById('porter-list-buyers'),
                    substitutes: document.getElementById('porter-list-substitutes'),
                };
                const counters = {
                    competitors: document.getElementById('porter-count-competitors'),
                    entrants: document.getElementById('porter-count-entrants'),
                    suppliers: document.getElementById('porter-count-suppliers'),
                    buyers: document.getElementById('porter-count-buyers'),
                    substitutes: document.getElementById('porter-count-substitutes'),
                };
                const factors = {
                    competitors: [],
                    entrants: [],
                    suppliers: [],
                    buyers: [],
                    substitutes: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPorter = () => {
                    forces.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="porter-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-porter-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    porterBuilder.querySelectorAll('[data-porter-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [force, indexRaw] = (btn.dataset.porterRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[force] || Number.isNaN(index)) return;
                            factors[force].splice(index, 1);
                            renderPorter();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const force = forceInput?.value || 'competitors';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor PORTER.', 'error');
                        return;
                    }
                    if (!factors[force]) return;
                    factors[force].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPorter();
                    showMessage('Factor PORTER agregado.', 'success');
                });
                renderPorter();
            }
            const percepcionBuilder = document.getElementById('percepcion-builder');
            if (percepcionBuilder) {
                const descriptionInput = document.getElementById('percepcion-description');
                const categoryInput = document.getElementById('percepcion-category');
                const priorityInput = document.getElementById('percepcion-priority');
                const addButton = document.getElementById('percepcion-add');
                const categories = ['positive', 'neutral', 'negative'];
                const lists = {
                    positive: document.getElementById('percepcion-list-positive'),
                    neutral: document.getElementById('percepcion-list-neutral'),
                    negative: document.getElementById('percepcion-list-negative'),
                };
                const counters = {
                    positive: document.getElementById('percepcion-count-positive'),
                    neutral: document.getElementById('percepcion-count-neutral'),
                    negative: document.getElementById('percepcion-count-negative'),
                };
                const factors = {
                    positive: [],
                    neutral: [],
                    negative: [],
                };
                const priorityLabel = {
                    high: 'Prioridad alta',
                    medium: 'Prioridad media',
                    low: 'Prioridad baja',
                };
                const renderPercepcion = () => {
                    categories.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="percepcion-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${priorityLabel[item.priority] || 'Prioridad media'}</small>
                                </div>
                                <button type="button" data-percepcion-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    percepcionBuilder.querySelectorAll('[data-percepcion-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [category, indexRaw] = (btn.dataset.percepcionRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[category] || Number.isNaN(index)) return;
                            factors[category].splice(index, 1);
                            renderPercepcion();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'neutral';
                    const priority = priorityInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para la percepcin del cliente.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, priority });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPercepcion();
                    showMessage('Percepcin agregada.', 'success');
                });
                renderPercepcion();
            }
            const navbarAvatarImg = document.getElementById('navbar-avatar-img');
            const sidebarUserImg = document.getElementById('sidebar-user-img');
            const applyFallback = (img) => {
                if (!img) return;
                const fallback = img.dataset.default;
                img.addEventListener('error', function() {
                    if (fallback) img.src = fallback;
                });
                if (!img.src) img.src = fallback;
            };
            applyFallback(navbarAvatarImg);
            applyFallback(sidebarUserImg);
            syncNavbarNotificationIconColor(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-text'));
            if (navbarAvatarBtn && userDropdown) {
                const closeUserDropdown = () => {
                    userDropdown.classList.remove('open');
                    navbarAvatarBtn.setAttribute('aria-expanded', 'false');
                };
                navbarAvatarBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const willOpen = !userDropdown.classList.contains('open');
                    if (willOpen) {
                        userDropdown.classList.add('open');
                        navbarAvatarBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('click', (event) => {
                    if (!userDropdown.contains(event.target) && !navbarAvatarBtn.contains(event.target)) {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeUserDropdown();
                    }
                });
                if (logoutLink) {
                    logoutLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        closeUserDropdown();
                        window.location.assign('/logout');
                    });
                }
            }
            if ((sidebarNotificationsTrigger || navbarNotificationsTrigger) && sidebarNotificationsPanel) {
                const closeNotifications = () => {
                    sidebarNotificationsPanel.classList.remove('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'true');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                };
                const openNotifications = async () => {
                    sidebarNotificationsPanel.classList.add('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'false');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    await loadNotifications(false);
                };
                const bindNotificationsTrigger = (trigger, setMenu = false) => {
                    if (!trigger) return;
                    trigger.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        if (setMenu) setMenuInfo(trigger);
                        const willOpen = !sidebarNotificationsPanel.classList.contains('open');
                        if (willOpen) {
                            await openNotifications();
                        } else {
                            closeNotifications();
                        }
                    });
                };
                bindNotificationsTrigger(sidebarNotificationsTrigger, true);
                bindNotificationsTrigger(navbarNotificationsTrigger, false);
                sidebarNotificationsRefresh && sidebarNotificationsRefresh.addEventListener('click', async (event) => {
                    event.preventDefault();
                    await loadNotifications(false);
                });
                sidebarNotificationsMarkAll && sidebarNotificationsMarkAll.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const ids = Array.from(
                        sidebarNotificationsList.querySelectorAll('[data-notification-id]')
                    ).map((el) => (el.getAttribute('data-notification-id') || '').trim()).filter(Boolean);
                    try {
                        await markAllNotificationsRead(ids);
                        await loadNotifications(false);
                    } catch (error) {
                        showMessage(error.message || 'No se pudieron marcar las notificaciones', 'error');
                    }
                });
                sidebarNotificationsList.addEventListener('click', async (event) => {
                    const link = event.target && event.target.closest ? event.target.closest('[data-notification-id]') : null;
                    if (!link) return;
                    const notificationId = (link.getAttribute('data-notification-id') || '').trim();
                    const href = link.getAttribute('href') || '#';
                    event.preventDefault();
                    try {
                        await markNotificationRead(notificationId);
                    } catch (error) {
                        // Si falla la persistencia, no bloqueamos navegacin.
                    }
                    await loadNotifications(true);
                    if (href && href !== '#') {
                        window.location.assign(href);
                    }
                });
                document.addEventListener('click', (event) => {
                    if (
                        sidebarNotificationsPanel.classList.contains('open')
                        && !sidebarNotificationsPanel.contains(event.target)
                        && !(sidebarNotificationsTrigger && sidebarNotificationsTrigger.contains(event.target))
                        && !(navbarNotificationsTrigger && navbarNotificationsTrigger.contains(event.target))
                    ) {
                        closeNotifications();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeNotifications();
                    }
                });
                loadNotifications(true);
                window.setInterval(() => {
                    loadNotifications(true);
                }, 60000);
            }
            const empresaToggle = document.getElementById("empresa-section-toggle");
            const empresaContent = document.getElementById("empresa-section-content");
            if (empresaToggle && empresaContent) {
                const setEmpresaOpenState = (open) => {
                    empresaContent.classList.toggle("open", open);
                    empresaToggle.setAttribute("aria-expanded", open ? "true" : "false");
                    const indicator = empresaToggle.querySelector(".toggle-indicator");
                    if (indicator) {
                        indicator.textContent = open ? "" : "+";
                    }
                };
                empresaToggle.addEventListener("click", () => {
                    const open = !empresaContent.classList.contains("open");
                    setEmpresaOpenState(open);
                });
                const currentPath = window.location.pathname;
                const empresaLinks = empresaContent.querySelectorAll('a[href]');
                const shouldOpenEmpresa = Array.from(empresaLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenEmpresa) {
                    setEmpresaOpenState(true);
                }
            }
        });
    </script>
</body>
</html>

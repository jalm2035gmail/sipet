        .tabla-oficial th:nth-child(2),
        .tabla-oficial td:nth-child(2) {
            min-width: 480px;
            width: 480px;
        }
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/dist/output.css">
    <style>
        :root {
            color-scheme: light;
            /* defaults */
            --navbar-bg: #ffffff;
            --navbar-text: #1f172a;
            --sidebar-top: #1f2a3d;
            --sidebar-bottom: #0f172a;
            --sidebar-text: #ffffff;
            --sidebar-icon: #f5f7fb;
            --sidebar-hover: #16a34a;
            --floating-toggle-text-color: var(--sidebar-text);
            --floating-icon-color: var(--sidebar-bottom);
            --floating-action-border: var(--sidebar-bottom);
            --floating-action-text: var(--sidebar-bottom);
            --floating-action-bg: var(--sidebar-text);
            --view-pill-border: var(--sidebar-bottom);
            --view-pill-bg: var(--sidebar-text);
            --view-pill-text: var(--sidebar-bottom);
            --view-pill-icon: var(--sidebar-bottom);
            --view-pill-hover-bg: var(--sidebar-bottom);
            --view-pill-hover-text: var(--sidebar-text);
            --view-pill-hover-icon: var(--sidebar-text);
            --page-bg: #f4f6fb;
            --content-bg: #ffffff;
            --body-text: #0f172a;
            --page-title-color: var(--sidebar-bottom);
            --sidebar-block-title-size: 1.05rem;
            --sidebar-submenu-size: calc(var(--sidebar-block-title-size) * 0.85);
            {% if colores %}
            {% for key, value in colores.items() %}
            --{{ key }}: {{ value }};
            {% endfor %}
            {% endif %}
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--page-bg, #f4f6fb);
            color: var(--body-text, #0f172a);
        }
        .sidebar {
            width: 220px;
            background: linear-gradient(
                180deg,
                var(--sidebar-top, #1f2a3d),
                var(--sidebar-bottom, #0f172a)
            );
            color: var(--sidebar-text, #ffffff);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow: visible;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            box-shadow: 2px 0 12px rgba(15, 23, 42, 0.35);
            z-index: 3;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            background: transparent;
            font-weight: 600;
        }
        .sidebar-user {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 96px;
            height: 96px;
            border-radius: 24px;
            background: transparent;
            border: 0;
        }
        .sidebar-user img {
            width: 88px;
            height: 88px;
            border-radius: 20px;
            object-fit: cover;
        }
        .navbar-hamburger {
            font-size: 20px;
            background: none;
            border: none;
            color: #0f172a;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .navbar-hamburger svg {
            stroke: currentColor;
        }
        .navbar-hamburger:hover {
            background: rgba(15, 23, 42, 0.06);
        }
        nav {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.35) transparent;
        }
        .menu-audit-note {
            margin: 12px 16px 16px;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.78rem;
            line-height: 1.35;
        }
        .menu-audit-note strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        nav::-webkit-scrollbar {
            width: 8px;
        }
        nav a:hover,
        .accordion-header:hover,
        .sidebar-section-toggle:hover {
            background: var(--sidebar-hover, rgba(255, 255, 255, 0.08));
        }
        .accordion-header {
            justify-content: space-between;
        }
        .accordion,
        .sidebar-section {
            margin-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 4px;
        }
        .accordion-content,
        .sidebar-section-content {
            display: none;
            flex-direction: column;
        }
        .accordion.open .accordion-content {
            display: flex;
        }
        .submenu {
            display: block;
            width: 100%;
            padding: 10px 24px 10px 24px;
            padding-left: 66px;
            font-size: var(--sidebar-submenu-size);
            color: var(--sidebar-text, #d9e5ff);
            text-decoration: none;
            text-align: right;
            transition: color 0.2s, background 0.2s;
            font-family: inherit;
        }
        .submenu:hover {
            color: #ffcb2b;
            background: var(--sidebar-hover, rgba(255, 255, 255, 0.05));
        }
        .menu-icon {
            display: inline-block;
            mask-size: 22px 22px;
            -webkit-mask-size: 22px 22px;
        }
        .menu-label {
            flex: 1;
            font-size: var(--sidebar-block-title-size);
            letter-spacing: 0.02em;
            text-transform: none;
        }
        .menu-notification-link {
            position: relative;
        }
        .menu-notification-badge {
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            border-radius: 999px;
            background: #ef4444;
            color: #ffffff;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 22px;
            text-align: center;
            display: none;
        }
        .menu-notification-badge.visible {
            display: inline-block;
        }
        .menu-icon.placeholder {
            visibility: hidden;
        }
        .navbar {
            margin-left: 220px;
            padding: 0 24px;
            background: var(--navbar-bg, #ffffff);
            border-bottom: 1px solid rgba(236, 237, 244, 0.9);
            position: sticky;
            top: 0;
            z-index: 2;
            transition: margin-left 0.34s cubic-bezier(0.22, 1, 0.36, 1);
            font-weight: 600;
            color: var(--navbar-text, #1f2933);
            display: flex;
            justify-content: center;
            height: 72px;
        }
        .navbar-inner {
            width: 100%;
            max-width: 1280px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .navbar-hamburger {
            width: 40px;
            height: 40px;
            border: 0;
            border-radius: 10px;
            background: transparent;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            padding: 0 10px;
            cursor: pointer;
            transition: background 0.22s ease, transform 0.22s ease;
        }
        .navbar-hamburger:hover,
        .navbar-hamburger:focus-visible {
            background: rgba(15, 23, 42, 0.08);
            outline: none;
        }
        .navbar-hamburger .bar {
            display: block;
            width: 100%;
            height: 2px;
            border-radius: 999px;
            background: var(--navbar-text, #1f2933);
            transition: transform 0.34s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.22s ease;
            transform-origin: center;
        }
        .navbar-hamburger.is-open .bar:nth-child(1) {
            transform: translateY(7px) rotate(45deg);
        }
        .navbar-hamburger.is-open .bar:nth-child(2) {
            opacity: 0;
        }
        .navbar-hamburger.is-open .bar:nth-child(3) {
            transform: translateY(-7px) rotate(-45deg);
        }
        .navbar-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            font-weight: 700;
            line-height: 1.15;
        }
        .navbar-menu-name {
            font-size: 1.18rem;
            font-weight: 700;
        }
        .navbar-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.45);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0;
            cursor: pointer;
            padding: 0;
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }
        .navbar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .navbar-notifications-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 0;
            z-index: 2;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }
        .navbar-notifications-icon {
            width: 20px;
            height: 20px;
            display: block;
            background: var(--navbar-notifications-icon-color, var(--navbar-text, #1f2933));
            -webkit-mask: url("/templates/icon/notificaciones.svg") center / contain no-repeat;
            mask: url("/templates/icon/notificaciones.svg") center / contain no-repeat;
            filter: none;
            transition: background 0.2s ease;
        }
        .navbar-notifications-btn:hover,
        .navbar-notifications-btn:focus-visible {
            background: var(--sidebar-text, #ffffff);
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.22);
            outline: none;
        }
        .navbar-avatar:hover,
        .navbar-avatar:focus-visible {
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.22), inset 0 0 0 2px rgba(15, 23, 42, 0.6);
            filter: saturate(1.08);
            outline: none;
        }
        .navbar-notifications-btn:hover .navbar-notifications-icon,
        .navbar-notifications-btn:focus-visible .navbar-notifications-icon {
            background: var(--navbar-bg, #ffffff);
        }
        .navbar-notifications-badge {
            position: absolute;
            top: -4px;
            right: -3px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 999px;
            background: #ef4444;
            color: #ffffff;
            font-size: 0.65rem;
            font-weight: 700;
            line-height: 18px;
            text-align: center;
            display: none;
            border: 1px solid #ffffff;
        }
        .navbar-notifications-badge.visible {
            display: inline-block;
        }
        .navbar-avatar-icon {
            width: 20px;
            height: 20px;
            display: block;
            background: #1f2933;
            -webkit-mask: url("/templates/icon/usuarios.svg") center / contain no-repeat;
            mask: url("/templates/icon/usuarios.svg") center / contain no-repeat;
            opacity: 0.9;
        }
        .navbar-user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            min-width: 168px;
            background: #ffffff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            padding: 8px;
            display: none;
            z-index: 40;
        }
        .user-dropdown.open {
            display: block;
        }
        .user-dropdown a {
            display: block;
            text-decoration: none;
            color: #0f172a;
            font-weight: 600;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        .user-dropdown a:hover {
            background: #f1f5f9;
        }
        .sidebar-notifications-panel {
            position: fixed;
            top: 86px;
            left: 230px;
            width: 340px;
            max-width: calc(100vw - 246px);
            max-height: 72vh;
            border-radius: 14px;
            background: #ffffff;
            border: 1px solid #dbe3ef;
            box-shadow: 0 16px 38px rgba(15, 23, 42, 0.22);
            overflow: hidden;
            z-index: 45;
            display: none;
        }
        .sidebar-notifications-panel.open {
            display: flex;
            flex-direction: column;
        }
        .sidebar-notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid #e2e8f0;
        }
        .sidebar-notifications-header strong {
            font-size: 0.95rem;
            color: #0f172a;
        }
        .sidebar-notifications-count {
            font-size: 0.8rem;
            color: #64748b;
        }
        .sidebar-notifications-refresh {
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            color: #334155;
            border-radius: 8px;
            font-size: 0.78rem;
            padding: 6px 10px;
            cursor: pointer;
        }
        .sidebar-notifications-actions {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .sidebar-notifications-list {
            list-style: none;
            margin: 0;
            padding: 8px 10px 10px;
            overflow-y: auto;
            max-height: calc(72vh - 56px);
        }
        .sidebar-notifications-empty {
            margin: 8px 10px 12px;
            padding: 12px;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.84rem;
            display: none;
        }
        .notification-item {
            display: block;
            text-decoration: none;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 12px;
            color: #0f172a;
            margin-bottom: 8px;
            background: #ffffff;
        }
        .notification-item:hover {
            background: #f8fafc;
        }
        .notification-item.read {
            opacity: 0.7;
            background: #f8fafc;
        }
        .notification-item-title {
            font-size: 0.84rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .notification-item-msg {
            font-size: 0.8rem;
            color: #334155;
            margin-bottom: 4px;
        }
        .notification-item-date {
            font-size: 0.72rem;
            color: #64748b;
        }
        .sidebar {
            width: 220px;
            background: linear-gradient(180deg, var(--sidebar-top, #22c55e), var(--sidebar-bottom, #15803d));
            color: var(--sidebar-text, #ffffff);
            position: fixed;
            height: 100vh;
            top: 0;
            left: 0;
            transition: transform 0.34s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.24s ease, opacity 0.24s ease;
            overflow-x: hidden;
            overflow-y: auto;
            z-index: 3;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            will-change: transform;
        }
        .sidebar.is-collapsed {
            width: 72px;
            box-shadow: 2px 0 12px rgba(15, 23, 42, 0.2);
        }
        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 18px;
            padding: 0 10px 14px;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .sidebar.is-collapsed nav {
            opacity: 1;
            transform: none;
            margin-top: 8px;
            padding: 0 8px 14px;
            overflow: visible;
        }
        .sidebar nav a,
        .sidebar .accordion-header,
        .sidebar .sidebar-section-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--sidebar-text, #ffffff);
            text-decoration: none;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.92rem;
            font-weight: 600;
        }
        .sidebar-block {
            border: 1px solid rgba(255, 255, 255, 0);
            border-radius: 12px;
            background: transparent;
            overflow: hidden;
        }
        .sidebar-block > summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            color: var(--sidebar-text, #ffffff);
            font-size: 0.9rem;
            font-weight: 700;
        }
        .sidebar-block > summary::-webkit-details-marker {
            display: none;
        }
        .sidebar-block > summary:hover {
            background: var(--sidebar-hover, rgba(255, 255, 255, 0.08));
        }
        .sidebar-main-left {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .sidebar-main-icon {
            width: 16px;
            height: 16px;
            flex: 0 0 16px;
            display: inline-block;
            background-color: var(--sidebar-icon, #f5f7fb);
            -webkit-mask: var(--icon-src) center / contain no-repeat;
            mask: var(--icon-src) center / contain no-repeat;
        }
        .sidebar-block:hover .sidebar-main-icon,
        .sidebar-block > summary:hover .sidebar-main-icon {
            background-color: var(--sidebar-hover, #16a34a);
        }
        .sidebar-main-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-main-caret {
            font-size: 0.88rem;
            opacity: 0.88;
            transition: transform 0.2s ease;
        }
        .sidebar-block[open] .sidebar-main-caret {
            transform: rotate(180deg);
        }
        .sidebar-submenu {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 2px 8px 6px;
        }
        .sidebar-submenu a {
            justify-content: flex-end;
            text-align: right;
            font-size: 0.84rem;
            font-weight: 500;
            padding: 6px 10px;
            color: rgba(255, 255, 255, 0.94);
            border-radius: 8px;
        }
        .sidebar-submenu a:hover {
            background: var(--sidebar-hover, rgba(255, 255, 255, 0.1));
            color: #ffffff;
        }
        .sidebar.is-collapsed .sidebar-header {
            display: none;
        }
        .sidebar.is-collapsed .sidebar-block {
            position: relative;
            overflow: visible;
        }
        .sidebar.is-collapsed .sidebar-block > summary {
            justify-content: center;
            padding: 10px 8px;
        }
        .sidebar.is-collapsed .sidebar-main-left {
            gap: 0;
        }
        .sidebar.is-collapsed .sidebar-main-label,
        .sidebar.is-collapsed .sidebar-main-caret {
            display: none;
        }
        .sidebar.is-collapsed .sidebar-submenu {
            display: none;
            position: absolute;
            left: calc(100% + 8px);
            top: 0;
            min-width: 220px;
            padding: 6px 0;
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 20;
        }
        .sidebar.is-collapsed .sidebar-block[open] .sidebar-submenu,
        .sidebar.is-collapsed .sidebar-block.is-flyout-open .sidebar-submenu {
            display: flex;
        }
        .sidebar.is-collapsed .sidebar-submenu a {
            justify-content: flex-start;
            text-align: left;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(2px);
        }
        .sidebar.is-collapsed .sidebar-block:hover .sidebar-main-icon,
        .sidebar.is-collapsed .sidebar-block > summary:hover .sidebar-main-icon {
            background-color: var(--sidebar-icon, #f5f7fb);
        }
        .main-content {
            margin-left: 220px;
            padding: 32px 40px 48px;
            min-height: 100vh;
            background: #f4f6fb;
            transition: margin-left 0.34s cubic-bezier(0.22, 1, 0.36, 1);
            overflow-x: hidden;
            overflow-y: auto;
            width: calc(100vw - 220px);
            box-sizing: border-box;
        }
        .content-shell {
            width: min(94%, 1520px);
            max-width: 100%;
            margin: 0 auto;
            background: var(--navbar-bg, #ecfdf3);
            border-radius: 28px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 16%, #ffffff 84%);
            box-shadow: 0 24px 56px rgba(15, 23, 42, 0.12);
            padding: 18px;
        }
        .navbar-route {
            font-size: 0.84rem;
            color: #0f172a;
            text-decoration: none;
            opacity: 0.82;
            font-style: italic;
            transition: opacity 0.15s ease, text-decoration-color 0.15s ease;
        }
        .navbar-route:hover,
        .navbar-route:focus-visible {
            opacity: 1;
            text-decoration: underline;
            outline: none;
        }
        .message-box {
            position: fixed;
            top: 80px;
            right: 40px;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
            color: var(--sidebar-bottom, #0f172a);
            background: transparent;
            z-index: 20;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.25s, transform 0.25s;
        }
        .message-box.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .page-header {
            max-width: 100%;
            margin: 0 0 18px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
        }
        .page-header-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .page-header-subtitle {
            font-size: 0.95rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-weight: 600;
            color: #475569;
        }
        .page-header-text h1 {
            font-size: clamp(1.6rem, 2.2vw, 2.35rem);
            margin: 0;
            color: var(--page-title-color, var(--sidebar-bottom, #0f172a));
        }
        .page-header-description {
            margin: 0;
            color: #475569;
            font-size: 1.05rem;
        }
        .content-section {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 14%, #ffffff 86%);
            border-radius: 22px;
            background: var(--field-color, #ffffff);
            padding: 18px 18px 20px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5), 0 10px 24px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .content-section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 0;
        }
        .content-section-kicker {
            display: inline-flex;
            align-self: flex-start;
            margin: 0;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.74rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: var(--button-bg, #0f172a);
            color: var(--button-text, #ffffff);
        }
        .content-section-title {
            margin: 0;
            font-size: 1.3rem;
            color: var(--sidebar-bottom, #0f172a);
        }
        .content-section-body {
            color: var(--navbar-text, #1f172a);
        }
        .subsection-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }
        .subsection-card {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 12%, #ffffff 88%);
            border-radius: 26px;
            background: var(--field-color, #f8fafc);
            padding: 22px 22px 20px;
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.05);
        }
        .subsection-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }
        .subsection-title {
            margin: 0;
            font-size: clamp(1.5rem, 3.2vw, 2.2rem);
            line-height: 1.05;
            color: var(--sidebar-bottom, #0f172a);
        }
        .subsection-description {
            margin: 0;
            color: var(--navbar-text, #475569);
            opacity: 0.78;
            font-size: 0.98rem;
        }
        .subsection-value {
            margin: 2px 0 0;
            font-size: clamp(2rem, 3.8vw, 3.2rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--sidebar-bottom, #0f172a);
        }
        .subsection-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
            background: color-mix(in srgb, var(--navbar-bg, #e9edf5) 72%, #ffffff 28%);
            color: var(--button-bg, #0f172a);
            font-size: 0.94rem;
            font-weight: 700;
            padding: 8px 14px;
            white-space: nowrap;
        }
        .content-section-body > :first-child {
            margin-top: 0;
        }
        .content-section-body > :last-child {
            margin-bottom: 0;
        }
        .personalization-panel {
            display: flex;
            flex-direction: column;
            gap: 14px;
            width: 100%;
        }
        .personalization-head {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 12%, #ffffff 88%);
            border-radius: 16px;
            background: color-mix(in srgb, var(--navbar-bg, #ffffff) 82%, #eef2ff 18%);
            padding: 14px 16px;
        }
        .personalization-head h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--sidebar-bottom, #0f172a);
        }
        .personalization-head p {
            margin: 6px 0 0;
            color: var(--navbar-text, #475569);
            opacity: 0.9;
            font-size: 0.92rem;
        }
        .color-group {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 11%, #ffffff 89%);
            border-radius: 18px;
            padding: 14px;
            background: #ffffff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
        }
        .color-group h3 {
            margin: 0 0 10px;
            font-size: 1rem;
            color: var(--sidebar-bottom, #0f172a);
        }
        .asset-group-description {
            margin: -2px 0 10px;
            color: var(--navbar-text, #475569);
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .asset-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .asset-file-input {
            display: none;
        }
        .asset-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 12%, #ffffff 88%);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 12px;
        }
        .asset-row-preview {
            width: 56px;
            height: 56px;
            flex-shrink: 0;
            border-radius: 12px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 18%, #ffffff 82%);
            background: #f8fafc;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .asset-thumb {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .asset-row-main {
            flex: 1;
            min-width: 0;
        }
        .asset-row-main h4 {
            margin: 0;
            font-size: 0.95rem;
            color: var(--sidebar-bottom, #0f172a);
        }
        .asset-filename {
            margin: 2px 0 0;
            color: var(--navbar-text, #334155);
            font-size: 0.84rem;
        }
        .asset-link {
            display: inline-block;
            margin-top: 2px;
            font-size: 0.8rem;
            color: var(--button-bg, #0f172a);
            text-decoration: underline;
            text-underline-offset: 2px;
        }
        .asset-row-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .color-option {
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 12%, #ffffff 88%);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.78);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .color-option label {
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--navbar-text, #334155);
        }
        .color-option input[type="color"] {
            width: 100%;
            height: 38px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
            border-radius: 10px;
            background: #ffffff;
            padding: 3px;
            cursor: pointer;
        }
        .color-preview {
            height: 18px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--button-bg, #0f172a) 20%, #ffffff 80%);
        }
        .color-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 2px;
        }
        .color-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--button-bg, #0f172a);
            transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
        }
        .color-btn__icon {
            width: 14px;
            height: 14px;
            object-fit: contain;
            display: block;
        }
        .color-btn--icon-toggle {
            min-width: 40px;
            width: auto;
            padding: 10px;
            border-radius: 999px;
            overflow: hidden;
        }
        .color-btn__label {
            max-width: 0;
            opacity: 0;
            white-space: nowrap;
            overflow: hidden;
            transition: max-width 0.18s ease, opacity 0.18s ease;
        }
        .color-btn--icon-toggle:hover {
            padding: 10px 14px;
        }
        .color-btn--icon-toggle:hover .color-btn__label {
            max-width: 96px;
            opacity: 1;
        }
        .color-btn--primary {
            background: var(--button-bg, #0f172a);
            color: var(--button-text, #ffffff);
        }
        .color-btn--primary:hover {
            background: var(--button-text, #ffffff);
            color: var(--button-bg, #0f172a);
            border-color: var(--button-bg, #0f172a);
        }
        .color-btn--ghost {
            background: #ffffff;
            color: var(--button-bg, #0f172a);
            border-color: color-mix(in srgb, var(--button-bg, #0f172a) 35%, #ffffff 65%);
        }
        .color-btn--ghost:hover {
            background: var(--button-bg, #0f172a);
            color: var(--button-text, #ffffff);
            border-color: var(--button-bg, #0f172a);
        }
        .view-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        .view-buttons .view-pill {
            border-radius: 999px;
            border: 1px solid var(--view-pill-border, var(--sidebar-bottom, #0f172a));
            background: var(--view-pill-bg, var(--sidebar-text, #ffffff));
            color: var(--view-pill-text, var(--sidebar-bottom, #0f172a));
            font-weight: 600;
            padding: 10px 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }
        .view-buttons .view-pill:hover {
            background: var(--view-pill-hover-bg, var(--sidebar-bottom, #0f172a));
            color: var(--view-pill-hover-text, var(--sidebar-text, #ffffff));
            border-color: var(--view-pill-border, var(--sidebar-bottom, #0f172a));
        }
        .view-buttons .view-pill.active {
            background: var(--view-pill-hover-bg, var(--sidebar-bottom, #0f172a));
            color: var(--view-pill-hover-text, var(--sidebar-text, #ffffff));
            border-color: var(--view-pill-border, var(--sidebar-bottom, #0f172a));
        }
        .view-buttons .view-pill img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: block;
        }
        .view-pill-icon-mask {
            width: 18px;
            height: 18px;
            display: inline-block;
            background: var(--view-pill-icon, var(--sidebar-bottom, #0f172a));
            -webkit-mask: var(--view-pill-icon-url) center / contain no-repeat;
            mask: var(--view-pill-icon-url) center / contain no-repeat;
            transition: background 0.2s;
            flex: 0 0 18px;
        }
        .view-buttons .view-pill:hover .view-pill-icon-mask,
        .view-buttons .view-pill.active .view-pill-icon-mask {
            background: var(--view-pill-hover-icon, var(--sidebar-text, #ffffff));
        }
        .floating-actions-wrapper {
            position: fixed;
            right: 12px;
            top: 50%;
            transform: translateY(-50%) scale(var(--floating-scale, 1));
            transform-origin: right center;
            z-index: 4;
        }
        .floating-actions {
            background: var(--floating-panel-bg, var(--sidebar-text, #ffffff));
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.2);
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid var(--floating-toggle-color, #1f2a3d);
            min-width: 72px;
            position: relative;
        }
        .floating-actions-group {
            display: none;
            flex-direction: column;
            gap: 6px;
        }
        .floating-actions-group.active {
            display: flex;
        }
        .floating-actions.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(24px);
            display: none;
        }
        .floating-actions::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            border: 2px solid var(--floating-toggle-color, #1f2a3d);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .floating-actions:hover::after {
            opacity: 1;
        }
        .floating-placeholder .floating-actions {
            opacity: 0.4;
        }
        .floating-actions-separator {
            width: 100%;
            height: 12px;
        }
        .action-button {
            position: relative;
            background: var(--floating-action-bg, #ffffff);
            border: 1px solid var(--floating-action-border, var(--button-bg, #0f172a));
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--floating-action-text, var(--button-bg, #0f172a));
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, color 0.2s, width 0.2s, border-color 0.2s;
            overflow: hidden;
        }
        .action-button:hover {
            width: 156px;
            background: var(--button-bg, #0f172a);
            color: var(--button-text, #ffffff);
            border-color: var(--button-bg, #0f172a);
        }
        .action-button img,
        .action-button svg {
            width: 36px;
            height: 36px;
            transition: opacity 0.2s;
            opacity: 1;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .action-icon-mask {
            width: 36px;
            height: 36px;
            display: inline-block;
            background: var(--floating-icon-color, var(--button-bg, #0f172a));
            -webkit-mask: var(--action-icon-url) center / contain no-repeat;
            mask: var(--action-icon-url) center / contain no-repeat;
            transition: opacity 0.2s;
            opacity: 1;
            flex: 0 0 36px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .action-button svg {
            fill: var(--floating-icon-color, #1f2a3d);
            stroke: var(--floating-icon-color, #1f2a3d);
        }
        .action-label {
            font-size: 0.95rem;
            font-style: normal;
            letter-spacing: 0.02em;
            opacity: 0;
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
            pointer-events: none;
        }
        .action-button:hover .action-label {
            opacity: 1;
        }
        .action-button:hover svg,
        .action-button:hover img,
        .action-button:hover .action-icon-mask {
            opacity: 0;
        }
        .floating-actions-group[data-floating-screen="areas"].active {
            display: flex !important;
        }
        .floating-actions-group[data-floating-screen="areas"] .action-button,
        .floating-actions-group[data-floating-screen="areas"] .action-label,
        .floating-actions-group[data-floating-screen="areas"] .action-button img,
        .floating-actions-group[data-floating-screen="areas"] .action-button svg {
            visibility: visible;
        }
        .floating-actions-group[data-floating-screen="usuarios"].active {
            display: flex !important;
        }
        .floating-actions-group[data-floating-screen="usuarios"] .action-button,
        .floating-actions-group[data-floating-screen="usuarios"] .action-label,
        .floating-actions-group[data-floating-screen="usuarios"] .action-button img,
        .floating-actions-group[data-floating-screen="usuarios"] .action-button svg {
            visibility: visible;
        }
        .floating-toggle {
            position: absolute;
            top: 50%;
            right: -18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--floating-toggle-color, #1f2a3d);
            background: var(--floating-toggle-color, #1f2a3d);
            font-size: 18px;
            font-weight: 700;
            color: var(--floating-toggle-text-color, #ffffff);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            transform: scale(1.56);
            transform-origin: center;
        }
        .floating-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.6);
        }
        .floating-toggle:hover {
            filter: brightness(1.15);
        }
        .usuario-panel {
            margin-top: 32px;
            background: #fff;
            border-radius: 20px;
            padding: 32px 36px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
        }
        .usuario-panel.hidden {
            display: none;
        }
        .usuario-header {
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 24px;
        }
        .usuario-avatar {
            width: 90px;
            height: 90px;
            border-radius: 18px;
            background: #e5f1ff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #0f172a;
        }
        .usuario-avatar img {
            width: 72px;
            height: 72px;
            object-fit: cover;
        }
        .usuario-title h2 {
            margin: 0;
            font-size: 1.8rem;
            color: #0f172a;
        }
        .usuario-title small {
            color: #475569;
            font-size: 0.95rem;
        }
        .usuario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        .usuario-tab,
        .area-tab {
            padding: 8px 18px;
            border-radius: 999px;
            border: 1px solid #d4d4d8;
            background: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .usuario-tab.active,
        .area-tab.active {
            background: #0f172a;
            color: #fff;
        }
        .usuario-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .usuario-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .usuario-form-group label {
            color: #475569;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .usuario-form-group input,
        .usuario-form-group textarea,
        .usuario-form-group select {
            border-radius: 14px;
            border: 1px solid #d1d5db;
            padding: 10px 12px;
            font-family: inherit;
            background: #fefefe;
            min-height: 44px;
            font-size: 0.95rem;
        }
        .usuario-form-group textarea {
            min-height: 90px;
        }
        .usuario-list,
        .usuario-kanban {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .usuario-card {
            padding: 16px 20px;
            border-radius: 16px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            background: #fcfcff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .kanban-card-two-col {
            display: grid;
            grid-template-columns: 88px minmax(0, 1fr);
            align-items: center;
            gap: 14px;
        }
        .kanban-card-media {
            width: 88px;
            height: 88px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #dbe3ef;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kanban-card-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .kanban-card-body {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }
        .kanban-card-body strong,
        .kanban-card-body span {
            overflow-wrap: anywhere;
        }
        .usuario-card strong {
            font-size: 1rem;
            color: #0f172a;
        }
        .usuario-card span {
            color: #475569;
        }
        .usuario-selectable {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
        }
        .usuario-selectable:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.09);
            border-color: rgba(37, 99, 235, 0.5);
        }
        .usuario-kanban-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .usuario-kanban-column {
            border: 1px dashed var(--sidebar-bottom, #0f172a);
            border-radius: 16px;
            padding: 12px;
            background: #fff;
        }
        .usuario-kanban-column h4 {
            margin: 0 0 12px;
            font-size: 1rem;
            color: #0f172a;
        }
        .usuario-role-filter {
            max-width: 280px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .usuario-role-filter label {
            font-size: 0.82rem;
            font-weight: 700;
            color: #334155;
        }
        .usuario-role-filter select {
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            padding: 9px 10px;
            font-size: 0.9rem;
        }
        .usuario-shell {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .usuario-shell__head {
            background: linear-gradient(140deg, rgba(15,61,46,.92), rgba(29,78,216,.86));
            border-radius: 16px;
            color: #fff;
            padding: 14px 16px;
            border: 1px solid rgba(15,61,46,.25);
            box-shadow: 0 14px 28px rgba(15,23,42,.12);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
        }
        .usuario-shell__head h2 {
            margin: 0;
            font-size: 1.12rem;
            font-weight: 700;
        }
        .usuario-shell__head p {
            margin: 6px 0 0;
            font-size: 0.85rem;
            opacity: .92;
        }
        .usuario-shell__meta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            border-radius: 999px;
            padding: 6px 10px;
            background: rgba(255,255,255,.16);
            border: 1px solid rgba(255,255,255,.25);
            font-size: 0.82rem;
            font-weight: 700;
        }
        .usuario-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .usuario-stat {
            background: #fff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(15,23,42,.05);
        }
        .usuario-stat strong {
            display: block;
            color: #0f172a;
            font-size: 1rem;
            line-height: 1;
            margin-bottom: 4px;
        }
        .usuario-stat span {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .usuario-empty {
            margin: 0;
            color: #64748b;
            font-size: 0.88rem;
            text-align: center;
            padding: 8px 0;
        }
        .area-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px 18px;
        }
        .area-shell {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .area-shell__head {
            background: linear-gradient(140deg, rgba(15,61,46,.92), rgba(29,78,216,.86));
            border-radius: 16px;
            color: #fff;
            padding: 14px 16px;
            border: 1px solid rgba(15,61,46,.25);
            box-shadow: 0 14px 28px rgba(15,23,42,.12);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
        }
        .area-shell__head h2 {
            margin: 0;
            font-size: 1.12rem;
            font-weight: 700;
        }
        .area-shell__head p {
            margin: 6px 0 0;
            font-size: 0.85rem;
            opacity: .92;
        }
        .area-shell__meta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 74px;
            border-radius: 999px;
            padding: 6px 10px;
            background: rgba(255,255,255,.16);
            border: 1px solid rgba(255,255,255,.25);
            font-size: 0.82rem;
            font-weight: 700;
        }
        .area-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .area-stat {
            background: #fff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(15,23,42,.05);
        }
        .area-stat strong {
            display: block;
            color: #0f172a;
            font-size: 1rem;
            line-height: 1;
            margin-bottom: 4px;
        }
        .area-stat span {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .area-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 2px;
        }
        .area-actions button {
            border: 1px solid #0f172a;
            background: #0f172a;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.86rem;
        }
        .area-actions button.secondary {
            background: #fff;
            color: #0f172a;
            border-color: #cbd5e1;
        }
        .area-relacion-help-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .area-relacion-help-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #334155;
            background: #f8fafc;
            border: 1px solid #dbeafe;
            border-radius: 999px;
            padding: 4px 10px;
        }
        .area-relacion-help-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #0f172a;
            background: #ffffff;
            color: #0f172a;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            cursor: pointer;
            padding: 0;
        }
        .area-kanban-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .area-kanban-column {
            border: 1px dashed var(--sidebar-bottom, #0f172a);
            border-radius: 12px;
            padding: 12px;
            background: #fff;
        }
        .area-kanban-column h4 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            color: #0f172a;
        }
        .area-card {
            padding: 10px 12px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            border-radius: 10px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .area-card strong {
            color: #0f172a;
        }
        .area-card span {
            color: #475569;
            font-size: 0.9rem;
        }
        .area-card.kanban-card-two-col {
            display: grid;
            grid-template-columns: 88px minmax(0, 1fr);
            align-items: center;
            gap: 14px;
        }
        .area-empty {
            margin: 0;
            color: #64748b;
            font-size: 0.88rem;
            text-align: center;
            padding: 8px 0;
        }
        .usuario-organigrama {
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding: 6px 0;
        }
        .plantillas-page {
            width: 100%;
        }
        .plantillas-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px;
            align-items: start;
        }
        .plantillas-list-card,
        .plantillas-editor-card {
            background: #ffffff;
            border: 1px solid #dbe3ef;
            border-radius: 12px;
            padding: 16px;
        }
        .plantillas-list-card h3 {
            margin: 0;
            color: #0f172a;
        }
        .plantillas-hint {
            margin: 8px 0 14px;
            font-size: 0.9rem;
            color: #475569;
        }
        .plantillas-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 460px;
            overflow: auto;
        }
        .plantillas-item {
            border: 1px solid #dbe3ef;
            background: #f8fbff;
            color: #1e293b;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            transition: border-color 160ms ease, background 160ms ease;
        }
        .plantillas-item.active {
            border-color: #2c9c63;
            background: #ecfdf5;
        }
        .plantillas-editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .plantilla-code {
            min-height: 240px;
            resize: vertical;
            font-family: "SFMono-Regular", Menlo, Consolas, monospace;
            font-size: 0.86rem;
            background: #f8fafc;
        }
        .plantillas-preview-head {
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .plantillas-preview-head h4 {
            margin: 0;
            color: #0f172a;
        }
        .plantillas-preview-head button {
            border: 1px solid #14532d;
            background: #166534;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .plantilla-preview-frame {
            width: 100%;
            min-height: 290px;
            height: 340px;
            border: 1px solid #dbe3ef;
            border-radius: 10px;
            background: #ffffff;
            margin-top: 10px;
        }
        .form-builder-panel {
            margin-top: 12px;
            border: 1px solid #dbe3ef;
            border-radius: 10px;
            padding: 14px;
            background: #f8fbff;
        }
        .form-builder-panel.hidden {
            display: none;
        }
        .form-builder-head h4 {
            margin: 0;
            color: #0f172a;
        }
        .form-builder-head p {
            margin: 4px 0 0;
            color: #475569;
            font-size: 0.9rem;
        }
        .form-builder-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 12px;
            margin-top: 12px;
        }
        .form-builder-grid.field-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .form-builder-description {
            grid-column: 1 / -1;
        }
        .form-builder-description textarea {
            min-height: 72px;
        }
        .form-field-inline {
            align-self: end;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .form-builder-field-editor {
            margin-top: 12px;
            border-top: 1px solid #dbe3ef;
            padding-top: 12px;
        }
        .form-builder-field-editor h5,
        .form-builder-list-wrap h5 {
            margin: 0 0 10px;
            color: #0f172a;
            font-size: 0.95rem;
        }
        .form-builder-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .form-builder-actions button {
            border: 1px solid #14532d;
            background: #166534;
            color: #fff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .form-builder-fields-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .builder-field-item {
            border: 1px solid #dbe3ef;
            background: #ffffff;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }
        .builder-field-item .meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            color: #334155;
            font-size: 0.86rem;
        }
        .builder-field-item strong {
            color: #0f172a;
            font-size: 0.92rem;
        }
        .builder-field-delete {
            border: 1px solid #b91c1c;
            background: #fff1f2;
            color: #b91c1c;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .org-level {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .org-node {
            min-width: 210px;
            padding: 12px 14px;
            border: 1px solid var(--sidebar-bottom, #0f172a);
            border-radius: 8px;
            background: #ffffff;
            text-align: center;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }
        .org-node-avatar {
            width: 74px;
            height: 74px;
            margin: 0 auto 10px;
            border-radius: 16px;
            border: 1px solid #cbd5e1;
            overflow: hidden;
            background: #ffffff;
        }
        .org-node-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .org-node strong {
            display: block;
            margin-bottom: 4px;
            color: #0f172a;
        }
        .org-node span {
            display: block;
            color: #475569;
            font-size: 0.9rem;
        }
        .org-root .org-node {
            border-color: var(--sidebar-bottom, #0f172a);
            background: #f8fafc;
        }
        .org-node.usuario-selectable:hover {
            background: #eff6ff;
        }
        .org-divider {
            width: 2px;
            height: 20px;
            margin: 0 auto;
            background: #cbd5e1;
        }
        .usuarios-form-layout {
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-width: 980px;
        }
        .form-section {
            background: #fff;
            border-radius: 2px;
            padding: 16px 18px;
            border: 1px solid #e5e7eb;
            box-shadow: none;
        }
        .section-title h2 {
            margin: 0 0 14px;
            font-size: 1.15rem;
            color: #1e293b;
            font-weight: 600;
        }
        .section-title .tag {
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #64748b;
            margin: 0 0 4px;
            font-weight: 600;
        }
        .section-grid {
            display: grid;
            gap: 12px 18px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .section-grid.two-columns {
            grid-template-columns: minmax(0, 1fr) 110px;
            align-items: start;
        }
        .tabla-oficial-wrap {
            width: 100%;
            overflow-x: auto;
        }
        .tabla-oficial {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            table-layout: auto;
        }
        .tabla-oficial th,
        .tabla-oficial td {
            border: 1px solid rgba(15, 23, 42, 0.25);
            padding: 8px 10px;
            vertical-align: middle;
        }
        .tabla-oficial tbody tr:nth-child(odd) td {
            background: #ffffff;
        }
        .tabla-oficial tbody tr:nth-child(even) td {
            background: var(--field-color, #e7d7da);
        }
        .tabla-oficial th.tabla-oficial-num,
        .tabla-oficial td.tabla-oficial-num {
            text-align: right;
        }
        .tabla-oficial-input {
            width: 100%;
            text-align: right;
            border: 0;
            outline: 0;
            padding: 0;
            margin: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            font: inherit;
            color: inherit;
        }
        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.88rem;
            color: #334155;
        }
        .form-field label {
            font-size: 0.86rem;
            font-weight: 600;
            color: #334155;
        }
        .form-field input,
        .form-field select,
        .form-field textarea {
            border-radius: 2px;
            border: 1px solid #d1d5db;
            padding: 9px 10px;
            font-size: 0.95rem;
            font-family: inherit;
            color: #0f172a;
            background: #fff;
        }
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #64748b;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.12);
        }
        .campo,
        .campo-personalizado {
            background: var(--field-color, #e7d7da) !important;
            border-radius: 16px !important;
            border: 1px solid rgba(15, 23, 42, 0.08);
            padding: 10px 14px;
        }
        input.campo,
        textarea.campo,
        select.campo,
        input.campo-personalizado,
        textarea.campo-personalizado,
        select.campo-personalizado {
            border-radius: 16px !important;
        }
        .password-confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 30;
        }
        .password-confirm-backdrop.hidden {
            display: none;
        }
        .password-confirm-modal {
            width: min(92vw, 360px);
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .password-confirm-modal h3 {
            margin: 0;
            font-size: 1rem;
            color: #0f172a;
        }
        .password-confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .password-confirm-actions button {
            border: 1px solid #cbd5e1;
            background: #fff;
            color: #0f172a;
            border-radius: 6px;
            padding: 7px 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .password-confirm-actions button.primary {
            background: #0f172a;
            border-color: #0f172a;
            color: #fff;
        }
        .password-confirm-msg {
            min-height: 16px;
            margin: 0;
            font-size: 0.82rem;
            color: #b91c1c;
        }
        .foda-page {
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .foda-input-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
        }
        .foda-input-card h2 {
            margin: 0;
            color: #0f172a;
            font-size: 1.25rem;
        }
        .foda-input-card p {
            margin: 8px 0 14px;
            color: #475569;
        }
        .foda-input-grid {
            display: grid;
            grid-template-columns: 1.8fr 1fr 1fr;
            gap: 12px;
        }
        .foda-input-grid textarea {
            min-height: 96px;
            resize: vertical;
        }
        .identity-inline-field {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            align-items: center;
            gap: 12px;
        }
        .identity-inline-field label.identity-field-label {
            text-align: right;
            font-size: 0.86rem;
            font-weight: 600;
            color: #334155;
            line-height: 1.1;
            display: inline-flex;
            flex-direction: column;
            gap: 2px;
            justify-self: end;
        }
        .identity-inline-field textarea {
            min-height: 86px;
        }
        .foda-input-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
        }
        .foda-input-actions button {
            border: 1px solid #0f172a;
            background: #0f172a;
            color: #fff;
            border-radius: 8px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .identity-assets-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .identity-asset-row {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            align-items: center;
            gap: 16px;
            background: #ffffff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 14px;
        }
        .identity-asset-title {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
            text-align: right;
        }
        .identity-asset-media {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .identity-asset-image {
            width: 100%;
            max-width: 520px;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #f8fafc;
        }
        .identity-asset-image-logo {
            object-fit: contain;
        }
        .identity-asset-image-favicon {
            width: 96px;
            height: 96px;
            max-width: 96px;
            object-fit: contain;
            padding: 10px;
        }
        .identity-asset-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 106px;
        }
        .identity-asset-actions button {
            border: 1px solid #94a3b8;
            background: #ffffff;
            color: #0f172a;
            border-radius: 10px;
            padding: 7px 10px;
            font-weight: 600;
            cursor: pointer;
        }
        .identity-asset-actions .identity-asset-delete {
            border-color: #fecaca;
            color: #991b1b;
            background: #fff1f2;
        }
        .image-uploader {
            align-items: flex-end;
            justify-content: flex-start;
        }
        .image-placeholder {
            width: 92px;
            min-height: 92px;
            background: #f8fafc;
            border-radius: 2px;
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #64748b;
            justify-content: center;
        }
        .image-placeholder span {
            font-size: 0.72rem;
            line-height: 1.2;
        }
        .image-placeholder button {
            border: 1px solid #cbd5e1;
            padding: 4px 8px;
            border-radius: 2px;
            background: #ffffff;
            color: #334155;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .notebook-section .notebook-tabs {
            display: flex;
            gap: 0;
            flex-wrap: nowrap;
            margin-top: 0;
            border-bottom: 1px solid #d1d5db;
            overflow-x: auto;
        }
        .notebook-tabs .tab {
            border: 1px solid #d1d5db;
            border-bottom: none;
            padding: 8px 14px;
            border-radius: 0;
            background: #f8fafc;
            color: #334155;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            margin-bottom: -1px;
        }
        .notebook-tabs .tab.active {
            background: #ffffff;
            color: #0f172a;
            border-color: #d1d5db;
        }
        .notebook-content {
            margin-top: 0;
            padding: 16px;
            border-radius: 0;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-top: none;
            min-height: 120px;
        }
        .notebook-content p {
            margin: 0;
            color: #334155;
        }
        @media (max-width: 900px) {
            .foda-input-grid {
                grid-template-columns: 1fr;
            }
            .identity-inline-field {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .identity-inline-field label.identity-field-label {
                text-align: left;
                justify-self: start;
            }
            .identity-asset-row {
                grid-template-columns: 1fr;
            }
            .identity-asset-title {
                text-align: left;
            }
            .identity-asset-media {
                flex-direction: column;
                align-items: flex-start;
            }
            .identity-asset-image {
                max-width: 100%;
                height: 150px;
            }
            .identity-asset-actions {
                flex-direction: row;
            }
            .section-grid.two-columns {
                grid-template-columns: 1fr;
            }
            .usuario-shell__head {
                flex-direction: column;
                align-items: flex-start;
            }
            .usuario-stats {
                grid-template-columns: 1fr;
            }
            .area-shell__head {
                flex-direction: column;
                align-items: flex-start;
            }
            .area-stats {
                grid-template-columns: 1fr;
            }
            .area-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            .plantillas-layout {
                grid-template-columns: 1fr;
            }
            .plantillas-editor-grid {
                grid-template-columns: 1fr;
            }
            .form-builder-grid,
            .form-builder-grid.field-grid {
                grid-template-columns: 1fr;
            }
            .kanban-card-two-col {
                grid-template-columns: 72px minmax(0, 1fr);
            }
            .kanban-card-media {
                width: 72px;
                height: 72px;
            }
            .image-uploader {
                align-items: flex-start;
            }
        }
        @media (max-width: 900px) {
            .sidebar {
                width: 0;
            }
            .sidebar-notifications-panel {
                left: 12px;
                right: 12px;
                width: auto;
                max-width: none;
                top: 78px;
            }
            .navbar,
            .main-content {
                margin-left: 0;
            }
            .navbar {
                padding: 0 12px;
            }
            .main-content {
                width: 100%;
                padding: 16px 14px 24px;
            }
            .page-header {
                margin-bottom: 18px;
            }
            .content-shell {
                width: 100%;
                padding: 14px;
                border-radius: 18px;
            }
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            .content-section-head {
                flex-direction: column;
                align-items: flex-start;
            }
            .subsection-grid {
                grid-template-columns: 1fr;
            }
            .color-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .color-actions {
                justify-content: flex-start;
            }
            .asset-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .asset-row-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
        }
        @media (max-width: 640px) {
            .color-grid {
                grid-template-columns: 1fr;
            }
            .color-btn {
                width: 100%;
            }
            .color-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    {% set hide_floating_actions = hide_floating_actions | default(false) %}
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-user">
                <img
                    id="sidebar-user-img"
                    src="{{ login_logo_url | default('/templates/icon/icon.png') }}"
                    data-default="{{ login_logo_url | default('/templates/icon/icon.png') }}"
                    alt="Logo empresa"
                />
            </div>
        </div>
        <nav>
            <details class="sidebar-block" open>
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/inicio.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Organizacin</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/inicio/departamentos">Departamentos</a>
                    <a href="/inicio/regiones">Regiones</a>
                    <a href="/inicio/sucursales">Sucursales</a>
                    <a href="/inicio/colaboradores">Colaboradores</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/proyectando.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Proyectando</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/proyectando">Tablero de control</a>
                    <a href="/proyectando/datos-preliminares">Datos preliminares</a>
                    <a href="/proyectando/crecimiento-general">Crecimiento General</a>
                    <a href="/proyectando/presupuesto">Presupuesto</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/plan.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Planificacin</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/planes">Plan estratgico</a>
                    <a href="/poa">POA</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/diagnostico.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Diagnstico</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/diagnostico/foda">FODA</a>
                    <a href="/diagnostico/pestel">PESTEL</a>
                    <a href="/diagnostico/porter">PORTER</a>
                    <a href="/diagnostico/percepcion-cliente">Percepcin del cliente</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/kpi.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">KPI's</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="https://cajapolotitlan.circulocooperativo.com/kpis">KPI's</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/notificaciones.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Notificaciones</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="#">Submenu 1</a>
                    <a href="#">Submenu 2</a>
                    <a href="#">Submenu 3</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/reporte.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Reportes</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="https://cajapolotitlan.circulocooperativo.com/reportes">Resumen</a>
                    <a href="https://cajapolotitlan.circulocooperativo.com/reportes/documentos">Documentos</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/empresa.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Empresa</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/identidad-institucional#">Identidad institucional</a>
                    <a href="/plantillas">Plantillas</a>
                    <a href="/plantillas/constructor">Constructor de formularios</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/settings.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Ajustes</span>
                    </span>
                    <span class="sidebar-main-caret"></span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/personalizar">Colores</a>
                    <a href="/roles-permisos">Roles</a>
                    <a href="/membresia">Membresa</a>
                </div>
            </details>
        </nav>
        <div class="sidebar-notifications-panel" id="sidebar-notifications-panel" aria-hidden="true">
            <div class="sidebar-notifications-header">
                <div>
                    <strong>Notificaciones</strong>
                    <div class="sidebar-notifications-count" id="sidebar-notifications-count">Sin pendientes</div>
                </div>
                <div class="sidebar-notifications-actions">
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-mark-all">Marcar todo</button>
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-refresh">Actualizar</button>
                </div>
            </div>
            <div class="sidebar-notifications-empty" id="sidebar-notifications-empty">No tienes notificaciones pendientes.</div>
            <ul class="sidebar-notifications-list" id="sidebar-notifications-list"></ul>
        </div>
    </div>
    <div class="navbar">
        <div class="navbar-inner">
            <div class="navbar-left">
                <button class="navbar-hamburger is-open" aria-label="Mostrar u ocultar men" aria-expanded="true" aria-controls="sidebar">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <div class="navbar-title">
                    <span class="navbar-menu-name">{{ page_title or title or "Inicio" }}</span>
                    <a class="navbar-route" href="{{ request.url.path | default('/inicio') }}">{{ request.url.path | default('/inicio') }}</a>
                </div>
            </div>
            <div class="navbar-user-menu">
                <button class="navbar-notifications-btn" id="navbar-notifications-trigger" aria-label="Notificaciones" aria-expanded="false">
                    <span class="navbar-notifications-icon" aria-hidden="true"></span>
                    <span class="navbar-notifications-badge" id="navbar-notifications-badge">0</span>
                </button>
                <button class="navbar-avatar" id="navbar-avatar-btn" aria-label="Men de usuario" aria-expanded="false">
                    <img
                        id="navbar-avatar-img"
                        src="/templates/icon/usuario.png"
                        data-default="/templates/icon/usuario.png"
                        alt="Usuario"
                    />
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="/logout" id="logout-link">Cerrar sesin</a>
                </div>
            </div>
        </div>
    </div>
    <main class="main-content">
        <div class="content-shell">
        {% if show_page_header | default(true) %}
        <section class="page-header">
            <div class="page-header-text">
                {% if subtitle %}
                <span class="page-header-subtitle">{{ subtitle }}</span>
                {% endif %}
                <h1 style="color: var(--titulo-color, var(--sidebar-bottom, #0f172a));">{{ page_title or title }}</h1>
                <p class="page-header-description" style="color: var(--descripcion-color, #475569);">{{ page_description or description }}</p>
            </div>
            {% if view_buttons_html %}
            <div class="view-buttons">
                {{ view_buttons_html | safe }}
            </div>
            {% endif %}
        </section>
        {% endif %}
        <section class="content-section">
            {% if section_label or section_title %}
            <header class="content-section-head">
                {% if section_label %}<p class="content-section-kicker">{{ section_label }}</p>{% endif %}
                {% if section_title %}<h2 class="content-section-title" style="color: var(--titulo-seccion-color, var(--sidebar-bottom, #0f172a));">{{ section_title }}</h2>{% endif %}
            </header>
            {% endif %}
            <div class="content-section-body" style="color: var(--texto-color, var(--navbar-text, #1f172a));">
                {{ content|safe }}
            </div>
        </section>
        </div>
    </main>
        {% if not hide_floating_actions and floating_actions_html %}
        <div class="floating-actions-wrapper"
             aria-label="Acciones rpidas de pantalla"
             data-default-screen="{{ floating_actions_screen | default('personalization') }}">
            <aside class="floating-actions">
                {{ floating_actions_html | safe }}
            </aside>
            <button class="floating-toggle" type="button" id="floating-toggle" aria-label="Ocultar barra flotante"></button>
        </div>
        {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const hamburger = document.querySelector('.navbar-hamburger');
            const sidebarElem = document.getElementById('sidebar');
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            const personalizarBtn = document.getElementById('personalizar-btn');
            const personalizarToggle = document.getElementById('personalizar-toggle');
            const personalizarSubmenu = document.getElementById('personalizar-submenu');
            const planificacionBtn = document.getElementById('planificacion-btn');
            const planificacionToggle = document.getElementById('planificacion-toggle');
            const planificacionSubmenu = document.getElementById('planificacion-submenu');
            const proyectandoBtn = document.getElementById('proyectando-btn');
            const proyectandoToggle = document.getElementById('proyectando-toggle');
            const proyectandoSubmenu = document.getElementById('proyectando-submenu');
            const diagnosticoBtn = document.getElementById('diagnostico-btn');
            const diagnosticoToggle = document.getElementById('diagnostico-toggle');
            const diagnosticoSubmenu = document.getElementById('diagnostico-submenu');
            const reportesBtn = document.getElementById('reportes-btn');
            const reportesToggle = document.getElementById('reportes-toggle');
            const reportesSubmenu = document.getElementById('reportes-submenu');
            const inicioBtn = document.getElementById('inicio-btn');
            const inicioToggle = document.getElementById('inicio-toggle');
            const inicioSubmenu = document.getElementById('inicio-submenu');
            const submenuLinks = document.querySelectorAll('.submenu[data-menu-name]');
            const menuLinks = document.querySelectorAll('nav > a[data-menu-name]');
            const sidebarBlocks = document.querySelectorAll('.sidebar-block');
            const sidebarSummaryItems = document.querySelectorAll('.sidebar-block > summary');
            const sidebarSubmenuLinks = document.querySelectorAll('.sidebar-submenu a');
            const navbarMenuName = document.querySelector('.navbar-menu-name');
            const navbarRoute = document.querySelector('.navbar-route');
            const floatingActions = document.querySelector('.floating-actions');
            const floatingGroups = document.querySelectorAll('.floating-actions-group');
            const floatingToggle = document.getElementById('floating-toggle');
            const floatingActionsWrapper = document.querySelector('.floating-actions-wrapper');
            const usuarioPanel = document.getElementById('usuario-panel');
            const areaPanel = document.getElementById('area-panel');
            const identityForm = document.getElementById('identity-form');
            const actionSavePersonal = document.getElementById('action-save-personal');
            const actionResetPersonal = document.getElementById('action-reset-personal');
            const actionCreateUser = document.getElementById('action-create-user');
            const actionEdit = document.getElementById('action-edit');
            const actionSaveUsuario = document.getElementById('action-save-usuario');
            const actionDelete = document.getElementById('action-delete');
            const actionNewAreas = document.getElementById('action-new-areas');
            const actionEditAreas = document.getElementById('action-edit-areas');
            const actionSaveAreas = document.getElementById('action-save-areas');
            const actionDeleteAreas = document.getElementById('action-delete-areas');
            const actionViewForm = document.getElementById('action-view-form');
            const actionViewList = document.getElementById('action-view-list');
            const actionViewKanban = document.getElementById('action-view-kanban');
            const actionViewGraph = document.getElementById('action-view-graph');
            const actionViewGantt = document.getElementById('action-view-gantt');
            const actionViewDashboard = document.getElementById('action-view-dashboard');
            const actionViewCalendar = document.getElementById('action-view-calendar');
            const actionNewTemplate = document.getElementById('action-new-template');
            const actionEditTemplate = document.getElementById('action-edit-template');
            const actionSaveTemplate = document.getElementById('action-save-template');
            const actionDeleteTemplate = document.getElementById('action-delete-template');
            const actionExportReportes = document.getElementById('action-export-reportes');
            const actionExportPdf = document.getElementById('action-export-pdf');
            const actionExportExcel = document.getElementById('action-export-excel');
            const personalizarEditBtn = document.getElementById('personalizar-edit-btn');
            const personalizarSaveBtn = document.getElementById('personalizar-save-btn');
            const personalizarResetBtn = document.getElementById('personalizar-reset-btn');
            const navbarAvatarBtn = document.getElementById('navbar-avatar-btn');
            const navbarAvatarImgEl = document.getElementById('navbar-avatar-img');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutLink = document.getElementById('logout-link');
            const sidebarUserImg = document.getElementById('sidebar-user-img');
            const COMPANY_LOGO_CACHE_KEY = 'sipet_logo_empresa_url';
            const USER_LOGO_CACHE_KEY = 'sipet_logo_usuario_url';
            try {
                if (sidebarUserImg instanceof HTMLImageElement) {
                    const cachedLogo = String(window.localStorage.getItem(COMPANY_LOGO_CACHE_KEY) || '').trim();
                    if (cachedLogo) {
                        sidebarUserImg.src = cachedLogo;
                    }
                }
                if (navbarAvatarImgEl instanceof HTMLImageElement) {
                    const cachedUserLogo = String(window.localStorage.getItem(USER_LOGO_CACHE_KEY) || '').trim();
                    if (cachedUserLogo) {
                        navbarAvatarImgEl.src = cachedUserLogo;
                    }
                }
            } catch (e) {
                // Ignorar acceso a localStorage cuando no est disponible.
            }
            const syncSidebarCompanyLogo = async () => {
                if (!(sidebarUserImg instanceof HTMLImageElement) && !(navbarAvatarImgEl instanceof HTMLImageElement)) return;
                try {
                    const res = await fetch('/personalizar/estado', { headers: { Accept: 'application/json' } });
                    if (!res.ok) return;
                    const json = await res.json();
                    const logoUrl = String(json?.assets?.logo_empresa?.url || '').trim();
                    if (logoUrl) {
                        sidebarUserImg.src = logoUrl;
                        try {
                            window.localStorage.setItem(COMPANY_LOGO_CACHE_KEY, logoUrl);
                        } catch (e) {
                            // Ignorar acceso a localStorage cuando no est disponible.
                        }
                    } else if (sidebarUserImg.dataset.default) {
                        sidebarUserImg.src = sidebarUserImg.dataset.default;
                        try {
                            window.localStorage.removeItem(COMPANY_LOGO_CACHE_KEY);
                        } catch (e) {
                            // Ignorar acceso a localStorage cuando no est disponible.
                        }
                    }
                    const userLogoUrl = String(json?.assets?.logo_usuario?.url || '').trim();
                    if (navbarAvatarImgEl instanceof HTMLImageElement) {
                        if (userLogoUrl) {
                            navbarAvatarImgEl.src = userLogoUrl;
                            try {
                                window.localStorage.setItem(USER_LOGO_CACHE_KEY, userLogoUrl);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no est disponible.
                            }
                        } else if (navbarAvatarImgEl.dataset.default) {
                            navbarAvatarImgEl.src = navbarAvatarImgEl.dataset.default;
                            try {
                                window.localStorage.removeItem(USER_LOGO_CACHE_KEY);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no est disponible.
                            }
                        }
                    }
                } catch (e) {
                    if (sidebarUserImg.dataset.default) {
                        sidebarUserImg.src = sidebarUserImg.dataset.default;
                    }
                    if (navbarAvatarImgEl instanceof HTMLImageElement && navbarAvatarImgEl.dataset.default) {
                        navbarAvatarImgEl.src = navbarAvatarImgEl.dataset.default;
                    }
                }
            };
            const sidebarNotificationsTrigger = document.getElementById('sidebar-notifications-trigger');
            const sidebarNotificationsBadge = document.getElementById('sidebar-notifications-badge');
            const navbarNotificationsTrigger = document.getElementById('navbar-notifications-trigger');
            const navbarNotificationsBadge = document.getElementById('navbar-notifications-badge');
            const navbarNotificationsIcon = document.querySelector('.navbar-notifications-icon');
            const sidebarNotificationsPanel = document.getElementById('sidebar-notifications-panel');
            const sidebarNotificationsCount = document.getElementById('sidebar-notifications-count');
            const sidebarNotificationsList = document.getElementById('sidebar-notifications-list');
            const sidebarNotificationsEmpty = document.getElementById('sidebar-notifications-empty');
            const sidebarNotificationsRefresh = document.getElementById('sidebar-notifications-refresh');
            const sidebarNotificationsMarkAll = document.getElementById('sidebar-notifications-mark-all');
            const personalizationPanel = document.querySelector('.personalization-panel');
            const viewPills = document.querySelectorAll('.view-buttons .view-pill[data-view]');
            const convertFloatingIconsToMasks = () => {
                document.querySelectorAll('.floating-actions .action-button img[src$=".svg"]').forEach((img) => {
                    const rawSrc = img.getAttribute('src');
                    if (!rawSrc || img.dataset.maskApplied === '1') return;
                    const src = rawSrc
                        .replace('/modulos/templates/icon/', '/templates/icon/')
                        .replace('fastapi_modulo/modulos/templates/icon/', '/templates/icon/');
                    const iconMask = document.createElement('span');
                    iconMask.className = 'action-icon-mask';
                    iconMask.setAttribute('aria-hidden', 'true');
                    iconMask.style.setProperty('--action-icon-url', `url("${src}")`);
                    img.dataset.maskApplied = '1';
                    img.replaceWith(iconMask);
                });
            };
            convertFloatingIconsToMasks();
            const shouldSkipThemedButton = (button) => (
                button.matches(
                    '.navbar-hamburger, .navbar-avatar, .navbar-notifications-btn, .accordion-header, .sidebar-section-toggle, .floating-toggle, .sipet-section-tab, .Pestana, [data-param-tab], [data-cg-tab], .cg-view-toggle, .view-pill, [data-view], .ar-chip, [data-relacion-help], .fp-row, .fp-btn, .fp-icon, [data-scn], .pe-axis__btn, .pe-btn, .table-delete-btn, .delete-activo-fijo-row'
                ) ||
                !!button.closest('.fp-shell, .pe-page, .ar-shell, #usuario-view, #area-view, #sucursales-view, .kpi-page, .axm-shell, #plantillas-page')
            );
            const applyButtonThemeClass = () => {
                document.querySelectorAll('button').forEach((button) => {
                    const forceTheme = button.getAttribute('data-force-button-theme') === '1';
                    if (forceTheme) {
                        button.classList.add('boton-personalizado');
                        return;
                    }
                    if (shouldSkipThemedButton(button)) {
                        button.classList.remove('boton-personalizado');
                        return;
                    }
                    button.classList.add('boton-personalizado');
                });
            };
            applyButtonThemeClass();
            if (document.body) {
                const themedButtonObserver = new MutationObserver(() => {
                    applyButtonThemeClass();
                });
                themedButtonObserver.observe(document.body, { childList: true, subtree: true });
            }
            const currentUserRole = {{ request.state.user_role | default('usuario') | tojson }};
            const currentSessionUser = {{ request.state.user_name | default('') | tojson }};
            const currentTenantId = {{ request.state.tenant_id | default('default') | tojson }};
            const activateViewButton = (view) => {
                if (!viewPills.length || !view) return;
                viewPills.forEach(pill => pill.classList.toggle('active', pill.dataset.view === view));
            };
            viewPills.forEach(pill => pill.addEventListener('click', function() {
                const targetView = pill.dataset.view;
                if (!targetView) return;
                document.dispatchEvent(new CustomEvent('backend-view-change', { detail: { view: targetView } }));
            }));
            const floatingDefaultScreen = floatingActionsWrapper?.dataset.defaultScreen || 'personalization';
            let activeFloatingScreen = floatingDefaultScreen;
            let currentUsuarioView = 'form';
            const setFloatingScreen = (screen) => {
                activeFloatingScreen = screen;
                floatingGroups.forEach(group => {
                    const isActive = group.dataset.floatingScreen === screen;
                    group.classList.toggle('active', isActive);
                    group.style.display = isActive ? 'flex' : 'none';
                });
                if (personalizationPanel) {
                    personalizationPanel.classList.toggle('hidden', screen !== 'personalization');
                }
            };
            setFloatingScreen(activeFloatingScreen);
            const usuariosFloatingGroup = document.querySelector('.floating-actions-group[data-floating-screen="usuarios"]');
            const refreshUsuarioFloating = () => {
                if (!usuariosFloatingGroup) return;
                usuariosFloatingGroup.style.display = activeFloatingScreen === 'usuarios' ? 'flex' : 'none';
            };
            refreshUsuarioFloating();

            const collapsedWidth = '72px';
            const expandedWidth = '220px';
            let isSidebarOpen = true;

            const slugify = (value) => {
                return (value || '')
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            };

            const formatRouteLabel = (mainLabel, subLabel = '') => {
                if (!mainLabel) return '';
                return subLabel ? `${mainLabel}/${subLabel}` : mainLabel;
            };

            const setMenuInfo = (source) => {
                if (!source) return;
                const fromSubmenu = source.matches && source.matches('.sidebar-submenu a');
                const fromSummary = source.matches && source.matches('.sidebar-block > summary');

                let mainLabel = source.dataset.menuName || source.textContent.trim();
                let subLabel = '';

                if (fromSubmenu) {
                    const parentSummary = source.closest('.sidebar-block')?.querySelector('.sidebar-main-label');
                    mainLabel = (parentSummary?.textContent || '').trim() || mainLabel;
                    subLabel = (source.dataset.submenuName || source.textContent || '').trim();
                } else if (fromSummary) {
                    const label = source.querySelector('.sidebar-main-label');
                    mainLabel = (label?.textContent || '').trim() || mainLabel;
                }

                const fallbackRoute = fromSubmenu
                    ? `/${slugify(mainLabel)}/${slugify(subLabel)}`
                    : `/${slugify(mainLabel)}`;
                const explicitHref = source.getAttribute('href');
                const routeHref = explicitHref && explicitHref !== '#'
                    ? explicitHref
                    : (source.dataset.route || fallbackRoute);

                navbarMenuName.textContent = mainLabel || 'Inicio';
                navbarRoute.textContent = formatRouteLabel(mainLabel || 'Inicio', subLabel);
                navbarRoute.href = routeHref || '/';
            };

            const updateRouteVisibility = () => {
                if (!navbarRoute) return;
                navbarRoute.style.display = 'inline-flex';
                navbarRoute.setAttribute('aria-hidden', 'false');
            };

            const setSidebarState = (open) => {
                const width = open ? expandedWidth : collapsedWidth;
                sidebarElem.classList.toggle('is-collapsed', !open);
                navbar.style.marginLeft = width;
                mainContent.style.marginLeft = width;
                mainContent.style.width = open ? `calc(100vw - ${expandedWidth})` : `calc(100vw - ${collapsedWidth})`;
                if (!open) {
                    sidebarBlocks.forEach((item) => {
                        item.removeAttribute('open');
                        item.classList.remove('is-flyout-open');
                    });
                }
                if (hamburger) {
                    hamburger.classList.toggle('is-open', open);
                    hamburger.setAttribute('aria-expanded', open ? 'true' : 'false');
                }
                isSidebarOpen = open;
                updateRouteVisibility();
            };

            const toggleSidebar = () => setSidebarState(!isSidebarOpen);

            if (hamburger) {
                hamburger.addEventListener('click', toggleSidebar);
            }

            sidebarSummaryItems.forEach((summary) => {
                summary.addEventListener('click', (event) => {
                    event.preventDefault();
                    const block = summary.closest('.sidebar-block');
                    if (!block) return;
                    if (!isSidebarOpen) {
                        const shouldOpenFlyout = !block.classList.contains('is-flyout-open');
                        sidebarBlocks.forEach((item) => {
                            item.classList.remove('is-flyout-open');
                            item.removeAttribute('open');
                        });
                        if (shouldOpenFlyout) {
                            block.classList.add('is-flyout-open');
                        }
                        setMenuInfo(summary);
                        return;
                    }
                    const shouldOpen = !block.hasAttribute('open');
                    sidebarBlocks.forEach((item) => {
                        if (item !== block) {
                            item.removeAttribute('open');
                            item.classList.remove('is-flyout-open');
                        }
                    });
                    if (shouldOpen) {
                        block.setAttribute('open', '');
                    } else {
                        block.removeAttribute('open');
                    }
                    setMenuInfo(summary);
                });
            });
            sidebarSubmenuLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    setMenuInfo(link);
                    if (!isSidebarOpen) {
                        sidebarBlocks.forEach((item) => {
                            item.removeAttribute('open');
                            item.classList.remove('is-flyout-open');
                        });
                    }
                });
            });
            document.addEventListener('click', (event) => {
                if (isSidebarOpen) return;
                if (sidebarElem && sidebarElem.contains(event.target)) return;
                sidebarBlocks.forEach((item) => {
                    item.removeAttribute('open');
                    item.classList.remove('is-flyout-open');
                });
            });

            if (personalizarBtn && personalizarSubmenu && personalizarToggle) {
                personalizarBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = personalizarBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    personalizarSubmenu.style.display = isOpen ? 'flex' : 'none';
                    personalizarToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(personalizarBtn);
                    setFloatingScreen('personalization');
                });
            }
            if (inicioBtn && inicioSubmenu && inicioToggle) {
                inicioBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = inicioBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    inicioSubmenu.style.display = isOpen ? 'flex' : 'none';
                    inicioToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(inicioBtn);
                });
                const currentPath = window.location.pathname;
                const inicioLinks = inicioSubmenu.querySelectorAll('a[href]');
                const shouldOpenInicio = Array.from(inicioLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenInicio) {
                    const accordion = inicioBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    inicioSubmenu.style.display = 'flex';
                    inicioToggle.textContent = '';
                    const activeInicioLink = Array.from(inicioLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeInicioLink) {
                        setMenuInfo(activeInicioLink);
                    }
                } else if (currentPath === '/inicio') {
                    setMenuInfo(inicioBtn);
                }
            }
            if (diagnosticoBtn && diagnosticoSubmenu && diagnosticoToggle) {
                diagnosticoBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = diagnosticoBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    diagnosticoSubmenu.style.display = isOpen ? 'flex' : 'none';
                    diagnosticoToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(diagnosticoBtn);
                });
                const currentPath = window.location.pathname;
                const diagnosticoLinks = diagnosticoSubmenu.querySelectorAll('a[href]');
                const shouldOpenDiagnostico = Array.from(diagnosticoLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenDiagnostico) {
                    const accordion = diagnosticoBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    diagnosticoSubmenu.style.display = 'flex';
                    diagnosticoToggle.textContent = '';
                    const activeDiagnosticoLink = Array.from(diagnosticoLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeDiagnosticoLink) {
                        setMenuInfo(activeDiagnosticoLink);
                    }
                }
            }
            if (planificacionBtn && planificacionSubmenu && planificacionToggle) {
                planificacionBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = planificacionBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    planificacionSubmenu.style.display = isOpen ? 'flex' : 'none';
                    planificacionToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(planificacionBtn);
                });
                const currentPath = window.location.pathname;
                const planificacionLinks = planificacionSubmenu.querySelectorAll('a[href]');
                const shouldOpenPlanificacion = Array.from(planificacionLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenPlanificacion) {
                    const accordion = planificacionBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    planificacionSubmenu.style.display = 'flex';
                    planificacionToggle.textContent = '';
                    const activePlanificacionLink = Array.from(planificacionLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activePlanificacionLink) {
                        setMenuInfo(activePlanificacionLink);
                    }
                }
            }
            if (proyectandoBtn && proyectandoSubmenu && proyectandoToggle) {
                proyectandoBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = proyectandoBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    proyectandoSubmenu.style.display = isOpen ? 'flex' : 'none';
                    proyectandoToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(proyectandoBtn);
                });
                const currentPath = window.location.pathname;
                const proyectandoLinks = proyectandoSubmenu.querySelectorAll('a[href]');
                const shouldOpenProyectando = Array.from(proyectandoLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenProyectando) {
                    const accordion = proyectandoBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    proyectandoSubmenu.style.display = 'flex';
                    proyectandoToggle.textContent = '';
                    const activeProyectandoLink = Array.from(proyectandoLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeProyectandoLink) {
                        setMenuInfo(activeProyectandoLink);
                    }
                }
            }
            if (reportesBtn && reportesSubmenu && reportesToggle) {
                reportesBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = reportesBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    reportesSubmenu.style.display = isOpen ? 'flex' : 'none';
                    reportesToggle.textContent = isOpen ? '' : '+';
                    setMenuInfo(reportesBtn);
                    setFloatingScreen('reportes');
                });
                const currentPath = window.location.pathname;
                const reportesLinks = reportesSubmenu.querySelectorAll('a[href]');
                const shouldOpenReportes = Array.from(reportesLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenReportes) {
                    const accordion = reportesBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    reportesSubmenu.style.display = 'flex';
                    reportesToggle.textContent = '';
                    const activeReportesLink = Array.from(reportesLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeReportesLink) {
                        setMenuInfo(activeReportesLink);
                    }
                }
            }

            // Eliminado: los links ahora navegan normalmente

            const activeSidebarLink = Array.from(sidebarSubmenuLinks).find(link => link.getAttribute('href') === window.location.pathname);
            if (activeSidebarLink) {
                const block = activeSidebarLink.closest('.sidebar-block');
                if (block) block.open = true;
                setMenuInfo(activeSidebarLink);
            } else if (sidebarSummaryItems.length) {
                setMenuInfo(sidebarSummaryItems[0]);
            } else if (menuLinks.length) {
                setMenuInfo(menuLinks[0]);
            }
            setSidebarState(true);
            setFloatingScreen(floatingDefaultScreen);
            if (identityForm) {
                const editButtons = document.querySelectorAll('.identity-asset-edit[data-target-input]');
                const deleteButtons = document.querySelectorAll('.identity-asset-delete[data-target-remove]');
                editButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const target = btn.getAttribute('data-target-input');
                        if (!target) return;
                        const input = document.getElementById(target);
                        const removeFlagId = target === 'favicon'
                            ? 'remove_favicon'
                            : target === 'logo_empresa'
                            ? 'remove_logo'
                            : target === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : target === 'fondo_movil'
                                    ? 'remove_mobile'
                                    : '';
                        if (removeFlagId) {
                            const removeFlag = document.getElementById(removeFlagId);
                            if (removeFlag) removeFlag.value = '0';
                        }
                        if (input) input.click();
                    });
                });
                deleteButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const targetRemove = btn.getAttribute('data-target-remove');
                        if (!targetRemove) return;
                        const flag = document.getElementById(targetRemove);
                        if (flag) flag.value = '1';
                        showMessage('Imagen marcada para eliminar. Guarda para aplicar.', 'success');
                    });
                });
                ['favicon', 'logo_empresa', 'fondo_escritorio', 'fondo_movil'].forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    input.addEventListener('change', () => {
                        if (!input.files || !input.files.length) return;
                        const removeFlagId = id === 'favicon'
                            ? 'remove_favicon'
                            : id === 'logo_empresa'
                            ? 'remove_logo'
                            : id === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : 'remove_mobile';
                        const removeFlag = document.getElementById(removeFlagId);
                        if (removeFlag) removeFlag.value = '0';
                        if (identityForm && typeof identityForm.requestSubmit === 'function') {
                            showMessage('Subiendo imagen seleccionada...', 'success');
                            identityForm.requestSubmit();
                        } else if (identityForm) {
                            identityForm.submit();
                        }
                    });
                });
            }
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            document.body.appendChild(messageBox);
            let hideTimeout;
            const showMessage = (msg, type = 'success') => {
                messageBox.textContent = msg;
                messageBox.classList.add('visible');
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    messageBox.classList.remove('visible');
                }, 2200);
            };
            const normalizeSidebarMenuIcons = () => {
                const sidebarMenuImages = document.querySelectorAll('.sidebar nav .menu-icon img');
                sidebarMenuImages.forEach((img) => {
                    if (img.dataset.maskReady === '1') return;
                    const src = img.getAttribute('src');
                    if (!src) return;
                    const maskEl = document.createElement('span');
                    maskEl.className = 'menu-icon-mask';
                    maskEl.style.setProperty('--icon-mask-url', `url("${src}")`);
                    maskEl.setAttribute('aria-hidden', 'true');
                    img.style.display = 'none';
                    img.dataset.maskReady = '1';
                    img.parentElement && img.parentElement.appendChild(maskEl);
                });
            };
            normalizeSidebarMenuIcons();
            const syncNavbarNotificationIconColor = (color) => {
                const fromNavbar = navbar ? getComputedStyle(navbar).color : '';
                const fromVar = getComputedStyle(document.documentElement).getPropertyValue('--navbar-text');
                const value = (color || '').trim() || (fromNavbar || '').trim() || (fromVar || '').trim() || '#1f2933';
                document.documentElement.style.setProperty('--navbar-notifications-icon-color', value);
                if (navbarNotificationsIcon) {
                    navbarNotificationsIcon.style.background = value;
                }
            };
            const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (char) => (
                { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char] || char
            ));
            const formatNotificationDate = (value) => {
                if (!value) return '';
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return '';
                return parsed.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                });
            };
            const renderNotifications = (payload) => {
                if (!sidebarNotificationsList || !sidebarNotificationsCount || !sidebarNotificationsEmpty) return;
                const total = Number(payload?.total || 0);
                const unread = Number(payload?.unread || 0);
                const items = Array.isArray(payload?.items) ? payload.items : [];
                if (sidebarNotificationsBadge) {
                    sidebarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    sidebarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                if (navbarNotificationsBadge) {
                    navbarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    navbarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                sidebarNotificationsCount.textContent = unread > 0 ? `${unread} pendiente${unread === 1 ? '' : 's'}` : 'Sin pendientes';
                if (!items.length) {
                    sidebarNotificationsList.innerHTML = '';
                    sidebarNotificationsEmpty.style.display = 'block';
                    return;
                }
                sidebarNotificationsEmpty.style.display = 'none';
                sidebarNotificationsList.innerHTML = items.map((item) => {
                    const href = item.href || '#';
                    const itemClass = item.read ? 'notification-item read' : 'notification-item';
                    const notificationId = escapeHtml(item.id || '');
                    return `
                        <li>
                            <a class="${itemClass}" href="${escapeHtml(href)}" data-notification-id="${notificationId}">
                                <div class="notification-item-title">${escapeHtml(item.title || 'Notificacin')}</div>
                                <div class="notification-item-msg">${escapeHtml(item.message || '')}</div>
                                <div class="notification-item-date">${escapeHtml(formatNotificationDate(item.created_at))}</div>
                            </a>
                        </li>
                    `;
                }).join('');
            };
            const markNotificationRead = async (notificationId) => {
                if (!notificationId) return;
                await fetch('/api/notificaciones/marcar-leida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: notificationId }),
                });
            };
            const markAllNotificationsRead = async (notificationIds) => {
                if (!Array.isArray(notificationIds) || !notificationIds.length) return;
                await fetch('/api/notificaciones/marcar-todas-leidas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: notificationIds }),
                });
            };
            const loadNotifications = async (silent = true) => {
                if (!sidebarNotificationsList) return;
                try {
                    const res = await fetch('/api/notificaciones/resumen', { headers: { 'Accept': 'application/json' } });
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) {
                        throw new Error(payload?.error || 'No se pudieron cargar las notificaciones');
                    }
                    renderNotifications(payload);
                } catch (error) {
                    if (!silent) {
                        showMessage(error.message || 'No se pudieron cargar las notificaciones', 'error');
                    }
                }
            };
            let guardarColores = () => {};
            let guardarAssets = () => Promise.resolve();
            let restablecerAssets = () => Promise.resolve();
            let restablecerColores = () => {};
            if (personalizationPanel) {
                const colorInputs = [
                    'navbar-bg','navbar-text','sidebar-top','sidebar-bottom','sidebar-text',
                    'field-color',
                    'button-bg','button-text',
                    'sidebar-icon','sidebar-hover'
                ];
                const colorDefaults = {};
                const assetsForm = document.getElementById('personalizar-assets-form');
                const assetConfig = {
                    favicon: { filenameId: 'asset-filename-favicon', linkId: 'asset-link-favicon', thumbId: 'asset-thumb-favicon' },
                    logo_empresa: { filenameId: 'asset-filename-logo-empresa', linkId: 'asset-link-logo-empresa', thumbId: 'asset-thumb-logo-empresa' },
                    logo_usuario: { filenameId: 'asset-filename-logo-usuario', linkId: 'asset-link-logo-usuario', thumbId: 'asset-thumb-logo-usuario' },
                    svg_fondo: { filenameId: 'asset-filename-svg-fondo', linkId: 'asset-link-svg-fondo', thumbId: 'asset-thumb-svg-fondo' },
                    svg_defecto: { filenameId: 'asset-filename-svg-defecto', linkId: 'asset-link-svg-defecto', thumbId: 'asset-thumb-svg-defecto' }
                };
                const defaultAssetThumb = '/templates/icon/placeholder.svg';
                const updatePreview = (id, value) => {
                    const preview = document.getElementById(id + '-preview');
                    if (preview) preview.style.background = value;
                };
                const normalizeHex = (hex) => {
                    const cleaned = (hex || '').trim().replace('#', '');
                    if (cleaned.length === 3) {
                        return cleaned.split('').map(char => char + char).join('');
                    }
                    return cleaned;
                };
                const hexToRgba = (hex, alpha = 1) => {
                    const normalized = normalizeHex(hex);
                    if (!/^[0-9A-Fa-f]{6}$/.test(normalized)) return hex;
                    const r = parseInt(normalized.slice(0, 2), 16);
                    const g = parseInt(normalized.slice(2, 4), 16);
                    const b = parseInt(normalized.slice(4, 6), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                function applyColors() {
                    const navbar = document.querySelector('.navbar');
                    const navbarBg = document.getElementById('navbar-bg');
                    const navbarText = document.getElementById('navbar-text');
                    const sidebarTop = document.getElementById('sidebar-top');
                    const sidebarBottom = document.getElementById('sidebar-bottom');
                    const sidebarText = document.getElementById('sidebar-text');
                    const fieldColor = document.getElementById('field-color');
                    const buttonBg = document.getElementById('button-bg');
                    const buttonText = document.getElementById('button-text');
                    const sidebarIcon = document.getElementById('sidebar-icon');
                    const sidebarHover = document.getElementById('sidebar-hover');
                    if (navbarBg && navbar) {
                        navbar.style.background = navbarBg.value;
                    }
                    if (navbarText && navbar) {
                        navbar.style.color = navbarText.value;
                        const hamburger = document.querySelector('.navbar-hamburger');
                        if (hamburger) {
                            hamburger.style.color = navbarText.value;
                        }
                        syncNavbarNotificationIconColor(navbarText.value);
                    } else {
                        syncNavbarNotificationIconColor(getComputedStyle(document.documentElement).getPropertyValue('--navbar-text'));
                    }
                    if (sidebarTop && sidebarElem) {
                        if (sidebarBottom && sidebarBottom.value) {
                            sidebarElem.style.background = `linear-gradient(180deg, ${sidebarTop.value} 0%, ${sidebarBottom.value} 100%)`;
                        } else {
                            sidebarElem.style.background = sidebarTop.value;
                        }
                    }
                    if (sidebarText && sidebarElem) {
                        sidebarElem.style.color = sidebarText.value;
                        document.documentElement.style.setProperty('--sidebar-text', sidebarText.value);
                    }
                    if (sidebarIcon) {
                        document.documentElement.style.setProperty('--sidebar-icon', sidebarIcon.value);
                        document.querySelectorAll('.menu-icon svg path').forEach(path => {
                            path.setAttribute('stroke', sidebarIcon.value);
                        });
                    }
                    if (sidebarHover) {
                        document.documentElement.style.setProperty('--sidebar-hover', sidebarHover.value);
                    }
                    if (fieldColor) {
                        document.documentElement.style.setProperty('--field-color', fieldColor.value);
                    }
                    if (buttonBg) {
                        document.documentElement.style.setProperty('--button-bg', buttonBg.value);
                    }
                    if (buttonText) {
                        document.documentElement.style.setProperty('--button-text', buttonText.value);
                    }
                    const rootStyles = getComputedStyle(document.documentElement);
                    const rootBottomColor = (rootStyles.getPropertyValue('--sidebar-bottom') || '').trim();
                    const rootTextColor = (rootStyles.getPropertyValue('--sidebar-text') || '').trim();
                    const bottomColor = (sidebarBottom && sidebarBottom.value) || rootBottomColor || '#0f172a';
                    const textColor = (sidebarText && sidebarText.value) || rootTextColor || '#ffffff';
                    document.documentElement.style.setProperty('--page-title-color', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-border', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-bg', textColor);
                    document.documentElement.style.setProperty('--view-pill-text', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-icon', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-bg', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-text', textColor);
                    document.documentElement.style.setProperty('--view-pill-hover-icon', textColor);
                    if (floatingActions) {
                        floatingActions.style.background = textColor;
                        floatingActions.style.borderColor = bottomColor;
                        floatingActions.style.setProperty('--floating-panel-bg', textColor);
                        floatingActions.style.setProperty('--floating-icon-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-text-color', textColor);
                        floatingActions.style.setProperty('--floating-action-border', bottomColor);
                        floatingActions.style.setProperty('--floating-action-text', bottomColor);
                        floatingActions.style.setProperty('--floating-action-bg', textColor);
                        floatingActions.style.color = bottomColor;
                    }
                    if (floatingToggle) {
                        floatingToggle.style.borderColor = bottomColor;
                        floatingToggle.style.background = bottomColor;
                        floatingToggle.style.color = textColor;
                    }
                }
                colorInputs.forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    colorDefaults[id] = input.value;
                    input.dataset.default = input.value;
                    updatePreview(id, input.value);
                    input.addEventListener('input', function() {
                        updatePreview(id, input.value);
                        applyColors();
                    });
                });
                async function cargarColoresGuardados() {
                    try {
                        const res = await fetch('/guardar-colores', { method: 'GET' });
                        if (!res.ok) return;
                        const json = await res.json();
                        if (json && json.success && json.data) {
                            colorInputs.forEach(function(id) {
                                if (json.data[id]) {
                                    const input = document.getElementById(id);
                                    if (input) {
                                        input.value = json.data[id];
                                        updatePreview(id, input.value);
                                    }
                                }
                            });
                            applyColors();
                        }
                    } catch (e) {
                        // Ignorar errores de carga
                    }
                }
                const applyAssetState = (assets = {}) => {
                    Object.entries(assetConfig).forEach(([field, refs]) => {
                        const filenameEl = document.getElementById(refs.filenameId);
                        const linkEl = document.getElementById(refs.linkId);
                        const thumbEl = document.getElementById(refs.thumbId);
                        const info = assets[field] || {};
                        const filename = String(info.filename || '').trim();
                        const url = String(info.url || '').trim();
                        if (filenameEl) {
                            filenameEl.textContent = filename || 'Sin archivo';
                        }
                        if (linkEl) {
                            if (url) {
                                linkEl.href = url;
                                linkEl.hidden = false;
                            } else {
                                linkEl.hidden = true;
                                linkEl.removeAttribute('href');
                            }
                        }
                        if (thumbEl instanceof HTMLImageElement) {
                            thumbEl.src = url || defaultAssetThumb;
                        }
                    });
                    const sidebarLogoEl = document.getElementById('sidebar-user-img');
                    if (sidebarLogoEl instanceof HTMLImageElement) {
                        const logoEmpresa = assets.logo_empresa || {};
                        const logoUrl = String(logoEmpresa.url || '').trim();
                        if (logoUrl) {
                            sidebarLogoEl.src = logoUrl;
                            try {
                                window.localStorage.setItem(COMPANY_LOGO_CACHE_KEY, logoUrl);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no est disponible.
                            }
                        } else if (sidebarLogoEl.dataset.default) {
                            sidebarLogoEl.src = sidebarLogoEl.dataset.default;
                            try {
                                window.localStorage.removeItem(COMPANY_LOGO_CACHE_KEY);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no est disponible.
                            }
                        }
                    }
                };
                const cargarEstadoAssets = async () => {
                    if (!assetsForm) return;
                    try {
                        const res = await fetch('/personalizar/estado', { headers: { Accept: 'application/json' } });
                        if (!res.ok) return;
                        const json = await res.json();
                        if (json && json.ok) {
                            applyAssetState(json.assets || {});
                        }
                    } catch (e) {
                        // Ignorar errores de carga
                    }
                };
                await cargarColoresGuardados();
                applyColors();
                await cargarEstadoAssets();
                if (assetsForm) {
                    const resetRemoveFlags = () => {
                        assetsForm.querySelectorAll('input[type="hidden"][name^="remove_"]').forEach((flag) => {
                            flag.value = '0';
                        });
                    };
                    const hasAssetChanges = () => {
                        const hasRemoved = Array.from(
                            assetsForm.querySelectorAll('input[type="hidden"][name^="remove_"]')
                        ).some((flag) => String(flag.value || '0').trim() === '1');
                        const hasFiles = Array.from(
                            assetsForm.querySelectorAll('input[type="file"]')
                        ).some((input) => input.files && input.files.length > 0);
                        return hasRemoved || hasFiles;
                    };
                    const clearFileInputs = () => {
                        assetsForm.querySelectorAll('input[type="file"]').forEach((input) => {
                            input.value = '';
                        });
                    };
                    const editButtons = assetsForm.querySelectorAll('.asset-edit-btn[data-target-input][data-target-remove]');
                    const deleteButtons = assetsForm.querySelectorAll('.asset-delete-btn[data-target-remove][data-asset]');
                    editButtons.forEach((btn) => {
                        btn.addEventListener('click', (event) => {
                            event.preventDefault();
                            const inputId = btn.getAttribute('data-target-input');
                            const removeId = btn.getAttribute('data-target-remove');
                            const input = inputId ? document.getElementById(inputId) : null;
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (removeFlag) removeFlag.value = '0';
                            if (input) input.click();
                        });
                    });
                    deleteButtons.forEach((btn) => {
                        btn.addEventListener('click', async (event) => {
                            event.preventDefault();
                            const assetName = btn.getAttribute('data-asset') || 'archivo';
                            const removeId = btn.getAttribute('data-target-remove');
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (!removeFlag) return;
                            const ok = window.confirm(`Eliminar ${assetName.replace('_', ' ')}?`);
                            if (!ok) return;
                            removeFlag.value = '1';
                            await guardarAssets();
                        });
                    });
                    assetsForm.querySelectorAll('input[type="file"]').forEach((input) => {
                        input.addEventListener('change', async () => {
                            if (!input.files || !input.files.length) return;
                            const removeId = input.getAttribute('data-target-remove');
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (removeFlag) removeFlag.value = '0';
                            await guardarAssets();
                        });
                    });
                    guardarAssets = async function() {
                        if (!hasAssetChanges()) return;
                        const data = new FormData(assetsForm);
                        try {
                            const res = await fetch('/personalizar/guardar', { method: 'POST', body: data });
                            const json = await res.json();
                            if (!res.ok || !json?.ok) {
                                throw new Error(json?.error || 'No se pudieron guardar las imagenes');
                            }
                            applyAssetState(json.assets || {});
                            resetRemoveFlags();
                            clearFileInputs();
                            showMessage('Imagenes actualizadas correctamente.', 'success');
                        } catch (error) {
                            showMessage(error.message || 'Error al guardar imagenes.', 'error');
                        }
                    };
                    restablecerAssets = async function() {
                        try {
                            const res = await fetch('/personalizar/restablecer-assets', { method: 'POST' });
                            const json = await res.json();
                            if (!res.ok || !json?.ok) {
                                throw new Error(json?.error || 'No se pudieron restablecer las imagenes');
                            }
                            applyAssetState(json.assets || {});
                            resetRemoveFlags();
                            clearFileInputs();
                            showMessage('Imagenes restablecidas.', 'success');
                        } catch (error) {
                            showMessage(error.message || 'Error al restablecer imagenes.', 'error');
                        }
                    };
                }
                guardarColores = function() {
                    const data = {};
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (input) data[id] = input.value;
                    });
                    return fetch('/guardar-colores', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async res => {
                        if (!res.ok) {
                            const text = await res.text();
                            console.error('Error backend:', text);
                            throw new Error(text);
                        }
                        return res.json();
                    })
                    .then(json => {
                        if (json && json.success) {
                            showMessage('Colores guardados exitosamente.', 'success');
                        } else {
                            showMessage('Error al guardar los colores: ' + (json && json.error ? json.error : ''), 'error');
                            console.error('Respuesta backend:', json);
                        }
                    })
                    .catch(err => {
                        showMessage('Error al guardar los colores.', 'error');
                        console.error('Error fetch:', err);
                    });
                };
                restablecerColores = function() {
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.value = colorDefaults[id] || input.defaultValue;
                        updatePreview(id, input.value);
                    });
                    applyColors();
                    showMessage('Colores restablecidos.', 'success');
                };
            }
            let actionsVisible = true;
            const updateToggle = () => {
                if (!floatingToggle || !floatingActions) return;
            floatingToggle.textContent = actionsVisible ? '' : '+';
            floatingToggle.setAttribute('aria-label', actionsVisible ? 'Ocultar barra flotante' : 'Mostrar barra flotante');
            floatingActions.classList.toggle('hidden', !actionsVisible);
        };
            const ensureFloatingVisible = () => {
                actionsVisible = true;
                updateToggle();
            };
            floatingToggle && floatingToggle.addEventListener('click', () => {
                actionsVisible = !actionsVisible;
                updateToggle();
            });
            updateToggle();
            const usuarioView = document.getElementById('usuario-view');
            const usuarioTabs = document.querySelectorAll('.usuario-tab');
            const usuarioLinks = document.querySelectorAll('.usuario-view-link');
            const areaView = document.getElementById('area-view');
            const areaTabs = document.querySelectorAll('.area-tab');
            const usuarioData = [];
            const defaultAreasData = [
                { name: 'Direccin General', parent: 'N/A', manager: 'Adriana Chvez Galeana', code: 'DIR-001', color: '#0f172a', status: 'Estratgico' },
                { name: 'Operaciones', parent: 'Direccin General', manager: 'Pablo Rojas', code: 'OPE-010', color: '#1d4ed8', status: 'Activo' },
                { name: 'Planeacin', parent: 'Direccin General', manager: 'Luca Ortega Moreno', code: 'PLA-020', color: '#0ea5e9', status: 'Activo' },
                { name: 'Servicios', parent: 'Operaciones', manager: 'Mara Delgado', code: 'SER-030', color: '#16a34a', status: 'En revisin' }
            ];
            let areasData = defaultAreasData.map((row) => ({ ...row }));
            const defaultKanbanImage = '/templates/icon/usuario.png';
            let usuariosImagenStore = [];
            let createAreaMode = false;
            const normalizeImagePath = (value) => {
                const raw = String(value || '').trim();
                if (!raw) return '';
                if (raw.startsWith('http://') || raw.startsWith('https://') || raw.startsWith('/')) {
                    return raw;
                }
                return `/templates/imagenes/${raw}`;
            };
            const getPersonImage = (person) => {
                if (!person || typeof person !== 'object') return defaultKanbanImage;
                const direct = person.image || person.photo || person.avatar || person.foto || person.imagen || '';
                if (typeof direct === 'string' && direct.trim()) return normalizeImagePath(direct);
                return defaultKanbanImage;
            };
            const enrichUsuarioImages = (usuarios = []) => {
                if (!Array.isArray(usuarios) || !usuarios.length) return;
                usuarios.forEach((u) => {
                    if (!u || typeof u !== 'object') return;
                    const nombre = String(u.nombre || '').trim();
                    if (!nombre) return;
                    const image = u.imagen || u.foto || u.image || u.avatar || '';
                    const normalizedImage = (typeof image === 'string' && image.trim()) ? normalizeImagePath(image) : '';
                    const incomingId = Number(u.id || 0) || 0;
                    const idx = usuarioData.findIndex((item) => (incomingId && Number(item.id || 0) === incomingId) || item.name === nombre);
                    if (idx >= 0) {
                        if (incomingId) usuarioData[idx].id = incomingId;
                        usuarioData[idx].login = String(u.usuario || usuarioData[idx].login || '');
                        usuarioData[idx].email = String(u.correo || usuarioData[idx].email || '');
                        usuarioData[idx].role = String(u.rol || usuarioData[idx].role || 'Usuario');
                        usuarioData[idx].department = String(u.departamento || usuarioData[idx].department || 'N/A');
                        usuarioData[idx].status = String(u.estado || usuarioData[idx].status || 'Activo');
                        if (normalizedImage) usuarioData[idx].image = normalizedImage;
                    } else {
                        usuarioData.push({
                            id: incomingId || undefined,
                            name: nombre,
                            role: String(u.rol || 'Usuario'),
                            department: String(u.departamento || 'N/A'),
                            status: String(u.estado || 'Activo'),
                            email: String(u.correo || ''),
                            login: String(u.usuario || ''),
                            image: normalizedImage || '',
                        });
                    }
                });
            };
            const normalizeAreaStatus = (value) => {
                const raw = String(value || '').trim();
                if (raw === 'Estratgico' || raw === 'En revisin' || raw === 'Activo') return raw;
                return 'Activo';
            };
            const normalizeAreaColor = (value) => {
                const raw = String(value || '').trim();
                return /^#[0-9a-fA-F]{6}$/.test(raw) ? raw : '#1d4ed8';
            };
            const normalizeAreaRow = (row, fallbackIndex = 0) => {
                const data = row && typeof row === 'object' ? row : {};
                const code = String(data.code || data.codigo || '').trim() || `DEP-${String(fallbackIndex + 1).padStart(3, '0')}`;
                return {
                    name: String(data.name || data.nombre || '').trim(),
                    parent: String(data.parent || data.padre || 'N/A').trim() || 'N/A',
                    manager: String(data.manager || data.responsable || '').trim(),
                    code,
                    color: normalizeAreaColor(data.color),
                    status: normalizeAreaStatus(data.status || data.estado),
                };
            };
            const replaceAreasData = (rows = []) => {
                const clean = (Array.isArray(rows) ? rows : [])
                    .map((row, index) => normalizeAreaRow(row, index))
                    .filter((row) => row.name && row.code);
                areasData = clean.length ? clean : defaultAreasData.map((row) => ({ ...row }));
            };
            const loadAreasData = async () => {
                try {
                    const res = await fetch('/api/inicio/departamentos');
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok || json?.success === false) throw new Error('No se pudieron cargar departamentos');
                    const payload = Array.isArray(json?.data) ? json.data : [];
                    if (payload.length) {
                        replaceAreasData(payload);
                        return true;
                    }
                    return false;
                } catch (_error) {
                    return false;
                }
            };
            const persistAreasData = async () => {
                try {
                    const res = await fetch('/api/inicio/departamentos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: areasData }),
                    });
                    const json = await res.json().catch(() => ({}));
                    if (!res.ok || json?.success === false) throw new Error('No se pudieron guardar departamentos');
                    replaceAreasData(json?.data || []);
                    return true;
                } catch (_error) {
                    return false;
                }
            };
            const hydrateAreasFromUsuarios = (usuarios = []) => {
                if (!Array.isArray(usuarios) || !usuarios.length) return;
                const grouped = new Map();
                usuarios.forEach((u) => {
                    const dept = String(u?.departamento || u?.department || '').trim();
                    if (!dept) return;
                    if (!grouped.has(dept)) grouped.set(dept, []);
                    grouped.get(dept).push(u);
                });
                const names = Array.from(grouped.keys());
                if (!names.length) return;
                const rootName = names.find((name) => name.toLowerCase() === 'direccin general' || name.toLowerCase() === 'direccion general') || names[0];
                const nextAreas = names.map((name, index) => {
                    const users = grouped.get(name) || [];
                    const managerCandidate = users.find((u) => {
                        const rol = String(u?.rol || '').toLowerCase();
                        const puesto = String(u?.puesto || '').toLowerCase();
                        return rol.includes('admin') || rol.includes('gerente') || puesto.includes('gerente') || puesto.includes('director');
                    }) || users[0] || {};
                    return {
                        name,
                        parent: name === rootName ? 'N/A' : rootName,
                        manager: String(managerCandidate?.nombre || managerCandidate?.name || 'Sin asignar'),
                        code: `DEP-${String(index + 1).padStart(3, '0')}`,
                        color: '#1d4ed8',
                        status: name === rootName ? 'Estratgico' : 'Activo',
                    };
                });
                if (nextAreas.length) {
                    areasData = nextAreas;
                }
            };
            const loadUsuariosImagenes = async () => {
                try {
                    const res = await fetch('/api/usuarios');
                    if (!res.ok) return;
                    const json = await res.json();
                    const data = Array.isArray(json?.data) ? json.data : [];
                    usuariosImagenStore = data;
                    enrichUsuarioImages(usuariosImagenStore);
                    hydrateAreasFromUsuarios(usuariosImagenStore);
                    syncCurrentUserShellAvatar(usuariosImagenStore);
                } catch (error) {
                    // Si falla, mantener fallback local/default.
                }
            };
            const syncCurrentUserShellAvatar = (usuarios = []) => {
                const sessionValue = String(currentSessionUser || '').trim().toLowerCase();
                if (!sessionValue) return;
                const match = (Array.isArray(usuarios) ? usuarios : []).find((u) => {
                    const usuario = String(u?.usuario || '').trim().toLowerCase();
                    const correo = String(u?.correo || '').trim().toLowerCase();
                    const nombre = String(u?.nombre || '').trim().toLowerCase();
                    return sessionValue === usuario || sessionValue === correo || sessionValue === nombre;
                });
                const imageValue = match?.imagen || match?.foto || match?.image || match?.avatar || '';
                if (!String(imageValue || '').trim()) return;
                const imageUrl = normalizeImagePath(imageValue);
                const navbarAvatarImgEl = document.getElementById('navbar-avatar-img');
                if (navbarAvatarImgEl) navbarAvatarImgEl.src = imageUrl;
            };
            const getManagerImage = (managerName) => {
                const manager = usuarioData.find((user) => user.name === managerName);
                return getPersonImage(manager);
            };
            const relacionOrganizacionalHelp = {
                'Lnea': (
                    '1. Relacin de Lnea (Ejecutiva)\n'
                    + 'Es la relacin jerrquica directa que sigue la cadena de mando desde la Gerencia General hacia las reas operativas.\n\n'
                    + 'Naturaleza: Es una autoridad de decisin y ejecucin.\n\n'
                    + 'En la empresa: La relacin entre la Gerencia de Crditos y sus analistas o agencias. '
                    + 'Estas reas son responsables directas de los resultados del negocio y del cumplimiento de metas financieras.'
                ),
                'Staff': (
                    '2. Relacin de Staff (Asesora)\n'
                    + 'El Staff no tiene autoridad directa de mando sobre las reas de lnea, sino una funcin de apoyo especializado.\n\n'
                    + 'Naturaleza: Es una autoridad de especializacin, consejo y servicio. Su objetivo es facilitar el trabajo de la lnea mediante el expertise tcnico.\n\n'
                    + 'Por ejemplo:\n'
                    + '- Asesora Jurdica: Provee el marco legal para los contratos, pero no decide a quin se le otorga un crdito.\n'
                    + '- Gestin de Talento Humano: Define polticas de reclutamiento, pero la decisin final de contratacin suele recaer en el jefe del rea solicitante.\n'
                    + '- Auditora Interna: Aunque es Staff, su reporte suele ser directo al Consejo de Administracin para garantizar independencia.'
                ),
                'Funcional': (
                    '3. Relacin Funcional (Especializada)\n'
                    + 'Es un punto intermedio donde un rea tcnica tiene autoridad limitada sobre otros departamentos en temas especficos de su competencia, independientemente de la jerarqua.\n\n'
                    + 'Naturaleza: Autoridad de normatividad y control.\n\n'
                    + 'Por ejemplo: El oficial de cumplimiento de Normatividad. Aunque no es el jefe de un gerente de agencia, '
                    + 'tiene la autoridad funcional para exigir que se cumplan los protocolos de prevencin de lavado de dinero, '
                    + 'y su instruccin es de acatamiento obligatorio.'
                ),
            };
            const getAreaNamesDisponibles = () => [...new Set(areasData.map(area => area.name).filter(Boolean))];
            const getUsuarioRolesFiltro = () => ['Todos', ...new Set(usuarioData.map(u => u.role))];
            let rolesSistemaDisponibles = [
                { value: 'usuario', label: 'Usuario' },
                { value: 'departamento', label: 'Departamento' },
            ];
            let selectedUsuarioName = null;
            let selectedAreaCode = null;
            let createUsuarioMode = false;
            let submitUsuarioFromPanel = null;
            const getDepartamentosDisponibles = () => [...new Set(usuarioData.map(u => u.department).filter(Boolean))];
            const roleMatches = (userRole, selectedRole) => {
                const left = String(userRole || '').trim().toLowerCase();
                const right = String(selectedRole || '').trim().toLowerCase();
                return left === right;
            };
            const escapeHtmlAttr = (value) => String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            const getRoleOptions = (selected = 'Todos') => {
                return getUsuarioRolesFiltro().map(role => `<option value="${role}" ${role === selected ? 'selected' : ''}>${role}</option>`).join('');
            };
            const getUsuarioRolOptions = (selected = '') => {
                return rolesSistemaDisponibles.map(role => `<option value="${role.value}" ${role.value === selected ? 'selected' : ''}>${role.label}</option>`).join('');
            };
            const getDepartamentoOptions = (selected = '') => {
                return getDepartamentosDisponibles().map(dept => `<option value="${dept}" ${dept === selected ? 'selected' : ''}>${dept}</option>`).join('');
            };
            const getAreaParentOptions = (selected = '') => {
                const areaNamesDisponibles = getAreaNamesDisponibles();
                const options = ['N/A', ...areaNamesDisponibles];
                return options.map((name) => `<option value="${name}" ${name === selected ? 'selected' : ''}>${name}</option>`).join('');
            };
            const getResponsableOptions = (selected = '') => {
                const responsables = [...new Set(usuarioData.map((u) => String(u?.name || '').trim()).filter(Boolean))]
                    .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
                const selectedValue = String(selected || '').trim();
                const dynamicOptions = responsables.map((name) => (
                    `<option value="${escapeHtmlAttr(name)}" ${name === selectedValue ? 'selected' : ''}>${escapeHtmlAttr(name)}</option>`
                )).join('');
                const selectedFallback = selectedValue && !responsables.includes(selectedValue)
                    ? `<option value="${escapeHtmlAttr(selectedValue)}" selected>${escapeHtmlAttr(selectedValue)}</option>`
                    : '';
                return `<option value="">Selecciona responsable</option>${selectedFallback}${dynamicOptions}`;
            };
            const openUsuarioInForm = (userName) => {
                const normalized = String(userName || '').trim();
                if (!normalized) return;
                createUsuarioMode = false;
                selectedUsuarioName = normalized;
                setUsuarioView('form');
            };
            const bindUsuarioSelectableCards = () => {
                if (!usuarioView) return;
                usuarioView.querySelectorAll('[data-usuario-name]').forEach((item) => {
                    item.addEventListener('click', () => {
                        openUsuarioInForm(item.getAttribute('data-usuario-name'));
                    });
                });
            };
            const loadRolesSistemaDisponibles = async () => {
                try {
                    const res = await fetch('/api/roles-disponibles');
                    if (!res.ok) return;
                    const json = await res.json();
                    const data = Array.isArray(json?.data) ? json.data : [];
                    if (!data.length) return;
                    rolesSistemaDisponibles = data.map((role) => {
                        const value = String(role?.nombre || '').trim().toLowerCase();
                        const label = String(role?.label || role?.nombre || '').trim();
                        return { value, label };
                    }).filter((role) => role.value);
                } catch (error) {
                    // Mantener fallback local si falla.
                }
            };
            function renderUsuarioForm() {
                submitUsuarioFromPanel = null;
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const roleCount = new Set(usuarioData.map((user) => user.role).filter(Boolean)).size;
                const selectedUser = createUsuarioMode
                    ? {}
                    : (usuarioData.find((user) => String(user.name || '').trim() === String(selectedUsuarioName || '').trim()) || usuarioData[0] || {});
                const selectedName = escapeHtmlAttr(selectedUser.name || '');
                const selectedEmail = escapeHtmlAttr(selectedUser.email || '');
                const selectedRole = String(selectedUser.role || 'Usuario');
                const selectedRoleValue = slugifyText(selectedRole).replace(/-/g, '_').toLowerCase();
                const selectedDepartmentRaw = selectedUser.department || '';
                const selectedDepartment = escapeHtmlAttr(selectedDepartmentRaw);
                const selectedStatus = escapeHtmlAttr(selectedUser.status || 'Activo');
                const selectedImage = getPersonImage(selectedUser);
                const selectedImageValue = escapeHtmlAttr((selectedUser.image || selectedUser.imagen || '').toString());
                const selectedUserId = Number(selectedUser.id || 0) || 0;
                const loginValue = escapeHtmlAttr(
                    String(selectedUser.login || selectedUser.usuario || '').trim()
                    || (String(selectedUser.email || '').split('@')[0])
                    || slugifyText(selectedUser.name || '').replace(/-/g, '_')
                );
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Usuarios activos</span></article>
                            <article class="usuario-stat"><strong>${roleCount}</strong><span>Roles en uso</span></article>
                        </section>
                        <section class="ar-grid ar-grid--stacked">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Gestion de usuarios</h2>
                                        <p>Registra perfiles, asigna roles y configura su estructura organizacional.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill ar-pill--soft">Usuario activo</span>
                                        <span class="ar-pill">${totalUsers} usuarios</span>
                                    </div>
                                </header>
                                <form class="ar-form">
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Nombre</label>
                                            <input type="text" id="usuario-nombre" placeholder="Nombre completo" value="${selectedName}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Usuario</label>
                                            <input type="text" id="usuario-usuario" placeholder="Nombre de usuario" value="${loginValue}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Correo electronico</label>
                                            <input type="email" id="usuario-correo" placeholder="usuario@empresa.com" value="${selectedEmail}">
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Contrasena</label>
                                            <input type="password" id="usuario-password" placeholder="********">
                                        </div>
                                        <div class="ar-field">
                                            <label>Rol</label>
                                            <select id="usuario-rol">
                                                <option value="">Selecciona un rol</option>
                                                ${getUsuarioRolOptions(selectedRoleValue || 'usuario')}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Estado</label>
                                            <select id="usuario-estado">
                                                <option value="Activo" ${selectedStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                                <option value="En mejora" ${selectedStatus === 'En mejora' ? 'selected' : ''}>En mejora</option>
                                                <option value="Observando" ${selectedStatus === 'Observando' ? 'selected' : ''}>Observando</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Departamento</label>
                                            <select id="usuario-departamento-select">
                                                <option value="">Selecciona un departamento</option>
                                                ${getDepartamentoOptions(selectedDepartmentRaw)}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Jefe inmediato</label>
                                            <select id="usuario-jefe-select">
                                                <option value="">Selecciona un jefe inmediato</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Direccion</label>
                                            <input type="text" placeholder="Direccion">
                                        </div>
                                        <div class="ar-field">
                                            <label>Telefono</label>
                                            <input type="text" placeholder="+52 55 0000 0000">
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--2 ar-row--image-preview">
                                        <div class="ar-field ar-field--image-input">
                                            <label>Imagen</label>
                                            <input type="text" id="usuario-imagen" placeholder="URL o nombre de archivo de imagen" value="${selectedImageValue}">
                                            <input type="file" id="usuario-image-file" accept="image/*" style="display:none">
                                        </div>
                                        <div class="ar-field ar-field--image-preview">
                                            <label>Vista previa</label>
                                            <div class="ar-avatar ar-avatar--preview-large ar-avatar--editable" aria-hidden="true">
                                                <img src="${selectedImage}" alt="Vista previa de imagen de usuario" class="ar-user-photo" id="usuario-image-preview">
                                                <div class="ar-avatar-tools">
                                                    <button type="button" class="ar-avatar-tool" id="usuario-image-edit" title="Editar imagen" aria-label="Editar imagen">
                                                        <img src="/templates/icon/editar.svg" alt="Editar">
                                                    </button>
                                                    <button type="button" class="ar-avatar-tool ar-avatar-tool--danger" id="usuario-image-delete" title="Eliminar imagen" aria-label="Eliminar imagen">
                                                        <img src="/templates/icon/eliminar.svg" alt="Eliminar">
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-actions">
                                        <button type="button" class="ar-btn ar-btn--soft" id="usuario-form-edit-btn" data-force-button-theme="1">Editar</button>
                                        <button type="button" class="ar-btn ar-btn--primary2" id="usuario-form-save-btn" data-force-button-theme="1">Guardar</button>
                                    </div>
                                </form>
                            </section>
                            <aside class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Resumen</h2>
                                        <p>Perfil y asignacion organizacional del usuario.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill">${escapeHtmlAttr(selectedRole || 'Usuario')}</span>
                                    </div>
                                </header>
                                <div class="ar-summary">
                                    <div class="ar-summary__top">
                                        <div class="ar-avatar" aria-hidden="true">
                                            <img src="${selectedImage}" alt="Foto de ${selectedName || 'Usuario'}" class="ar-user-photo">
                                        </div>
                                        <div>
                                            <div class="ar-summary__name">${selectedName || 'Sin asignar'}</div>
                                            <div class="ar-summary__meta">
                                                <span class="ar-badge ${selectedStatus === 'Activo' ? 'ar-badge--ok' : ''}">${selectedStatus}</span>
                                                <span class="ar-badge">${escapeHtmlAttr(selectedRole || 'Usuario')}</span>
                                                <span class="ar-badge">${selectedDepartment || 'Sin departamento'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-miniGrid">
                                        <div class="ar-mini"><div class="ar-mini__k">Correo</div><div class="ar-mini__v">${selectedEmail || 'No registrado'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Departamento</div><div class="ar-mini__v">${selectedDepartment || 'N/A'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Usuarios activos</div><div class="ar-mini__v">${activeUsers}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Roles en uso</div><div class="ar-mini__v">${roleCount}</div></div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-links">
                                        <button class="ar-link" type="button">Ver permisos del rol</button>
                                        <button class="ar-link" type="button">Abrir en organigrama</button>
                                        <button class="ar-link" type="button">Revisar historial</button>
                                    </div>
                                </div>
                            </aside>
                        </section>
                    </section>
                    <div class="password-confirm-backdrop hidden" id="password-confirm-backdrop">
                        <div class="password-confirm-modal" role="dialog" aria-modal="true" aria-label="Confirmar contrasena">
                            <h3>Confirmar contrasena</h3>
                            <input type="password" id="usuario-confirm-password" placeholder="Repite la contrasena">
                            <div class="password-confirm-actions">
                                <button type="button" id="password-confirm-cancel">Cancelar</button>
                                <button type="button" class="primary" id="password-confirm-ok">Confirmar</button>
                            </div>
                            <p class="password-confirm-msg" id="password-confirm-msg"></p>
                        </div>
                    </div>
                `;
                const departamentoSelect = usuarioView.querySelector('#usuario-departamento-select');
                const jefeSelect = usuarioView.querySelector('#usuario-jefe-select');
                const refreshJefes = (department) => {
                    if (!jefeSelect) return;
                    const options = usuarioData
                        .filter(user => user.department === department)
                        .map(user => `<option value="${user.name}">${user.name}</option>`)
                        .join('');
                    jefeSelect.innerHTML = `<option value="">Selecciona un jefe inmediato</option>${options}`;
                };
                if (departamentoSelect) {
                    departamentoSelect.addEventListener('change', () => refreshJefes(departamentoSelect.value));
                    departamentoSelect.value = selectedDepartmentRaw;
                    refreshJefes(departamentoSelect.value);
                }
                const rolInput = usuarioView.querySelector('#usuario-rol');
                const imagenInput = usuarioView.querySelector('#usuario-imagen');
                const imageFileInput = usuarioView.querySelector('#usuario-image-file');
                const imagePreview = usuarioView.querySelector('#usuario-image-preview');
                const imageEditBtn = usuarioView.querySelector('#usuario-image-edit');
                const imageDeleteBtn = usuarioView.querySelector('#usuario-image-delete');
                const usuarioFormEditBtn = usuarioView.querySelector('#usuario-form-edit-btn');
                const usuarioFormSaveBtn = usuarioView.querySelector('#usuario-form-save-btn');
                const syncImagePreview = () => {
                    if (!imagePreview) return;
                    const raw = (imagenInput?.value || '').trim();
                    imagePreview.src = raw ? normalizeImagePath(raw) : defaultKanbanImage;
                };
                if (imagenInput) {
                    imagenInput.addEventListener('input', syncImagePreview);
                    imagenInput.addEventListener('change', syncImagePreview);
                }
                imageEditBtn && imageEditBtn.addEventListener('click', () => {
                    if (imageFileInput) {
                        imageFileInput.click();
                        return;
                    }
                    if (!imagenInput) return;
                    imagenInput.focus();
                    imagenInput.select();
                    showMessage('Edita el campo Imagen y guarda para aplicar.', 'success');
                });
                imageDeleteBtn && imageDeleteBtn.addEventListener('click', () => {
                    if (!imagenInput) return;
                    imagenInput.value = '';
                    syncImagePreview();
                    showMessage('Imagen eliminada del formulario. Guarda para aplicar.', 'success');
                });
                imageFileInput && imageFileInput.addEventListener('change', async () => {
                    const file = imageFileInput.files && imageFileInput.files[0];
                    if (!file || !imagenInput) return;
                    try {
                        const fd = new FormData();
                        fd.append('archivo', file);
                        const res = await fetch('/api/usuarios/upload-imagen', {
                            method: 'POST',
                            body: fd,
                        });
                        const json = await res.json().catch(() => ({}));
                        if (!res.ok || !json?.success) {
                            throw new Error(json?.error || 'No se pudo subir la imagen');
                        }
                        imagenInput.value = String(json?.data?.filename || '').trim();
                        syncImagePreview();
                        showMessage('Imagen cargada. Guarda para aplicar.', 'success');
                    } catch (err) {
                        showMessage(err?.message || 'Error al subir imagen.', 'error');
                    } finally {
                        imageFileInput.value = '';
                    }
                });
                if (rolInput) {
                    const normalizedRole = String(selectedRole || '').trim().toLowerCase();
                    const roleOption = Array.from(rolInput.options).find((opt) => String(opt.value || '').trim().toLowerCase() === normalizedRole);
                    if (roleOption) rolInput.value = roleOption.value;
                }
                selectedUsuarioName = null;
                const passwordInput = usuarioView.querySelector('#usuario-password');
                const passwordConfirmBackdrop = usuarioView.querySelector('#password-confirm-backdrop');
                const passwordConfirmInput = usuarioView.querySelector('#usuario-confirm-password');
                const passwordConfirmOk = usuarioView.querySelector('#password-confirm-ok');
                const passwordConfirmCancel = usuarioView.querySelector('#password-confirm-cancel');
                const passwordConfirmMsg = usuarioView.querySelector('#password-confirm-msg');
                let passwordConfirmed = false;
                const openPasswordModal = () => {
                    if (!passwordConfirmBackdrop || !passwordConfirmInput) return;
                    passwordConfirmBackdrop.classList.remove('hidden');
                    passwordConfirmInput.value = '';
                    if (passwordConfirmMsg) passwordConfirmMsg.textContent = '';
                    setTimeout(() => passwordConfirmInput.focus(), 0);
                };
                const closePasswordModal = () => {
                    if (!passwordConfirmBackdrop) return;
                    passwordConfirmBackdrop.classList.add('hidden');
                };
                if (passwordInput) {
                    passwordInput.addEventListener('input', () => {
                        passwordConfirmed = false;
                    });
                    passwordInput.addEventListener('blur', () => {
                        const value = (passwordInput.value || '').trim();
                        if (!value || passwordConfirmed) return;
                        openPasswordModal();
                    });
                }
                passwordConfirmCancel && passwordConfirmCancel.addEventListener('click', () => {
                    passwordConfirmed = false;
                    closePasswordModal();
                });
                passwordConfirmOk && passwordConfirmOk.addEventListener('click', () => {
                    if (!passwordInput || !passwordConfirmInput) return;
                    if (passwordConfirmInput.value !== passwordInput.value) {
                        if (passwordConfirmMsg) passwordConfirmMsg.textContent = 'Las contrasenas no coinciden.';
                        return;
                    }
                    passwordConfirmed = true;
                    closePasswordModal();
                    showMessage('Contrasena confirmada.', 'success');
                });
                submitUsuarioFromPanel = async () => {
                    if (!usuarioPanel || usuarioPanel.classList.contains('hidden')) {
                        showMessage('Abre la vista de formulario para guardar usuarios.', 'error');
                        return;
                    }
                    const nombreInput = usuarioView.querySelector('#usuario-nombre');
                    const usuarioInput = usuarioView.querySelector('#usuario-usuario');
                    const correoInput = usuarioView.querySelector('#usuario-correo');
                    const passwordInput = usuarioView.querySelector('#usuario-password');
                    const rolSelect = usuarioView.querySelector('#usuario-rol');
                    const imagenInput = usuarioView.querySelector('#usuario-imagen');
                    if (!nombreInput || !usuarioInput || !correoInput || !passwordInput) {
                        showMessage('No se pudo leer el formulario de usuario.', 'error');
                        return;
                    }
                    const payload = {
                        nombre: (nombreInput.value || '').trim(),
                        usuario: (usuarioInput.value || '').trim(),
                        correo: (correoInput.value || '').trim(),
                        contrasena: passwordInput.value || '',
                        rol: (rolSelect?.value || 'usuario').trim(),
                        imagen: (imagenInput?.value || '').trim(),
                    };
                    const isEditing = !createUsuarioMode && selectedUserId > 0;
                    if (!payload.nombre || !payload.usuario || !payload.correo) {
                        showMessage('Nombre, usuario y correo son obligatorios.', 'error');
                        return;
                    }
                    if (!isEditing && !payload.contrasena) {
                        showMessage('La contrasea es obligatoria para crear usuarios.', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(isEditing ? `/api/usuarios/${selectedUserId}` : '/api/usuarios/registro-seguro', {
                            method: isEditing ? 'PUT' : 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const json = await res.json().catch(() => ({}));
                        if (!res.ok || !json?.success) {
                            throw new Error(json?.error || (isEditing ? 'No se pudo actualizar el usuario' : 'No se pudo guardar el usuario'));
                        }
                        createUsuarioMode = false;
                        showMessage(isEditing ? 'Usuario actualizado correctamente.' : 'Usuario registrado correctamente.', 'success');
                        passwordInput.value = '';
                        await loadUsuariosImagenes();
                    } catch (err) {
                        showMessage(err?.message || (isEditing ? 'Error al actualizar usuario.' : 'Error al registrar usuario.'), 'error');
                    }
                };
                usuarioFormEditBtn && usuarioFormEditBtn.addEventListener('click', () => {
                    createUsuarioMode = false;
                    showMessage('Modo edicin activado.', 'success');
                });
                usuarioFormSaveBtn && usuarioFormSaveBtn.addEventListener('click', () => {
                    if (typeof submitUsuarioFromPanel === 'function') {
                        submitUsuarioFromPanel();
                        return;
                    }
                    showMessage('No se pudo ejecutar el guardado del formulario.', 'error');
                });
            }
            function renderUsuarioList(role = 'Todos') {
                const filtered = role === 'Todos' ? usuarioData : usuarioData.filter(u => roleMatches(u.role, role));
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const inReview = usuarioData.filter((user) => user.status !== 'Activo').length;
                const statusBadgeClass = (status) => {
                    if (status === 'Activo') return 'ar-badge--ok';
                    if (status === 'En mejora') return 'ar-badge--warn';
                    return '';
                };
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Activos</span></article>
                            <article class="usuario-stat"><strong>${inReview}</strong><span>En mejora u observacion</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Listado de usuarios</h2>
                                    <p>Consulta perfiles por rol y monitorea su estado operativo.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${filtered.length} resultados</span>
                                    <div class="ar-field">
                                        <select id="usuario-role-select">
                                            ${getRoleOptions(role)}
                                        </select>
                                    </div>
                                </div>
                            </header>
                            <div class="ar-user-list view-list-excel-list usuarios-list-right-photo">
                                ${filtered.length ? filtered.map(user => `
                                    <button type="button" class="ar-user-item usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}">
                                        <div class="ar-user-item__main">
                                            <div class="ar-avatar">
                                                <img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo">
                                            </div>
                                            <div>
                                                <strong>${escapeHtmlAttr(user.name)}</strong>
                                                <div class="ar-user-item__sub">${escapeHtmlAttr(user.department)}</div>
                                            </div>
                                        </div>
                                        <div class="ar-summary__meta">
                                            <span class="ar-badge">${escapeHtmlAttr(user.role)}</span>
                                            <span class="ar-badge ${statusBadgeClass(user.status)}">${escapeHtmlAttr(user.status)}</span>
                                        </div>
                                    </button>
                                `).join('') : '<p class="ar-empty">No hay usuarios para este rol.</p>'}
                            </div>
                        </section>
                    </section>
                `;
                const selector = document.getElementById('usuario-role-select');
                selector && selector.addEventListener('change', () => renderUsuarioList(selector.value));
                bindUsuarioSelectableCards();
            }
            function renderUsuarioKanban(role = 'Todos') {
                const filtered = role === 'Todos' ? usuarioData : usuarioData.filter(u => roleMatches(u.role, role));
                const statuses = ['Activo', 'En mejora', 'Observando'];
                const totalUsers = usuarioData.length;
                const activeUsers = usuarioData.filter((user) => user.status === 'Activo').length;
                const observingUsers = usuarioData.filter((user) => user.status === 'Observando').length;
                const accentByStatus = (status) => {
                    if (status === 'Activo') return '#1f6f52';
                    if (status === 'En mejora') return '#f59e0b';
                    return '#2563eb';
                };
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>${totalUsers}</strong><span>Total de usuarios</span></article>
                            <article class="usuario-stat"><strong>${activeUsers}</strong><span>Activos</span></article>
                            <article class="usuario-stat"><strong>${observingUsers}</strong><span>Observando</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Kanban de usuarios</h2>
                                    <p>Distribucion visual del equipo por estado para seguimiento rapido.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${filtered.length} visibles</span>
                                    <div class="ar-field">
                                        <select id="usuario-role-select-kanban">
                                            ${getRoleOptions(role)}
                                        </select>
                                    </div>
                                </div>
                            </header>
                            <div class="ar-kanban">
                                ${statuses.map(status => `
                                    <div class="ar-col">
                                        <div class="ar-col__head">
                                            <div>
                                                <strong>${status}</strong>
                                                <span class="ar-col__count">${filtered.filter(u => u.status === status).length}</span>
                                            </div>
                                        </div>
                                        <div class="ar-col__body">
                                            ${(filtered.filter(u => u.status === status)).length
                                                ? filtered.filter(u => u.status === status).map(user => `
                                                    <article class="ar-kcard usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:${accentByStatus(status)}">
                                                        <div class="ar-kcard__accent"></div>
                                                        <div class="ar-kcard__top">
                                                            <div class="ar-klogo">
                                                                <img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}">
                                                            </div>
                                                            <div class="ar-kcard__main">
                                                                <div class="ar-kcard__title">${escapeHtmlAttr(user.name)}</div>
                                                                <div class="ar-kcard__sub">${escapeHtmlAttr(user.department)}</div>
                                                                <div class="ar-kcard__person">${escapeHtmlAttr(user.role)}</div>
                                                            </div>
                                                        </div>
                                                        <div class="ar-kcard__foot">
                                                            <span class="ar-badge">${escapeHtmlAttr(user.role)}</span>
                                                            <span class="ar-badge">${status}</span>
                                                        </div>
                                                    </article>
                                                `).join('')
                                                : '<p class="ar-empty">Sin usuarios en esta columna.</p>'
                                            }
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </section>
                `;
                const selector = document.getElementById('usuario-role-select-kanban');
                selector && selector.addEventListener('change', () => renderUsuarioKanban(selector.value));
                bindUsuarioSelectableCards();
            }
            function renderUsuarioOrganigrama() {
                const lider = usuarioData[0];
                const mandos = usuarioData.slice(1, 3);
                const equipoBase = usuarioData.slice(3);
                usuarioView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="usuario-stat"><strong>1</strong><span>Nivel directivo</span></article>
                            <article class="usuario-stat"><strong>${mandos.length}</strong><span>Mandos medios</span></article>
                            <article class="usuario-stat"><strong>${equipoBase.length}</strong><span>Equipo base</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Organigrama de usuarios</h2>
                                    <p>Cadena de mando y distribucion por niveles dentro de la organizacion.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${usuarioData.length} usuarios</span>
                                </div>
                            </header>
                            <div class="ar-org">
                                <div class="ar-org__level">
                                    <article class="ar-node ar-node--persona usuario-selectable" data-usuario-name="${escapeHtmlAttr(lider?.name || '')}" style="--accent:#0f3d2e">
                                        <div class="ar-node__badge">Nivel 1</div>
                                        <div class="ar-node__logo"><img src="${getPersonImage(lider)}" alt="Foto de ${escapeHtmlAttr(lider?.name || 'Direccion General')}" class="ar-user-photo"></div>
                                        <div class="ar-node__title">${escapeHtmlAttr(lider?.name || 'Sin asignar')}</div>
                                        <div class="ar-node__sub">Direccion General</div>
                                        <div class="ar-node__code">${escapeHtmlAttr(lider?.role || 'N/A')}</div>
                                    </article>
                                </div>
                                <div class="ar-org__pipe" aria-hidden="true"></div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${mandos.map(user => `
                                        <article class="ar-node ar-node--persona usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:#1f6f52">
                                            <div class="ar-node__badge">Nivel 2</div>
                                            <div class="ar-node__logo"><img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo"></div>
                                            <div class="ar-node__title">${escapeHtmlAttr(user.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(user.department)}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(user.role)}</div>
                                        </article>
                                    `).join('')}
                                </div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${equipoBase.map(user => `
                                        <article class="ar-node ar-node--persona usuario-selectable" data-usuario-name="${escapeHtmlAttr(user.name)}" style="--accent:#2563eb">
                                            <div class="ar-node__badge">Base</div>
                                            <div class="ar-node__logo"><img src="${getPersonImage(user)}" alt="Foto de ${escapeHtmlAttr(user.name)}" class="ar-user-photo"></div>
                                            <div class="ar-node__title">${escapeHtmlAttr(user.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(user.department)}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(user.role)}</div>
                                        </article>
                                    `).join('')}
                                </div>
                            </div>
                        </section>
                    </section>
                `;
                bindUsuarioSelectableCards();
            }
            function renderAreaForm() {
                if (!areaView) return;
                const areaCount = areasData.length;
                const parentCount = new Set(areasData.map(area => area.parent).filter(parent => parent && parent !== 'N/A')).size;
                const strategicCount = areasData.filter(area => area.status === 'Estratgico').length;
                const selectedArea = createAreaMode
                    ? {}
                    : (
                        areasData.find((area) => String(area.code || '').trim() === String(selectedAreaCode || '').trim())
                        || areasData.find(area => area.status === 'Activo')
                        || areasData[0]
                        || {}
                    );
                const selectedNameRaw = selectedArea.name || '';
                const selectedParentRaw = selectedArea.parent || 'N/A';
                const selectedManagerRaw = selectedArea.manager || '';
                const selectedCodeRaw = selectedArea.code || '';
                const selectedName = escapeHtmlAttr(selectedNameRaw);
                const selectedParent = escapeHtmlAttr(selectedParentRaw);
                const selectedManager = escapeHtmlAttr(selectedManagerRaw);
                const selectedCode = escapeHtmlAttr(selectedCodeRaw);
                const selectedColor = String(selectedArea.color || '#0f3d2e');
                const selectedStatus = escapeHtmlAttr(selectedArea.status || 'Activo');
                const relation = selectedStatus === 'En revisin' ? 'Funcional' : 'Lnea';
                const safeRelation = escapeHtmlAttr(relation);
                const hexLabel = /^#[0-9a-fA-F]{6}$/.test(selectedColor) ? selectedColor.toUpperCase() : '#0F3D2E';
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-grid ar-grid--stacked">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Datos del rea</h2>
                                        <p>Completa la informacin base y define su relacin organizacional.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill ar-pill--soft">${createAreaMode ? 'Nuevo registro' : 'Registro activo'}</span>
                                        <span class="ar-pill">${areaCount} reas</span>
                                    </div>
                                </header>
                                <form class="ar-form">
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Nombre</label>
                                            <input id="area-name-input" type="text" placeholder="Nombre del rea" value="${selectedName}">
                                        </div>
                                        <div class="ar-field">
                                            <label>Departamento padre</label>
                                            <select id="area-parent-select">
                                                ${getAreaParentOptions(selectedParentRaw)}
                                            </select>
                                        </div>
                                        <div class="ar-field">
                                            <label>Responsable</label>
                                            <select id="area-manager-select">
                                                ${getResponsableOptions(selectedManagerRaw)}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="ar-row ar-row--3">
                                        <div class="ar-field">
                                            <label>Relacin organizacional</label>
                                            <select id="area-relacion-select">
                                                <option value="Lnea" ${safeRelation === 'Lnea' ? 'selected' : ''}>Lnea</option>
                                                <option value="Staff" ${safeRelation === 'Staff' ? 'selected' : ''}>Staff</option>
                                                <option value="Funcional" ${safeRelation === 'Funcional' ? 'selected' : ''}>Funcional</option>
                                            </select>
                                            <div class="ar-chips">
                                                <button class="ar-chip ${safeRelation === 'Lnea' ? 'is-active' : ''}" type="button" data-relacion-help="Lnea">Lnea <span class="ar-q">?</span></button>
                                                <button class="ar-chip ${safeRelation === 'Staff' ? 'is-active' : ''}" type="button" data-relacion-help="Staff">Staff <span class="ar-q">?</span></button>
                                                <button class="ar-chip ${safeRelation === 'Funcional' ? 'is-active' : ''}" type="button" data-relacion-help="Funcional">Funcional <span class="ar-q">?</span></button>
                                            </div>
                                        </div>
                                        <div class="ar-field">
                                            <label>Cdigo</label>
                                            <input id="area-code-input" type="text" placeholder="Ej: OPE-010" value="${selectedCode}">
                                            <div class="ar-help">Recomendado: prefijo + consecutivo (ej. OPE-010).</div>
                                        </div>
                                        <div class="ar-field">
                                            <label>Color</label>
                                            <div class="ar-color">
                                                <input id="area-color-input" type="color" value="${selectedColor}">
                                                <span class="ar-color__swatch" style="--c:${selectedColor}"></span>
                                                <span class="ar-color__txt">${hexLabel}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-row ar-row--2">
                                        <div class="ar-field">
                                            <label>Descripcin</label>
                                            <textarea placeholder="Describe el propsito del rea">Responsable de la operacin diaria y ejecucin de procesos crticos.</textarea>
                                        </div>
                                        <div class="ar-field">
                                            <label>Notas internas</label>
                                            <textarea placeholder="Observaciones, acuerdos, excepciones"></textarea>
                                        </div>
                                    </div>
                                    <div class="ar-actions">
                                        <button type="button" id="area-form-new-btn" class="ar-btn ar-btn--soft" data-force-button-theme="1">Nuevo</button>
                                        <button type="button" id="area-form-cancel-btn" class="ar-btn ar-btn--soft" data-force-button-theme="1">Cancelar</button>
                                        <button type="button" id="area-form-save-btn" class="ar-btn ar-btn--primary2" data-force-button-theme="1">Guardar</button>
                                    </div>
                                </form>
                            </section>
                            <aside class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Resumen</h2>
                                        <p>Informacin rpida del rea y su posicin en la estructura.</p>
                                    </div>
                                    <div class="ar-card__tools">
                                        <span class="ar-pill">${selectedCode || 'N/A'}</span>
                                    </div>
                                </header>
                                <div class="ar-summary">
                                    <div class="ar-summary__top">
                                        <div class="ar-avatar" aria-hidden="true">${escapeHtmlAttr((selectedNameRaw || 'A').charAt(0))}</div>
                                        <div>
                                            <div class="ar-summary__name">${selectedName || 'Sin rea'}</div>
                                            <div class="ar-summary__meta">
                                                <span class="ar-badge ${selectedStatus === 'Activo' ? 'ar-badge--ok' : ''}">${selectedStatus}</span>
                                                <span class="ar-badge">${safeRelation}</span>
                                                <span class="ar-badge">Padre: ${selectedParent}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ar-miniGrid">
                                        <div class="ar-mini"><div class="ar-mini__k">Responsable</div><div class="ar-mini__v">${selectedManager || 'Sin asignar'}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Dependencias</div><div class="ar-mini__v">${parentCount}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">reas activas</div><div class="ar-mini__v">${areasData.filter(area => area.status === 'Activo').length}</div></div>
                                        <div class="ar-mini"><div class="ar-mini__k">Estado</div><div class="ar-mini__v ar-mini__v--ok">En regla</div></div>
                                    </div>
                                    <div class="ar-divider"></div>
                                    <div class="ar-links">
                                        <button class="ar-link" type="button">Ver puestos relacionados</button>
                                        <button class="ar-link" type="button">Abrir en organigrama</button>
                                        <button class="ar-link" type="button">Ver indicadores del rea</button>
                                    </div>
                                </div>
                            </aside>
                        </section>
                        <section class="area-stats">
                            <article class="area-stat"><strong>${areaCount}</strong><span>Total de reas</span></article>
                            <article class="area-stat"><strong>${parentCount}</strong><span>Dependencias padre</span></article>
                            <article class="area-stat"><strong>${strategicCount}</strong><span>reas estratgicas</span></article>
                        </section>
                    </section>
                `;
                areaView.querySelectorAll('[data-relacion-help]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const key = btn.getAttribute('data-relacion-help') || '';
                        const text = relacionOrganizacionalHelp[key];
                        if (text) alert(text);
                    });
                });
                const nameInput = areaView.querySelector('#area-name-input');
                const parentSelect = areaView.querySelector('#area-parent-select');
                const managerInput = areaView.querySelector('#area-manager-select');
                const relationSelect = areaView.querySelector('#area-relacion-select');
                const codeInput = areaView.querySelector('#area-code-input');
                const colorInput = areaView.querySelector('#area-color-input');
                const saveBtn = areaView.querySelector('#area-form-save-btn');
                const cancelBtn = areaView.querySelector('#area-form-cancel-btn');
                const newBtn = areaView.querySelector('#area-form-new-btn');
                newBtn && newBtn.addEventListener('click', () => {
                    createAreaMode = true;
                    selectedAreaCode = null;
                    renderAreaForm();
                    const input = areaView.querySelector('#area-name-input');
                    input && input.focus();
                });
                cancelBtn && cancelBtn.addEventListener('click', () => {
                    createAreaMode = false;
                    setAreaView('list');
                });
                saveBtn && saveBtn.addEventListener('click', async () => {
                    const name = String(nameInput?.value || '').trim();
                    const parent = String(parentSelect?.value || 'N/A').trim() || 'N/A';
                    const manager = String(managerInput?.value || '').trim();
                    const code = String(codeInput?.value || '').trim();
                    const color = normalizeAreaColor(colorInput?.value || '#1d4ed8');
                    const relationValue = String(relationSelect?.value || 'Lnea').trim();
                    const status = relationValue === 'Funcional'
                        ? 'En revisin'
                        : (createAreaMode ? 'Activo' : normalizeAreaStatus(selectedArea.status || 'Activo'));
                    if (!name || !code) {
                        showMessage('Nombre y cdigo son obligatorios.', 'error');
                        return;
                    }
                    const existingIndex = areasData.findIndex((area) => String(area.code || '').trim() === code);
                    const payload = { name, parent, manager, code, color, status };
                    if (existingIndex >= 0) {
                        areasData[existingIndex] = payload;
                    } else {
                        areasData.push(payload);
                    }
                    const saved = await persistAreasData();
                    if (!saved) {
                        showMessage('No se pudo guardar departamentos en BD.', 'error');
                        return;
                    }
                    createAreaMode = false;
                    selectedAreaCode = code;
                    showMessage('Departamento guardado en BD.', 'success');
                    setAreaView('form');
                });
            }
            function renderAreaList() {
                if (!areaView) return;
                const total = areasData.length;
                const activos = areasData.filter((area) => area.status === 'Activo').length;
                const enRevision = areasData.filter((area) => area.status === 'En revisin').length;
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="area-stats">
                            <article class="area-stat"><strong>${total}</strong><span>Total de reas</span></article>
                            <article class="area-stat"><strong>${activos}</strong><span>reas activas</span></article>
                            <article class="area-stat"><strong>${enRevision}</strong><span>En revisin</span></article>
                        </section>
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Listado de reas</h2>
                                    <p>Consulta reas por cdigo, responsable y estado.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">${total} registros</span>
                                </div>
                            </header>
                            <div class="ar-user-list view-list-excel-list">
                                ${areasData.length ? areasData.map((area) => `
                                    <button
                                        type="button"
                                        class="ar-user-item"
                                        data-area-code="${escapeHtmlAttr(area.code || '')}"
                                    >
                                        <div class="ar-user-item__main">
                                            <div class="ar-avatar" aria-hidden="true">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                            <div>
                                                <strong>${escapeHtmlAttr(area.name || 'Sin nombre')}</strong>
                                                <div class="ar-user-item__sub">${escapeHtmlAttr(area.manager || 'Sin responsable')}</div>
                                            </div>
                                        </div>
                                        <div class="ar-summary__meta">
                                            <span class="ar-badge">${escapeHtmlAttr(area.code || 'N/A')}</span>
                                            <span class="ar-badge ${area.status === 'Activo' ? 'ar-badge--ok' : ''}">${escapeHtmlAttr(area.status || 'N/A')}</span>
                                        </div>
                                    </button>
                                `).join('') : '<p class="ar-empty">No hay reas registradas.</p>'}
                            </div>
                        </section>
                    </section>
                `;
                areaView.querySelectorAll('[data-area-code]').forEach((item) => {
                    item.addEventListener('click', () => {
                        createAreaMode = false;
                        selectedAreaCode = (item.getAttribute('data-area-code') || '').trim();
                        setAreaView('form');
                    });
                });
            }
            function renderAreaKanban() {
                if (!areaView) return;
                const byStatus = {
                    'Estratgico': areasData.filter(area => area.status === 'Estratgico'),
                    'Activo': areasData.filter(area => area.status === 'Activo'),
                    'En revisin': areasData.filter(area => area.status === 'En revisin')
                };
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Kanban de reas</h2>
                                    <p>Arrastra y suelta para cambiar estado. Cada tarjeta muestra responsable y cdigo.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <span class="ar-pill">3 columnas</span>
                                    <button class="ar-btn ar-btn--soft" type="button">Nuevo estado</button>
                                </div>
                            </header>
                            <div class="ar-kanban">
                                ${Object.entries(byStatus).map(([status, areas]) => `
                                    <div class="ar-col">
                                        <div class="ar-col__head">
                                            <div>
                                                <strong>${status}</strong>
                                                <span class="ar-col__count">${areas.length}</span>
                                            </div>
                                            <button class="ar-btn ar-btn--soft" type="button"></button>
                                        </div>
                                        <div class="ar-col__body">
                                            ${areas.length ? areas.map(area => `
                                                <article class="ar-kcard" style="--accent:${escapeHtmlAttr(area.color || '#1f6f52')}">
                                                    <div class="ar-kcard__accent"></div>
                                                    <div class="ar-kcard__top">
                                                        <div class="ar-klogo" aria-hidden="true">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                                        <div class="ar-kcard__main">
                                                            <div class="ar-kcard__title">${escapeHtmlAttr(area.name)}</div>
                                                            <div class="ar-kcard__sub">${escapeHtmlAttr(area.code)}</div>
                                                            <div class="ar-kcard__person">${escapeHtmlAttr(area.manager)}</div>
                                                        </div>
                                                    </div>
                                                    <div class="ar-kcard__foot">
                                                        <span class="ar-badge">${status === 'Activo' ? 'Lnea' : (status === 'Estratgico' ? 'Nivel 1' : 'Pendiente')}</span>
                                                        <span class="ar-badge ${status === 'Activo' ? 'ar-badge--ok' : (status === 'En revisin' ? 'ar-badge--warn' : '')}">${status}</span>
                                                    </div>
                                                </article>
                                            `).join('') : '<p class="ar-empty">Sin reas en esta columna.</p>'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </section>
                `;
            }
            function renderAreaOrganigrama() {
                if (!areaView) return;
                const root = areasData.find(area => area.parent === 'N/A') || areasData[0];
                if (!root) {
                    areaView.innerHTML = `
                        <section class="ar-shell">
                            <section class="ar-card ar-card--pad">
                                <header class="ar-card__head">
                                    <div>
                                        <h2>Organigrama de reas</h2>
                                        <p>No hay reas disponibles para construir el organigrama.</p>
                                    </div>
                                    <div class="ar-card__tools"><span class="ar-pill">0 reas</span></div>
                                </header>
                                <p class="ar-empty">
                                    Crea una primera rea para habilitar la vista jerrquica.
                                </p>
                            </section>
                        </section>
                    `;
                    return;
                }
                const firstLevel = areasData.filter(area => area.parent === root.name);
                const secondLevel = areasData.filter(area => firstLevel.some(parent => parent.name === area.parent));
                areaView.innerHTML = `
                    <section class="ar-shell">
                        <section class="ar-card ar-card--pad">
                            <header class="ar-card__head">
                                <div>
                                    <h2>Organigrama de reas</h2>
                                    <p>Vista jerrquica con lneas y niveles. Selecciona un nodo para ver detalle.</p>
                                </div>
                                <div class="ar-card__tools">
                                    <button class="ar-btn ar-btn--soft" type="button">Centrar</button>
                                    <button class="ar-btn ar-btn--soft" type="button">Expandir</button>
                                    <button class="ar-btn ar-btn--soft" type="button">Exportar</button>
                                </div>
                            </header>
                            <div class="ar-org">
                                <div class="ar-org__level">
                                    <div class="ar-node ar-node--root" style="--accent:${escapeHtmlAttr(root.color || '#0f3d2e')}">
                                        <div class="ar-node__badge">Nivel 1</div>
                                        <div class="ar-node__logo">${escapeHtmlAttr((root.name || 'A').charAt(0))}</div>
                                        <div class="ar-node__title">${escapeHtmlAttr(root.name)}</div>
                                        <div class="ar-node__sub">${escapeHtmlAttr(root.manager || 'Sin asignar')}</div>
                                        <div class="ar-node__code">${escapeHtmlAttr(root.code || 'N/A')}</div>
                                    </div>
                                </div>
                                <div class="ar-org__pipe" aria-hidden="true"></div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${firstLevel.map(area => `
                                        <div class="ar-node" style="--accent:${escapeHtmlAttr(area.color || '#1f6f52')}">
                                            <div class="ar-node__badge">Nivel 2</div>
                                            <div class="ar-node__logo">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                            <div class="ar-node__title">${escapeHtmlAttr(area.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(area.manager || 'Sin asignar')}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(area.code || 'N/A')}</div>
                                        </div>
                                    `).join('') || '<p class="ar-empty">Sin reas de primer nivel.</p>'}
                                </div>
                                <div class="ar-org__level ar-org__level--children">
                                    ${secondLevel.map(area => `
                                        <div class="ar-node" style="--accent:${escapeHtmlAttr(area.color || '#2563eb')}">
                                            <div class="ar-node__badge">Nivel 3</div>
                                            <div class="ar-node__logo">${escapeHtmlAttr((area.name || 'A').charAt(0))}</div>
                                            <div class="ar-node__title">${escapeHtmlAttr(area.name)}</div>
                                            <div class="ar-node__sub">${escapeHtmlAttr(area.manager || 'Sin asignar')}</div>
                                            <div class="ar-node__code">${escapeHtmlAttr(area.code || 'N/A')}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="ar-org__legend">
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#0f3d2e"></span> Estratgico</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#1f6f52"></span> Operativo</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#2563eb"></span> Staff</span>
                                    <span class="ar-legendItem"><span class="ar-dot" style="--c:#f59e0b"></span> Revisin</span>
                                </div>
                            </div>
                        </section>
                    </section>
                `;
            }
            function setAreaView(view) {
                if (!areaPanel || !areaView) return;
                setFloatingScreen('areas');
                ensureFloatingVisible();
                areaPanel.classList.remove('hidden');
                areaTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === view));
                activateViewButton(view);
                switch (view) {
                    case 'list':
                        renderAreaList();
                        break;
                    case 'kanban':
                        renderAreaKanban();
                        break;
                    case 'organigrama':
                        renderAreaOrganigrama();
                        break;
                    default:
                        renderAreaForm();
                        break;
                }
            }
            function setUsuarioView(view) {
                if (!usuarioPanel || !usuarioView) return;
                setFloatingScreen('usuarios');
                ensureFloatingVisible();
                usuarioPanel.classList.remove('hidden');
                usuarioTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === view));
                activateViewButton(view);
                currentUsuarioView = view;
                refreshUsuarioFloating();
                switch (view) {
                    case 'list':
                        renderUsuarioList();
                        break;
                    case 'kanban':
                        renderUsuarioKanban();
                        break;
                    case 'organigrama':
                        renderUsuarioOrganigrama();
                        break;
                    default:
                        renderUsuarioForm();
                        break;
                }
            }
            usuarioTabs.forEach(tab => tab.addEventListener('click', () => setUsuarioView(tab.dataset.view)));
            areaTabs.forEach(tab => tab.addEventListener('click', () => setAreaView(tab.dataset.view)));
            usuarioLinks.forEach(link => link.addEventListener('click', event => {
                const targetHref = link.getAttribute('href');
                const currentPath = window.location.pathname;
                if (targetHref && targetHref !== currentPath) {
                    return;
                }
                event.preventDefault();
                setUsuarioView(link.dataset.view || 'form');
            }));
            const isUsuariosRoute = window.location.pathname === '/usuarios-sistema' || window.location.pathname === '/usuarios' || window.location.pathname === '/inicio/colaboradores';
            if (isUsuariosRoute && usuarioPanel && usuarioView) {
                const activeUsuarioLink = Array.from(usuarioLinks).find(link => link.getAttribute('href') === window.location.pathname);
                if (activeUsuarioLink) {
                    setMenuInfo(activeUsuarioLink);
                }
                await loadUsuariosImagenes();
                await loadRolesSistemaDisponibles();
                setUsuarioView('form');
            }
            const isAreasRoute = window.location.pathname === '/areas-organizacionales' || window.location.pathname === '/inicio/departamentos';
            if (isAreasRoute && areaPanel && areaView) {
                const areaMenuLink = document.querySelector(`a[data-route="${window.location.pathname}"]`) || document.querySelector('a[data-route="/areas-organizacionales"]');
                if (areaMenuLink) {
                    setMenuInfo(areaMenuLink);
                }
                await loadUsuariosImagenes();
                await loadAreasData();
                setAreaView('form');
            }
            const plantillasPage = document.getElementById('plantillas-page');
            const templateNameInput = document.getElementById('template-name');
            const templateHtmlInput = document.getElementById('template-html');
            const templateCssInput = document.getElementById('template-css');
            const templateNewBtn = document.getElementById('template-new-btn');
            const templateEditBtn = document.getElementById('template-edit-btn');
            const templateBuilderBtn = document.getElementById('template-builder-btn');
            const templatePreviewBtn = document.getElementById('template-preview-btn');
            const templateSaveBtn = document.getElementById('template-save-btn');
            const templateDeleteBtn = document.getElementById('template-delete-btn');
            const templatePreviewFrame = document.getElementById('template-preview');
            const builderBackToTemplates = document.getElementById('builder-back-to-templates');
            const plantillasList = document.getElementById('plantillas-list');
            const formBuilderPanel = document.getElementById('form-builder-panel');
            const builderFormSelect = document.getElementById('builder-form-select');
            const builderFormName = document.getElementById('builder-form-name');
            const builderFormSlug = document.getElementById('builder-form-slug');
            const builderFormActive = document.getElementById('builder-form-active');
            const builderFormTenant = document.getElementById('builder-form-tenant');
            const builderFormRoles = document.getElementById('builder-form-roles');
            const builderFormDescription = document.getElementById('builder-form-description');
            const builderFormConfig = document.getElementById('builder-form-config');
            const builderFieldType = document.getElementById('builder-field-type');
            const builderFieldLabel = document.getElementById('builder-field-label');
            const builderFieldName = document.getElementById('builder-field-name');
            const builderFieldPlaceholder = document.getElementById('builder-field-placeholder');
            const builderFieldHelp = document.getElementById('builder-field-help');
            const builderFieldOptions = document.getElementById('builder-field-options');
            const builderFieldConditional = document.getElementById('builder-field-conditional');
            const builderFieldRequired = document.getElementById('builder-field-required');
            const builderAddFieldBtn = document.getElementById('builder-add-field-btn');
            const builderClearFormBtn = document.getElementById('builder-clear-form-btn');
            const builderSaveFormBtn = document.getElementById('builder-save-form-btn');
            const builderDeleteFormBtn = document.getElementById('builder-delete-form-btn');
            const builderFieldsList = document.getElementById('builder-fields-list');
            let plantillasStore = [];
            let selectedTemplateId = null;
            let formDefinitionsStore = [];
            let selectedFormDefinitionId = null;
            let builderFields = [];
            let builderRoleOptions = [];
            function slugifyText(value) {
                return (value || '')
                    .toString()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
            const normalizeRoleValue = (value) => (value || '').toString().trim().toLowerCase();
            const getBuilderSelectedRoles = () => {
                if (!builderFormRoles) return [];
                return Array.from(builderFormRoles.selectedOptions || [])
                    .map((opt) => normalizeRoleValue(opt.value))
                    .filter(Boolean);
            };
            const renderBuilderRoleOptions = (selected = []) => {
                if (!builderFormRoles) return;
                const selectedSet = new Set((Array.isArray(selected) ? selected : []).map((item) => normalizeRoleValue(item)));
                builderFormRoles.innerHTML = builderRoleOptions.map((role) => (
                    `<option value="${role.value}" ${selectedSet.has(role.value) ? 'selected' : ''}>${role.label}</option>`
                )).join('');
            };
            const renderBuilderFields = () => {
                if (!builderFieldsList) return;
                if (!builderFields.length) {
                    builderFieldsList.innerHTML = '<p class="plantillas-hint">No hay campos agregados.</p>';
                    return;
                }
                builderFieldsList.innerHTML = builderFields.map((field, index) => `
                    <div class="builder-field-item">
                        <div class="meta">
                            <strong>${field.label || field.name}</strong>
                            <span>Tipo: ${field.field_type} | Nombre: ${field.name}</span>
                            <span>${field.is_required ? 'Obligatorio' : 'Opcional'}${field.options?.length ? ` | Opciones: ${field.options.map((opt) => opt.label || opt.value).join(', ')}` : ''}${field.conditional_logic && Object.keys(field.conditional_logic).length ? ' | Condicional' : ''}</span>
                        </div>
                        <button type="button" class="builder-field-delete" data-builder-remove-field="${index}">Quitar</button>
                    </div>
                `).join('');
                builderFieldsList.querySelectorAll('[data-builder-remove-field]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const index = Number(btn.dataset.builderRemoveField);
                        if (Number.isNaN(index)) return;
                        builderFields = builderFields.filter((_, i) => i !== index);
                        renderBuilderFields();
                    });
                });
            };
            const clearBuilderFieldInputs = () => {
                if (builderFieldType) builderFieldType.value = 'text';
                if (builderFieldLabel) builderFieldLabel.value = '';
                if (builderFieldName) builderFieldName.value = '';
                if (builderFieldPlaceholder) builderFieldPlaceholder.value = '';
                if (builderFieldHelp) builderFieldHelp.value = '';
                if (builderFieldOptions) builderFieldOptions.value = '';
                if (builderFieldConditional) builderFieldConditional.value = '';
                if (builderFieldRequired) builderFieldRequired.checked = false;
            };
            const clearBuilderForm = () => {
                selectedFormDefinitionId = null;
                builderFields = [];
                if (builderFormSelect) builderFormSelect.value = '';
                if (builderFormName) builderFormName.value = '';
                if (builderFormSlug) builderFormSlug.value = '';
                if (builderFormActive) builderFormActive.value = 'true';
                if (builderFormTenant) builderFormTenant.value = currentTenantId || 'default';
                renderBuilderRoleOptions([]);
                if (builderFormDescription) builderFormDescription.value = '';
                if (builderFormConfig) builderFormConfig.value = '';
                clearBuilderFieldInputs();
                renderBuilderFields();
            };
            const setBuilderFromForm = (formDef) => {
                if (!formDef) return;
                selectedFormDefinitionId = formDef.id;
                if (builderFormSelect) builderFormSelect.value = String(formDef.id);
                if (builderFormName) builderFormName.value = formDef.name || '';
                if (builderFormSlug) builderFormSlug.value = formDef.slug || '';
                if (builderFormActive) builderFormActive.value = formDef.is_active ? 'true' : 'false';
                if (builderFormTenant) builderFormTenant.value = (formDef.tenant_id || currentTenantId || 'default');
                renderBuilderRoleOptions(Array.isArray(formDef.allowed_roles) ? formDef.allowed_roles : []);
                if (builderFormDescription) builderFormDescription.value = formDef.description || '';
                if (builderFormConfig) {
                    const cfg = formDef.config && typeof formDef.config === 'object' ? formDef.config : {};
                    builderFormConfig.value = Object.keys(cfg).length ? JSON.stringify(cfg) : '';
                }
                const fields = Array.isArray(formDef.fields) ? formDef.fields : [];
                builderFields = fields.map((field, index) => ({
                    field_type: field.field_type || field.type || 'text',
                    label: field.label || '',
                    name: field.name || `campo_${index + 1}`,
                    placeholder: field.placeholder || '',
                    help_text: field.help_text || field.helpText || '',
                    default_value: field.default_value || field.defaultValue || '',
                    is_required: Boolean(field.is_required ?? field.required),
                    validation_rules: field.validation_rules || field.validation || {},
                    options: Array.isArray(field.options)
                        ? field.options.map((opt) => {
                            if (typeof opt === 'object' && opt !== null) {
                                return { label: String(opt.label || opt.value || ''), value: String(opt.value || opt.label || '') };
                            }
                            const value = String(opt || '');
                            return { label: value, value };
                        }).filter((opt) => opt.value)
                        : [],
                    order: Number(field.order ?? index),
                    conditional_logic: field.conditional_logic || field.conditional || {},
                }));
                renderBuilderFields();
            };
            const renderBuilderFormSelect = () => {
                if (!builderFormSelect) return;
                builderFormSelect.innerHTML = `<option value="">Nuevo formulario</option>${formDefinitionsStore.map((formDef) => (
                    `<option value="${formDef.id}" ${Number(formDef.id) === Number(selectedFormDefinitionId) ? 'selected' : ''}>${formDef.name} (${formDef.slug})</option>`
                )).join('')}`;
            };
            const loadFormDefinitions = async () => {
                if (!formBuilderPanel) return;
                try {
                    const res = await fetch('/api/admin/forms');
                    const json = await res.json();
                    if (!res.ok) throw new Error(json?.detail || 'No se pudo cargar formularios');
                    formDefinitionsStore = Array.isArray(json) ? json : [];
                    renderBuilderFormSelect();
                    if (selectedFormDefinitionId) {
                        const match = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                        if (match) setBuilderFromForm(match);
                    }
                } catch (error) {
                    showMessage('No se pudieron cargar los formularios.', 'error');
                }
            };
            const loadBuilderRoleOptions = async () => {
                if (!formBuilderPanel) return;
                builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                try {
                    const res = await fetch('/api/roles-disponibles');
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) throw new Error(payload?.error || 'No se pudieron cargar roles');
                    const items = Array.isArray(payload?.data) ? payload.data : [];
                    builderRoleOptions = items.map((role) => {
                        const value = normalizeRoleValue(role?.nombre || role?.value || '');
                        const label = String(role?.label || role?.nombre || value || '').trim();
                        return { value, label };
                    }).filter((role) => role.value);
                    if (!builderRoleOptions.length) {
                        builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                    }
                } catch (error) {
                    builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                }
                renderBuilderRoleOptions(getBuilderSelectedRoles());
            };
            const collectBuilderPayload = () => {
                const name = (builderFormName?.value || '').trim();
                const slug = (builderFormSlug?.value || '').trim();
                const description = (builderFormDescription?.value || '').trim();
                const tenantId = (builderFormTenant?.value || currentTenantId || 'default').trim();
                const rawConfig = (builderFormConfig?.value || '').trim();
                if (!name) {
                    throw new Error('El nombre del formulario es obligatorio.');
                }
                if (!builderFields.length) {
                    throw new Error('Agrega al menos un campo al formulario.');
                }
                let config = {};
                if (rawConfig) {
                    try {
                        const parsed = JSON.parse(rawConfig);
                        if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                            throw new Error();
                        }
                        config = parsed;
                    } catch (error) {
                        throw new Error('La configuracin JSON del formulario es invlida.');
                    }
                }
                return {
                    name,
                    slug: slug || slugifyText(name),
                    tenant_id: tenantId || 'default',
                    description: description || null,
                    is_active: (builderFormActive?.value || 'true') === 'true',
                    config,
                    allowed_roles: getBuilderSelectedRoles(),
                    fields: builderFields.map((field, index) => ({
                        ...field,
                        order: index,
                    })),
                };
            };
            const renderTemplatePreview = () => {
                if (!templatePreviewFrame) return;
                let htmlCode = templateHtmlInput?.value || '';
                const cssCode = templateCssInput?.value || '';
                if (!htmlCode.trim() && !cssCode.trim()) {
                    htmlCode = "<section style='padding:16px;font-family:Arial,sans-serif;color:#475569;'>Agrega HTML/CSS o selecciona una plantilla para previsualizar.</section>";
                }
                const previewDoc = `<!doctype html><html><head><meta charset="UTF-8"><style>${cssCode}</style></head><body>${htmlCode}</body></html>`;
                templatePreviewFrame.srcdoc = previewDoc;
                try {
                    const frameDoc = templatePreviewFrame.contentDocument || templatePreviewFrame.contentWindow?.document;
                    if (frameDoc) {
                        frameDoc.open();
                        frameDoc.write(previewDoc);
                        frameDoc.close();
                    }
                } catch (error) {
                    // srcdoc remains as fallback if direct write is blocked by browser policy.
                }
            };
            const clearTemplateEditor = () => {
                selectedTemplateId = null;
                if (templateNameInput) templateNameInput.value = '';
                if (templateHtmlInput) templateHtmlInput.value = '';
                if (templateCssInput) templateCssInput.value = '';
                renderTemplatePreview();
                if (plantillasList) {
                    plantillasList.querySelectorAll('.plantillas-item').forEach((btn) => btn.classList.remove('active'));
                }
            };
            const setTemplateEditor = (tpl) => {
                if (!tpl) return;
                selectedTemplateId = tpl.id;
                if (templateNameInput) templateNameInput.value = tpl.nombre || '';
                if (templateHtmlInput) templateHtmlInput.value = tpl.html || '';
                if (templateCssInput) templateCssInput.value = tpl.css || '';
                renderTemplatePreview();
            };
            const renderPlantillasList = () => {
                if (!plantillasList) return;
                plantillasList.innerHTML = plantillasStore.map((tpl) => `
                    <li>
                        <button type="button" class="plantillas-item ${tpl.id === selectedTemplateId ? 'active' : ''}" data-template-id="${tpl.id}">
                            ${tpl.nombre}
                        </button>
                    </li>
                `).join('');
                plantillasList.querySelectorAll('[data-template-id]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.templateId;
                        const tpl = plantillasStore.find((item) => item.id === id);
                        if (!tpl) return;
                        setTemplateEditor(tpl);
                        renderPlantillasList();
                        showMessage(`Plantilla "${tpl.nombre}" cargada.`, 'success');
                    });
                });
            };
            const loadPlantillas = async () => {
                if (!plantillasPage) return;
                try {
                    const res = await fetch('/api/plantillas');
                    if (!res.ok) throw new Error('No se pudo cargar la lista');
                    const json = await res.json();
                    plantillasStore = Array.isArray(json?.data) ? json.data : [];
                    if (!selectedTemplateId && plantillasStore.length) {
                        setTemplateEditor(plantillasStore[0]);
                    } else if (!plantillasStore.length) {
                        clearTemplateEditor();
                    }
                    renderPlantillasList();
                } catch (error) {
                    showMessage('No se pudieron cargar las plantillas.', 'error');
                }
            };
            if (plantillasPage) {
                const plantillasLink = document.querySelector('a[data-route="/plantillas"]');
                if (plantillasLink) {
                    setMenuInfo(plantillasLink);
                }
                setFloatingScreen('plantillas');
                ensureFloatingVisible();
                await loadBuilderRoleOptions();
                loadPlantillas();
                templatePreviewBtn && templatePreviewBtn.addEventListener('click', renderTemplatePreview);
                templateHtmlInput && templateHtmlInput.addEventListener('input', renderTemplatePreview);
                templateCssInput && templateCssInput.addEventListener('input', renderTemplatePreview);
                builderFormName && builderFormName.addEventListener('input', () => {
                    if (selectedFormDefinitionId) return;
                    if (!builderFormSlug) return;
                    if ((builderFormSlug.value || '').trim()) return;
                    builderFormSlug.value = slugifyText(builderFormName.value);
                });
                builderFieldLabel && builderFieldLabel.addEventListener('input', () => {
                    if (!builderFieldName) return;
                    if ((builderFieldName.value || '').trim()) return;
                    builderFieldName.value = slugifyText(builderFieldLabel.value).replace(/-/g, '_');
                });
                templateBuilderBtn && templateBuilderBtn.addEventListener('click', () => {
                    window.location.href = '/plantillas/constructor';
                });
                builderBackToTemplates && builderBackToTemplates.addEventListener('click', () => {
                    window.location.href = '/plantillas';
                });
                builderFormSelect && builderFormSelect.addEventListener('change', () => {
                    const formId = Number(builderFormSelect.value);
                    if (!formId) {
                        clearBuilderForm();
                        return;
                    }
                    const found = formDefinitionsStore.find((item) => Number(item.id) === formId);
                    if (!found) {
                        showMessage('Formulario no encontrado en la lista.', 'error');
                        return;
                    }
                    setBuilderFromForm(found);
                    showMessage(`Formulario "${found.name}" cargado.`, 'success');
                });
                builderAddFieldBtn && builderAddFieldBtn.addEventListener('click', () => {
                    const fieldLabel = (builderFieldLabel?.value || '').trim();
                    const fieldNameRaw = (builderFieldName?.value || '').trim();
                    const fieldType = (builderFieldType?.value || 'text').trim();
                    const conditionalRaw = (builderFieldConditional?.value || '').trim();
                    if (!fieldLabel) {
                        showMessage('La etiqueta del campo es obligatoria.', 'error');
                        return;
                    }
                    const normalizedName = (fieldNameRaw || slugifyText(fieldLabel).replace(/-/g, '_')).replace(/[^a-zA-Z0-9_]/g, '_');
                    if (!normalizedName) {
                        showMessage('El nombre tcnico del campo es invlido.', 'error');
                        return;
                    }
                    if (builderFields.some((item) => item.name === normalizedName)) {
                        showMessage('Ya existe un campo con ese nombre tcnico.', 'error');
                        return;
                    }
                    const optionValues = (builderFieldOptions?.value || '')
                        .split(',')
                        .map((opt) => opt.trim())
                        .filter(Boolean);
                    let normalizedOptions = optionValues.map((opt) => ({ label: opt, value: opt }));
                    if (fieldType === 'likert' && !normalizedOptions.length) {
                        normalizedOptions = ['1', '2', '3', '4', '5'].map((value) => ({ label: value, value }));
                    }
                    let conditionalLogic = {};
                    if (conditionalRaw) {
                        try {
                            const parsed = JSON.parse(conditionalRaw);
                            if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                                showMessage('La condicin debe ser un objeto JSON vlido.', 'error');
                                return;
                            }
                            conditionalLogic = parsed;
                        } catch (error) {
                            showMessage('JSON condicional invlido.', 'error');
                            return;
                        }
                    }
                    builderFields.push({
                        field_type: fieldType,
                        label: fieldLabel,
                        name: normalizedName,
                        placeholder: (builderFieldPlaceholder?.value || '').trim() || null,
                        help_text: (builderFieldHelp?.value || '').trim() || null,
                        default_value: null,
                        is_required: Boolean(builderFieldRequired?.checked),
                        validation_rules: {},
                        options: ['select', 'radio', 'checkboxes', 'likert'].includes(fieldType)
                            ? normalizedOptions
                            : [],
                        order: builderFields.length,
                        conditional_logic: conditionalLogic,
                    });
                    renderBuilderFields();
                    clearBuilderFieldInputs();
                    showMessage('Campo agregado al formulario.', 'success');
                });
                builderClearFormBtn && builderClearFormBtn.addEventListener('click', () => {
                    clearBuilderForm();
                    showMessage('Constructor limpiado.', 'success');
                });
                builderSaveFormBtn && builderSaveFormBtn.addEventListener('click', async () => {
                    try {
                        const payload = collectBuilderPayload();
                        const formId = selectedFormDefinitionId ? Number(selectedFormDefinitionId) : null;
                        const endpoint = formId ? `/api/admin/forms/${encodeURIComponent(formId)}` : '/api/admin/forms';
                        const method = formId ? 'PUT' : 'POST';
                        const res = await fetch(endpoint, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo guardar el formulario');
                        selectedFormDefinitionId = Number(json?.id || formId || selectedFormDefinitionId);
                        await loadFormDefinitions();
                        if (!selectedFormDefinitionId && json?.id) {
                            selectedFormDefinitionId = Number(json.id);
                        }
                        if (selectedFormDefinitionId) {
                            const saved = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                            if (saved) setBuilderFromForm(saved);
                        }
                        showMessage('Formulario guardado correctamente.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al guardar formulario.', 'error');
                    }
                });
                builderDeleteFormBtn && builderDeleteFormBtn.addEventListener('click', async () => {
                    if (!selectedFormDefinitionId) {
                        showMessage('Selecciona un formulario para eliminar.', 'error');
                        return;
                    }
                    if (!confirm('Eliminar el formulario seleccionado?')) {
                        showMessage('Eliminacin cancelada.', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/admin/forms/${encodeURIComponent(selectedFormDefinitionId)}`, {
                            method: 'DELETE',
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo eliminar');
                        clearBuilderForm();
                        await loadFormDefinitions();
                        showMessage('Formulario eliminado.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al eliminar formulario.', 'error');
                    }
                });
                if (formBuilderPanel && !formBuilderPanel.classList.contains('hidden')) {
                    clearBuilderForm();
                    loadFormDefinitions();
                    if (!builderFields.length) renderBuilderFields();
                }
            }
            document.addEventListener('backend-view-change', (event) => {
                const view = event.detail?.view;
                if (!view) return;
                if (activeFloatingScreen === 'usuarios') {
                    setUsuarioView(view);
                } else if (activeFloatingScreen === 'areas') {
                    setAreaView(view);
                }
            });
            const notebookTabs = document.querySelectorAll('.notebook-tabs .tab');
            const notebookPanels = document.querySelectorAll('.notebook-content .tab-panel');
            const activateNotebookTab = (name) => {
                if (!name) return;
                notebookTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === name));
                notebookPanels.forEach(panel => {
                    panel.hidden = panel.dataset.panel !== name;
                });
            };
            notebookTabs.forEach(tab => tab.addEventListener('click', () => activateNotebookTab(tab.dataset.tab)));
            const openCreateUsuarioForm = () => {
                setFloatingScreen('usuarios');
                refreshUsuarioFloating();
                ensureFloatingVisible();
                createUsuarioMode = true;
                selectedUsuarioName = null;
                setUsuarioView('form');
                const nombreInput = usuarioView ? usuarioView.querySelector('#usuario-nombre') : null;
                const usuarioInput = usuarioView ? usuarioView.querySelector('#usuario-usuario') : null;
                const correoInput = usuarioView ? usuarioView.querySelector('#usuario-correo') : null;
                const passwordInput = usuarioView ? usuarioView.querySelector('#usuario-password') : null;
                const rolSelect = usuarioView ? usuarioView.querySelector('#usuario-rol') : null;
                const estadoSelect = usuarioView ? usuarioView.querySelector('#usuario-estado') : null;
                const departamentoSelect = usuarioView ? usuarioView.querySelector('#usuario-departamento-select') : null;
                const jefeSelect = usuarioView ? usuarioView.querySelector('#usuario-jefe-select') : null;
                if (nombreInput) nombreInput.value = '';
                if (usuarioInput) usuarioInput.value = '';
                if (correoInput) correoInput.value = '';
                if (passwordInput) passwordInput.value = '';
                if (rolSelect) rolSelect.value = '';
                if (estadoSelect) estadoSelect.value = 'Activo';
                if (departamentoSelect) departamentoSelect.value = '';
                if (jefeSelect) jefeSelect.innerHTML = '<option value="">Selecciona un jefe inmediato</option>';
                if (nombreInput) nombreInput.focus();
                showMessage('Formulario listo para crear usuario.', 'success');
            };
            actionCreateUser && actionCreateUser.addEventListener('click', (event) => {
                event.preventDefault();
                openCreateUsuarioForm();
            });
            actionEdit && actionEdit.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                createUsuarioMode = false;
                setUsuarioView('form');
                showMessage('Modo edicin activado.', 'success');
            });
            actionSavePersonal && actionSavePersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                if (identityForm) {
                    if (typeof identityForm.requestSubmit === 'function') {
                        identityForm.requestSubmit();
                    } else {
                        identityForm.submit();
                    }
                    return;
                }
                guardarColores();
                guardarAssets();
            });
            actionResetPersonal && actionResetPersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                restablecerColores();
                restablecerAssets();
                showMessage('Colores restablecidos en personalizacin.', 'success');
            });
            personalizarEditBtn && personalizarEditBtn.addEventListener('click', (event) => {
                event.preventDefault();
                const firstColorInput = document.querySelector('.personalization-panel input[type="color"]');
                if (firstColorInput instanceof HTMLElement) {
                    firstColorInput.focus();
                }
                showMessage('Modo edicin activo en personalizacin.', 'success');
            });
            personalizarSaveBtn && personalizarSaveBtn.addEventListener('click', (event) => {
                event.preventDefault();
                guardarColores();
                guardarAssets();
            });
            personalizarResetBtn && personalizarResetBtn.addEventListener('click', (event) => {
                event.preventDefault();
                restablecerColores();
                restablecerAssets();
                guardarColores();
            });
            actionSaveUsuario && actionSaveUsuario.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                if (typeof submitUsuarioFromPanel === 'function') {
                    submitUsuarioFromPanel();
                    return;
                }
                showMessage('Abre la vista de formulario para guardar usuarios.', 'error');
            });
            actionDelete && actionDelete.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                if (confirm('Eliminar el registro seleccionado?')) {
                    showMessage('Registro eliminado.', 'success');
                } else {
                    showMessage('Eliminacin cancelada.', 'error');
                }
            });
            actionNewAreas && actionNewAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                createAreaMode = true;
                selectedAreaCode = null;
                setAreaView('form');
                showMessage('Nueva rea lista para captura.', 'success');
            });
            actionEditAreas && actionEditAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                createAreaMode = false;
                setAreaView('form');
                showMessage('Modo edicin de reas activado.', 'success');
            });
            actionSaveAreas && actionSaveAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                const saveBtn = areaView ? areaView.querySelector('#area-form-save-btn') : null;
                if (!(saveBtn instanceof HTMLElement)) {
                    showMessage('Abre la vista formulario para guardar departamentos.', 'error');
                    return;
                }
                saveBtn.click();
            });
            actionDeleteAreas && actionDeleteAreas.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'areas') return;
                event.preventDefault();
                if (confirm('Eliminar el rea seleccionada?')) {
                    showMessage('rea eliminada.', 'success');
                } else {
                    showMessage('Eliminacin cancelada.', 'error');
                }
            });
            actionNewTemplate && actionNewTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                clearTemplateEditor();
                templateNameInput && templateNameInput.focus();
                showMessage('Nueva plantilla lista para captura.', 'success');
            });
            actionEditTemplate && actionEditTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para editar.', 'error');
                    return;
                }
                templateNameInput && templateNameInput.focus();
                showMessage('Modo edicin de plantilla activado.', 'success');
            });
            const handleTemplateSave = async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                if (event) event.preventDefault();
                const payload = {
                    id: selectedTemplateId,
                    nombre: (templateNameInput?.value || '').trim(),
                    html: templateHtmlInput?.value || '',
                    css: templateCssInput?.value || '',
                };
                if (!payload.nombre) {
                    showMessage('El nombre de la plantilla es obligatorio.', 'error');
                    return;
                }
                if (!payload.html.trim() && !payload.css.trim()) {
                    showMessage('Agrega HTML o CSS para guardar.', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/plantillas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo guardar');
                    }
                    selectedTemplateId = json?.data?.id || selectedTemplateId;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla guardada.', 'success');
                } catch (error) {
                    showMessage('Error al guardar la plantilla.', 'error');
                }
            };
            actionSaveTemplate && actionSaveTemplate.addEventListener('click', handleTemplateSave);
            templateSaveBtn && templateSaveBtn.addEventListener('click', handleTemplateSave);
            actionDeleteTemplate && actionDeleteTemplate.addEventListener('click', async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para eliminar.', 'error');
                    return;
                }
                if (!confirm('Eliminar la plantilla seleccionada?')) {
                    showMessage('Eliminacin cancelada.', 'error');
                    return;
                }
                try {
                    const res = await fetch(`/api/plantillas/${encodeURIComponent(selectedTemplateId)}`, {
                        method: 'DELETE',
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo eliminar');
                    }
                    selectedTemplateId = null;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla eliminada.', 'success');
                } catch (error) {
                    showMessage(error?.message || 'Error al eliminar la plantilla.', 'error');
                }
            });
            templateNewBtn && templateNewBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionNewTemplate && actionNewTemplate.click();
            });
            templateEditBtn && templateEditBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionEditTemplate && actionEditTemplate.click();
            });
            templateDeleteBtn && templateDeleteBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionDeleteTemplate && actionDeleteTemplate.click();
            });
            actionExportReportes && actionExportReportes.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/html';
                showMessage('Exportando reporte con encabezado.', 'success');
            });
            actionExportPdf && actionExportPdf.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/pdf';
                showMessage('Generando PDF con encabezado.', 'success');
            });
            actionExportExcel && actionExportExcel.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/excel';
                showMessage('Generando Excel con encabezado.', 'success');
            });
            actionViewForm && actionViewForm.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('form');
                showMessage('Vista formulario.', 'success');
            });
            actionViewList && actionViewList.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('list');
                showMessage('Vista lista.', 'success');
            });
            actionViewKanban && actionViewKanban.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                setUsuarioView('kanban');
                showMessage('Vista kanban.', 'success');
            });
            actionViewGraph && actionViewGraph.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista grfica.', 'success');
            });
            actionViewGantt && actionViewGantt.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista gantt.', 'success');
            });
            actionViewDashboard && actionViewDashboard.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista dashboard.', 'success');
            });
            actionViewCalendar && actionViewCalendar.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'usuarios') return;
                event.preventDefault();
                showMessage('Vista calendario.', 'success');
            });
            const fodaBuilder = document.getElementById('foda-builder');
            if (fodaBuilder) {
                const descriptionInput = document.getElementById('foda-description');
                const categoryInput = document.getElementById('foda-category');
                const impactInput = document.getElementById('foda-impact');
                const addButton = document.getElementById('foda-add');
                const lists = {
                    strengths: document.getElementById('foda-list-strengths'),
                    weaknesses: document.getElementById('foda-list-weaknesses'),
                    opportunities: document.getElementById('foda-list-opportunities'),
                    threats: document.getElementById('foda-list-threats'),
                };
                const counters = {
                    strengths: document.getElementById('foda-count-strengths'),
                    weaknesses: document.getElementById('foda-count-weaknesses'),
                    opportunities: document.getElementById('foda-count-opportunities'),
                    threats: document.getElementById('foda-count-threats'),
                };
                const factors = {
                    strengths: [],
                    weaknesses: [],
                    opportunities: [],
                    threats: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderFoda = () => {
                    Object.keys(factors).forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="foda-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-foda-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    fodaBuilder.querySelectorAll('[data-foda-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [cat, indexRaw] = (btn.dataset.fodaRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[cat] || Number.isNaN(index)) return;
                            factors[cat].splice(index, 1);
                            renderFoda();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'strengths';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor FODA.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderFoda();
                    showMessage('Factor FODA agregado.', 'success');
                });
                renderFoda();
            }
            const pestelBuilder = document.getElementById('pestel-builder');
            if (pestelBuilder) {
                const descriptionInput = document.getElementById('pestel-description');
                const factorInput = document.getElementById('pestel-factor');
                const impactInput = document.getElementById('pestel-impact');
                const addButton = document.getElementById('pestel-add');
                const dimensions = ['political', 'economic', 'social', 'technological', 'ecological', 'legal'];
                const lists = {
                    political: document.getElementById('pestel-list-political'),
                    economic: document.getElementById('pestel-list-economic'),
                    social: document.getElementById('pestel-list-social'),
                    technological: document.getElementById('pestel-list-technological'),
                    ecological: document.getElementById('pestel-list-ecological'),
                    legal: document.getElementById('pestel-list-legal'),
                };
                const counters = {
                    political: document.getElementById('pestel-count-political'),
                    economic: document.getElementById('pestel-count-economic'),
                    social: document.getElementById('pestel-count-social'),
                    technological: document.getElementById('pestel-count-technological'),
                    ecological: document.getElementById('pestel-count-ecological'),
                    legal: document.getElementById('pestel-count-legal'),
                };
                const factors = {
                    political: [],
                    economic: [],
                    social: [],
                    technological: [],
                    ecological: [],
                    legal: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPestel = () => {
                    dimensions.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="pestel-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-pestel-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    pestelBuilder.querySelectorAll('[data-pestel-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [dimension, indexRaw] = (btn.dataset.pestelRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[dimension] || Number.isNaN(index)) return;
                            factors[dimension].splice(index, 1);
                            renderPestel();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const dimension = factorInput?.value || 'political';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor PESTEL.', 'error');
                        return;
                    }
                    if (!factors[dimension]) return;
                    factors[dimension].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPestel();
                    showMessage('Factor PESTEL agregado.', 'success');
                });
                renderPestel();
            }
            const porterBuilder = document.getElementById('porter-builder');
            if (porterBuilder) {
                const descriptionInput = document.getElementById('porter-description');
                const forceInput = document.getElementById('porter-force');
                const impactInput = document.getElementById('porter-impact');
                const addButton = document.getElementById('porter-add');
                const forces = ['competitors', 'entrants', 'suppliers', 'buyers', 'substitutes'];
                const lists = {
                    competitors: document.getElementById('porter-list-competitors'),
                    entrants: document.getElementById('porter-list-entrants'),
                    suppliers: document.getElementById('porter-list-suppliers'),
                    buyers: document.getElementById('porter-list-buyers'),
                    substitutes: document.getElementById('porter-list-substitutes'),
                };
                const counters = {
                    competitors: document.getElementById('porter-count-competitors'),
                    entrants: document.getElementById('porter-count-entrants'),
                    suppliers: document.getElementById('porter-count-suppliers'),
                    buyers: document.getElementById('porter-count-buyers'),
                    substitutes: document.getElementById('porter-count-substitutes'),
                };
                const factors = {
                    competitors: [],
                    entrants: [],
                    suppliers: [],
                    buyers: [],
                    substitutes: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPorter = () => {
                    forces.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="porter-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-porter-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    porterBuilder.querySelectorAll('[data-porter-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [force, indexRaw] = (btn.dataset.porterRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[force] || Number.isNaN(index)) return;
                            factors[force].splice(index, 1);
                            renderPorter();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const force = forceInput?.value || 'competitors';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para el factor PORTER.', 'error');
                        return;
                    }
                    if (!factors[force]) return;
                    factors[force].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPorter();
                    showMessage('Factor PORTER agregado.', 'success');
                });
                renderPorter();
            }
            const percepcionBuilder = document.getElementById('percepcion-builder');
            if (percepcionBuilder) {
                const descriptionInput = document.getElementById('percepcion-description');
                const categoryInput = document.getElementById('percepcion-category');
                const priorityInput = document.getElementById('percepcion-priority');
                const addButton = document.getElementById('percepcion-add');
                const categories = ['positive', 'neutral', 'negative'];
                const lists = {
                    positive: document.getElementById('percepcion-list-positive'),
                    neutral: document.getElementById('percepcion-list-neutral'),
                    negative: document.getElementById('percepcion-list-negative'),
                };
                const counters = {
                    positive: document.getElementById('percepcion-count-positive'),
                    neutral: document.getElementById('percepcion-count-neutral'),
                    negative: document.getElementById('percepcion-count-negative'),
                };
                const factors = {
                    positive: [],
                    neutral: [],
                    negative: [],
                };
                const priorityLabel = {
                    high: 'Prioridad alta',
                    medium: 'Prioridad media',
                    low: 'Prioridad baja',
                };
                const renderPercepcion = () => {
                    categories.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="percepcion-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${priorityLabel[item.priority] || 'Prioridad media'}</small>
                                </div>
                                <button type="button" data-percepcion-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    percepcionBuilder.querySelectorAll('[data-percepcion-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [category, indexRaw] = (btn.dataset.percepcionRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[category] || Number.isNaN(index)) return;
                            factors[category].splice(index, 1);
                            renderPercepcion();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'neutral';
                    const priority = priorityInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripcin para la percepcin del cliente.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, priority });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPercepcion();
                    showMessage('Percepcin agregada.', 'success');
                });
                renderPercepcion();
            }
            const navbarAvatarImg = document.getElementById('navbar-avatar-img');
            const applyFallback = (img) => {
                if (!img) return;
                const fallback = img.dataset.default;
                img.addEventListener('error', function() {
                    if (fallback) img.src = fallback;
                });
                if (!img.src) img.src = fallback;
            };
            applyFallback(navbarAvatarImg);
            applyFallback(sidebarUserImg);
            syncSidebarCompanyLogo();
            loadUsuariosImagenes();
            syncNavbarNotificationIconColor(
                (navbar ? getComputedStyle(navbar).color : '')
                || getComputedStyle(document.documentElement).getPropertyValue('--navbar-text')
            );
            if (navbarAvatarBtn && userDropdown) {
                const closeUserDropdown = () => {
                    userDropdown.classList.remove('open');
                    navbarAvatarBtn.setAttribute('aria-expanded', 'false');
                };
                navbarAvatarBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const willOpen = !userDropdown.classList.contains('open');
                    if (willOpen) {
                        userDropdown.classList.add('open');
                        navbarAvatarBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('click', (event) => {
                    if (!userDropdown.contains(event.target) && !navbarAvatarBtn.contains(event.target)) {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeUserDropdown();
                    }
                });
                if (logoutLink) {
                    logoutLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        closeUserDropdown();
                        window.location.assign('/logout');
                    });
                }
            }
            if ((sidebarNotificationsTrigger || navbarNotificationsTrigger) && sidebarNotificationsPanel) {
                const closeNotifications = () => {
                    sidebarNotificationsPanel.classList.remove('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'true');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                };
                const openNotifications = async () => {
                    sidebarNotificationsPanel.classList.add('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'false');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    await loadNotifications(false);
                };
                const bindNotificationsTrigger = (trigger, setMenu = false) => {
                    if (!trigger) return;
                    trigger.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        if (setMenu) setMenuInfo(trigger);
                        const willOpen = !sidebarNotificationsPanel.classList.contains('open');
                        if (willOpen) {
                            await openNotifications();
                        } else {
                            closeNotifications();
                        }
                    });
                };
                bindNotificationsTrigger(sidebarNotificationsTrigger, true);
                bindNotificationsTrigger(navbarNotificationsTrigger, false);
                sidebarNotificationsRefresh && sidebarNotificationsRefresh.addEventListener('click', async (event) => {
                    event.preventDefault();
                    await loadNotifications(false);
                });
                sidebarNotificationsMarkAll && sidebarNotificationsMarkAll.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const ids = Array.from(
                        sidebarNotificationsList.querySelectorAll('[data-notification-id]')
                    ).map((el) => (el.getAttribute('data-notification-id') || '').trim()).filter(Boolean);
                    try {
                        await markAllNotificationsRead(ids);
                        await loadNotifications(false);
                    } catch (error) {
                        showMessage(error.message || 'No se pudieron marcar las notificaciones', 'error');
                    }
                });
                sidebarNotificationsList.addEventListener('click', async (event) => {
                    const link = event.target && event.target.closest ? event.target.closest('[data-notification-id]') : null;
                    if (!link) return;
                    const notificationId = (link.getAttribute('data-notification-id') || '').trim();
                    const href = link.getAttribute('href') || '#';
                    event.preventDefault();
                    try {
                        await markNotificationRead(notificationId);
                    } catch (error) {
                        // Si falla la persistencia, no bloqueamos navegacin.
                    }
                    await loadNotifications(true);
                    if (href && href !== '#') {
                        window.location.assign(href);
                    }
                });
                document.addEventListener('click', (event) => {
                    if (
                        sidebarNotificationsPanel.classList.contains('open')
                        && !sidebarNotificationsPanel.contains(event.target)
                        && !(sidebarNotificationsTrigger && sidebarNotificationsTrigger.contains(event.target))
                        && !(navbarNotificationsTrigger && navbarNotificationsTrigger.contains(event.target))
                    ) {
                        closeNotifications();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeNotifications();
                    }
                });
                loadNotifications(true);
                window.setInterval(() => {
                    loadNotifications(true);
                }, 60000);
            }
            const empresaToggle = document.getElementById("empresa-section-toggle");
            const empresaContent = document.getElementById("empresa-section-content");
            if (empresaToggle && empresaContent) {
                const setEmpresaOpenState = (open) => {
                    empresaContent.classList.toggle("open", open);
                    empresaToggle.setAttribute("aria-expanded", open ? "true" : "false");
                    const indicator = empresaToggle.querySelector(".toggle-indicator");
                    if (indicator) {
                        indicator.textContent = open ? "" : "+";
                    }
                };
                empresaToggle.addEventListener("click", () => {
                    const open = !empresaContent.classList.contains("open");
                    setEmpresaOpenState(open);
                });
                const currentPath = window.location.pathname;
                const empresaLinks = empresaContent.querySelectorAll('a[href]');
                const shouldOpenEmpresa = Array.from(empresaLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenEmpresa) {
                    setEmpresaOpenState(true);
                    const activeEmpresaLink = Array.from(empresaLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeEmpresaLink) {
                        setMenuInfo(activeEmpresaLink);
                    }
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ app_favicon_url | default('/templates/icon/icon.png') }}">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/dist/output.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <style>
        :root {
            {% if colores %}
            {% for key, value in colores.items() %}
            --{{ key }}: {{ value }};
            {% endfor %}
            {% endif %}
        }
    </style>
    <script>
        window.__sipet_server_colors = {{ colores | default({}, true) | tojson }};
    </script>
</head>
<body>
    <script>
        (function() {
            var colors = window.__sipet_server_colors || {};
            var rootStyle = document.documentElement.style;
            for (var key in colors) {
                if (!Object.prototype.hasOwnProperty.call(colors, key)) continue;
                rootStyle.setProperty('--' + key, String(colors[key]));
            }
        })();
    </script>
    {% set hide_floating_actions = hide_floating_actions | default(false) %}
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-user">
                <img
                    id="sidebar-user-img"
                    src="{{ sidebar_logo_url | default('/templates/icon/icon.png', true) }}"
                    data-default="{{ sidebar_logo_url | default('/templates/icon/icon.png', true) }}"
                    alt="Logo empresa"
                />
            </div>
        </div>
        <nav>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/inicio.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Inicio</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/inicio">Inicio</a>
                </div>
            </details>
            <details class="sidebar-block" open>
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/inicio.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Organización</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/inicio/departamentos">Áreas organizacionales</a>
                    <a href="/inicio/regiones">Regiones</a>
                    <a href="/inicio/sucursales">Sucursales</a>
                    <a href="/inicio/colaboradores">Colaboradores</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/plan.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Estrategia y táctica</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <details class="sidebar-submenu-group">
                        <summary>Diagnóstico</summary>
                        <div class="sidebar-submenu-level3">
                            <a href="/diagnostico/foda">FODA</a>
                            <a href="/diagnostico/pestel">PESTEL</a>
                            <a href="/diagnostico/porter">PORTER</a>
                            <a href="/diagnostico/percepcion-cliente">Percepción del cliente</a>
                        </div>
                    </details>
                    <a href="/planes">Plan estratégico</a>
                    <a href="/poa">POA</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/proyectando.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Datos financieros</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/proyectando">Tablero de control</a>
                    <details class="sidebar-submenu-group">
                        <summary>Proyectando</summary>
                        <div class="sidebar-submenu-level3">
                            <a href="/proyectando/datos-preliminares">1. Preliminares</a>
                            <a href="/proyectando/crecimiento-general">2. Crecimiento general</a>
                            <a href="/proyectando/activo-fijo">3. Activo fijo</a>
                            <a href="/proyectando/otras-cuentas-activo">4. Otras cuentas de activo</a>
                            <a href="/proyectando/cartera-prestamos">5. Cartera de préstamos</a>
                            <a href="/proyectando/recursos-liquidos">6. Liquidez</a>
                            <a href="/proyectando/pasivos">7. Pasivos</a>
                            <a href="/proyectando/gastos">8. Gastos</a>
                            <a href="/proyectando/tasa-referencia">9. Tasa de referencia</a>
                        </div>
                    </details>
                    <details class="sidebar-submenu-group">
                        <summary>Presupuesto</summary>
                        <div class="sidebar-submenu-level3">
                            <a href="/proyectando/presupuesto">Vista general</a>
                        </div>
                    </details>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/inicio.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Control y segumiento</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/control-seguimiento">Control y segumiento</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/kpi.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">KPI's</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/kpis">KPI's</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/notificaciones.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Notificaciones</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/notificaciones">Bandeja</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/reporte.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Reportes</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/reportes">Resumen</a>
                    <a href="/reportes/documentos">Documentos</a>
                </div>
            </details>
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/empresa.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Empresa</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/identidad-institucional">Identidad institucional</a>
                    <a href="/empresa/base-datos">Base de datos</a>
                    <a href="/plantillas">Plantillas</a>
                    <a href="/plantillas/constructor">Constructor de formularios</a>
                </div>
            </details>
            {% if (request.state.user_role | default('')) in ['superadministrador', 'superadmin'] %}
            <details class="sidebar-block">
                <summary>
                    <span class="sidebar-main-left">
                        <span class="sidebar-main-icon" style="--icon-src: url('/icon/settings.svg');" aria-hidden="true"></span>
                        <span class="sidebar-main-label">Ajustes</span>
                    </span>
                    <span class="sidebar-main-caret">▾</span>
                </summary>
                <div class="sidebar-submenu">
                    <a href="/personalizar">Colores</a>
                    <a href="/roles-permisos">Roles</a>
                    <a href="/membresia">Membresía</a>
                </div>
            </details>
            {% endif %}
        </nav>
        <div class="sidebar-notifications-panel" id="sidebar-notifications-panel" aria-hidden="true">
            <div class="sidebar-notifications-header">
                <div>
                    <strong>Notificaciones</strong>
                    <div class="sidebar-notifications-count" id="sidebar-notifications-count">Sin pendientes</div>
                </div>
                <div class="sidebar-notifications-actions">
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-mark-all">Marcar todo</button>
                    <button type="button" class="sidebar-notifications-refresh" id="sidebar-notifications-refresh">Actualizar</button>
                </div>
            </div>
            <div class="sidebar-notifications-empty" id="sidebar-notifications-empty">No tienes notificaciones pendientes.</div>
            <ul class="sidebar-notifications-list" id="sidebar-notifications-list"></ul>
        </div>
    </div>
    <div class="navbar">
        <div class="navbar-inner">
            <div class="navbar-left">
                <button class="navbar-hamburger is-open" aria-label="Mostrar u ocultar menú" aria-expanded="true" aria-controls="sidebar">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <div class="navbar-title">
                    <span class="navbar-menu-name">{{ page_title or title or "Inicio" }}</span>
                    <a class="navbar-route" href="{{ request.url.path | default('/inicio') }}">{{ request.url.path | default('/inicio') }}</a>
                </div>
            </div>
            <div class="navbar-user-menu">
                <button class="navbar-notifications-btn" id="navbar-notifications-trigger" aria-label="Notificaciones" aria-expanded="false">
                    <span class="navbar-notifications-icon" aria-hidden="true"></span>
                    <span class="navbar-notifications-badge" id="navbar-notifications-badge">0</span>
                </button>
                <button class="navbar-avatar" id="navbar-avatar-btn" aria-label="Menú de usuario" aria-expanded="false">
                    <img
                        id="navbar-avatar-img"
                        src="{{ login_logo_url | default('/templates/icon/usuario.png', true) }}"
                        data-default="{{ login_logo_url | default('/templates/icon/usuario.png', true) }}"
                        alt="Usuario"
                    />
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="/perfil" id="profile-link">Perfil</a>
                    <a href="/logout" id="logout-link">Salir de SIPET</a>
                </div>
            </div>
        </div>
    </div>
    <main class="main-content">
        <div class="content-shell">
        {% if show_page_header | default(true) %}
        <section class="page-header">
            <div class="page-header-text">
                {% if subtitle %}
                <span class="page-header-subtitle">{{ subtitle }}</span>
                {% endif %}
                <h1 class="page-title">{{ page_title or title }}</h1>
                <p class="page-description">{{ page_description or description }}</p>
                {% if view_buttons_html %}
                <div class="view-buttons page-view-buttons">
                    {{ view_buttons_html | safe }}
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}
        <section class="content-section">
            {% if section_label or section_title %}
            <!-- header de sección eliminado -->
            {% endif %}
            <div class="content-section-body">
                {{ content|safe }}
            </div>
        </section>
        </div>
    </main>
        {% if not hide_floating_actions and floating_actions_html %}
        <div class="floating-actions-wrapper"
             aria-label="Acciones rápidas de pantalla"
             data-default-screen="{{ floating_actions_screen | default('personalization') }}">
            <aside class="floating-actions">
                {{ floating_actions_html | safe }}
            </aside>
            <button class="floating-toggle" type="button" id="floating-toggle" aria-label="Ocultar barra flotante">−</button>
        </div>
        {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const hamburger = document.querySelector('.navbar-hamburger');
            const sidebarElem = document.getElementById('sidebar');
            const navbar = document.querySelector('.navbar');
            const mainContent = document.querySelector('.main-content');
            const personalizarBtn = document.getElementById('personalizar-btn');
            const personalizarToggle = document.getElementById('personalizar-toggle');
            const personalizarSubmenu = document.getElementById('personalizar-submenu');
            const planificacionBtn = document.getElementById('planificacion-btn');
            const planificacionToggle = document.getElementById('planificacion-toggle');
            const planificacionSubmenu = document.getElementById('planificacion-submenu');
            const proyectandoBtn = document.getElementById('proyectando-btn');
            const proyectandoToggle = document.getElementById('proyectando-toggle');
            const proyectandoSubmenu = document.getElementById('proyectando-submenu');
            const diagnosticoBtn = document.getElementById('diagnostico-btn');
            const diagnosticoToggle = document.getElementById('diagnostico-toggle');
            const diagnosticoSubmenu = document.getElementById('diagnostico-submenu');
            const reportesBtn = document.getElementById('reportes-btn');
            const reportesToggle = document.getElementById('reportes-toggle');
            const reportesSubmenu = document.getElementById('reportes-submenu');
            const inicioBtn = document.getElementById('inicio-btn');
            const inicioToggle = document.getElementById('inicio-toggle');
            const inicioSubmenu = document.getElementById('inicio-submenu');
            const submenuLinks = document.querySelectorAll('.submenu[data-menu-name]');
            const menuLinks = document.querySelectorAll('nav > a[data-menu-name]');
            const sidebarBlocks = document.querySelectorAll('.sidebar-block');
            const sidebarSummaryItems = document.querySelectorAll('.sidebar-block > summary');
            const sidebarSubmenuLinks = document.querySelectorAll('.sidebar-submenu a');
            const navbarMenuName = document.querySelector('.navbar-menu-name');
            const navbarRoute = document.querySelector('.navbar-route');
            const floatingActions = document.querySelector('.floating-actions');
            const floatingGroups = document.querySelectorAll('.floating-actions-group');
            const floatingToggle = document.getElementById('floating-toggle');
            const floatingActionsWrapper = document.querySelector('.floating-actions-wrapper');
            const usuarioPanel = document.getElementById('usuario-panel');
            const identityForm = document.getElementById('identity-form');
            const actionSavePersonal = document.getElementById('action-save-personal');
            const actionResetPersonal = document.getElementById('action-reset-personal');
            const actionCreateUser = document.getElementById('action-create-user');
            const actionEdit = document.getElementById('action-edit');
            const actionSaveUsuario = document.getElementById('action-save-usuario');
            const actionDelete = document.getElementById('action-delete');
            const actionViewGantt = document.getElementById('action-view-gantt');
            const actionViewDashboard = document.getElementById('action-view-dashboard');
            const actionViewCalendar = document.getElementById('action-view-calendar');
            const actionNewTemplate = document.getElementById('action-new-template');
            const actionEditTemplate = document.getElementById('action-edit-template');
            const actionSaveTemplate = document.getElementById('action-save-template');
            const actionDeleteTemplate = document.getElementById('action-delete-template');
            const actionExportReportes = document.getElementById('action-export-reportes');
            const actionExportPdf = document.getElementById('action-export-pdf');
            const actionExportExcel = document.getElementById('action-export-excel');
            const personalizarEditBtn = document.getElementById('personalizar-edit-btn');
            const personalizarSaveBtn = document.getElementById('personalizar-save-btn');
            const personalizarResetBtn = document.getElementById('personalizar-reset-btn');
            const navbarAvatarBtn = document.getElementById('navbar-avatar-btn');
            const navbarAvatarImgEl = document.getElementById('navbar-avatar-img');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutLink = document.getElementById('logout-link');
            const sidebarUserImg = document.getElementById('sidebar-user-img');
            const USER_LOGO_CACHE_KEY = 'sipet_logo_usuario_url';
            try {
                if (sidebarUserImg instanceof HTMLImageElement) {
                    // El logo del sidebar siempre proviene de Identidad institucional (valor por defecto del template).
                    sidebarUserImg.src = sidebarUserImg.dataset.default || sidebarUserImg.src;
                    window.localStorage.removeItem('sipet_logo_empresa_url');
                }
                if (navbarAvatarImgEl instanceof HTMLImageElement) {
                    const cachedUserLogo = String(window.localStorage.getItem(USER_LOGO_CACHE_KEY) || '').trim();
                    if (cachedUserLogo) {
                        navbarAvatarImgEl.src = cachedUserLogo;
                    }
                }
            } catch (e) {
                // Ignorar acceso a localStorage cuando no esté disponible.
            }
            const syncSidebarCompanyLogo = async () => {
                if (!(sidebarUserImg instanceof HTMLImageElement) && !(navbarAvatarImgEl instanceof HTMLImageElement)) return;
                try {
                    const res = await fetch('/personalizar/estado', { headers: { Accept: 'application/json' } });
                    if (!res.ok) return;
                    const json = await res.json();
                    const userLogoUrl = String(json?.assets?.logo_usuario?.url || '').trim();
                    if (navbarAvatarImgEl instanceof HTMLImageElement) {
                        if (userLogoUrl) {
                            navbarAvatarImgEl.src = userLogoUrl;
                            try {
                                window.localStorage.setItem(USER_LOGO_CACHE_KEY, userLogoUrl);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no esté disponible.
                            }
                        } else if (navbarAvatarImgEl.dataset.default) {
                            navbarAvatarImgEl.src = navbarAvatarImgEl.dataset.default;
                            try {
                                window.localStorage.removeItem(USER_LOGO_CACHE_KEY);
                            } catch (e) {
                                // Ignorar acceso a localStorage cuando no esté disponible.
                            }
                        }
                    }
                } catch (e) {
                    if (sidebarUserImg.dataset.default) {
                        sidebarUserImg.src = sidebarUserImg.dataset.default;
                    }
                    if (navbarAvatarImgEl instanceof HTMLImageElement && navbarAvatarImgEl.dataset.default) {
                        navbarAvatarImgEl.src = navbarAvatarImgEl.dataset.default;
                    }
                }
            };
            const sidebarNotificationsTrigger = document.getElementById('sidebar-notifications-trigger');
            const sidebarNotificationsBadge = document.getElementById('sidebar-notifications-badge');
            const navbarNotificationsTrigger = document.getElementById('navbar-notifications-trigger');
            const navbarNotificationsBadge = document.getElementById('navbar-notifications-badge');
            const navbarNotificationsIcon = document.querySelector('.navbar-notifications-icon');
            const sidebarNotificationsPanel = document.getElementById('sidebar-notifications-panel');
            const sidebarNotificationsCount = document.getElementById('sidebar-notifications-count');
            const sidebarNotificationsList = document.getElementById('sidebar-notifications-list');
            const sidebarNotificationsEmpty = document.getElementById('sidebar-notifications-empty');
            const sidebarNotificationsRefresh = document.getElementById('sidebar-notifications-refresh');
            const sidebarNotificationsMarkAll = document.getElementById('sidebar-notifications-mark-all');
            const personalizationPanel = document.querySelector('.personalization-panel');
            const viewPills = document.querySelectorAll('.view-buttons .view-pill[data-view]');
            const convertFloatingIconsToMasks = () => {
                document.querySelectorAll('.floating-actions .action-button img[src$=".svg"]').forEach((img) => {
                    const rawSrc = img.getAttribute('src');
                    if (!rawSrc || img.dataset.maskApplied === '1') return;
                    const src = rawSrc
                        .replace('/modulos/templates/icon/', '/templates/icon/')
                        .replace('fastapi_modulo/modulos/templates/icon/', '/templates/icon/');
                    const iconMask = document.createElement('span');
                    iconMask.className = 'action-icon-mask';
                    iconMask.setAttribute('aria-hidden', 'true');
                    iconMask.style.setProperty('--action-icon-url', `url("${src}")`);
                    img.dataset.maskApplied = '1';
                    img.replaceWith(iconMask);
                });
            };
            convertFloatingIconsToMasks();
            const shouldSkipThemedButton = (button) => (
                button.matches(
                    '.navbar-hamburger, .navbar-avatar, .navbar-notifications-btn, .accordion-header, .sidebar-section-toggle, .floating-toggle, .sipet-section-tab, .Pestana, [data-param-tab], [data-cg-tab], .cg-view-toggle, .view-pill, [data-view], .ar-chip, [data-relacion-help], .fp-row, .fp-btn, .fp-icon, [data-scn], .pe-axis__btn, .pe-btn, .table-delete-btn, .delete-activo-fijo-row'
                ) ||
                !!button.closest('.fp-shell, .pe-page, #usuario-view, #sucursales-view, .kpi-page, .axm-shell, #plantillas-page')
            );
            const applyButtonThemeClass = () => {
                document.querySelectorAll('button').forEach((button) => {
                    const forceTheme = button.getAttribute('data-force-button-theme') === '1';
                    if (forceTheme) {
                        button.classList.add('boton-personalizado');
                        return;
                    }
                    if (shouldSkipThemedButton(button)) {
                        button.classList.remove('boton-personalizado');
                        return;
                    }
                    button.classList.add('boton-personalizado');
                });
            };
            applyButtonThemeClass();
            if (document.body) {
                const themedButtonObserver = new MutationObserver(() => {
                    applyButtonThemeClass();
                });
                themedButtonObserver.observe(document.body, { childList: true, subtree: true });
            }
            const currentUserRole = {{ request.state.user_role | default('usuario') | tojson }};
            const currentSessionUser = {{ request.state.user_name | default('') | tojson }};
            const currentTenantId = {{ request.state.tenant_id | default('default') | tojson }};
            const activateViewButton = (view) => {
                if (!viewPills.length || !view) return;
                viewPills.forEach(pill => pill.classList.toggle('active', pill.dataset.view === view));
            };
            viewPills.forEach(pill => pill.addEventListener('click', function() {
                const targetView = pill.dataset.view;
                if (!targetView) return;
                document.dispatchEvent(new CustomEvent('backend-view-change', { detail: { view: targetView } }));
            }));
            const floatingDefaultScreen = floatingActionsWrapper?.dataset.defaultScreen || 'personalization';
            let activeFloatingScreen = floatingDefaultScreen;
            let currentUsuarioView = 'form';
            const setFloatingScreen = (screen) => {
                activeFloatingScreen = screen;
                floatingGroups.forEach(group => {
                    const isActive = group.dataset.floatingScreen === screen;
                    group.classList.toggle('active', isActive);
                    group.style.display = isActive ? 'flex' : 'none';
                });
                if (personalizationPanel) {
                    personalizationPanel.classList.toggle('hidden', screen !== 'personalization');
                }
            };
            setFloatingScreen(activeFloatingScreen);
            const usuariosFloatingGroup = document.querySelector('.floating-actions-group[data-floating-screen="usuarios"]');
            const refreshUsuarioFloating = () => {
                if (!usuariosFloatingGroup) return;
                usuariosFloatingGroup.style.display = activeFloatingScreen === 'usuarios' ? 'flex' : 'none';
            };
            refreshUsuarioFloating();

            const collapsedWidth = '72px';
            const expandedWidth = '220px';
            let isSidebarOpen = true;

            const slugify = (value) => {
                return (value || '')
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            };

            const formatRouteLabel = (mainLabel, subLabel = '') => {
                if (!mainLabel) return '';
                return subLabel ? `${mainLabel}/${subLabel}` : mainLabel;
            };

            const setMenuInfo = (source) => {
                if (!source) return;
                const fromSubmenu = source.matches && source.matches('.sidebar-submenu a');
                const fromSummary = source.matches && source.matches('.sidebar-block > summary');

                let mainLabel = source.dataset.menuName || source.textContent.trim();
                let subLabel = '';

                if (fromSubmenu) {
                    const parentSummary = source.closest('.sidebar-block')?.querySelector('.sidebar-main-label');
                    mainLabel = (parentSummary?.textContent || '').trim() || mainLabel;
                    subLabel = (source.dataset.submenuName || source.textContent || '').trim();
                } else if (fromSummary) {
                    const label = source.querySelector('.sidebar-main-label');
                    mainLabel = (label?.textContent || '').trim() || mainLabel;
                }

                const fallbackRoute = fromSubmenu
                    ? `/${slugify(mainLabel)}/${slugify(subLabel)}`
                    : `/${slugify(mainLabel)}`;
                const explicitHref = source.getAttribute('href');
                const routeHref = explicitHref && explicitHref !== '#'
                    ? explicitHref
                    : (source.dataset.route || fallbackRoute);

                navbarMenuName.textContent = mainLabel || 'Inicio';
                navbarRoute.textContent = formatRouteLabel(mainLabel || 'Inicio', subLabel);
                navbarRoute.href = routeHref || '/';
            };

            const updateRouteVisibility = () => {
                if (!navbarRoute) return;
                navbarRoute.style.display = 'inline-flex';
                navbarRoute.setAttribute('aria-hidden', 'false');
            };

            const setSidebarState = (open) => {
                const width = open ? expandedWidth : collapsedWidth;
                sidebarElem.classList.toggle('is-collapsed', !open);
                navbar.style.marginLeft = width;
                mainContent.style.marginLeft = width;
                mainContent.style.width = open ? `calc(100vw - ${expandedWidth})` : `calc(100vw - ${collapsedWidth})`;
                if (!open) {
                    sidebarBlocks.forEach((item) => {
                        item.removeAttribute('open');
                        item.classList.remove('is-flyout-open');
                    });
                }
                if (hamburger) {
                    hamburger.classList.toggle('is-open', open);
                    hamburger.setAttribute('aria-expanded', open ? 'true' : 'false');
                }
                isSidebarOpen = open;
                updateRouteVisibility();
            };

            const toggleSidebar = () => setSidebarState(!isSidebarOpen);

            if (hamburger) {
                hamburger.addEventListener('click', toggleSidebar);
            }

            sidebarSummaryItems.forEach((summary) => {
                summary.addEventListener('click', (event) => {
                    event.preventDefault();
                    const block = summary.closest('.sidebar-block');
                    if (!block) return;
                    if (!isSidebarOpen) {
                        const shouldOpenFlyout = !block.classList.contains('is-flyout-open');
                        sidebarBlocks.forEach((item) => {
                            item.classList.remove('is-flyout-open');
                            item.removeAttribute('open');
                        });
                        if (shouldOpenFlyout) {
                            block.classList.add('is-flyout-open');
                        }
                        setMenuInfo(summary);
                        return;
                    }
                    const shouldOpen = !block.hasAttribute('open');
                    sidebarBlocks.forEach((item) => {
                        if (item !== block) {
                            item.removeAttribute('open');
                            item.classList.remove('is-flyout-open');
                        }
                    });
                    if (shouldOpen) {
                        block.setAttribute('open', '');
                    } else {
                        block.removeAttribute('open');
                    }
                    setMenuInfo(summary);
                });
            });
            sidebarSubmenuLinks.forEach((link) => {
                link.addEventListener('click', () => {
                    setMenuInfo(link);
                    if (!isSidebarOpen) {
                        sidebarBlocks.forEach((item) => {
                            item.removeAttribute('open');
                            item.classList.remove('is-flyout-open');
                        });
                    }
                });
            });
            document.addEventListener('click', (event) => {
                if (isSidebarOpen) return;
                if (sidebarElem && sidebarElem.contains(event.target)) return;
                sidebarBlocks.forEach((item) => {
                    item.removeAttribute('open');
                    item.classList.remove('is-flyout-open');
                });
            });

            if (personalizarBtn && personalizarSubmenu && personalizarToggle) {
                personalizarBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = personalizarBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    personalizarSubmenu.style.display = isOpen ? 'flex' : 'none';
                    personalizarToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(personalizarBtn);
                    setFloatingScreen('personalization');
                });
            }
            if (inicioBtn && inicioSubmenu && inicioToggle) {
                inicioBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = inicioBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    inicioSubmenu.style.display = isOpen ? 'flex' : 'none';
                    inicioToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(inicioBtn);
                });
                const currentPath = window.location.pathname;
                const inicioLinks = inicioSubmenu.querySelectorAll('a[href]');
                const shouldOpenInicio = Array.from(inicioLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenInicio) {
                    const accordion = inicioBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    inicioSubmenu.style.display = 'flex';
                    inicioToggle.textContent = '−';
                    const activeInicioLink = Array.from(inicioLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeInicioLink) {
                        setMenuInfo(activeInicioLink);
                    }
                } else if (currentPath === '/inicio') {
                    setMenuInfo(inicioBtn);
                }
            }
            if (diagnosticoBtn && diagnosticoSubmenu && diagnosticoToggle) {
                diagnosticoBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = diagnosticoBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    diagnosticoSubmenu.style.display = isOpen ? 'flex' : 'none';
                    diagnosticoToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(diagnosticoBtn);
                });
                const currentPath = window.location.pathname;
                const diagnosticoLinks = diagnosticoSubmenu.querySelectorAll('a[href]');
                const shouldOpenDiagnostico = Array.from(diagnosticoLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenDiagnostico) {
                    const accordion = diagnosticoBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    diagnosticoSubmenu.style.display = 'flex';
                    diagnosticoToggle.textContent = '−';
                    const activeDiagnosticoLink = Array.from(diagnosticoLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeDiagnosticoLink) {
                        setMenuInfo(activeDiagnosticoLink);
                    }
                }
            }
            if (planificacionBtn && planificacionSubmenu && planificacionToggle) {
                planificacionBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = planificacionBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    planificacionSubmenu.style.display = isOpen ? 'flex' : 'none';
                    planificacionToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(planificacionBtn);
                });
                const currentPath = window.location.pathname;
                const planificacionLinks = planificacionSubmenu.querySelectorAll('a[href]');
                const shouldOpenPlanificacion = Array.from(planificacionLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenPlanificacion) {
                    const accordion = planificacionBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    planificacionSubmenu.style.display = 'flex';
                    planificacionToggle.textContent = '−';
                    const activePlanificacionLink = Array.from(planificacionLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activePlanificacionLink) {
                        setMenuInfo(activePlanificacionLink);
                    }
                }
            }
            if (proyectandoBtn && proyectandoSubmenu && proyectandoToggle) {
                proyectandoBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = proyectandoBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    proyectandoSubmenu.style.display = isOpen ? 'flex' : 'none';
                    proyectandoToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(proyectandoBtn);
                });
                const currentPath = window.location.pathname;
                const proyectandoLinks = proyectandoSubmenu.querySelectorAll('a[href]');
                const shouldOpenProyectando = Array.from(proyectandoLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenProyectando) {
                    const accordion = proyectandoBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    proyectandoSubmenu.style.display = 'flex';
                    proyectandoToggle.textContent = '−';
                    const activeProyectandoLink = Array.from(proyectandoLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeProyectandoLink) {
                        setMenuInfo(activeProyectandoLink);
                    }
                }
            }
            if (reportesBtn && reportesSubmenu && reportesToggle) {
                reportesBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const accordion = reportesBtn.closest('.accordion');
                    const isOpen = accordion.classList.toggle('open');
                    reportesSubmenu.style.display = isOpen ? 'flex' : 'none';
                    reportesToggle.textContent = isOpen ? '−' : '+';
                    setMenuInfo(reportesBtn);
                    setFloatingScreen('reportes');
                });
                const currentPath = window.location.pathname;
                const reportesLinks = reportesSubmenu.querySelectorAll('a[href]');
                const shouldOpenReportes = Array.from(reportesLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenReportes) {
                    const accordion = reportesBtn.closest('.accordion');
                    accordion && accordion.classList.add('open');
                    reportesSubmenu.style.display = 'flex';
                    reportesToggle.textContent = '−';
                    const activeReportesLink = Array.from(reportesLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeReportesLink) {
                        setMenuInfo(activeReportesLink);
                    }
                }
            }

            // Eliminado: los links ahora navegan normalmente

            const normalizeRoutePath = (value) => {
                const raw = String(value || '').split('?')[0].split('#')[0].trim();
                if (!raw) return '/';
                const normalized = raw.replace(/\/+$/, '');
                return normalized || '/';
            };
            const currentSidebarPath = normalizeRoutePath(window.location.pathname);
            const activeSidebarLink = Array.from(sidebarSubmenuLinks).find((link) => {
                const href = normalizeRoutePath(link.getAttribute('href'));
                if (href === currentSidebarPath) return true;
                return href !== '/' && currentSidebarPath.startsWith(`${href}/`);
            });
            if (activeSidebarLink) {
                const block = activeSidebarLink.closest('.sidebar-block');
                if (block) block.open = true;
                setMenuInfo(activeSidebarLink);
            } else if (sidebarSummaryItems.length) {
                setMenuInfo(sidebarSummaryItems[0]);
            } else if (menuLinks.length) {
                setMenuInfo(menuLinks[0]);
            }
            setSidebarState(true);
            setFloatingScreen(floatingDefaultScreen);
            if (identityForm) {
                const editButtons = document.querySelectorAll('.identity-asset-edit[data-target-input]');
                const deleteButtons = document.querySelectorAll('.identity-asset-delete[data-target-remove]');
                editButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const target = btn.getAttribute('data-target-input');
                        if (!target) return;
                        const input = document.getElementById(target);
                        const removeFlagId = target === 'favicon'
                            ? 'remove_favicon'
                            : target === 'logo_empresa'
                            ? 'remove_logo'
                            : target === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : target === 'fondo_movil'
                                    ? 'remove_mobile'
                                    : '';
                        if (removeFlagId) {
                            const removeFlag = document.getElementById(removeFlagId);
                            if (removeFlag) removeFlag.value = '0';
                        }
                        if (input) input.click();
                    });
                });
                deleteButtons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const targetRemove = btn.getAttribute('data-target-remove');
                        if (!targetRemove) return;
                        const flag = document.getElementById(targetRemove);
                        if (flag) flag.value = '1';
                        showMessage('Imagen marcada para eliminar. Guarda para aplicar.', 'success');
                    });
                });
                ['favicon', 'logo_empresa', 'fondo_escritorio', 'fondo_movil'].forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    input.addEventListener('change', () => {
                        if (!input.files || !input.files.length) return;
                        const removeFlagId = id === 'favicon'
                            ? 'remove_favicon'
                            : id === 'logo_empresa'
                            ? 'remove_logo'
                            : id === 'fondo_escritorio'
                                ? 'remove_desktop'
                                : 'remove_mobile';
                        const removeFlag = document.getElementById(removeFlagId);
                        if (removeFlag) removeFlag.value = '0';
                        if (identityForm && typeof identityForm.requestSubmit === 'function') {
                            showMessage('Subiendo imagen seleccionada...', 'success');
                            identityForm.requestSubmit();
                        } else if (identityForm) {
                            identityForm.submit();
                        }
                    });
                });
            }
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            document.body.appendChild(messageBox);
            let hideTimeout;
            const showMessage = (msg, type = 'success') => {
                messageBox.textContent = msg;
                messageBox.classList.add('visible');
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    messageBox.classList.remove('visible');
                }, 2200);
            };
            const normalizeSidebarMenuIcons = () => {
                const sidebarMenuImages = document.querySelectorAll('.sidebar nav .menu-icon img');
                sidebarMenuImages.forEach((img) => {
                    if (img.dataset.maskReady === '1') return;
                    const src = img.getAttribute('src');
                    if (!src) return;
                    const maskEl = document.createElement('span');
                    maskEl.className = 'menu-icon-mask';
                    maskEl.style.setProperty('--icon-mask-url', `url("${src}")`);
                    maskEl.setAttribute('aria-hidden', 'true');
                    img.style.display = 'none';
                    img.dataset.maskReady = '1';
                    img.parentElement && img.parentElement.appendChild(maskEl);
                });
            };
            normalizeSidebarMenuIcons();
            const syncNavbarNotificationIconColor = (color) => {
                const fromNavbar = navbar ? getComputedStyle(navbar).color : '';
                const fromVar = getComputedStyle(document.documentElement).getPropertyValue('--navbar-text');
                const value = (color || '').trim() || (fromNavbar || '').trim() || (fromVar || '').trim() || '#1f2933';
                document.documentElement.style.setProperty('--navbar-notifications-icon-color', value);
                if (navbarNotificationsIcon) {
                    navbarNotificationsIcon.style.background = value;
                }
            };
            const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (char) => (
                { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char] || char
            ));
            const formatNotificationDate = (value) => {
                if (!value) return '';
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return '';
                return parsed.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                });
            };
            const renderNotifications = (payload) => {
                if (!sidebarNotificationsList || !sidebarNotificationsCount || !sidebarNotificationsEmpty) return;
                const total = Number(payload?.total || 0);
                const unread = Number(payload?.unread || 0);
                const items = Array.isArray(payload?.items) ? payload.items : [];
                if (sidebarNotificationsBadge) {
                    sidebarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    sidebarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                if (navbarNotificationsBadge) {
                    navbarNotificationsBadge.textContent = unread > 99 ? '99+' : String(unread);
                    navbarNotificationsBadge.classList.toggle('visible', unread > 0);
                }
                sidebarNotificationsCount.textContent = unread > 0 ? `${unread} pendiente${unread === 1 ? '' : 's'}` : 'Sin pendientes';
                if (!items.length) {
                    sidebarNotificationsList.innerHTML = '';
                    sidebarNotificationsEmpty.style.display = 'block';
                    return;
                }
                sidebarNotificationsEmpty.style.display = 'none';
                sidebarNotificationsList.innerHTML = items.map((item) => {
                    const href = item.href || '#';
                    const itemClass = item.read ? 'notification-item read' : 'notification-item';
                    const notificationId = escapeHtml(item.id || '');
                    return `
                        <li>
                            <a class="${itemClass}" href="${escapeHtml(href)}" data-notification-id="${notificationId}">
                                <div class="notification-item-title">${escapeHtml(item.title || 'Notificación')}</div>
                                <div class="notification-item-msg">${escapeHtml(item.message || '')}</div>
                                <div class="notification-item-date">${escapeHtml(formatNotificationDate(item.created_at))}</div>
                            </a>
                        </li>
                    `;
                }).join('');
            };
            const markNotificationRead = async (notificationId) => {
                if (!notificationId) return;
                await fetch('/api/notificaciones/marcar-leida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: notificationId }),
                });
            };
            const markAllNotificationsRead = async (notificationIds) => {
                if (!Array.isArray(notificationIds) || !notificationIds.length) return;
                await fetch('/api/notificaciones/marcar-todas-leidas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: notificationIds }),
                });
            };
            const loadNotifications = async (silent = true) => {
                if (!sidebarNotificationsList) return;
                try {
                    const res = await fetch('/api/notificaciones/resumen', { headers: { 'Accept': 'application/json' } });
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) {
                        throw new Error(payload?.error || 'No se pudieron cargar las notificaciones');
                    }
                    renderNotifications(payload);
                } catch (error) {
                    if (!silent) {
                        showMessage(error.message || 'No se pudieron cargar las notificaciones', 'error');
                    }
                }
            };
            let guardarColores = () => {};
            let guardarAssets = () => Promise.resolve();
            let restablecerAssets = () => Promise.resolve();
            let restablecerColores = () => {};
            if (personalizationPanel) {
                const colorInputs = [
                    'navbar-bg','navbar-text','sidebar-top','sidebar-bottom','sidebar-text',
                    'field-color',
                    'button-bg','button-text',
                    'sidebar-icon','sidebar-hover'
                ];
                const colorDefaults = {};
                const assetsForm = document.getElementById('personalizar-assets-form');
                const assetConfig = {
                    favicon: { filenameId: 'asset-filename-favicon', linkId: 'asset-link-favicon', thumbId: 'asset-thumb-favicon' },
                    logo_empresa: { filenameId: 'asset-filename-logo-empresa', linkId: 'asset-link-logo-empresa', thumbId: 'asset-thumb-logo-empresa' },
                    logo_usuario: { filenameId: 'asset-filename-logo-usuario', linkId: 'asset-link-logo-usuario', thumbId: 'asset-thumb-logo-usuario' },
                    svg_fondo: { filenameId: 'asset-filename-svg-fondo', linkId: 'asset-link-svg-fondo', thumbId: 'asset-thumb-svg-fondo' },
                    svg_defecto: { filenameId: 'asset-filename-svg-defecto', linkId: 'asset-link-svg-defecto', thumbId: 'asset-thumb-svg-defecto' }
                };
                const defaultAssetThumb = '/templates/icon/placeholder.svg';
                const setLiveFavicon = (url) => {
                    document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]').forEach((linkEl) => {
                        if (url) {
                            linkEl.setAttribute('href', url);
                        }
                    });
                };
                const applyLiveAssetUrl = (field, url) => {
                    const safeUrl = String(url || '').trim();
                    if (!safeUrl) return;
                    if (field === 'logo_empresa' && sidebarUserImg instanceof HTMLImageElement) {
                        const currentDefault = String(sidebarUserImg.dataset.default || '').trim();
                        if (currentDefault.includes('/personalizar/uploads/')) {
                            sidebarUserImg.src = safeUrl;
                            sidebarUserImg.dataset.default = safeUrl;
                        }
                    }
                    if (field === 'logo_usuario' && navbarAvatarImgEl instanceof HTMLImageElement) {
                        navbarAvatarImgEl.src = safeUrl;
                    }
                    if (field === 'favicon') {
                        setLiveFavicon(safeUrl);
                    }
                };
                const updatePreview = (id, value) => {
                    const preview = document.getElementById(id + '-preview');
                    if (preview) preview.style.background = value;
                };
                const normalizeHex = (hex) => {
                    const cleaned = (hex || '').trim().replace('#', '');
                    if (cleaned.length === 3) {
                        return cleaned.split('').map(char => char + char).join('');
                    }
                    return cleaned;
                };
                const hexToRgba = (hex, alpha = 1) => {
                    const normalized = normalizeHex(hex);
                    if (!/^[0-9A-Fa-f]{6}$/.test(normalized)) return hex;
                    const r = parseInt(normalized.slice(0, 2), 16);
                    const g = parseInt(normalized.slice(2, 4), 16);
                    const b = parseInt(normalized.slice(4, 6), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                function applyColors() {
                    const navbar = document.querySelector('.navbar');
                    const navbarBg = document.getElementById('navbar-bg');
                    const navbarText = document.getElementById('navbar-text');
                    const sidebarTop = document.getElementById('sidebar-top');
                    const sidebarBottom = document.getElementById('sidebar-bottom');
                    const sidebarText = document.getElementById('sidebar-text');
                    const fieldColor = document.getElementById('field-color');
                    const buttonBg = document.getElementById('button-bg');
                    const buttonText = document.getElementById('button-text');
                    const sidebarIcon = document.getElementById('sidebar-icon');
                    const sidebarHover = document.getElementById('sidebar-hover');
                    if (navbarBg && navbar) {
                        navbar.style.background = navbarBg.value;
                    }
                    if (navbarText && navbar) {
                        navbar.style.color = navbarText.value;
                        const hamburger = document.querySelector('.navbar-hamburger');
                        if (hamburger) {
                            hamburger.style.color = navbarText.value;
                        }
                        syncNavbarNotificationIconColor(navbarText.value);
                    } else {
                        syncNavbarNotificationIconColor(getComputedStyle(document.documentElement).getPropertyValue('--navbar-text'));
                    }
                    if (sidebarTop && sidebarElem) {
                        if (sidebarBottom && sidebarBottom.value) {
                            sidebarElem.style.background = `linear-gradient(180deg, ${sidebarTop.value} 0%, ${sidebarBottom.value} 100%)`;
                        } else {
                            sidebarElem.style.background = sidebarTop.value;
                        }
                    }
                    if (sidebarText && sidebarElem) {
                        sidebarElem.style.color = sidebarText.value;
                        document.documentElement.style.setProperty('--sidebar-text', sidebarText.value);
                    }
                    if (sidebarIcon) {
                        document.documentElement.style.setProperty('--sidebar-icon', sidebarIcon.value);
                        document.querySelectorAll('.menu-icon svg path').forEach(path => {
                            path.setAttribute('stroke', sidebarIcon.value);
                        });
                    }
                    if (sidebarHover) {
                        document.documentElement.style.setProperty('--sidebar-hover', sidebarHover.value);
                    }
                    if (fieldColor) {
                        document.documentElement.style.setProperty('--field-color', fieldColor.value);
                    }
                    if (buttonBg) {
                        document.documentElement.style.setProperty('--button-bg', buttonBg.value);
                    }
                    if (buttonText) {
                        document.documentElement.style.setProperty('--button-text', buttonText.value);
                    }
                    const rootStyles = getComputedStyle(document.documentElement);
                    const rootBottomColor = (rootStyles.getPropertyValue('--sidebar-bottom') || '').trim();
                    const rootTextColor = (rootStyles.getPropertyValue('--sidebar-text') || '').trim();
                    const bottomColor = (sidebarBottom && sidebarBottom.value) || rootBottomColor || '#0f172a';
                    const textColor = (sidebarText && sidebarText.value) || rootTextColor || '#ffffff';
                    document.documentElement.style.setProperty('--page-title-color', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-border', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-bg', textColor);
                    document.documentElement.style.setProperty('--view-pill-text', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-icon', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-bg', bottomColor);
                    document.documentElement.style.setProperty('--view-pill-hover-text', textColor);
                    document.documentElement.style.setProperty('--view-pill-hover-icon', textColor);
                    if (floatingActions) {
                        floatingActions.style.background = textColor;
                        floatingActions.style.borderColor = bottomColor;
                        floatingActions.style.setProperty('--floating-panel-bg', textColor);
                        floatingActions.style.setProperty('--floating-icon-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-color', bottomColor);
                        floatingActions.style.setProperty('--floating-toggle-text-color', textColor);
                        floatingActions.style.setProperty('--floating-action-border', bottomColor);
                        floatingActions.style.setProperty('--floating-action-text', bottomColor);
                        floatingActions.style.setProperty('--floating-action-bg', textColor);
                        floatingActions.style.color = bottomColor;
                    }
                    if (floatingToggle) {
                        floatingToggle.style.borderColor = bottomColor;
                        floatingToggle.style.background = bottomColor;
                        floatingToggle.style.color = textColor;
                    }
                }
                colorInputs.forEach((id) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    colorDefaults[id] = input.value;
                    input.dataset.default = input.value;
                    updatePreview(id, input.value);
                    input.addEventListener('input', function() {
                        updatePreview(id, input.value);
                        applyColors();
                    });
                });
                async function cargarColoresGuardados() {
                    try {
                        const res = await fetch('/guardar-colores', { method: 'GET' });
                        if (!res.ok) return;
                        const json = await res.json();
                        if (json && json.success && json.data) {
                            colorInputs.forEach(function(id) {
                                if (json.data[id]) {
                                    const input = document.getElementById(id);
                                    if (input) {
                                        input.value = json.data[id];
                                        updatePreview(id, input.value);
                                    }
                                }
                            });
                            applyColors();
                        }
                    } catch (e) {
                        // Ignorar errores de carga
                    }
                }
                const applyAssetState = (assets = {}) => {
                    Object.entries(assetConfig).forEach(([field, refs]) => {
                        const filenameEl = document.getElementById(refs.filenameId);
                        const linkEl = document.getElementById(refs.linkId);
                        const thumbEl = document.getElementById(refs.thumbId);
                        const info = assets[field] || {};
                        const filename = String(info.filename || '').trim();
                        const url = String(info.url || '').trim();
                        if (filenameEl) {
                            filenameEl.textContent = filename || 'Sin archivo';
                        }
                        if (linkEl) {
                            if (url) {
                                linkEl.href = url;
                                linkEl.hidden = false;
                            } else {
                                linkEl.hidden = true;
                                linkEl.removeAttribute('href');
                            }
                        }
                        if (thumbEl instanceof HTMLImageElement) {
                            thumbEl.src = url || defaultAssetThumb;
                        }
                        if (url) {
                            applyLiveAssetUrl(field, url);
                        }
                    });
                };
                const cargarEstadoAssets = async () => {
                    if (!assetsForm) return;
                    try {
                        const res = await fetch('/personalizar/estado', { headers: { Accept: 'application/json' } });
                        if (!res.ok) return;
                        const json = await res.json();
                        if (json && json.ok) {
                            applyAssetState(json.assets || {});
                        }
                    } catch (e) {
                        // Ignorar errores de carga
                    }
                };
                await cargarColoresGuardados();
                applyColors();
                await cargarEstadoAssets();
                if (assetsForm) {
                    const resetRemoveFlags = () => {
                        assetsForm.querySelectorAll('input[type="hidden"][name^="remove_"]').forEach((flag) => {
                            flag.value = '0';
                        });
                    };
                    const hasAssetChanges = () => {
                        const hasRemoved = Array.from(
                            assetsForm.querySelectorAll('input[type="hidden"][name^="remove_"]')
                        ).some((flag) => String(flag.value || '0').trim() === '1');
                        const hasFiles = Array.from(
                            assetsForm.querySelectorAll('input[type="file"]')
                        ).some((input) => input.files && input.files.length > 0);
                        return hasRemoved || hasFiles;
                    };
                    const clearFileInputs = () => {
                        assetsForm.querySelectorAll('input[type="file"]').forEach((input) => {
                            input.value = '';
                        });
                    };
                    const editButtons = assetsForm.querySelectorAll('.asset-edit-btn[data-target-input][data-target-remove]');
                    const deleteButtons = assetsForm.querySelectorAll('.asset-delete-btn[data-target-remove][data-asset]');
                    editButtons.forEach((btn) => {
                        btn.addEventListener('click', (event) => {
                            event.preventDefault();
                            const inputId = btn.getAttribute('data-target-input');
                            const removeId = btn.getAttribute('data-target-remove');
                            const input = inputId ? document.getElementById(inputId) : null;
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (removeFlag) removeFlag.value = '0';
                            if (input) {
                                try {
                                    if (typeof input.showPicker === 'function') {
                                        input.showPicker();
                                    } else {
                                        input.click();
                                    }
                                } catch (e) {
                                    input.click();
                                }
                            }
                        });
                    });
                    deleteButtons.forEach((btn) => {
                        btn.addEventListener('click', async (event) => {
                            event.preventDefault();
                            const assetName = btn.getAttribute('data-asset') || 'archivo';
                            const removeId = btn.getAttribute('data-target-remove');
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (!removeFlag) return;
                            const ok = window.confirm(`¿Eliminar ${assetName.replace('_', ' ')}?`);
                            if (!ok) return;
                            removeFlag.value = '1';
                            await guardarAssets();
                        });
                    });
                    assetsForm.querySelectorAll('input[type="file"]').forEach((input) => {
                        input.addEventListener('change', async () => {
                            if (!input.files || !input.files.length) return;
                            const removeId = input.getAttribute('data-target-remove');
                            const removeFlag = removeId ? document.getElementById(removeId) : null;
                            if (removeFlag) removeFlag.value = '0';
                            const field = (input.getAttribute('name') || '').trim();
                            const refs = field ? assetConfig[field] : null;
                            const file = input.files[0];
                            if (refs && file) {
                                const filenameEl = document.getElementById(refs.filenameId);
                                const linkEl = document.getElementById(refs.linkId);
                                const thumbEl = document.getElementById(refs.thumbId);
                                if (filenameEl) filenameEl.textContent = file.name;
                                if (linkEl) {
                                    linkEl.hidden = true;
                                    linkEl.removeAttribute('href');
                                }
                                if (thumbEl instanceof HTMLImageElement && file.type && file.type.startsWith('image/')) {
                                    try {
                                        const tempUrl = URL.createObjectURL(file);
                                        thumbEl.src = tempUrl;
                                        applyLiveAssetUrl(field, tempUrl);
                                    } catch (e) {
                                        // Ignorar errores de vista previa local.
                                    }
                                }
                            }
                            await guardarAssets();
                        });
                    });
                    guardarAssets = async function() {
                        if (!hasAssetChanges()) return;
                        const data = new FormData(assetsForm);
                        try {
                            const res = await fetch('/personalizar/guardar', { method: 'POST', body: data });
                            const json = await res.json();
                            if (!res.ok || !json?.ok) {
                                throw new Error(json?.error || 'No se pudieron guardar las imagenes');
                            }
                            applyAssetState(json.assets || {});
                            resetRemoveFlags();
                            clearFileInputs();
                            showMessage('Imagenes actualizadas correctamente.', 'success');
                        } catch (error) {
                            showMessage(error.message || 'Error al guardar imagenes.', 'error');
                        }
                    };
                    restablecerAssets = async function() {
                        try {
                            const res = await fetch('/personalizar/restablecer-assets', { method: 'POST' });
                            const json = await res.json();
                            if (!res.ok || !json?.ok) {
                                throw new Error(json?.error || 'No se pudieron restablecer las imagenes');
                            }
                            applyAssetState(json.assets || {});
                            resetRemoveFlags();
                            clearFileInputs();
                            showMessage('Imagenes restablecidas.', 'success');
                        } catch (error) {
                            showMessage(error.message || 'Error al restablecer imagenes.', 'error');
                        }
                    };
                }
                guardarColores = function() {
                    const data = {};
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (input) data[id] = input.value;
                    });
                    return fetch('/guardar-colores', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async res => {
                        if (!res.ok) {
                            const text = await res.text();
                            console.error('Error backend:', text);
                            throw new Error(text);
                        }
                        return res.json();
                    })
                    .then(json => {
                        if (json && json.success) {
                            showMessage('Colores guardados exitosamente.', 'success');
                        } else {
                            showMessage('Error al guardar los colores: ' + (json && json.error ? json.error : ''), 'error');
                            console.error('Respuesta backend:', json);
                        }
                    })
                    .catch(err => {
                        showMessage('Error al guardar los colores.', 'error');
                        console.error('Error fetch:', err);
                    });
                };
                restablecerColores = function() {
                    colorInputs.forEach(function(id) {
                        const input = document.getElementById(id);
                        if (!input) return;
                        input.value = colorDefaults[id] || input.defaultValue;
                        updatePreview(id, input.value);
                    });
                    applyColors();
                    showMessage('Colores restablecidos.', 'success');
                };
            }
            let actionsVisible = true;
            const updateToggle = () => {
                if (!floatingToggle || !floatingActions) return;
            floatingToggle.textContent = actionsVisible ? '−' : '+';
            floatingToggle.setAttribute('aria-label', actionsVisible ? 'Ocultar barra flotante' : 'Mostrar barra flotante');
            floatingActions.classList.toggle('hidden', !actionsVisible);
        };
            const ensureFloatingVisible = () => {
                actionsVisible = true;
                updateToggle();
            };
            floatingToggle && floatingToggle.addEventListener('click', () => {
                actionsVisible = !actionsVisible;
                updateToggle();
            });
            updateToggle();
            const usuarioView = document.getElementById('usuario-view');
            const usuarioTabs = document.querySelectorAll('.usuario-tab');
            const usuarioLinks = document.querySelectorAll('.usuario-view-link');
            const plantillasPage = document.getElementById('plantillas-page');
            const templateNameInput = document.getElementById('template-name');
            const templateHtmlInput = document.getElementById('template-html');
            const templateCssInput = document.getElementById('template-css');
            const templateNewBtn = document.getElementById('template-new-btn');
            const templateEditBtn = document.getElementById('template-edit-btn');
            const templateBuilderBtn = document.getElementById('template-builder-btn');
            const templatePreviewBtn = document.getElementById('template-preview-btn');
            const templateSaveBtn = document.getElementById('template-save-btn');
            const templateDeleteBtn = document.getElementById('template-delete-btn');
            const templatePreviewFrame = document.getElementById('template-preview');
            const builderBackToTemplates = document.getElementById('builder-back-to-templates');
            const plantillasList = document.getElementById('plantillas-list');
            const formBuilderPanel = document.getElementById('form-builder-panel');
            const builderFormSelect = document.getElementById('builder-form-select');
            const builderFormName = document.getElementById('builder-form-name');
            const builderFormSlug = document.getElementById('builder-form-slug');
            const builderFormActive = document.getElementById('builder-form-active');
            const builderFormTenant = document.getElementById('builder-form-tenant');
            const builderFormRoles = document.getElementById('builder-form-roles');
            const builderFormDescription = document.getElementById('builder-form-description');
            const builderFormConfig = document.getElementById('builder-form-config');
            const builderFieldType = document.getElementById('builder-field-type');
            const builderFieldLabel = document.getElementById('builder-field-label');
            const builderFieldName = document.getElementById('builder-field-name');
            const builderFieldPlaceholder = document.getElementById('builder-field-placeholder');
            const builderFieldHelp = document.getElementById('builder-field-help');
            const builderFieldOptions = document.getElementById('builder-field-options');
            const builderFieldConditional = document.getElementById('builder-field-conditional');
            const builderFieldRequired = document.getElementById('builder-field-required');
            const builderAddFieldBtn = document.getElementById('builder-add-field-btn');
            const builderClearFormBtn = document.getElementById('builder-clear-form-btn');
            const builderSaveFormBtn = document.getElementById('builder-save-form-btn');
            const builderDeleteFormBtn = document.getElementById('builder-delete-form-btn');
            const builderFieldsList = document.getElementById('builder-fields-list');
            let plantillasStore = [];
            let selectedTemplateId = null;
            let formDefinitionsStore = [];
            let selectedFormDefinitionId = null;
            let builderFields = [];
            let builderRoleOptions = [];
            function slugifyText(value) {
                return (value || '')
                    .toString()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
            const normalizeRoleValue = (value) => (value || '').toString().trim().toLowerCase();
            const getBuilderSelectedRoles = () => {
                if (!builderFormRoles) return [];
                return Array.from(builderFormRoles.selectedOptions || [])
                    .map((opt) => normalizeRoleValue(opt.value))
                    .filter(Boolean);
            };
            const renderBuilderRoleOptions = (selected = []) => {
                if (!builderFormRoles) return;
                const selectedSet = new Set((Array.isArray(selected) ? selected : []).map((item) => normalizeRoleValue(item)));
                builderFormRoles.innerHTML = builderRoleOptions.map((role) => (
                    `<option value="${role.value}" ${selectedSet.has(role.value) ? 'selected' : ''}>${role.label}</option>`
                )).join('');
            };
            const renderBuilderFields = () => {
                if (!builderFieldsList) return;
                if (!builderFields.length) {
                    builderFieldsList.innerHTML = '<p class="plantillas-hint">No hay campos agregados.</p>';
                    return;
                }
                builderFieldsList.innerHTML = builderFields.map((field, index) => `
                    <div class="builder-field-item">
                        <div class="meta">
                            <strong>${field.label || field.name}</strong>
                            <span>Tipo: ${field.field_type} | Nombre: ${field.name}</span>
                            <span>${field.is_required ? 'Obligatorio' : 'Opcional'}${field.options?.length ? ` | Opciones: ${field.options.map((opt) => opt.label || opt.value).join(', ')}` : ''}${field.conditional_logic && Object.keys(field.conditional_logic).length ? ' | Condicional' : ''}</span>
                        </div>
                        <button type="button" class="builder-field-delete" data-builder-remove-field="${index}">Quitar</button>
                    </div>
                `).join('');
                builderFieldsList.querySelectorAll('[data-builder-remove-field]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const index = Number(btn.dataset.builderRemoveField);
                        if (Number.isNaN(index)) return;
                        builderFields = builderFields.filter((_, i) => i !== index);
                        renderBuilderFields();
                    });
                });
            };
            const clearBuilderFieldInputs = () => {
                if (builderFieldType) builderFieldType.value = 'text';
                if (builderFieldLabel) builderFieldLabel.value = '';
                if (builderFieldName) builderFieldName.value = '';
                if (builderFieldPlaceholder) builderFieldPlaceholder.value = '';
                if (builderFieldHelp) builderFieldHelp.value = '';
                if (builderFieldOptions) builderFieldOptions.value = '';
                if (builderFieldConditional) builderFieldConditional.value = '';
                if (builderFieldRequired) builderFieldRequired.checked = false;
            };
            const clearBuilderForm = () => {
                selectedFormDefinitionId = null;
                builderFields = [];
                if (builderFormSelect) builderFormSelect.value = '';
                if (builderFormName) builderFormName.value = '';
                if (builderFormSlug) builderFormSlug.value = '';
                if (builderFormActive) builderFormActive.value = 'true';
                if (builderFormTenant) builderFormTenant.value = currentTenantId || 'default';
                renderBuilderRoleOptions([]);
                if (builderFormDescription) builderFormDescription.value = '';
                if (builderFormConfig) builderFormConfig.value = '';
                clearBuilderFieldInputs();
                renderBuilderFields();
            };
            const setBuilderFromForm = (formDef) => {
                if (!formDef) return;
                selectedFormDefinitionId = formDef.id;
                if (builderFormSelect) builderFormSelect.value = String(formDef.id);
                if (builderFormName) builderFormName.value = formDef.name || '';
                if (builderFormSlug) builderFormSlug.value = formDef.slug || '';
                if (builderFormActive) builderFormActive.value = formDef.is_active ? 'true' : 'false';
                if (builderFormTenant) builderFormTenant.value = (formDef.tenant_id || currentTenantId || 'default');
                renderBuilderRoleOptions(Array.isArray(formDef.allowed_roles) ? formDef.allowed_roles : []);
                if (builderFormDescription) builderFormDescription.value = formDef.description || '';
                if (builderFormConfig) {
                    const cfg = formDef.config && typeof formDef.config === 'object' ? formDef.config : {};
                    builderFormConfig.value = Object.keys(cfg).length ? JSON.stringify(cfg) : '';
                }
                const fields = Array.isArray(formDef.fields) ? formDef.fields : [];
                builderFields = fields.map((field, index) => ({
                    field_type: field.field_type || field.type || 'text',
                    label: field.label || '',
                    name: field.name || `campo_${index + 1}`,
                    placeholder: field.placeholder || '',
                    help_text: field.help_text || field.helpText || '',
                    default_value: field.default_value || field.defaultValue || '',
                    is_required: Boolean(field.is_required ?? field.required),
                    validation_rules: field.validation_rules || field.validation || {},
                    options: Array.isArray(field.options)
                        ? field.options.map((opt) => {
                            if (typeof opt === 'object' && opt !== null) {
                                return { label: String(opt.label || opt.value || ''), value: String(opt.value || opt.label || '') };
                            }
                            const value = String(opt || '');
                            return { label: value, value };
                        }).filter((opt) => opt.value)
                        : [],
                    order: Number(field.order ?? index),
                    conditional_logic: field.conditional_logic || field.conditional || {},
                }));
                renderBuilderFields();
            };
            const renderBuilderFormSelect = () => {
                if (!builderFormSelect) return;
                builderFormSelect.innerHTML = `<option value="">Nuevo formulario</option>${formDefinitionsStore.map((formDef) => (
                    `<option value="${formDef.id}" ${Number(formDef.id) === Number(selectedFormDefinitionId) ? 'selected' : ''}>${formDef.name} (${formDef.slug})</option>`
                )).join('')}`;
            };
            const loadFormDefinitions = async () => {
                if (!formBuilderPanel) return;
                try {
                    const res = await fetch('/api/admin/forms');
                    const json = await res.json();
                    if (!res.ok) throw new Error(json?.detail || 'No se pudo cargar formularios');
                    formDefinitionsStore = Array.isArray(json) ? json : [];
                    renderBuilderFormSelect();
                    if (selectedFormDefinitionId) {
                        const match = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                        if (match) setBuilderFromForm(match);
                    }
                } catch (error) {
                    showMessage('No se pudieron cargar los formularios.', 'error');
                }
            };
            const loadBuilderRoleOptions = async () => {
                if (!formBuilderPanel) return;
                builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                try {
                    const res = await fetch('/api/roles-disponibles');
                    const payload = await res.json();
                    if (!res.ok || !payload?.success) throw new Error(payload?.error || 'No se pudieron cargar roles');
                    const items = Array.isArray(payload?.data) ? payload.data : [];
                    builderRoleOptions = items.map((role) => {
                        const value = normalizeRoleValue(role?.nombre || role?.value || '');
                        const label = String(role?.label || role?.nombre || value || '').trim();
                        return { value, label };
                    }).filter((role) => role.value);
                    if (!builderRoleOptions.length) {
                        builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                    }
                } catch (error) {
                    builderRoleOptions = [{ value: normalizeRoleValue(currentUserRole || 'usuario'), label: String(currentUserRole || 'Usuario') }];
                }
                renderBuilderRoleOptions(getBuilderSelectedRoles());
            };
            const collectBuilderPayload = () => {
                const name = (builderFormName?.value || '').trim();
                const slug = (builderFormSlug?.value || '').trim();
                const description = (builderFormDescription?.value || '').trim();
                const tenantId = (builderFormTenant?.value || currentTenantId || 'default').trim();
                const rawConfig = (builderFormConfig?.value || '').trim();
                if (!name) {
                    throw new Error('El nombre del formulario es obligatorio.');
                }
                if (!builderFields.length) {
                    throw new Error('Agrega al menos un campo al formulario.');
                }
                let config = {};
                if (rawConfig) {
                    try {
                        const parsed = JSON.parse(rawConfig);
                        if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                            throw new Error();
                        }
                        config = parsed;
                    } catch (error) {
                        throw new Error('La configuración JSON del formulario es inválida.');
                    }
                }
                return {
                    name,
                    slug: slug || slugifyText(name),
                    tenant_id: tenantId || 'default',
                    description: description || null,
                    is_active: (builderFormActive?.value || 'true') === 'true',
                    config,
                    allowed_roles: getBuilderSelectedRoles(),
                    fields: builderFields.map((field, index) => ({
                        ...field,
                        order: index,
                    })),
                };
            };
            const renderTemplatePreview = () => {
                if (!templatePreviewFrame) return;
                let htmlCode = templateHtmlInput?.value || '';
                const cssCode = templateCssInput?.value || '';
                if (!htmlCode.trim() && !cssCode.trim()) {
                    htmlCode = "<section style='padding:16px;font-family:Arial,sans-serif;color:#475569;'>Agrega HTML/CSS o selecciona una plantilla para previsualizar.</section>";
                }
                const previewDoc = `<!doctype html><html><head><meta charset="UTF-8"><style>${cssCode}</style></head><body>${htmlCode}</body></html>`;
                templatePreviewFrame.srcdoc = previewDoc;
                try {
                    const frameDoc = templatePreviewFrame.contentDocument || templatePreviewFrame.contentWindow?.document;
                    if (frameDoc) {
                        frameDoc.open();
                        frameDoc.write(previewDoc);
                        frameDoc.close();
                    }
                } catch (error) {
                    // srcdoc remains as fallback if direct write is blocked by browser policy.
                }
            };
            const clearTemplateEditor = () => {
                selectedTemplateId = null;
                if (templateNameInput) templateNameInput.value = '';
                if (templateHtmlInput) templateHtmlInput.value = '';
                if (templateCssInput) templateCssInput.value = '';
                renderTemplatePreview();
                if (plantillasList) {
                    plantillasList.querySelectorAll('.plantillas-item').forEach((btn) => btn.classList.remove('active'));
                }
            };
            const setTemplateEditor = (tpl) => {
                if (!tpl) return;
                selectedTemplateId = tpl.id;
                if (templateNameInput) templateNameInput.value = tpl.nombre || '';
                if (templateHtmlInput) templateHtmlInput.value = tpl.html || '';
                if (templateCssInput) templateCssInput.value = tpl.css || '';
                renderTemplatePreview();
            };
            const renderPlantillasList = () => {
                if (!plantillasList) return;
                plantillasList.innerHTML = plantillasStore.map((tpl) => `
                    <li>
                        <button type="button" class="plantillas-item ${tpl.id === selectedTemplateId ? 'active' : ''}" data-template-id="${tpl.id}">
                            ${tpl.nombre}
                        </button>
                    </li>
                `).join('');
                plantillasList.querySelectorAll('[data-template-id]').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.templateId;
                        const tpl = plantillasStore.find((item) => item.id === id);
                        if (!tpl) return;
                        setTemplateEditor(tpl);
                        renderPlantillasList();
                        showMessage(`Plantilla "${tpl.nombre}" cargada.`, 'success');
                    });
                });
            };
            const loadPlantillas = async () => {
                if (!plantillasPage) return;
                try {
                    const res = await fetch('/api/plantillas');
                    if (!res.ok) throw new Error('No se pudo cargar la lista');
                    const json = await res.json();
                    plantillasStore = Array.isArray(json?.data) ? json.data : [];
                    if (!selectedTemplateId && plantillasStore.length) {
                        setTemplateEditor(plantillasStore[0]);
                    } else if (!plantillasStore.length) {
                        clearTemplateEditor();
                    }
                    renderPlantillasList();
                } catch (error) {
                    showMessage('No se pudieron cargar las plantillas.', 'error');
                }
            };
            if (plantillasPage) {
                const plantillasLink = document.querySelector('a[data-route="/plantillas"]');
                if (plantillasLink) {
                    setMenuInfo(plantillasLink);
                }
                setFloatingScreen('plantillas');
                ensureFloatingVisible();
                await loadBuilderRoleOptions();
                loadPlantillas();
                templatePreviewBtn && templatePreviewBtn.addEventListener('click', renderTemplatePreview);
                templateHtmlInput && templateHtmlInput.addEventListener('input', renderTemplatePreview);
                templateCssInput && templateCssInput.addEventListener('input', renderTemplatePreview);
                builderFormName && builderFormName.addEventListener('input', () => {
                    if (selectedFormDefinitionId) return;
                    if (!builderFormSlug) return;
                    if ((builderFormSlug.value || '').trim()) return;
                    builderFormSlug.value = slugifyText(builderFormName.value);
                });
                builderFieldLabel && builderFieldLabel.addEventListener('input', () => {
                    if (!builderFieldName) return;
                    if ((builderFieldName.value || '').trim()) return;
                    builderFieldName.value = slugifyText(builderFieldLabel.value).replace(/-/g, '_');
                });
                templateBuilderBtn && templateBuilderBtn.addEventListener('click', () => {
                    window.location.href = '/plantillas/constructor';
                });
                builderBackToTemplates && builderBackToTemplates.addEventListener('click', () => {
                    window.location.href = '/plantillas';
                });
                builderFormSelect && builderFormSelect.addEventListener('change', () => {
                    const formId = Number(builderFormSelect.value);
                    if (!formId) {
                        clearBuilderForm();
                        return;
                    }
                    const found = formDefinitionsStore.find((item) => Number(item.id) === formId);
                    if (!found) {
                        showMessage('Formulario no encontrado en la lista.', 'error');
                        return;
                    }
                    setBuilderFromForm(found);
                    showMessage(`Formulario "${found.name}" cargado.`, 'success');
                });
                builderAddFieldBtn && builderAddFieldBtn.addEventListener('click', () => {
                    const fieldLabel = (builderFieldLabel?.value || '').trim();
                    const fieldNameRaw = (builderFieldName?.value || '').trim();
                    const fieldType = (builderFieldType?.value || 'text').trim();
                    const conditionalRaw = (builderFieldConditional?.value || '').trim();
                    if (!fieldLabel) {
                        showMessage('La etiqueta del campo es obligatoria.', 'error');
                        return;
                    }
                    const normalizedName = (fieldNameRaw || slugifyText(fieldLabel).replace(/-/g, '_')).replace(/[^a-zA-Z0-9_]/g, '_');
                    if (!normalizedName) {
                        showMessage('El nombre técnico del campo es inválido.', 'error');
                        return;
                    }
                    if (builderFields.some((item) => item.name === normalizedName)) {
                        showMessage('Ya existe un campo con ese nombre técnico.', 'error');
                        return;
                    }
                    const optionValues = (builderFieldOptions?.value || '')
                        .split(',')
                        .map((opt) => opt.trim())
                        .filter(Boolean);
                    let normalizedOptions = optionValues.map((opt) => ({ label: opt, value: opt }));
                    if (fieldType === 'likert' && !normalizedOptions.length) {
                        normalizedOptions = ['1', '2', '3', '4', '5'].map((value) => ({ label: value, value }));
                    }
                    let conditionalLogic = {};
                    if (conditionalRaw) {
                        try {
                            const parsed = JSON.parse(conditionalRaw);
                            if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                                showMessage('La condición debe ser un objeto JSON válido.', 'error');
                                return;
                            }
                            conditionalLogic = parsed;
                        } catch (error) {
                            showMessage('JSON condicional inválido.', 'error');
                            return;
                        }
                    }
                    builderFields.push({
                        field_type: fieldType,
                        label: fieldLabel,
                        name: normalizedName,
                        placeholder: (builderFieldPlaceholder?.value || '').trim() || null,
                        help_text: (builderFieldHelp?.value || '').trim() || null,
                        default_value: null,
                        is_required: Boolean(builderFieldRequired?.checked),
                        validation_rules: {},
                        options: ['select', 'radio', 'checkboxes', 'likert'].includes(fieldType)
                            ? normalizedOptions
                            : [],
                        order: builderFields.length,
                        conditional_logic: conditionalLogic,
                    });
                    renderBuilderFields();
                    clearBuilderFieldInputs();
                    showMessage('Campo agregado al formulario.', 'success');
                });
                builderClearFormBtn && builderClearFormBtn.addEventListener('click', () => {
                    clearBuilderForm();
                    showMessage('Constructor limpiado.', 'success');
                });
                builderSaveFormBtn && builderSaveFormBtn.addEventListener('click', async () => {
                    try {
                        const payload = collectBuilderPayload();
                        const formId = selectedFormDefinitionId ? Number(selectedFormDefinitionId) : null;
                        const endpoint = formId ? `/api/admin/forms/${encodeURIComponent(formId)}` : '/api/admin/forms';
                        const method = formId ? 'PUT' : 'POST';
                        const res = await fetch(endpoint, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo guardar el formulario');
                        selectedFormDefinitionId = Number(json?.id || formId || selectedFormDefinitionId);
                        await loadFormDefinitions();
                        if (!selectedFormDefinitionId && json?.id) {
                            selectedFormDefinitionId = Number(json.id);
                        }
                        if (selectedFormDefinitionId) {
                            const saved = formDefinitionsStore.find((item) => Number(item.id) === Number(selectedFormDefinitionId));
                            if (saved) setBuilderFromForm(saved);
                        }
                        showMessage('Formulario guardado correctamente.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al guardar formulario.', 'error');
                    }
                });
                builderDeleteFormBtn && builderDeleteFormBtn.addEventListener('click', async () => {
                    if (!selectedFormDefinitionId) {
                        showMessage('Selecciona un formulario para eliminar.', 'error');
                        return;
                    }
                    if (!confirm('¿Eliminar el formulario seleccionado?')) {
                        showMessage('Eliminación cancelada.', 'error');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/admin/forms/${encodeURIComponent(selectedFormDefinitionId)}`, {
                            method: 'DELETE',
                        });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json?.detail || json?.error || 'No se pudo eliminar');
                        clearBuilderForm();
                        await loadFormDefinitions();
                        showMessage('Formulario eliminado.', 'success');
                    } catch (error) {
                        showMessage(error?.message || 'Error al eliminar formulario.', 'error');
                    }
                });
                if (formBuilderPanel && !formBuilderPanel.classList.contains('hidden')) {
                    clearBuilderForm();
                    loadFormDefinitions();
                    if (!builderFields.length) renderBuilderFields();
                }
            }
            const notebookTabs = document.querySelectorAll('.notebook-tabs .tab');
            const notebookPanels = document.querySelectorAll('.notebook-content .tab-panel');
            const activateNotebookTab = (name) => {
                if (!name) return;
                notebookTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === name));
                notebookPanels.forEach(panel => {
                    panel.hidden = panel.dataset.panel !== name;
                });
            };
            notebookTabs.forEach(tab => tab.addEventListener('click', () => activateNotebookTab(tab.dataset.tab)));
            actionSavePersonal && actionSavePersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                if (identityForm) {
                    if (typeof identityForm.requestSubmit === 'function') {
                        identityForm.requestSubmit();
                    } else {
                        identityForm.submit();
                    }
                    return;
                }
                guardarColores();
                guardarAssets();
            });
            actionResetPersonal && actionResetPersonal.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'personalization') return;
                event.preventDefault();
                restablecerColores();
                restablecerAssets();
                showMessage('Colores restablecidos en personalización.', 'success');
            });
            personalizarEditBtn && personalizarEditBtn.addEventListener('click', (event) => {
                event.preventDefault();
                const firstColorInput = document.querySelector('.personalization-panel input[type="color"]');
                if (firstColorInput instanceof HTMLElement) {
                    firstColorInput.focus();
                }
                showMessage('Modo edición activo en personalización.', 'success');
            });
            personalizarSaveBtn && personalizarSaveBtn.addEventListener('click', (event) => {
                event.preventDefault();
                guardarColores();
                guardarAssets();
            });
            personalizarResetBtn && personalizarResetBtn.addEventListener('click', (event) => {
                event.preventDefault();
                restablecerColores();
                restablecerAssets();
                guardarColores();
            });
            actionNewTemplate && actionNewTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                clearTemplateEditor();
                templateNameInput && templateNameInput.focus();
                showMessage('Nueva plantilla lista para captura.', 'success');
            });
            actionEditTemplate && actionEditTemplate.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para editar.', 'error');
                    return;
                }
                templateNameInput && templateNameInput.focus();
                showMessage('Modo edición de plantilla activado.', 'success');
            });
            const handleTemplateSave = async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                if (event) event.preventDefault();
                const payload = {
                    id: selectedTemplateId,
                    nombre: (templateNameInput?.value || '').trim(),
                    html: templateHtmlInput?.value || '',
                    css: templateCssInput?.value || '',
                };
                if (!payload.nombre) {
                    showMessage('El nombre de la plantilla es obligatorio.', 'error');
                    return;
                }
                if (!payload.html.trim() && !payload.css.trim()) {
                    showMessage('Agrega HTML o CSS para guardar.', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/plantillas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo guardar');
                    }
                    selectedTemplateId = json?.data?.id || selectedTemplateId;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla guardada.', 'success');
                } catch (error) {
                    showMessage('Error al guardar la plantilla.', 'error');
                }
            };
            actionSaveTemplate && actionSaveTemplate.addEventListener('click', handleTemplateSave);
            templateSaveBtn && templateSaveBtn.addEventListener('click', handleTemplateSave);
            actionDeleteTemplate && actionDeleteTemplate.addEventListener('click', async (event) => {
                if (activeFloatingScreen !== 'plantillas') return;
                event.preventDefault();
                if (!selectedTemplateId) {
                    showMessage('Selecciona una plantilla para eliminar.', 'error');
                    return;
                }
                if (!confirm('¿Eliminar la plantilla seleccionada?')) {
                    showMessage('Eliminación cancelada.', 'error');
                    return;
                }
                try {
                    const res = await fetch(`/api/plantillas/${encodeURIComponent(selectedTemplateId)}`, {
                        method: 'DELETE',
                    });
                    const json = await res.json();
                    if (!res.ok || !json?.success) {
                        throw new Error(json?.error || 'No se pudo eliminar');
                    }
                    selectedTemplateId = null;
                    await loadPlantillas();
                    renderTemplatePreview();
                    showMessage('Plantilla eliminada.', 'success');
                } catch (error) {
                    showMessage(error?.message || 'Error al eliminar la plantilla.', 'error');
                }
            });
            templateNewBtn && templateNewBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionNewTemplate && actionNewTemplate.click();
            });
            templateEditBtn && templateEditBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionEditTemplate && actionEditTemplate.click();
            });
            templateDeleteBtn && templateDeleteBtn.addEventListener('click', (event) => {
                event.preventDefault();
                actionDeleteTemplate && actionDeleteTemplate.click();
            });
            actionExportReportes && actionExportReportes.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/html';
                showMessage('Exportando reporte con encabezado.', 'success');
            });
            actionExportPdf && actionExportPdf.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/pdf';
                showMessage('Generando PDF con encabezado.', 'success');
            });
            actionExportExcel && actionExportExcel.addEventListener('click', (event) => {
                if (activeFloatingScreen !== 'reportes') return;
                event.preventDefault();
                window.location.href = '/api/reportes/export/excel';
                showMessage('Generando Excel con encabezado.', 'success');
            });
            const fodaBuilder = document.getElementById('foda-builder');
            if (fodaBuilder) {
                const descriptionInput = document.getElementById('foda-description');
                const categoryInput = document.getElementById('foda-category');
                const impactInput = document.getElementById('foda-impact');
                const addButton = document.getElementById('foda-add');
                const lists = {
                    strengths: document.getElementById('foda-list-strengths'),
                    weaknesses: document.getElementById('foda-list-weaknesses'),
                    opportunities: document.getElementById('foda-list-opportunities'),
                    threats: document.getElementById('foda-list-threats'),
                };
                const counters = {
                    strengths: document.getElementById('foda-count-strengths'),
                    weaknesses: document.getElementById('foda-count-weaknesses'),
                    opportunities: document.getElementById('foda-count-opportunities'),
                    threats: document.getElementById('foda-count-threats'),
                };
                const factors = {
                    strengths: [],
                    weaknesses: [],
                    opportunities: [],
                    threats: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderFoda = () => {
                    Object.keys(factors).forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="foda-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-foda-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    fodaBuilder.querySelectorAll('[data-foda-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [cat, indexRaw] = (btn.dataset.fodaRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[cat] || Number.isNaN(index)) return;
                            factors[cat].splice(index, 1);
                            renderFoda();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'strengths';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripción para el factor FODA.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderFoda();
                    showMessage('Factor FODA agregado.', 'success');
                });
                renderFoda();
            }
            const pestelBuilder = document.getElementById('pestel-builder');
            if (pestelBuilder) {
                const descriptionInput = document.getElementById('pestel-description');
                const factorInput = document.getElementById('pestel-factor');
                const impactInput = document.getElementById('pestel-impact');
                const addButton = document.getElementById('pestel-add');
                const dimensions = ['political', 'economic', 'social', 'technological', 'ecological', 'legal'];
                const lists = {
                    political: document.getElementById('pestel-list-political'),
                    economic: document.getElementById('pestel-list-economic'),
                    social: document.getElementById('pestel-list-social'),
                    technological: document.getElementById('pestel-list-technological'),
                    ecological: document.getElementById('pestel-list-ecological'),
                    legal: document.getElementById('pestel-list-legal'),
                };
                const counters = {
                    political: document.getElementById('pestel-count-political'),
                    economic: document.getElementById('pestel-count-economic'),
                    social: document.getElementById('pestel-count-social'),
                    technological: document.getElementById('pestel-count-technological'),
                    ecological: document.getElementById('pestel-count-ecological'),
                    legal: document.getElementById('pestel-count-legal'),
                };
                const factors = {
                    political: [],
                    economic: [],
                    social: [],
                    technological: [],
                    ecological: [],
                    legal: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPestel = () => {
                    dimensions.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="pestel-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-pestel-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    pestelBuilder.querySelectorAll('[data-pestel-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [dimension, indexRaw] = (btn.dataset.pestelRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[dimension] || Number.isNaN(index)) return;
                            factors[dimension].splice(index, 1);
                            renderPestel();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const dimension = factorInput?.value || 'political';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripción para el factor PESTEL.', 'error');
                        return;
                    }
                    if (!factors[dimension]) return;
                    factors[dimension].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPestel();
                    showMessage('Factor PESTEL agregado.', 'success');
                });
                renderPestel();
            }
            const porterBuilder = document.getElementById('porter-builder');
            if (porterBuilder) {
                const descriptionInput = document.getElementById('porter-description');
                const forceInput = document.getElementById('porter-force');
                const impactInput = document.getElementById('porter-impact');
                const addButton = document.getElementById('porter-add');
                const forces = ['competitors', 'entrants', 'suppliers', 'buyers', 'substitutes'];
                const lists = {
                    competitors: document.getElementById('porter-list-competitors'),
                    entrants: document.getElementById('porter-list-entrants'),
                    suppliers: document.getElementById('porter-list-suppliers'),
                    buyers: document.getElementById('porter-list-buyers'),
                    substitutes: document.getElementById('porter-list-substitutes'),
                };
                const counters = {
                    competitors: document.getElementById('porter-count-competitors'),
                    entrants: document.getElementById('porter-count-entrants'),
                    suppliers: document.getElementById('porter-count-suppliers'),
                    buyers: document.getElementById('porter-count-buyers'),
                    substitutes: document.getElementById('porter-count-substitutes'),
                };
                const factors = {
                    competitors: [],
                    entrants: [],
                    suppliers: [],
                    buyers: [],
                    substitutes: [],
                };
                const impactLabel = {
                    high: 'Impacto alto',
                    medium: 'Impacto medio',
                    low: 'Impacto bajo',
                };
                const renderPorter = () => {
                    forces.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="porter-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${impactLabel[item.impact] || 'Impacto medio'}</small>
                                </div>
                                <button type="button" data-porter-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    porterBuilder.querySelectorAll('[data-porter-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [force, indexRaw] = (btn.dataset.porterRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[force] || Number.isNaN(index)) return;
                            factors[force].splice(index, 1);
                            renderPorter();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const force = forceInput?.value || 'competitors';
                    const impact = impactInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripción para el factor PORTER.', 'error');
                        return;
                    }
                    if (!factors[force]) return;
                    factors[force].push({ description, impact });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPorter();
                    showMessage('Factor PORTER agregado.', 'success');
                });
                renderPorter();
            }
            const percepcionBuilder = document.getElementById('percepcion-builder');
            if (percepcionBuilder) {
                const descriptionInput = document.getElementById('percepcion-description');
                const categoryInput = document.getElementById('percepcion-category');
                const priorityInput = document.getElementById('percepcion-priority');
                const addButton = document.getElementById('percepcion-add');
                const categories = ['positive', 'neutral', 'negative'];
                const lists = {
                    positive: document.getElementById('percepcion-list-positive'),
                    neutral: document.getElementById('percepcion-list-neutral'),
                    negative: document.getElementById('percepcion-list-negative'),
                };
                const counters = {
                    positive: document.getElementById('percepcion-count-positive'),
                    neutral: document.getElementById('percepcion-count-neutral'),
                    negative: document.getElementById('percepcion-count-negative'),
                };
                const factors = {
                    positive: [],
                    neutral: [],
                    negative: [],
                };
                const priorityLabel = {
                    high: 'Prioridad alta',
                    medium: 'Prioridad media',
                    low: 'Prioridad baja',
                };
                const renderPercepcion = () => {
                    categories.forEach((key) => {
                        const targetList = lists[key];
                        const targetCount = counters[key];
                        if (!targetList || !targetCount) return;
                        targetCount.textContent = String(factors[key].length);
                        targetList.innerHTML = factors[key].map((item, index) => `
                            <li class="percepcion-item">
                                <div>
                                    <strong>${item.description}</strong><br>
                                    <small>${priorityLabel[item.priority] || 'Prioridad media'}</small>
                                </div>
                                <button type="button" data-percepcion-remove="${key}:${index}">Quitar</button>
                            </li>
                        `).join('');
                    });
                    percepcionBuilder.querySelectorAll('[data-percepcion-remove]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const [category, indexRaw] = (btn.dataset.percepcionRemove || '').split(':');
                            const index = Number(indexRaw);
                            if (!factors[category] || Number.isNaN(index)) return;
                            factors[category].splice(index, 1);
                            renderPercepcion();
                        });
                    });
                };
                addButton && addButton.addEventListener('click', () => {
                    const description = (descriptionInput?.value || '').trim();
                    const category = categoryInput?.value || 'neutral';
                    const priority = priorityInput?.value || 'medium';
                    if (!description) {
                        showMessage('Escribe una descripción para la percepción del cliente.', 'error');
                        return;
                    }
                    if (!factors[category]) return;
                    factors[category].push({ description, priority });
                    if (descriptionInput) descriptionInput.value = '';
                    renderPercepcion();
                    showMessage('Percepción agregada.', 'success');
                });
                renderPercepcion();
            }
            const navbarAvatarImg = document.getElementById('navbar-avatar-img');
            const applyFallback = (img) => {
                if (!img) return;
                const fallback = img.dataset.default;
                img.addEventListener('error', function() {
                    if (fallback) img.src = fallback;
                });
                if (!img.src) img.src = fallback;
            };
            applyFallback(navbarAvatarImg);
            applyFallback(sidebarUserImg);
            syncSidebarCompanyLogo();
            syncNavbarNotificationIconColor(
                (navbar ? getComputedStyle(navbar).color : '')
                || getComputedStyle(document.documentElement).getPropertyValue('--navbar-text')
            );
            if (navbarAvatarBtn && userDropdown) {
                const closeUserDropdown = () => {
                    userDropdown.classList.remove('open');
                    navbarAvatarBtn.setAttribute('aria-expanded', 'false');
                };
                navbarAvatarBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const willOpen = !userDropdown.classList.contains('open');
                    if (willOpen) {
                        userDropdown.classList.add('open');
                        navbarAvatarBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('click', (event) => {
                    if (!userDropdown.contains(event.target) && !navbarAvatarBtn.contains(event.target)) {
                        closeUserDropdown();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeUserDropdown();
                    }
                });
                if (logoutLink) {
                    logoutLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        closeUserDropdown();
                        window.location.assign('/logout');
                    });
                }
            }
            if ((sidebarNotificationsTrigger || navbarNotificationsTrigger) && sidebarNotificationsPanel) {
                const closeNotifications = () => {
                    sidebarNotificationsPanel.classList.remove('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'true');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'false');
                };
                const openNotifications = async () => {
                    sidebarNotificationsPanel.classList.add('open');
                    sidebarNotificationsPanel.setAttribute('aria-hidden', 'false');
                    if (navbarNotificationsTrigger) navbarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    if (sidebarNotificationsTrigger) sidebarNotificationsTrigger.setAttribute('aria-expanded', 'true');
                    await loadNotifications(false);
                };
                const bindNotificationsTrigger = (trigger, setMenu = false) => {
                    if (!trigger) return;
                    trigger.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        if (setMenu) setMenuInfo(trigger);
                        const willOpen = !sidebarNotificationsPanel.classList.contains('open');
                        if (willOpen) {
                            await openNotifications();
                        } else {
                            closeNotifications();
                        }
                    });
                };
                bindNotificationsTrigger(sidebarNotificationsTrigger, true);
                bindNotificationsTrigger(navbarNotificationsTrigger, false);
                sidebarNotificationsRefresh && sidebarNotificationsRefresh.addEventListener('click', async (event) => {
                    event.preventDefault();
                    await loadNotifications(false);
                });
                sidebarNotificationsMarkAll && sidebarNotificationsMarkAll.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const ids = Array.from(
                        sidebarNotificationsList.querySelectorAll('[data-notification-id]')
                    ).map((el) => (el.getAttribute('data-notification-id') || '').trim()).filter(Boolean);
                    try {
                        await markAllNotificationsRead(ids);
                        await loadNotifications(false);
                    } catch (error) {
                        showMessage(error.message || 'No se pudieron marcar las notificaciones', 'error');
                    }
                });
                sidebarNotificationsList.addEventListener('click', async (event) => {
                    const link = event.target && event.target.closest ? event.target.closest('[data-notification-id]') : null;
                    if (!link) return;
                    const notificationId = (link.getAttribute('data-notification-id') || '').trim();
                    const href = link.getAttribute('href') || '#';
                    event.preventDefault();
                    try {
                        await markNotificationRead(notificationId);
                    } catch (error) {
                        // Si falla la persistencia, no bloqueamos navegación.
                    }
                    await loadNotifications(true);
                    if (href && href !== '#') {
                        window.location.assign(href);
                    }
                });
                document.addEventListener('click', (event) => {
                    if (
                        sidebarNotificationsPanel.classList.contains('open')
                        && !sidebarNotificationsPanel.contains(event.target)
                        && !(sidebarNotificationsTrigger && sidebarNotificationsTrigger.contains(event.target))
                        && !(navbarNotificationsTrigger && navbarNotificationsTrigger.contains(event.target))
                    ) {
                        closeNotifications();
                    }
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        closeNotifications();
                    }
                });
                loadNotifications(true);
                window.setInterval(() => {
                    loadNotifications(true);
                }, 60000);
            }
            const empresaToggle = document.getElementById("empresa-section-toggle");
            const empresaContent = document.getElementById("empresa-section-content");
            if (empresaToggle && empresaContent) {
                const setEmpresaOpenState = (open) => {
                    empresaContent.classList.toggle("open", open);
                    empresaToggle.setAttribute("aria-expanded", open ? "true" : "false");
                    const indicator = empresaToggle.querySelector(".toggle-indicator");
                    if (indicator) {
                        indicator.textContent = open ? "−" : "+";
                    }
                };
                empresaToggle.addEventListener("click", () => {
                    const open = !empresaContent.classList.contains("open");
                    setEmpresaOpenState(open);
                });
                const currentPath = window.location.pathname;
                const empresaLinks = empresaContent.querySelectorAll('a[href]');
                const shouldOpenEmpresa = Array.from(empresaLinks).some(link => link.getAttribute('href') === currentPath);
                if (shouldOpenEmpresa) {
                    setEmpresaOpenState(true);
                    const activeEmpresaLink = Array.from(empresaLinks).find(link => link.getAttribute('href') === currentPath);
                    if (activeEmpresaLink) {
                        setMenuInfo(activeEmpresaLink);
                    }
                }
            }
        });
    </script>
</body>
</html>
